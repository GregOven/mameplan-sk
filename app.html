<!doctype html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://www.google.com https://apis.google.com https://www.googletagmanager.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    connect-src https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebaseinstallations.googleapis.com https://www.googleapis.com https://www.google-analytics.com https://api.emailjs.com https://www.google.com https://firebase.googleapis.com https://content-firebaseappcheck.googleapis.com https://*.google-analytics.com https://*.analytics.google.com;
    frame-src https://accounts.google.com https://www.google.com https://bez-paniky.firebaseapp.com https://recaptcha.google.com;
    img-src 'self' data: https://*.googleusercontent.com https://www.google-analytics.com https://www.googletagmanager.com;
    object-src 'none';
    base-uri 'self';
  " />
  <title>Gerlach – Pripravenosť na krízové situácie</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --c-bg: #f5f3ee;
      --c-surface: #ffffff;
      --c-border: #e2ddd5;
      --c-text: #1a1714;
      --c-muted: #6b6560;
      --c-accent: #d4501a;
      --c-accent-light: #fdf0eb;
      --c-green: #2a7a4b;
      --c-green-light: #eaf4ee;
      --c-amber: #b45309;
      --c-amber-light: #fef3c7;
      /* ── Design tokens ── */
      --c-info: #475569;
      --c-info-bg: #f1f5f9;
      --c-info-border: #cbd5e1;
      --c-success: #2a7a4b;
      --c-success-bg: #eaf4ee;
      --c-success-border: #86efac;
      --c-warning: #b45309;
      --c-warning-bg: #fef3c7;
      --c-warning-border: #fcd34d;
      --c-error: #dc2626;
      --c-error-bg: #fef2f2;
      --c-error-border: #fecaca;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Lexend', sans-serif; background: var(--c-bg); color: var(--c-text); font-size: 110%; }
    h1, h2, h3, .font-display { font-family: 'DM Sans', 'Lexend', sans-serif; letter-spacing: -0.025em; }

    /* ═══════════════════════════════════════════
       ACCESSIBILITY
    ═══════════════════════════════════════════ */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--c-text);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0 0 0.75rem 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
      z-index: 10001;
      text-decoration: none;
      transition: top 0.2s;
    }
    .skip-link:focus {
      top: 0;
      outline: 3px solid var(--c-accent);
      outline-offset: 2px;
    }

    /* Focus visible ring for all interactive elements */
    [tabindex]:focus-visible,
    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2.5px solid var(--c-accent);
      outline-offset: 2px;
    }

    /* ═══════════════════════════════════════════
       DESIGN SYSTEM: SHADOWS & TRANSITIONS
    ═══════════════════════════════════════════ */
    .shadow-sm { box-shadow: 0 1px 2px rgba(26,23,20,0.04), 0 1px 3px rgba(26,23,20,0.06); }
    .shadow-md { box-shadow: 0 2px 8px rgba(26,23,20,0.06), 0 4px 16px rgba(26,23,20,0.04); }
    .shadow-lg { box-shadow: 0 4px 12px rgba(26,23,20,0.08), 0 8px 32px rgba(26,23,20,0.06); }

    /* Tab switch stagger animation */
    .tab-pane.active > * {
      animation: fadeSlideIn 0.35s ease both;
    }
    .tab-pane.active > *:nth-child(1) { animation-delay: 0s; }
    .tab-pane.active > *:nth-child(2) { animation-delay: 0.05s; }
    .tab-pane.active > *:nth-child(3) { animation-delay: 0.1s; }
    .tab-pane.active > *:nth-child(4) { animation-delay: 0.15s; }
    .tab-pane.active > *:nth-child(5) { animation-delay: 0.2s; }
    .tab-pane.active > *:nth-child(6) { animation-delay: 0.25s; }
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Progress bar living gradient */
    .progress-fill::after {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.25) 50%, transparent 100%);
      animation: shimmer 2.5s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Confetti canvas */
    #confettiCanvas {
      position: fixed; inset: 0; z-index: 9999;
      pointer-events: none;
    }

    /* Easter egg: Tatry panorama */
    .easter-tatry {
      position: fixed; inset: 0; z-index: 10000;
      background: linear-gradient(180deg, #1a1b3a 0%, #2d3561 30%, #4a6fa5 60%, #87CEEB 100%);
      display: none; align-items: center; justify-content: center;
      flex-direction: column; cursor: pointer;
      animation: tatryFadeIn 0.6s ease;
    }
    .easter-tatry.visible { display: flex; }
    @keyframes tatryFadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }
    .easter-tatry-mountains {
      width: 100%; max-width: 800px; height: 200px; position: relative;
    }
    .easter-tatry-quote {
      color: white; font-family: 'DM Sans', sans-serif;
      font-size: 1.5rem; font-weight: 700; text-align: center;
      margin-top: 2rem; padding: 0 2rem;
      text-shadow: 0 2px 12px rgba(0,0,0,0.3);
      letter-spacing: -0.02em;
    }
    .easter-tatry-sub {
      color: rgba(255,255,255,0.6); font-size: 0.85rem;
      margin-top: 1rem; font-family: 'Lexend', sans-serif;
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--c-bg);
      padding: 2rem;
      position: relative;
      overflow: hidden;
    }

    /* ═══════════════════════════════════════════
       DEMO BANNER + VERSION BADGE
    ═══════════════════════════════════════════ */
    .demo-banner {
      display: none;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-bottom: 1px solid #f59e0b;
      padding: 0.5rem 1rem;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 500;
      color: #92400e;
      /* Statický banner — scrolluje preč. Verzia badge v headeri ostáva. */
    }
    .demo-banner.visible { display: flex; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap; }
    .demo-banner a {
      display: inline-flex; align-items: center; gap: 0.25rem;
      background: #92400e; color: #fff;
      padding: 0.25rem 0.75rem; border-radius: 99px;
      font-size: 0.72rem; font-weight: 700;
      text-decoration: none; transition: background 0.15s;
    }
    .demo-banner a:hover { background: #78350f; }
    .version-badge {
      display: inline-flex; align-items: center; gap: 0.375rem;
      font-size: 0.65rem; font-weight: 600;
      padding: 0.15rem 0.5rem;
      border-radius: 99px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .version-badge.beta {
      background: var(--c-accent-light);
      color: var(--c-accent);
      border: 1px solid rgba(212,80,26,0.2);
    }
    .version-badge.demo-badge {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
    }
    /* Demo mode: badge in header serves as persistent reminder */
    .login-screen::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 120px;
      opacity: 0.06;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120'%3E%3Cpath d='M0 120 L80 70 L130 90 L200 40 L260 65 L330 20 L380 50 L440 10 L500 45 L560 15 L620 55 L680 25 L740 60 L800 35 L860 70 L920 45 L980 75 L1040 50 L1100 80 L1160 55 L1200 70 L1200 120Z' fill='%231a1714'/%3E%3C/svg%3E") no-repeat bottom center;
      background-size: cover;
      pointer-events: none;
    }
    .login-card {
      background: var(--c-surface);
      border: 1px solid var(--c-border);
      border-radius: 1.5rem;
      padding: 3rem 2.5rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    }
    .logo-mark {
      width: 64px; height: 64px;
      background: var(--c-accent);
      border-radius: 1rem;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 1.75rem;
    }
    .btn-google {
      display: flex; align-items: center; justify-content: center; gap: 0.75rem;
      width: 100%;
      padding: 0.875rem 1.5rem;
      border: 1.5px solid var(--c-border);
      border-radius: 0.875rem;
      background: var(--c-surface);
      color: var(--c-text);
      font-family: 'Lexend', sans-serif;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-google:hover { background: var(--c-bg); border-color: #c5c0b8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    #btnDemoLogin:hover { background: #fef3c7 !important; border-color: #d97706 !important; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.15); }
    .btn-google svg { flex-shrink: 0; }

    .app-header {
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--c-border);
      position: sticky; top: 0; z-index: 50;
    }
    .app-header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.25rem;
      height: 48px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .app-header-logo { display: flex; align-items: center; gap: 0.5rem; min-width: 0; }

    /* ── Unified segment tabs (inside header) ── */
    .header-tabs {
      display: flex;
      align-items: center;
      background: var(--c-bg);
      border: 1px solid var(--c-border);
      border-radius: 999px;
      padding: 3px;
      gap: 2px;
      position: relative;
    }
    .header-tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      padding: 0.375rem 0.875rem;
      border: none;
      background: transparent;
      color: var(--c-muted);
      font-family: 'DM Sans', 'Lexend', sans-serif;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 999px;
      transition: color 0.2s, background 0.2s, box-shadow 0.2s;
      white-space: nowrap;
      position: relative;
      z-index: 1;
    }
    .header-tab-btn:hover {
      color: var(--c-text);
    }
    .header-tab-btn.active {
      color: var(--c-accent);
      background: var(--c-surface);
      box-shadow: 0 1px 3px rgba(26,23,20,0.08), 0 1px 2px rgba(26,23,20,0.06);
    }
    .header-tab-btn .tab-emoji { font-size: 0.82rem; }
    .app-logo-sm {
      width: 32px; height: 32px;
      background: var(--c-accent);
      border-radius: 0.5rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; color: white;
    }

    .card {
      background: var(--c-surface);
      border: 1px solid var(--c-border);
      border-radius: 1.25rem;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(26,23,20,0.04), 0 2px 8px rgba(26,23,20,0.03);
      transition: box-shadow 0.25s ease, transform 0.25s ease;
    }
    .card:hover {
      box-shadow: 0 2px 8px rgba(26,23,20,0.06), 0 4px 16px rgba(26,23,20,0.04);
    }

    .progress-bar { height: 8px; border-radius: 999px; background: #ede9e3; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 999px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden; }

    .cat-card {
      background: var(--c-surface);
      border: 2px solid var(--c-border);
      border-radius: 1.25rem;
      padding: 1rem;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .cat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.11), inset 0 1px 0 rgba(255,255,255,0.8);
    }
    .cat-card.selected {
      transform: translateY(-5px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.14);
      border-width: 3px;
    }

    .item-row {
      background: var(--c-surface);
      border: 1px solid var(--c-border);
      border-radius: 0.875rem;
      padding: 0.875rem 1rem;
      display: flex; align-items: flex-start; gap: 0.75rem;
      transition: background 0.1s;
    }
    .item-row:hover { background: #faf9f7; }

    .badge {
      display: inline-flex; align-items: center;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem; font-weight: 600;
      border: 1px solid;
    }
    .badge-red { background: #fef2f2; color: #991b1b; border-color: #fecaca; }
    .badge-amber { background: var(--c-amber-light); color: var(--c-amber); border-color: #fcd34d; }
    .badge-gray { background: #f9fafb; color: #6b7280; border-color: #e5e7eb; }
    .badge-green { background: var(--c-green-light); color: var(--c-green); border-color: #86efac; }

    .btn-primary {
      background: var(--c-text); color: white;
      border: none; border-radius: 0.75rem;
      padding: 0.625rem 1.125rem;
      font-size: 0.875rem; font-weight: 500;
      cursor: pointer; transition: background 0.15s;
      font-family: 'Lexend', sans-serif;
    }
    .btn-primary:hover { background: #333; }
    .btn-danger {
      background: #fee2e2; color: #991b1b;
      border: 1px solid #fecaca;
      border-radius: 0.75rem;
      padding: 0.5rem 0.875rem;
      font-size: 0.8rem; font-weight: 500;
      cursor: pointer; transition: background 0.15s;
      font-family: 'Lexend', sans-serif;
    }
    .btn-danger:hover { background: #fecaca; }
    .btn-ghost {
      background: transparent; color: var(--c-muted);
      border: 1px solid var(--c-border);
      border-radius: 0.75rem;
      padding: 0.5rem 0.875rem;
      font-size: 0.8rem;
      cursor: pointer; transition: all 0.15s;
      font-family: 'Lexend', sans-serif;
    }
    .btn-ghost:hover { background: var(--c-bg); color: var(--c-text); }

    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      display: none; align-items: center; justify-content: center;
      padding: 1rem; z-index: 100;
      overscroll-behavior: contain;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--c-surface);
      border: 1px solid var(--c-border);
      border-radius: 1.5rem;
      padding: 1.5rem;
      width: 100%; max-width: 560px;
      max-height: 90vh; overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }

    input[type="text"], input[type="number"], input[type="date"], input[type="url"], select, textarea {
      width: 100%;
      background: white;
      border: 1.5px solid var(--c-border);
      border-radius: 0.75rem;
      padding: 0.625rem 0.875rem;
      font-family: 'Lexend', sans-serif;
      font-size: 0.9rem;
      color: var(--c-text);
      transition: border-color 0.15s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--c-accent); }

    .limit-banner {
      background: linear-gradient(135deg, #1a1714 0%, #2d2926 100%);
      color: white;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      display: flex; align-items: center; gap: 1rem;
    }

    .user-avatar {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: var(--c-accent);
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 0.875rem;
      overflow: hidden;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .sync-indicator {
      display: inline-flex; align-items: center; gap: 0.375rem;
      font-size: 0.75rem; color: var(--c-muted);
    }
    .sync-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: #d1d5db;
    }
    .sync-dot.synced { background: var(--c-green); }
    .sync-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }

    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    @keyframes tipSlideIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }

    .water-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1.5px solid #bfdbfe;
      border-radius: 1rem;
      padding: 1.25rem;
    }

    /* ═══════════════════════════════════════════
       PRVÁ POMOC
    ═══════════════════════════════════════════ */
    .fa-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.75rem;
    }
    .fa-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem 0.5rem;
      border-radius: 1rem;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, background 0.15s ease;
      background: var(--c-surface);
      border: 1.5px solid var(--c-border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .fa-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.10);
      border-color: #d4501a;
    }
    .fa-card:active { transform: translateY(-1px); }
    .fa-icon {
      width: 52px; height: 52px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      flex-shrink: 0;
    }
    .fa-card-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--c-text);
      line-height: 1.3;
    }
    /* ── Modal content system (unified) ── */
    .modal-section {
      margin-bottom: 0.25rem;
    }
    .modal-section-header {
      display: flex; align-items: center; gap: 0.625rem;
      padding: 0.625rem 0.75rem;
      background: var(--c-bg);
      border-left: 4px solid var(--c-accent);
      border-radius: 0 0.5rem 0.5rem 0;
      margin: 1rem 0 0.5rem;
      font-family: 'DM Sans', 'Lexend', sans-serif;
      font-size: 0.88rem;
      font-weight: 700;
      color: var(--c-text);
      letter-spacing: -0.01em;
    }
    .modal-section-header:first-child { margin-top: 0; }
    .modal-section-steps {
      padding-left: 0.5rem;
      border-left: 2px solid var(--c-border);
      margin-left: 0.375rem;
    }
    .fa-modal-step {
      display: flex;
      align-items: flex-start;
      gap: 0.625rem;
      padding: 0.5rem 0.375rem;
      margin: 0;
      border-bottom: none;
      transition: background 0.15s;
      border-radius: 0.5rem;
    }
    .fa-modal-step:hover {
      background: rgba(0,0,0,0.02);
    }
    .fa-step-num {
      width: 24px; height: 24px;
      border-radius: 50%;
      background: var(--c-accent);
      color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.68rem; font-weight: 700;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }
    .fa-step-text {
      font-size: 0.82rem;
      line-height: 1.6;
      color: var(--c-text);
    }
    .fa-step-text strong { color: var(--c-text); font-weight: 700; }
    .modal-warn-box {
      background: var(--c-error-bg);
      border: 1px solid var(--c-error-border);
      border-radius: 0.75rem;
      padding: 0.625rem 0.75rem;
      font-size: 0.8rem;
      color: #991b1b;
      line-height: 1.55;
      margin: 0.375rem 0 0.375rem 0.875rem;
    }
    .modal-note-box {
      background: var(--c-warning-bg);
      border: 1px solid var(--c-warning-border);
      border-radius: 0.75rem;
      padding: 0.625rem 0.75rem;
      font-size: 0.8rem;
      color: #854d0e;
      line-height: 1.55;
      margin: 0.375rem 0 0.375rem 0.875rem;
    }
    /* Legacy aliases — keep for backward compat */
    .fa-warning {
      background: var(--c-error-bg);
      border: 1px solid var(--c-error-border);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 0.8rem;
      color: #991b1b;
      line-height: 1.5;
      margin-top: 0.75rem;
    }
    .fa-info {
      background: var(--c-info-bg);
      border: 1px solid var(--c-info-border);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 0.8rem;
      color: var(--c-info);
      line-height: 1.5;
      margin-top: 0.75rem;
    }
    .fa-source {
      font-size: 0.68rem;
      color: var(--c-muted);
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--c-border);
      line-height: 1.5;
    }
    .fa-emergency-bar {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      flex-wrap: wrap;
    }
    .fa-emergency-bar a {
      color: white;
      text-decoration: underline;
      font-weight: 700;
    }

    /* ═══════════════════════════════════════════
       UTILITY CLASSES (consolidated inline styles)
    ═══════════════════════════════════════════ */

    /* Modal close button */
    .modal-close {
      background: none; border: none; cursor: pointer;
      color: var(--c-muted); font-size: 1.375rem;
      flex-shrink: 0; margin-left: 1rem;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 0.5rem; transition: background 0.15s;
    }
    .modal-close:hover { background: var(--c-bg); }

    /* Modal header row */
    .modal-header {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }

    /* Section heading (uppercase muted) */
    .section-label {
      font-size: 0.78rem; font-weight: 700;
      color: var(--c-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.625rem;
    }

    /* Card inner section background */
    .card-section {
      background: var(--c-bg);
      border-radius: 1rem;
      padding: 1rem;
    }

    /* Item form label (bold) — used in category/bag item rows */
    .item-label {
      font-size: 0.78rem; color: var(--c-muted);
      display: block; margin-bottom: 0.375rem;
      font-weight: 600;
    }
    /* Item form sublabel */
    .item-sublabel {
      font-size: 0.68rem; color: var(--c-muted);
      display: block; margin-bottom: 0.2rem;
    }
    /* Item form label (regular) */
    .item-label-light {
      font-size: 0.8rem; color: var(--c-muted);
      display: block; margin-bottom: 0.375rem;
    }

    /* Undo toast */
    .undo-toast {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      left: 50%; transform: translateX(-50%);
      background: #1a1714; color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 1rem;
      font-family: 'Lexend', sans-serif;
      font-size: 0.82rem;
      display: flex; align-items: center; gap: 0.75rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.24);
      z-index: 200;
      animation: toastSlideUp 0.3s ease-out;
    }
    .undo-toast button {
      background: none; border: none;
      color: #60a5fa; font-weight: 700;
      font-family: 'Lexend', sans-serif;
      font-size: 0.82rem; cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      transition: background 0.15s;
    }
    .undo-toast button:hover { background: rgba(96,165,250,0.15); }
    @keyframes toastSlideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(16px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* ── Source collapsible (minimal) ── */
    .source-toggle {
      background: none; border: none; cursor: pointer;
      font-size: 0.65rem; color: var(--c-muted);
      padding: 0.25rem 0; display: inline-flex;
      align-items: center; gap: 0.25rem;
      font-family: 'Lexend', sans-serif;
      opacity: 0.7; transition: opacity 0.15s;
    }
    .source-toggle:hover { opacity: 1; }
    .source-toggle .arrow { transition: transform 0.2s; font-size: 0.5rem; }
    .source-body {
      max-height: 0; overflow: hidden;
      transition: max-height 0.3s ease;
      font-size: 0.65rem; color: var(--c-muted); line-height: 1.5;
    }
    .source-body.open { max-height: 200px; }

    /* ── Scenario list card ── */
    .scenario-row {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.875rem 1rem;
      background: var(--c-surface);
      border: 1.5px solid var(--c-border);
      border-radius: 0.875rem;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
    }
    .scenario-row:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .scenario-row.done { border-color: var(--c-success-border); }
    .scenario-row .sc-icon {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--c-bg); border: 1.5px solid var(--c-border);
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; flex-shrink: 0;
    }
    .scenario-row.done .sc-icon {
      background: var(--c-success-bg);
      border-color: var(--c-success-border);
    }
    .scenario-row .sc-title {
      flex: 1; min-width: 0;
      font-weight: 600; font-size: 0.88rem;
    }
    .scenario-row .sc-status {
      font-size: 0.68rem; font-weight: 700;
      padding: 0.2rem 0.5rem;
      border-radius: 999px; white-space: nowrap;
      flex-shrink: 0;
    }
    .scenario-row .sc-status.done {
      background: var(--c-success-bg); color: var(--c-success);
      border: 1px solid var(--c-success-border);
    }
    .scenario-row .sc-status.todo {
      background: var(--c-accent-light); color: var(--c-accent);
      border: 1px solid #f9c9b3;
    }

    /* ── Summary stat (Potrebné/Máte/Chýba) ── */
    .tracker-summary {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem; margin-bottom: 0.875rem;
    }
    .tracker-stat {
      background: rgba(255,255,255,0.7);
      border-radius: 0.625rem;
      padding: 0.5rem 0.625rem;
      text-align: center;
    }
    .tracker-stat-label {
      font-size: 0.62rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.04em;
      margin-bottom: 0.2rem; opacity: 0.8;
    }
    .tracker-stat-value {
      font-size: 0.95rem; font-weight: 800;
      line-height: 1.2;
    }
    .tracker-stat-unit {
      font-size: 0.62rem; opacity: 0.7;
      margin-top: 0.1rem;
    }

    /* ── Mobile grid fix for tracker forms ── */
    .tracker-form-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;
    }

    /* Desktop: sirens + radio grids expanded by default */
    @media (min-width: 641px) {
      #sirensCollapse .info-collapse-body,
      #radioCollapse .info-collapse-body {
        max-height: 1200px !important;
        padding: 0 0.875rem 0.75rem !important;
      }
      #sirensCollapse .info-collapse-arrow,
      #radioCollapse .info-collapse-arrow {
        transform: rotate(180deg);
      }
    }

    @media (max-width: 640px) {

      /* Tracker form: 3-col → 2+1 on mobile */
      .tracker-form-grid {
        grid-template-columns: 1fr 1fr !important;
      }
      .tracker-form-grid .tracker-form-full {
        grid-column: 1 / -1;
      }
      /* Summary stat: 3-col → stack on small phones */
      .tracker-summary {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 0.375rem;
      }
      .tracker-stat-value { font-size: 0.82rem; }

      /* Prvá pomoc */
      .fa-grid { grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
      .fa-icon { width: 44px; height: 44px; font-size: 1.25rem; }
      .fa-card { padding: 0.75rem 0.375rem; }
      .fa-card-label { font-size: 0.65rem; }

      /* Header */
      .app-header-inner {
        padding: 0 0.75rem !important;
        height: 48px !important;
      }
      .app-header-logo span {
        font-size: 0.9375rem !important;
      }
      .header-tabs { display: none; }

      /* Hlavný obsah */
      .app-main-padding {
        padding: 1rem 0.75rem !important;
      }

      /* Profile + Overall - stack na mobile */
      .top-row-grid {
        grid-template-columns: 1fr !important;
      }

      /* Kategórie - 2 stĺpce na mobile */
      .categories-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 0.5rem !important;
      }

      /* Plány - 1 stĺpec */
      .plans-grid {
        grid-template-columns: 1fr !important;
      }

      /* Profil karta - 2x2 grid */
      .profile-stats-grid {
        grid-template-columns: 1fr 1fr !important;
      }

      /* Buttons v header detail */
      .detail-header-row {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      /* Item riadky - tlačidlá menšie */
      .item-row {
        padding: 0.75rem 0.75rem !important;
      }

      /* Modal - full screen na mobile */
      .modal-box {
        border-radius: 1.25rem 1.25rem 0 0 !important;
        max-height: 92vh !important;
        margin-top: auto !important;
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        padding: 1.25rem 1rem !important;
      }
      /* Category modal items need breathing room on mobile */
      #categoryDetail {
        font-size: 0.88rem;
        line-height: 1.6;
      }
      #categoryDetail .item-row {
        padding: 0.75rem 0.625rem !important;
      }
      .modal-box::before {
        content: '';
        display: block;
        width: 36px;
        height: 4px;
        border-radius: 2px;
        background: var(--c-border);
        margin: 0 auto 0.75rem;
        opacity: 0.7;
      }
      .modal-overlay {
        align-items: flex-end !important;
        padding: 0 !important;
      }

      /* Profil modal - 3 stĺpce -> 1 stĺpec */
      .profile-3col {
        grid-template-columns: 1fr !important;
      }

      /* Osoby - 2x2 na mobile */
      .persons-grid {
        grid-template-columns: 1fr 1fr !important;
      }

      /* Dni + Bývanie - stack na mobile */
      .profile-days-housing {
        grid-template-columns: 1fr !important;
      }

      /* Water card grid */
      .water-info-grid {
        grid-template-columns: 1fr !important;
      }

      /* Cat card - menší padding */
      .cat-card {
        padding: 0.75rem !important;
      }

      /* Sync indicator - skryť text na mobile */
      .sync-label-text {
        display: none;
      }

      /* Celková pripravenosť - handled by hero banner */

      /* Item row tlačidlá - len ikony na mobile */
      .item-btn-edit { font-size: 0.75rem !important; padding: 0.375rem 0.5rem !important; }
      .item-btn-del { padding: 0.375rem 0.5rem !important; }

      /* Profil karta - full width water box */
      .profile-water-full { grid-column: 1 / -1 !important; }

      /* Výstraha sekcia */
      .alerts-header { flex-wrap: wrap; gap: 0.5rem; }

      /* Nadpis Kategórie */
      .cats-heading { font-size: 1.1rem !important; }

      /* Overall % číslo menšie */
      #overallPct { font-size: 1.6rem !important; }

      /* Plán karty - zmenšiť padding */
      .plan-card { padding: 0.875rem !important; }

      /* Na mobile - skryť desktop logout, zobraziť mobile verziu */
      #btnLogout { display: none !important; }
      .user-avatar { cursor: pointer; }
      .mobile-logout-btn { display: flex !important; }

      /* Osobné kontakty modal - telefónne polia na 1 stĺpec */
      #personalContactForm > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      /* Osobné kontakty modal - menší padding a scrollovateľný form */
      #modalPersonalContact .modal-box {
        padding: 1.25rem 1rem !important;
      }
    }
    /* Stredné obrazovky - tablet */
    @media (min-width: 641px) and (max-width: 900px) {
      .top-row-grid {
        grid-template-columns: 1fr 1fr !important;
      }
      .categories-grid {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      .profile-3col {
        grid-template-columns: 1fr 1fr !important;
      }
    }
    
    #userMenu.open { display: block !important; }
    /* Zavrieť menu pri kliknutí mimo */

    /* ═══════════════════════════════════════════
       TAB NAVIGÁCIA
    ═══════════════════════════════════════════ */
    .tab-bar {
      display: none; /* Tabs are now inside header on desktop/tablet */
    }
    .tab-bar-inner {
      display: none;
    }
    .tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.75rem 1.25rem;
      border: none;
      background: transparent;
      color: var(--c-muted);
      font-family: 'DM Sans', 'Lexend', sans-serif;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 0;
      transition: color 0.2s;
      white-space: nowrap;
      position: relative;
    }
    .tab-btn::after { display: none; }
    .tab-btn:hover {
      color: var(--c-text);
    }
    .tab-btn.active {
      color: var(--c-accent);
      background: transparent;
    }
    .tab-btn .tab-emoji { font-size: 0.9rem; }
    .tab-pane { display: none; }
    .tab-pane.active { display: grid; grid-template-columns: 1fr; gap: 1rem; }

    /* ═══════════════════════════════════════════
       HERO BANNER
    ═══════════════════════════════════════════ */
    .hero-banner {
      background: var(--c-surface);
      border: 1.5px solid var(--c-border);
      border-radius: 1.25rem;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 2px 8px rgba(26,23,20,0.06), 0 4px 16px rgba(26,23,20,0.04);
      position: relative;
      overflow: hidden;
    }
    .hero-banner::before {
      content: '';
      position: absolute;
      bottom: 0; right: 0;
      width: 320px; height: 80px;
      opacity: 0.04;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 80'%3E%3Cpath d='M0 80 L40 45 L65 60 L95 25 L115 40 L140 15 L160 30 L175 10 L190 30 L210 18 L230 35 L250 22 L270 40 L290 30 L310 50 L320 42 L320 80Z' fill='%231a1714'/%3E%3C/svg%3E") no-repeat bottom right;
      background-size: contain;
      pointer-events: none;
    }
    .hero-top {
      display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; margin-bottom: 0.75rem; position: relative; z-index: 1;
    }
    .hero-rank { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; font-size: 1.125rem; font-family: 'DM Sans', sans-serif; }
    .hero-pct { font-size: 1.75rem; font-weight: 800; font-family: 'DM Sans', sans-serif; letter-spacing: -0.03em; }
    .hero-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; position: relative; z-index: 1; }
    .hero-tag {
      display: inline-flex; align-items: center; gap: 0.25rem;
      background: var(--c-bg); border-radius: 0.5rem; padding: 0.25rem 0.625rem;
      font-size: 0.75rem; font-weight: 500; color: var(--c-muted);
      transition: background 0.15s;
    }
    .hero-tag:hover { background: #e8e4dd; }

    /* Slovak milestone messages (shown below progress) */
    .hero-milestone {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--c-muted);
      margin-top: 0.5rem;
      font-style: italic;
      position: relative; z-index: 1;
    }

    /* ═══════════════════════════════════════════
       ONBOARDING
    ═══════════════════════════════════════════ */
    .onboarding-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
      border: 2px solid #fcd34d; border-radius: 1.25rem;
      padding: 2rem 1.5rem; text-align: center;
    }
    .onboarding-card h2 { font-size: 1.5rem; font-weight: 800; color: #92400e; margin-bottom: 0.5rem; font-family: 'DM Sans', sans-serif; letter-spacing: -0.03em; }
    .onboarding-card p { color: #854d0e; font-size: 0.9rem; line-height: 1.6; margin-bottom: 1.5rem; }
    .onboarding-card .btn-primary { padding: 0.875rem 2rem; font-size: 1rem; background: #92400e; }
    .onboarding-card .btn-primary:hover { background: #78350f; }

    /* Procedure groups */
    .proc-group-heading {
      font-size: 0.78rem; font-weight: 700; color: var(--c-muted);
      text-transform: uppercase; letter-spacing: 0.05em;
      padding: 0.25rem 0; margin-top: 0.5rem; grid-column: 1 / -1;
    }
    .proc-group-heading:first-child { margin-top: 0; }

    .zone-intro { font-size: 0.85rem; color: var(--c-muted); line-height: 1.6; padding: 0.25rem 0 0.5rem; }

    /* ═══════════════════════════════════════════
       MOBILE BOTTOM NAV
    ═══════════════════════════════════════════ */
    .bottom-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--c-border);
      z-index: 50; padding: 0.25rem 0.5rem calc(0.25rem + env(safe-area-inset-bottom, 0px));
    }
    .bottom-nav .tab-btn {
      flex: 1;
      flex-direction: column; gap: 0.15rem; font-size: 0.6rem;
      padding: 0.4rem 0.125rem; border-radius: 0.75rem;
    }
    .bottom-nav .tab-btn::after { display: none; }
    .bottom-nav .tab-btn .tab-emoji { font-size: 1.125rem; }
    .bottom-nav .tab-btn.active {
      background: var(--c-accent-light); color: var(--c-accent);
    }

    /* ═══════════════════════════════════════════
       SOS FLOATING ACTION BUTTON
    ═══════════════════════════════════════════ */
    .sos-fab {
      display: none;
      position: fixed;
      z-index: 48;
      bottom: calc(72px + env(safe-area-inset-bottom, 0px));
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      border: 2.5px solid #fecaca;
      color: white;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.05rem;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.35), 0 2px 6px rgba(0,0,0,0.15);
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
      font-family: 'DM Sans', 'Lexend', sans-serif;
    }
    .sos-fab:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 24px rgba(220, 38, 38, 0.45), 0 4px 12px rgba(0,0,0,0.15);
    }
    .sos-fab:active { transform: scale(0.95); }
    .sos-fab-icon { font-size: 1.25rem; line-height: 1; }
    .sos-fab-label { font-size: 0.5rem; font-weight: 800; letter-spacing: 0.04em; line-height: 1; }

    /* ═══ Collapsible Info Panel ═══ */
    .info-collapse {
      border-radius: 0.75rem;
      overflow: hidden;
      transition: margin 0.2s;
    }
    .info-collapse-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 0.875rem;
      border: none;
      background: none;
      cursor: pointer;
      font-family: 'Lexend', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      line-height: 1.3;
      text-align: left;
      transition: opacity 0.15s;
    }
    .info-collapse-toggle:hover { opacity: 0.8; }
    .info-collapse-arrow {
      font-size: 0.6rem;
      transition: transform 0.25s;
      flex-shrink: 0;
      margin-left: auto;
    }
    .info-collapse-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0 0.875rem;
    }
    .info-collapse.open .info-collapse-body {
      max-height: 1200px;
      padding: 0 0.875rem 0.75rem;
    }
    .info-collapse.open .info-collapse-arrow {
      transform: rotate(180deg);
    }

    @media (max-width: 640px) {
      .app-header { border-bottom: 1px solid var(--c-border); }
      .tab-bar.top-tabs { display: none !important; }
      .bottom-nav { display: flex; gap: 0.125rem; }
      .sos-fab { display: flex; }
      .app-main-padding { padding-bottom: 80px !important; }
      .hero-pct { font-size: 1.5rem !important; }
      .hero-rank { font-size: 1rem !important; }
      .hero-banner { padding: 1rem !important; }
      .hero-meta { gap: 0.375rem !important; }
      .hero-tag { font-size: 0.68rem !important; padding: 0.2rem 0.5rem !important; }
    }
    @media (min-width: 641px) {
      .sos-fab {
        display: flex;
        bottom: 1.5rem;
        right: 1.5rem;
      }
    }

    @media (min-width: 641px) and (max-width: 900px) {
      .header-tab-btn { font-size: 0.72rem; padding: 0.3rem 0.625rem; }
      .header-tab-btn .tab-emoji { font-size: 0.75rem; }
    }

    /* ═══════════════════════════════════════════
       DÔLEŽITÉ KONTAKTY & VAROVNÉ SIGNÁLY
    ═══════════════════════════════════════════ */
    .ec-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.625rem;
    }
    .ec-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem 0.625rem;
      border-radius: 1rem;
      background: var(--c-surface);
      border: 1.5px solid var(--c-border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      text-decoration: none;
      color: var(--c-text);
      transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.2s, border-color 0.2s;
      cursor: pointer;
    }
    .ec-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
    }
    .ec-card:active { transform: translateY(-1px); }
    .ec-icon {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.375rem;
      margin-bottom: 0.5rem;
      flex-shrink: 0;
    }
    .ec-card-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--c-text);
      line-height: 1.3;
    }
    .ec-card-number {
      font-size: 1rem;
      font-weight: 800;
      margin-top: 0.2rem;
      letter-spacing: -0.01em;
    }

    /* Sirény - vizualizácia */
    .siren-card {
      background: var(--c-surface);
      border: 1.5px solid var(--c-border);
      border-radius: 1rem;
      padding: 1rem;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.2s, border-color 0.2s;
    }
    .siren-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      border-color: var(--c-accent);
    }
    .siren-wave {
      height: 28px;
      border-radius: 0.375rem;
      overflow: hidden;
      position: relative;
      margin-top: 0.5rem;
    }
    .siren-wave-bar {
      position: absolute;
      bottom: 0;
      width: 3px;
      border-radius: 2px;
      animation: sirenPulse 1.5s ease-in-out infinite;
    }
    @keyframes sirenPulse {
      0%, 100% { transform: scaleY(0.3); }
      50% { transform: scaleY(1); }
    }
    .siren-wave-steady .siren-wave-bar {
      animation: sirenSteady 2s ease-in-out infinite;
    }
    @keyframes sirenSteady {
      0%, 100% { transform: scaleY(0.85); }
      50% { transform: scaleY(1); }
    }

    /* Postupy pri MU */
    .mu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.75rem;
    }
    .mu-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem 0.5rem;
      border-radius: 1rem;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.2s, border-color 0.15s;
      background: var(--c-surface);
      border: 1.5px solid var(--c-border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .mu-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.10);
      border-color: var(--c-accent);
    }
    .mu-card:active { transform: translateY(-1px); }
    .mu-icon {
      width: 52px; height: 52px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      flex-shrink: 0;
    }
    .mu-card-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--c-text);
      line-height: 1.3;
    }

    @media (max-width: 640px) {
      .ec-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
      .ec-icon { width: 40px; height: 40px; font-size: 1.125rem; }
      .ec-card { padding: 0.75rem 0.375rem; }
      .ec-card-label { font-size: 0.65rem; }
      .ec-card-number { font-size: 0.85rem; }
      .mu-grid { grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
      .mu-icon { width: 44px; height: 44px; font-size: 1.25rem; }
      .mu-card { padding: 0.75rem 0.375rem; }
      .mu-card-label { font-size: 0.65rem; }
    }

    /* ═══════════════════════════════════════════
       COOKIE BANNER
    ═══════════════════════════════════════════ */
    .cookie-banner {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 9999;
      background: #1a1612;
      color: rgba(255,255,255,0.85);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 1rem 1.5rem;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .cookie-banner.show { transform: none; }
    .cookie-banner-inner {
      max-width: 640px; margin: 0 auto;
      display: flex; align-items: center; gap: 1rem;
      flex-wrap: wrap;
    }
    .cookie-banner-text {
      flex: 1; min-width: 220px;
      font-size: 0.78rem; font-weight: 300; line-height: 1.6;
      font-family: 'DM Sans', 'Lexend', sans-serif;
    }
    .cookie-banner-text a { color: #c94f1a; text-decoration: underline; }
    .cookie-banner-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
    .cookie-btn {
      font-family: 'DM Sans', 'Lexend', sans-serif;
      font-size: 0.78rem; font-weight: 600;
      padding: 0.5rem 1.125rem;
      border-radius: 99px;
      cursor: pointer; border: none;
      transition: all 0.2s;
    }
    .cookie-btn-accept {
      background: #c94f1a; color: #fff;
    }
    .cookie-btn-accept:hover { background: #b5441a; }
    .cookie-btn-info {
      background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.12);
      text-decoration: none; display: inline-flex; align-items: center;
    }
    .cookie-btn-info:hover { background: rgba(255,255,255,0.15); color: #fff; }
    @media (max-width: 640px) {
      .cookie-banner { padding: 0.875rem 1rem; }
      .cookie-banner-text { font-size: 0.72rem; min-width: 100%; }
      .cookie-banner-actions { width: 100%; }
      .cookie-btn { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>

<!-- Skip to content (accessibility) -->
<a href="#appMain" class="skip-link" id="skipLink">Preskočiť na obsah</a>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <h1 style="font-size:1.75rem; font-weight:800; margin-bottom:0.5rem; letter-spacing:-0.03em; font-family:'DM Sans','Lexend',sans-serif;">Gerlach</h1>
    <p style="color:var(--c-muted); font-size:0.9rem; margin-bottom:2rem; line-height:1.6;">
      Pomáha domácnostiam na Slovensku<br>pripraviť sa na krízové situácie.
    </p>
    <button class="btn-google" id="btnGoogleLogin">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Pokračovať cez Google
    </button>
    <div style="text-align:center; margin-top:0.5rem; font-size:0.7rem; color:var(--c-muted); line-height:1.4;">
      údaje sa uložia do vášho účtu a budú dostupné na každom zariadení
    </div>

    <div style="display:flex; align-items:center; gap:0.75rem; margin-top:1rem;">
      <div style="flex:1; height:1px; background:var(--c-border);"></div>
      <span style="font-size:0.75rem; color:var(--c-muted); font-weight:400;">alebo</span>
      <div style="flex:1; height:1px; background:var(--c-border);"></div>
    </div>

    <button class="btn-google" id="btnDemoLogin" style="margin-top:1rem; border-color:#f59e0b; background:#fffbeb;">
      🔍 Vyskúšať demo
    </button>
    <div style="text-align:center; margin-top:0.5rem; font-size:0.7rem; color:var(--c-muted); line-height:1.4;">
      dáta sa vymažú po zatvorení prehliadača
    </div>

    <div id="loginError" style="margin-top:1rem; color:#991b1b; font-size:0.85rem; display:none;"></div>
  </div>
  <p style="margin-top:1.5rem; font-size:0.75rem; color:var(--c-muted);">
    Gerlach © <span class="js-year"></span> – Zadarmo pre verejnosť
  </p>
  <p style="margin-top:0.375rem; font-size:0.65rem; color:var(--c-muted);">
    <a href="./pravne-info.html" style="color:var(--c-muted); text-decoration:underline; text-underline-offset:2px;">Podmienky používania</a>
    &nbsp;·&nbsp;
    <a href="./pravne-info.html#ochrana-udajov" style="color:var(--c-muted); text-decoration:underline; text-underline-offset:2px;">Ochrana údajov</a>
  </p>
</div>

<!-- REGISTRATION CLOSED SCREEN -->
<div id="closedScreen" style="display:none;" class="login-screen">
    <h1 style="font-size:1.5rem; font-weight:800; margin-bottom:0.5rem;">Registrácia uzavretá</h1>
    <p style="color:var(--c-muted); font-size:0.9rem; line-height:1.6;">
      Momentálne sme dosiahli maximálny počet používateľov v beta verzii. Skús to znova neskôr.
    </p>
</div>

<!-- MAIN APP -->
<div id="appScreen" style="display:none;">

  <!-- Demo banner: viditeľný len v demo režime -->
  <div class="demo-banner" id="demoBanner" role="alert">
    <span>🔍 <strong>Demo režim</strong> — skúšate si Gerlach bez registrácie. Všetko funguje rovnako, iba dáta sa uložia len do prehliadača (zmažú sa po zatvorení karty v prehliadači).</span>
    <a href="#" id="demoBannerCreateAccount">Vytvoriť účet zadarmo</a>
  </div>

  <!-- Header -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="app-header-logo">
        <span style="font-family:'DM Sans','Lexend',sans-serif; font-weight:700; font-size:1rem; letter-spacing:-0.02em; cursor:pointer;" id="headerLogo" title="Gerlach">Gerlach</span>
        <span class="version-badge beta" id="versionBadge" style="font-size:0.55rem; padding:0.1rem 0.4rem;">Beta</span>
      </div>

      <!-- Segment tabs (desktop/tablet only, hidden on mobile via CSS) -->
      <nav class="header-tabs" id="headerTabs" aria-label="Hlavná navigácia">
        <button class="header-tab-btn active" data-tab="preparation" onclick="switchTab('preparation')">
          <span class="tab-emoji">🎒</span> Príprava
        </button>
        <button class="header-tab-btn" data-tab="plan" onclick="switchTab('plan')">
          <span class="tab-emoji">📋</span> Plán
        </button>
        <button class="header-tab-btn" data-tab="knowledge" onclick="switchTab('knowledge')">
          <span class="tab-emoji">📖</span> Vedomosti
        </button>
        <button class="header-tab-btn" data-tab="contacts" onclick="switchTab('contacts')">
          <span class="tab-emoji">📞</span> Kontakty
        </button>
      </nav>

      <div style="display:flex; align-items:center; gap:0.75rem;">
        <span class="sync-indicator">
          <span class="sync-dot" id="syncDot"></span>
          <span id="syncLabel" class="sync-label-text">–</span>
        </span>
        <div style="display:flex; align-items:center; gap:0.5rem; position:relative;">
          <div class="user-avatar" id="userAvatar" onclick="document.getElementById('userMenu').classList.toggle('open')" style="cursor:pointer;">?</div>
          <button class="btn-ghost" id="btnLogout" style="padding:0.3rem 0.625rem; font-size:0.78rem;">Odhlásiť</button>
          <button class="mobile-logout-btn" onclick="document.getElementById('btnLogout').click();" style="display:none; background:none; border:1px solid var(--c-border); border-radius:0.5rem; padding:0.375rem 0.75rem; font-size:0.875rem; cursor:pointer; color:var(--c-muted); font-family:'Lexend',sans-serif; align-items:center; gap:0.375rem; font-weight:500;">Odhlásiť</button>
          <!-- Mobile user menu -->
          <div id="userMenu" style="display:none; position:absolute; top:calc(100% + 8px); right:0; background:white; border:1.5px solid var(--c-border); border-radius:0.875rem; padding:0.5rem; min-width:160px; box-shadow:0 8px 24px rgba(0,0,0,0.12); z-index:200;">
            <div id="userMenuName" style="font-size:0.8rem; font-weight:600; padding:0.5rem 0.75rem; color:var(--c-muted); border-bottom:1px solid var(--c-border); margin-bottom:0.375rem;"></div>
            <button onclick="document.getElementById('userMenu').classList.remove('open'); document.getElementById('btnLogout').click();" style="width:100%; text-align:left; background:none; border:none; padding:0.5rem 0.75rem; font-size:0.875rem; cursor:pointer; border-radius:0.625rem; color:#dc2626; font-family:'Lexend',sans-serif; font-weight:500;">
              🚪 Odhlásiť sa
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Tab Bar (kept for backwards compat, hidden on desktop via CSS) -->
  <div class="tab-bar top-tabs" style="position:sticky; top:48px; z-index:49;">
    <div class="tab-bar-inner">
    <button class="tab-btn active" data-tab="preparation" onclick="switchTab('preparation')">
      <span class="tab-emoji">🎒</span> Príprava
    </button>
    <button class="tab-btn" data-tab="plan" onclick="switchTab('plan')">
      <span class="tab-emoji">📋</span> Plán
    </button>
    <button class="tab-btn" data-tab="knowledge" onclick="switchTab('knowledge')">
      <span class="tab-emoji">📖</span> Vedomosti
    </button>
    <button class="tab-btn" data-tab="contacts" onclick="switchTab('contacts')">
      <span class="tab-emoji">📞</span> Kontakty
    </button>
    </div>
  </div>

  <div class="app-main-padding" id="appMain" style="max-width:1100px; margin:0 auto; padding:1.5rem 1rem;">

    <!-- ═══════════════ TAB A: MOJA PRÍPRAVA ═══════════════ -->
    <div class="tab-pane active" id="tabPreparation">

      <!-- Hero Banner (merged profile + progress) -->
      <div class="hero-banner" id="heroBanner"></div>

      <!-- Onboarding (for new users without profile) -->
      <div id="onboardingCard" style="display:none;">
        <div class="onboarding-card">
          <div style="font-size:3rem; margin-bottom:1rem;">🏔️</div>
          <h2>Vitajte v Gerlachu</h2>
          <p>Začneme tým, že si nastavíme váš profil domácnosti.<br>Podľa neho vypočítame, čo presne potrebujete pripraviť.</p>
          <button class="btn-primary" onclick="openProfileEditor()">Nastaviť domácnosť →</button>
        </div>
      </div>

      <!-- Alerts -->
      <div class="card" id="alertsSection" style="display:none;">
        <h2 style="font-size:1rem; font-weight:700; margin-bottom:0.25rem;">⚠️ Upozornenia</h2>
        <p style="font-size:0.75rem; color:var(--c-muted); margin-bottom:0.75rem;">Čo sa blíži a oplatí sa riešiť teraz</p>
        <div id="alertsBox"></div>
      </div>

      <!-- Categories Grid -->
      <div id="onboardingTip" style="display:none; margin-bottom:0.75rem;">
        <div style="background:linear-gradient(135deg, #ecfdf5, #d1fae5); border:1.5px solid #6ee7b7; border-radius:1rem; padding:1rem 1.25rem; display:flex; align-items:center; gap:0.875rem; animation:tipSlideIn 0.4s ease-out; cursor:pointer;" onclick="this.parentElement.style.display='none'">
          <span style="font-size:1.5rem; flex-shrink:0;">🎯</span>
          <div>
            <div style="font-size:0.85rem; font-weight:700; color:#065f46; line-height:1.3;">Výborne! Profil je nastavený.</div>
            <div style="font-size:0.75rem; color:#047857; margin-top:0.2rem; line-height:1.4;">Teraz kliknite na ľubovoľnú kategóriu nižšie a začnite pridávať položky. Začnite tam, kde vám to dáva najväčší zmysel.</div>
          </div>
          <span style="font-size:0.7rem; color:#6ee7b7; flex-shrink:0;">✕</span>
        </div>
      </div>
      <div id="categoriesSection">
        <h2 class="cats-heading" style="font-family:'Lexend',sans-serif; font-weight:700; font-size:1.275rem; margin-bottom:0.25rem;">Čo mať doma pripravené?</h2>
        <p style="font-size:0.78rem; color:var(--c-muted); margin-bottom:0.75rem; line-height:1.4;">Nakupujte postupne, odškrtávajte priebežne.</p>
        <div id="categoriesGrid" class="categories-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:0.75rem;"></div>
      </div>

    </div><!-- end tabPreparation -->

    <!-- ═══════════════ TAB B: PLÁN ═══════════════ -->
    <div class="tab-pane" id="tabPlan">

      
      <!-- Evakuačné batohy -->
      <div class="card" id="evacBagsSection">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:0.875rem; flex-wrap:wrap; gap:0.5rem;">
          <div>
            <h2 style="font-size:1.2rem; font-weight:700;">🎒 Evakuačné batohy</h2>
            <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Osobný evakuačný batoh pre každého člena domácnosti – pripravený a skontrolovaný</p>
          </div>
          <button class="btn-ghost" id="btnRegenBags" style="font-size:0.72rem; padding:0.3rem 0.6rem; display:none;">🔄 Pregenerovať</button>
        </div>
        <div id="evacBagsContainer"></div>
      </div>

      <!-- Rodinný krízový plán -->
      <div class="card">
        <div style="margin-bottom:1rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">📋 Rodinný krízový plán</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Dohodnite sa vopred. Keď vypadne signál a internet, budete vedieť čo robiť a kde sa nájsť.</p>
        </div>
        <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:1rem;">
          <button class="info-collapse-toggle" style="color:#991b1b;" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>💡 Prečo potrebujete krízový plán</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-text); line-height:1.6;">
            Mobilná sieť je preťažená do <strong>15–30 minút</strong> od začiatku krízy. Bez plánu sa rodina nemusí nájsť. <strong>Vytlačte</strong> a dajte kópiu každému členovi rodiny.
          </div>
        </div>
        <div id="meetingPointBox"></div>
        <div style="margin-top:1rem;">
          <div class="section-label">Krízové scenáre – kto, čo, kam?</div>
          <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:0.75rem;">
            <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
              <span>💡 Ako pracovať so scenármi</span>
              <span class="info-collapse-arrow">▼</span>
            </button>
            <div class="info-collapse-body" style="font-size:0.75rem; color:var(--c-muted); line-height:1.6;">
              Prejdite si každý scenár a doplňte konkrétne mená, miesta a úlohy. Krízový plán funguje len ak ho <strong>poznajú všetci členovia rodiny</strong> – vrátane detí od 6 rokov. Ideálne si plán <strong>raz za rok precvičte</strong> (napr. pri skúške sirén).
            </div>
          </div>
          <div id="scenariosBox" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
        </div>
        <div class="info-collapse" style="background:#eff6ff; border:1px solid #bfdbfe; margin-top:1rem;">
          <button class="info-collapse-toggle" style="color:#1e40af;" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>📱 Komunikačný plán (ak telefóny nefungujú)</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-text); line-height:1.7;">
            <p style="margin:0 0 0.375rem;"><strong>1)</strong> Pošlite <strong>SMS</strong> – prechádza aj pri slabom signáli, keď hovory neprechádzajú.</p>
            <p style="margin:0 0 0.375rem;"><strong>2)</strong> Vyberte si <strong>jednu osobu v inom meste</strong> (príbuzný, kamarát), ktorej sa každý člen rodiny ozve – slúži ako „ústredňa” keď sa nemôžete spojiť priamo.</p>
            <p style="margin:0 0 0.375rem;"><strong>3)</strong> Nechajte <strong>lístok na dverách</strong> s informáciou kedy a kam ste odišli.</p>
            <p style="margin:0 0 0.375rem;"><strong>4)</strong> Stretávajte sa na <strong>dohodnutom mieste</strong> – pravidlo: počkaj 30 min, príď znova o interval.</p>
            <p style="margin:0;"><strong>5)</strong> Ak máte internet – <strong>Google crisis response</strong>, sociálne siete (status „som v bezpečí”).</p>
          </div>
        </div>
      </div>


    </div><!-- end tabPlan -->

    <!-- ═══════════════ TAB C: VEDOMOSTI ═══════════════ -->
    <div class="tab-pane" id="tabKnowledge">

      
      <!-- Prvá pomoc -->
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.875rem; flex-wrap:wrap; gap:0.5rem;">
          <div>
            <h2 style="font-size:1.2rem; font-weight:700;">🏥 Prvá pomoc</h2>
            <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Základné postupy prvej pomoci, keď ide o minúty</p>
          </div>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <a href="tel:112" style="display:inline-flex; align-items:center; gap:0.375rem; background:#dc2626; color:white; border-radius:0.625rem; padding:0.4rem 0.75rem; font-size:0.78rem; font-weight:700; text-decoration:none; font-family:'Lexend',sans-serif;">📞 112</a>
            <a href="tel:155" style="display:inline-flex; align-items:center; gap:0.375rem; background:#1e40af; color:white; border-radius:0.625rem; padding:0.4rem 0.75rem; font-size:0.78rem; font-weight:700; text-decoration:none; font-family:'Lexend',sans-serif;">🚑 155</a>
          </div>
        </div>
        <div id="firstAidGrid" class="fa-grid"></div>
      </div>

      <!-- Postupy pri MU -->
      <!-- Prírodné hrozby -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">🌊 Prírodné hrozby</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Čo robiť pri povodniach, zemetrasení, búrkach a ďalších živloch</p>
        </div>
        <div id="procGridNature" class="mu-grid"></div>
      </div>

      <!-- Havárie a ohrozenia -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">🔥 Havárie a ohrozenia</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Požiare, výpadky, úniky plynu, chemické a radiačné havárie</p>
        </div>
        <div id="procGridHazards" class="mu-grid"></div>
      </div>

      <!-- Ozbrojený konflikt -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">⚔️ Ozbrojený konflikt</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Teroristický útok a vojenský konflikt – ako sa chrániť</p>
        </div>
        <div id="procGridConflict" class="mu-grid"></div>
      </div>

      <!-- Pripravenosť a podpora -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">🛡️ Pripravenosť a podpora</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">72-hodinová sebestačnosť, evakuácia, pomoc susedom, deti v kríze</p>
        </div>
        <div id="procGridSupport" class="mu-grid"></div>
      </div>

      <!-- Varovné signály sirén -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">🔔 Varovné signály sirén</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Rozoznajte signály, pochopte ich význam a vedzte čo robiť</p>
        </div>
        <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:0.75rem;">
          <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>💡 Čo robiť keď zaznie siréna</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-text); line-height:1.6;">
            Ak zaznie siréna a nie je oznámená skúška – berte to vážne. Vojdite do budovy a zapnite rádio.
          </div>
        </div>
        <div class="info-collapse" id="sirensCollapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:0.5rem;">
          <button class="info-collapse-toggle" style="color:var(--c-text);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>🔔 Typy signálov (kliknutím rozbaľte)</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body">
            <div id="sirensGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:0.625rem;"></div>
          </div>
        </div>
        <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-top:0.75rem;">
          <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>💡 Skúška sirén a ďalšie informácie</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-muted); line-height:1.6;">
            <p style="margin:0 0 0.5rem;"><strong style="color:var(--c-text);">Skúška sirén:</strong> Každý <strong>druhý piatok v mesiaci o 12:00</strong> prebieha pravidelná skúška (2 min stály tón). O skúškach informujú vopred médiá. Ak počujete sirénu mimo tohto termínu – <strong>nie je to skúška</strong>.</p>
            <p style="margin:0; font-size:0.72rem;">Rozoznajte typ tónu: kolísavý = všeobecné ohrozenie, stály = koniec ohrozenia. Pri kolísavom tóne vojdite do budovy, zatvorte okná, zapnite rádio.</p>
          </div>
        </div>
      </div>

      <!-- Núdzové vysielanie rádia -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">📻 Núdzové vysielanie rádia</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Frekvencie pre príjem krízových informácií – fungujú aj bez internetu a mobilnej siete</p>
        </div>
        <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:0.75rem;">
          <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>💡 Prečo rádio na batérie</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-text); line-height:1.6;">
            Pri výpadku elektriny a internetu je FM rádio na batérie jediný spoľahlivý zdroj informácií. <strong>Rádio na batérie patrí do každej domácnosti.</strong>
          </div>
        </div>
        <div class="info-collapse" id="radioCollapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:0.5rem;">
          <button class="info-collapse-toggle" style="color:var(--c-text);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>📻 Frekvencie podľa regiónov (kliknutím rozbaľte)</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body">
            <div id="radioGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:0.625rem;"></div>
          </div>
        </div>
        <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-top:0.75rem;">
          <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>💡 Tipy pre núdzové rádio</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-text); line-height:1.6;">
            <p style="margin:0 0 0.5rem;">Zapíšte si frekvenciu pre váš región na papier a vložte ho k rádiu na batérie. V krízovej situácii nemusíte nič hľadať.</p>
            <p style="margin:0;"><strong>Rádio Slovensko</strong> a <strong>Rádio Regina</strong> sú prioritné stanice pre núdzové hlásenia podľa Zákona o civilnej ochrane. Mobilná sieť a internet môžu zlyhať – rádio vysiela vždy.</p>
          </div>
        </div>
      </div>

    </div><!-- end tabKnowledge -->

    <!-- ═══════════════ TAB D: KONTAKTY ═══════════════ -->
    <div class="tab-pane" id="tabContacts">

      <!-- Tiesňové linky (6 hlavných) -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">📞 Tiesňové kontakty</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Tiesňové linky SR – fungujú aj bez kreditu</p>
        </div>
        <div class="ec-grid" id="emergencyLinesGrid"></div>
      </div>

      <!-- Inštitúcie, krízové linky a poruchové služby -->
      <div class="card">
        <div style="margin-bottom:0.875rem;">
          <h2 style="font-size:1.2rem; font-weight:700;">🏛️ Inštitúcie, krízové linky a poruchové služby</h2>
          <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Kliknite na kategóriu pre zobrazenie kontaktov</p>
        </div>
        <div id="institutionsGrid" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
      </div>

      <!-- Osobné kontakty -->
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.875rem; flex-wrap:wrap; gap:0.5rem;">
          <div>
            <h2 style="font-size:1.2rem; font-weight:700;">👤 Osobné kontakty</h2>
            <p style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">Lekári, poisťovne, služby a ľudia, na ktorých sa spoľahnete</p>
          </div>
          <button class="btn-ghost" id="btnAddPersonalContact" style="font-size:0.78rem; padding:0.375rem 0.75rem;">+ Pridať kontakt</button>
        </div>
        <div id="personalContactsGrid" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
      </div>

    </div><!-- end tabContacts -->

  </div><!-- end app-main-padding -->

  <!-- Bottom Nav (Mobile) -->
  <div class="bottom-nav" id="bottomNav">
    <button class="tab-btn active" data-tab="preparation" onclick="switchTab('preparation')">
      <span class="tab-emoji">🎒</span> Príprava
    </button>
    <button class="tab-btn" data-tab="plan" onclick="switchTab('plan')">
      <span class="tab-emoji">📋</span> Plán
    </button>
    <button class="tab-btn" data-tab="knowledge" onclick="switchTab('knowledge')">
      <span class="tab-emoji">📖</span> Vedomosti
    </button>
    <button class="tab-btn" data-tab="contacts" onclick="switchTab('contacts')">
      <span class="tab-emoji">📞</span> Kontakty
    </button>
  </div>

  <!-- SOS Floating Button (quick access to First Aid) -->
  <button class="sos-fab" id="sosFab" onclick="switchTab('knowledge'); setTimeout(() => { const fa = document.getElementById('firstAidGrid'); if(fa) fa.scrollIntoView({behavior:'smooth', block:'start'}); }, 150);" aria-label="SOS – Prvá pomoc">
    <span class="sos-fab-icon">🆘</span>
  </button>

</div><!-- end appScreen -->

<!-- Modal: EmailJS technická konfigurácia -->
<div class="modal-overlay" id="modalEmailJSInfo">
  <div class="modal-box" style="max-width:420px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
      <h3 style="font-family:'Lexend',sans-serif; font-weight:700; font-size:1rem;">⚙️ Technická poznámka pre správcu</h3>
      <button data-close="modalEmailJSInfo" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem;">✕</button>
    </div>
    <div style="font-size:0.8rem; color:var(--c-muted); line-height:1.6;">
      <p style="margin-bottom:0.5rem;">Emailové pripomienky využívajú službu <strong>EmailJS</strong>. Pre aktiváciu je potrebné nastaviť konfiguráciu:</p>
      <div style="background:var(--c-bg); border-radius:0.5rem; padding:0.75rem; margin:0.5rem 0; font-family:monospace; font-size:0.72rem; line-height:1.5;">
        publicKey: "S9KjZEwsiiUC69fX-XqbK"<br>
        serviceId: "service_h4jkdfs"
      </div>
      <p style="margin-top:0.5rem;">Email sa odosiela max 1× za 24 hodín. Upozornenia na expiráciu podľa nastavení sledovania + nákupný zoznam (14 dní pred).</p>
    </div>
  </div>
</div>

<!-- Modal: Profile -->
<div class="modal-overlay" id="modalProfile">
  <div class="modal-box" style="max-width:640px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
      <div>
        <h3 style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.25rem; margin:0;">Vaša domácnosť</h3>
        <p style="font-size:0.8rem; color:var(--c-muted); margin:0.25rem 0 0;">Podľa týchto údajov vypočítame, čo má pre vašu domácnosť zmysel pripraviť.</p>
      </div>
      <button data-close="modalProfile" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem; flex-shrink:0; margin-left:1rem;">✕</button>
    </div>

    <form id="profileForm" style="display:grid; gap:1rem;">

      <!-- ── ZÁKLADNÉ NASTAVENIA ── -->

      <!-- Počet osôb -->
      <div class="card-section">
        <div style="font-size:0.8rem; font-weight:700; color:var(--c-text); margin-bottom:0.75rem;">👨‍👩‍👧‍👦 Počet osôb v domácnosti</div>
        <div class="persons-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:0.625rem;">
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.3rem; white-space:nowrap;">Dospelí (13–64)</label>
            <input name="adults" type="number" min="0" value="0"
              onfocus="if(this.value==='0')this.value=''"
              onblur="if(this.value==='')this.value='0'" style="text-align:center; font-weight:600; font-size:0.9rem;" />
          </div>
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.3rem; white-space:nowrap;">Deti (1–12)</label>
            <input name="kids" type="number" min="0" value="0"
              onfocus="if(this.value==='0')this.value=''"
              onblur="if(this.value==='')this.value='0'" style="text-align:center; font-weight:600; font-size:0.9rem;" />
          </div>
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.3rem; white-space:nowrap;">Dojčatá (0–1)</label>
            <input name="infants" type="number" min="0" value="0"
              onfocus="if(this.value==='0')this.value=''"
              onblur="if(this.value==='')this.value='0'" style="text-align:center; font-weight:600; font-size:0.9rem;" />
          </div>
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.3rem; white-space:nowrap;">Seniori (65+)</label>
            <input name="seniors" type="number" min="0" value="0"
              onfocus="if(this.value==='0')this.value=''"
              onblur="if(this.value==='')this.value='0'" style="text-align:center; font-weight:600; font-size:0.9rem;" />
          </div>
        </div>
      </div>

      <!-- Počet dní + Typ bývania -->
      <div class="profile-days-housing" style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; align-items:start;">
        <!-- Počet dní sebestačnosti -->
        <div class="prepdays-row" class="card-section">
          <div style="font-size:0.8rem; font-weight:700; color:var(--c-text);">📅 Počet dní sebestačnosti</div>
          <div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.2rem; margin-bottom:0.75rem; line-height:1.4;">Minimum 3 dni. Pre väčší pocit istoty odporúčame 7 dní.</div>
          <input name="prepDays" type="number" min="1" max="30" value="3"
            onfocus="if(this.value==='3' && !this._touched)this.value=''"
            onblur="if(this.value===''){this.value='3'} this._touched=true;"
            style="width:100%; text-align:center; font-weight:600; font-size:0.9rem;" />
        </div>

        <!-- Typ bývania -->
        <div class="card-section">
          <div style="font-size:0.8rem; font-weight:700; color:var(--c-text); margin-bottom:0.2rem;">🏠 Typ bývania</div>
          <div style="font-size:0.72rem; color:var(--c-muted); margin-bottom:0.75rem; line-height:1.4;">Ovplyvňuje niektoré odporúčania.</div>
          <div style="display:flex; flex-direction:column; gap:0.5rem;">
            <label style="display:flex; align-items:center; gap:0.625rem; padding:0.5rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
              <input type="radio" name="housing" value="flat" style="accent-color:var(--c-accent); flex-shrink:0;" />
              <div style="font-size:0.78rem; font-weight:600; line-height:1.3;">Byt <span style="font-weight:400; color:var(--c-muted);">– panelák / bytovka</span></div>
            </label>
            <label style="display:flex; align-items:center; gap:0.625rem; padding:0.5rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
              <input type="radio" name="housing" value="rd" style="accent-color:var(--c-accent); flex-shrink:0;" />
              <div style="font-size:0.78rem; font-weight:600; line-height:1.3;">Rodinný dom</div>
            </label>
            <label style="display:flex; align-items:center; gap:0.625rem; padding:0.5rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
              <input type="radio" name="housing" value="rd_cellar" style="accent-color:var(--c-accent); flex-shrink:0;" />
              <div style="font-size:0.78rem; font-weight:600; line-height:1.3;">RD + pivnica <span style="font-weight:400; color:var(--c-muted);">/ garáž</span></div>
            </label>
          </div>
        </div>
      </div>

      <!-- ── POKROČILÉ NASTAVENIA (collapsible) ── -->
      <div id="profileAdvanced">
        <button type="button" id="profileAdvancedToggle" style="width:100%; display:flex; align-items:center; justify-content:space-between; background:none; border:1.5px solid var(--c-border); border-radius:0.875rem; padding:0.75rem 1rem; cursor:pointer; font-family:'Lexend',sans-serif; font-size:0.82rem; font-weight:600; color:var(--c-muted); transition:background 0.15s, border-color 0.15s;" onmouseover="this.style.background='var(--c-bg)'" onmouseout="this.style.background='none'">
          <span>⚙️ Pokročilé nastavenia</span>
          <span id="profileAdvancedArrow" style="font-size:0.7rem; transition:transform 0.25s;">▼</span>
        </button>
        <div id="profileAdvancedContent" style="display:none; margin-top:0.75rem; gap:0.75rem;">

          <!-- Úroveň + Nákladovosť -->
          <div class="profile-3col" style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; align-items:start;">
            <!-- Úroveň pripravenosti -->
            <div class="card-section">
              <div style="font-size:0.8rem; font-weight:700; color:var(--c-text); margin-bottom:0.2rem;">🛡️ Úroveň zásob</div>
              <div style="font-size:0.72rem; color:var(--c-muted); margin-bottom:0.75rem; line-height:1.4;">Určuje výsledný komfort v čase krízy.</div>
              <div style="display:flex; flex-direction:column; gap:0.5rem;">
                <label style="display:flex; align-items:center; gap:0.625rem; padding:0.625rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
                  <input type="radio" name="readiness" value="standard" style="accent-color:var(--c-accent); flex-shrink:0;" />
                  <div>
                    <div style="font-size:0.8rem; font-weight:600; line-height:1.2;">Odporúčaná</div>
                    <div style="font-size:0.7rem; color:var(--c-muted);">Podľa príručiek</div>
                  </div>
                </label>
                <label style="display:flex; align-items:center; gap:0.625rem; padding:0.625rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
                  <input type="radio" name="readiness" value="enhanced" style="accent-color:var(--c-accent); flex-shrink:0;" />
                  <div>
                    <div style="font-size:0.8rem; font-weight:600; line-height:1.2;">Zvýšená</div>
                    <div style="font-size:0.7rem; color:var(--c-muted);">+30% viac zásob</div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Nákladovosť -->
            <div class="card-section">
              <div style="font-size:0.8rem; font-weight:700; color:var(--c-text); margin-bottom:0.2rem;">💰 Nákladovosť</div>
              <div style="font-size:0.72rem; color:var(--c-muted); margin-bottom:0.75rem; line-height:1.4;">Cenová kategória odporúčaných produktov.</div>
              <div style="display:flex; flex-direction:column; gap:0.5rem;">
                <label style="display:flex; align-items:center; gap:0.625rem; padding:0.625rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
                  <input type="radio" name="budget" value="mid" style="accent-color:var(--c-accent); flex-shrink:0;" />
                  <div>
                    <div style="font-size:0.8rem; font-weight:600; line-height:1.2;">Základná</div>
                    <div style="font-size:0.7rem; color:var(--c-muted);">Kvalita za rozumnú cenu</div>
                  </div>
                </label>
                <label style="display:flex; align-items:center; gap:0.625rem; padding:0.625rem 0.75rem; border-radius:0.75rem; border:1.5px solid var(--c-border); background:white; cursor:pointer;">
                  <input type="radio" name="budget" value="premium" style="accent-color:var(--c-accent); flex-shrink:0;" />
                  <div>
                    <div style="font-size:0.8rem; font-weight:600; line-height:1.2;">Prémiová</div>
                    <div style="font-size:0.7rem; color:var(--c-muted);">Bez kompromisov</div>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Nastavenia: Sledovanie expirácie -->
          <div class="card-section">
            <div style="font-size:0.8rem; font-weight:700; color:var(--c-text); margin-bottom:0.2rem;">⏰ Sledovanie expirácie</div>
            <div style="font-size:0.72rem; color:var(--c-muted); margin-bottom:0.75rem; line-height:1.4;">Upozorníme vás na položky, ktorým sa blíži dátum spotreby.</div>
            <div style="display:flex; flex-wrap:wrap; gap:0.625rem;">
              <div style="display:flex; align-items:center; gap:0.375rem; background:#fef2f2; border:1px solid #fecaca; border-radius:0.625rem; padding:0.375rem 0.625rem;">
                <span style="font-size:0.75rem; font-weight:600; color:#dc2626;">🩺 Lieky</span>
                <select id="alertDaysMeds" style="width:auto; font-size:0.75rem; padding:0.2rem 0.4rem; border-radius:0.375rem; border:1px solid #fecaca; background:white; color:#dc2626; font-weight:600;">
                  <option value="270">9 mesiacov</option>
                  <option value="180" selected>6 mesiacov</option>
                  <option value="90">3 mesiace</option>
                  <option value="30">1 mesiac</option>
                </select>
              </div>
              <div style="display:flex; align-items:center; gap:0.375rem; background:#eff6ff; border:1px solid #bfdbfe; border-radius:0.625rem; padding:0.375rem 0.625rem;">
                <span style="font-size:0.75rem; font-weight:600; color:#1e40af;">🥫 Potraviny a voda</span>
                <select id="alertDaysFood" style="width:auto; font-size:0.75rem; padding:0.2rem 0.4rem; border-radius:0.375rem; border:1px solid #bfdbfe; background:white; color:#1e40af; font-weight:600;">
                  <option value="270">9 mesiacov</option>
                  <option value="180">6 mesiacov</option>
                  <option value="90">3 mesiace</option>
                  <option value="30" selected>1 mesiac</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Nastavenia: Emailové pripomienky -->
          <div id="emailSettingsInProfile" class="card-section">
            <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.5rem;">
              <div>
                <div style="font-size:0.8rem; font-weight:700; color:var(--c-text);">✉️ Emailové pripomienky</div>
                <div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.2rem;" id="emailNotifStatus">Pripomienky zatiaľ nie sú aktívne</div>
              </div>
              <div style="display:flex; gap:0.375rem;">
                <button type="button" id="btnTestEmail" onclick="sendTestNotification()" class="btn-ghost" style="font-size:0.72rem; padding:0.3rem 0.625rem;">Testovací email</button>
                <button type="button" onclick="document.getElementById('modalEmailJSInfo').classList.add('open')" class="btn-ghost" style="font-size:0.65rem; padding:0.3rem 0.4rem; color:var(--c-muted);">⚙️</button>
              </div>
            </div>
          </div>

        </div><!-- end profileAdvancedContent -->
      </div>

      <div style="display:flex; justify-content:flex-end; padding-top:0.25rem;">
        <button type="submit" class="btn-primary" style="padding:0.75rem 2.5rem; font-size:0.9375rem;">Uložiť profil</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Kategória Detail -->
<div class="modal-overlay" id="modalCategory">
  <div class="modal-box" style="max-width:680px;">
    <div class="modal-header">
      <div id="modalCatHeader" style="flex:1; min-width:0;"></div>
      <button data-close="modalCategory" class="modal-close">✕</button>
    </div>
    <div id="categoryDetail" style="max-height:65vh; overflow-y:auto; padding-right:0.25rem;"></div>
    <div style="display:flex; align-items:center; justify-content:space-between; padding-top:1rem; margin-top:0.5rem; border-top:1px solid var(--c-border);">
      <span id="modalCatProgress" style="font-size:0.8rem; color:var(--c-muted);"></span>
      <button class="btn-primary" id="btnAddItem" style="display:flex; align-items:center; gap:0.5rem;">
        <span style="font-size:1.1rem; line-height:1;">+</span> Pridať položku
      </button>
    </div>
  </div>
</div>

<!-- Modal: Add / Edit Item -->
<div class="modal-overlay" id="modalAddItem">
  <div class="modal-box" style="max-width:480px;">
    <div class="modal-header">
      <h3 id="itemModalTitle" style="font-family:'Lexend',sans-serif; font-weight:700; font-size:1.125rem;">Pridať položku</h3>
      <button data-close="modalAddItem" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem;">✕</button>
    </div>
    <form id="addItemForm" style="display:grid; gap:0.75rem;">
      <input type="hidden" name="editIndex" value="-1" />
      <div>
        <label id="itemLabelName" class="item-label-light">Názov *</label>
        <input name="name" type="text" required />
      </div>
      <div id="itemFieldQtyRow" style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
        <div id="itemFieldQty">
          <label id="itemLabelQty" class="item-label-light">Množstvo</label>
          <input name="qty" type="text" placeholder="napr. 5 ks" />
        </div>
        <div id="itemFieldExpiry">
          <label class="item-label-light">Expirácia</label>
          <input name="expiry" type="date" />
        </div>
      </div>
      <div id="itemFieldDocs" style="display:none;">
        <label class="item-label-light">Typ uloženia</label>
        <input name="qty_docs" type="text" placeholder="napr. Originál + scan Cloud + USB kľúč" />
      </div>
      <div id="itemFieldLink">
        <label class="item-label-light">Odkaz (URL)</label>
        <input name="link" type="url" placeholder="https://..." />
      </div>
      <div style="display:flex; justify-content:flex-end; padding-top:0.5rem;">
        <button type="submit" id="btnItemSubmit" class="btn-primary" style="padding:0.75rem 2rem;">Pridať</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Delete Item Confirmation -->
<div class="modal-overlay" id="modalDeleteItem">
  <div class="modal-box" style="max-width:420px; text-align:center;">
    <div style="font-size:2.5rem; margin-bottom:0.75rem;">🗑️</div>
    <h3 id="deleteItemTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0 0 0.5rem;">Odstrániť položku?</h3>
    <p id="deleteItemText" style="font-size:0.85rem; color:var(--c-muted); margin:0 0 1.25rem; line-height:1.5;"></p>
    <div style="display:flex; gap:0.625rem; justify-content:center;">
      <button data-close="modalDeleteItem" class="btn-ghost" style="padding:0.625rem 1.5rem; font-size:0.85rem;">Zrušiť</button>
      <button id="btnConfirmDelete" class="btn-primary" style="padding:0.625rem 1.5rem; font-size:0.85rem; background:#dc2626;">Odstrániť</button>
    </div>
  </div>
</div>

<!-- Modal: Edit Food Entry -->
<div class="modal-overlay" id="modalFoodEdit">
  <div class="modal-box" style="max-width:440px;">
    <div class="modal-header">
      <h3 style="font-family:'Lexend',sans-serif; font-weight:700; font-size:1.125rem;">✏️ Upraviť jedlo</h3>
      <button data-close="modalFoodEdit" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem;">✕</button>
    </div>
    <form id="foodEditForm" style="display:grid; gap:0.75rem;">
      <input type="hidden" name="fe_catId" />
      <input type="hidden" name="fe_itemIdx" />
      <input type="hidden" name="fe_entryIdx" />
      <div>
        <label class="item-label-light">Názov *</label>
        <input name="fe_name" type="text" required />
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
        <div>
          <label class="item-label-light">kcal / kus *</label>
          <input name="fe_kcal" type="number" min="0" required />
        </div>
        <div>
          <label class="item-label-light">Počet</label>
          <input name="fe_qty" type="number" min="1" value="1" />
        </div>
      </div>
      <div>
        <label class="item-label-light">Expirácia *</label>
        <input name="fe_expiry" type="date" required />
      </div>
      <div style="display:flex; justify-content:flex-end; padding-top:0.5rem;">
        <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Edit Water Entry -->
<div class="modal-overlay" id="modalWaterEdit">
  <div class="modal-box" style="max-width:440px;">
    <div class="modal-header">
      <h3 style="font-family:'Lexend',sans-serif; font-weight:700; font-size:1.125rem;">✏️ Upraviť vodu</h3>
      <button data-close="modalWaterEdit" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem;">✕</button>
    </div>
    <form id="waterEditForm" style="display:grid; gap:0.75rem;">
      <input type="hidden" name="we_catId" />
      <input type="hidden" name="we_itemIdx" />
      <input type="hidden" name="we_entryIdx" />
      <div>
        <label class="item-label-light">Názov *</label>
        <input name="we_name" type="text" required />
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
        <div>
          <label class="item-label-light">Litrov / kus *</label>
          <input name="we_liters" type="number" min="0" step="0.1" required />
        </div>
        <div>
          <label class="item-label-light">Počet</label>
          <input name="we_qty" type="number" min="1" value="1" />
        </div>
      </div>
      <div>
        <label class="item-label-light">Expirácia *</label>
        <input name="we_expiry" type="date" required />
      </div>
      <div style="display:flex; justify-content:flex-end; padding-top:0.5rem;">
        <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Edit Cash Entry -->
<div class="modal-overlay" id="modalCashEdit">
  <div class="modal-box" style="max-width:440px;">
    <div class="modal-header">
      <h3 style="font-family:'Lexend',sans-serif; font-weight:700; font-size:1.125rem;">✏️ Upraviť hotovosť</h3>
      <button data-close="modalCashEdit" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem;">✕</button>
    </div>
    <form id="cashEditForm" style="display:grid; gap:0.75rem;">
      <input type="hidden" name="ce_catId" />
      <input type="hidden" name="ce_itemIdx" />
      <input type="hidden" name="ce_entryIdx" />
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
        <div>
          <label class="item-label-light">Typ</label>
          <select name="ce_type" style="font-size:0.9rem; padding:0.625rem 0.875rem;">
            <option value="bankovka">💶 Bankovka</option>
            <option value="minca">🪙 Minca</option>
          </select>
        </div>
        <div>
          <label class="item-label-light">Hodnota (€) *</label>
          <input name="ce_value" type="number" min="0" step="0.01" required />
        </div>
      </div>
      <div>
        <label class="item-label-light">Počet kusov</label>
        <input name="ce_qty" type="number" min="1" value="1" />
      </div>
      <div style="display:flex; justify-content:flex-end; padding-top:0.5rem;">
        <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Validation Warning -->
<div class="modal-overlay" id="modalValidation">
  <div class="modal-box" style="max-width:400px; text-align:center;">
    <div style="font-size:2.5rem; margin-bottom:0.75rem;">⚠️</div>
    <h3 style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0 0 0.5rem;">Chýbajúce údaje</h3>
    <p id="validationText" style="font-size:0.85rem; color:var(--c-muted); margin:0 0 1.25rem; line-height:1.5;"></p>
    <button data-close="modalValidation" class="btn-primary" style="padding:0.625rem 2rem; font-size:0.85rem;">Rozumiem</button>
  </div>
</div>

<!-- Modal: Postup pri MU detail -->
<div class="modal-overlay" id="modalEmergencyProc">
  <div class="modal-box" style="max-width:600px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
      <div style="display:flex; align-items:center; gap:0.75rem; flex:1; min-width:0;">
        <div class="mu-icon" id="muModalIcon" style="flex-shrink:0;"></div>
        <div>
          <h3 id="muModalTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;"></h3>
          <p id="muModalSubtitle" style="font-size:0.78rem; color:var(--c-muted); margin:0.125rem 0 0;"></p>
        </div>
      </div>
      <button data-close="modalEmergencyProc" class="modal-close">✕</button>
    </div>
    <div id="muModalContent" style="max-height:65vh; overflow-y:auto; padding-right:0.25rem;"></div>
  </div>
</div>

<!-- Modal: Varovný signál detail -->
<div class="modal-overlay" id="modalSiren">
  <div class="modal-box" style="max-width:500px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
      <h3 id="sirenModalTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;"></h3>
      <button data-close="modalSiren" class="modal-close">✕</button>
    </div>
    <div id="sirenModalContent" style="max-height:65vh; overflow-y:auto;"></div>
  </div>
</div>

<!-- Modal: Prvá pomoc detail -->

<!-- Modal: Osobný kontakt -->

<!-- Modal: Evakuačný batoh detail -->
<div class="modal-overlay" id="modalEvacBag">
  <div class="modal-box" style="max-width:560px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
      <div style="display:flex; align-items:center; gap:0.75rem; flex:1; min-width:0;">
        <div id="evacBagModalIcon" style="width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.375rem; flex-shrink:0;"></div>
        <div>
          <h3 id="evacBagModalTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;"></h3>
          <p id="evacBagModalSubtitle" style="font-size:0.78rem; color:var(--c-muted); margin:0.125rem 0 0;"></p>
        </div>
      </div>
      <button data-close="modalEvacBag" class="modal-close">✕</button>
    </div>
    <div id="evacBagModalContent" style="max-height:65vh; overflow-y:auto; padding-right:0.25rem;"></div>
  </div>
</div>

<!-- Modal: Osobný kontakt -->
<div class="modal-overlay" id="modalPersonalContact">
  <div class="modal-box" style="max-width:500px;">
    <div class="modal-header">
      <div>
        <h3 id="pcModalTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;">👤 Nový kontakt</h3>
        <p style="font-size:0.78rem; color:var(--c-muted); margin:0.25rem 0 0;">Uložte si dôležité číslo pre prípad núdze</p>
      </div>
      <button data-close="modalPersonalContact" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem; flex-shrink:0; margin-left:1rem;">✕</button>
    </div>
    <form id="personalContactForm" style="display:grid; gap:1rem;">
      <input type="hidden" name="pc_editIndex" value="-1" />
      <div>
        <label class="item-label">Typ kontaktu *</label>
        <div id="pcCategoryPicker" style="display:flex; flex-wrap:wrap; gap:0.375rem; margin-bottom:0.5rem;"></div>
        <input name="pc_customType" type="text" id="pcCustomTypeInput" placeholder="Vlastný typ (napr. Susedka Mária)" style="display:none;" />
      </div>
      <div>
        <label class="item-label">Meno / Názov *</label>
        <input name="pc_name" type="text" required placeholder="napr. MUDr. Kováč, Allianz, Matka..." />
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.625rem;">
        <div>
          <label class="item-label">Telefón *</label>
          <input name="pc_phone" type="tel" required placeholder="+421..." />
        </div>
        <div>
          <label class="item-label">Telefón 2 (záložný)</label>
          <input name="pc_phone2" type="tel" placeholder="" />
        </div>
      </div>
      <div>
        <label class="item-label">Adresa</label>
        <input name="pc_address" type="text" placeholder="napr. Hlavná 15, Bratislava" />
      </div>
      <div>
        <label class="item-label">Poznámka</label>
        <input name="pc_note" type="text" placeholder="napr. Ordinačné hodiny, číslo zmluvy..." />
      </div>
      <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
        <button type="button" id="btnDeletePC" class="btn-ghost" style="padding:0.625rem 1.25rem; color:#dc2626; display:none;">Odstrániť</button>
        <button type="submit" class="btn-primary" style="padding:0.625rem 2rem;">Uložiť</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Miesto stretnutia -->
<div class="modal-overlay" id="modalMeetingPoint">
  <div class="modal-box" style="max-width:560px;">
    <div class="modal-header">
      <div>
        <h3 style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;">📍 Miesto stretnutia</h3>
        <p style="font-size:0.78rem; color:var(--c-muted); margin:0.25rem 0 0;">Kde sa stretnete, keď nebude signál ani internet?</p>
      </div>
      <button data-close="modalMeetingPoint" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem; flex-shrink:0; margin-left:1rem;">✕</button>
    </div>
    <form id="meetingPointForm" style="display:grid; gap:1rem;">
      <div class="card-section">
        <div style="font-size:0.8rem; font-weight:700; margin-bottom:0.625rem;">Hlavné miesto</div>
        <div style="display:grid; gap:0.625rem;">
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.25rem;">Názov miesta *</label>
            <input name="mp_name" type="text" placeholder="napr. Hodiny na námestí, Kostol sv. Martina..." required />
          </div>
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.25rem;">Adresa / popis polohy</label>
            <input name="mp_address" type="text" placeholder="napr. Hlavné námestie 1, pri fontáne" />
          </div>
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.25rem;">Poznámka</label>
            <input name="mp_note" type="text" placeholder="napr. Vchod od parkoviska, pri lavičkách" />
          </div>
        </div>
      </div>

      <div style="background:#eff6ff; border:1px solid #bfdbfe; border-radius:1rem; padding:1rem;">
        <div style="font-size:0.8rem; font-weight:700; color:#1e40af; margin-bottom:0.25rem;">⏰ Časy stretávania</div>
        <div style="font-size:0.72rem; color:#2563eb; margin-bottom:0.625rem; line-height:1.5;">Kedy sa budete na mieste hľadať? Napr. každé 4 hodiny. Ak tam druhý nie je, príďte o ďalší interval.</div>
        <div id="meetingTimesEditor" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;"></div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
          <input type="time" id="newMeetingTime" style="width:auto; font-size:0.85rem; padding:0.4rem 0.625rem;" />
          <button type="button" id="btnAddMeetingTime" class="btn-ghost" style="font-size:0.78rem; padding:0.4rem 0.75rem; white-space:nowrap;">+ Pridať čas</button>
        </div>
      </div>

      <div class="card-section">
        <div style="font-size:0.8rem; font-weight:700; margin-bottom:0.25rem;">Záložné miesto</div>
        <div style="font-size:0.72rem; color:var(--c-muted); margin-bottom:0.625rem;">Ak hlavné miesto nie je prístupné.</div>
        <div style="display:grid; gap:0.625rem;">
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.25rem;">Názov záložného miesta</label>
            <input name="mp_backup_name" type="text" placeholder="napr. Dom starej mamy, škola..." />
          </div>
          <div>
            <label style="font-size:0.72rem; color:var(--c-muted); display:block; margin-bottom:0.25rem;">Adresa</label>
            <input name="mp_backup_address" type="text" placeholder="" />
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end;">
        <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Scenár -->
<div class="modal-overlay" id="modalScenario">
  <div class="modal-box" style="max-width:600px;">
    <div class="modal-header">
      <div>
        <h3 id="scenarioModalTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;"></h3>
        <p id="scenarioModalSubtitle" style="font-size:0.78rem; color:var(--c-muted); margin:0.25rem 0 0;"></p>
      </div>
      <button data-close="modalScenario" style="background:none;border:none;cursor:pointer;color:var(--c-muted);font-size:1.25rem; flex-shrink:0; margin-left:1rem;">✕</button>
    </div>
    <div id="scenarioModalContent"></div>
  </div>
</div>
<div class="modal-overlay" id="modalFirstAid">
  <div class="modal-box" style="max-width:600px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
      <div style="display:flex; align-items:center; gap:0.75rem; flex:1; min-width:0;">
        <div class="fa-icon" id="faModalIcon" style="flex-shrink:0;"></div>
        <div>
          <h3 id="faModalTitle" style="font-family:'Lexend',sans-serif; font-weight:800; font-size:1.125rem; margin:0;"></h3>
          <p id="faModalSubtitle" style="font-size:0.78rem; color:var(--c-muted); margin:0.125rem 0 0;"></p>
        </div>
      </div>
      <button data-close="modalFirstAid" class="modal-close">✕</button>
    </div>
    <div id="faModalContent" style="max-height:65vh; overflow-y:auto; padding-right:0.25rem;"></div>
  </div>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  // ── EmailJS konfigurácia ─────────────────────────────────────────
  // POKYN: Zaregistruj sa na emailjs.com, vytvor service + template a vlož ID sem
  const EMAILJS_CONFIG = {
    publicKey:   "S9KjZEwsiiUC69fX-XqbK",     // Account → API Keys
    serviceId:   "service_h4jkdfs",             // Email Services → Service ID
    template_expiry:  "template_expiry_warn", // Template ID pre upozornenie na expiráciu
    template_shopping: "template_shopping_list" // Template ID pre nákupný zoznam
  };
  // Inicializuj EmailJS
  (function() {
    if (EMAILJS_CONFIG.publicKey !== "YOUR_EMAILJS_PUBLIC_KEY") {
      emailjs.init({ publicKey: EMAILJS_CONFIG.publicKey });
    }
  })();
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, runTransaction }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAnalytics, logEvent, setAnalyticsCollectionEnabled }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { initializeAppCheck, ReCaptchaV3Provider }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app-check.js";

  // ── Firebase config ──────────────────────────────────────────────
  // Demo mode: ?mode=demo v URL
  let isDemo = new URLSearchParams(location.search).get('mode') === 'demo';

  const firebaseConfig = {
    apiKey: "AIzaSyA5_U4_9La4JpK8wAXBqY6GmkKxCLkH8T4",
    authDomain: "bez-paniky.firebaseapp.com",
    projectId: "bez-paniky",
    storageBucket: "bez-paniky.firebasestorage.app",
    messagingSenderId: "539726693021",
    appId: "1:539726693021:web:123de9d93568a285e54a74",
    measurementId: "G-8CG5KPWS0V"
  };

  const MAX_USERS = 200; // Limit registrácií

  // Firebase sa inicializuje VŽDY (aj v demo) — niektoré funkcie ho potrebujú.
  // V demo režime sa preskočí len auth listener a ukladanie do Firestore.
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ── App Check (reCAPTCHA v3) ──────────────────────────────────
  if (location.hostname === 'localhost') { self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; }
  initializeAppCheck(app, {
    provider: new ReCaptchaV3Provider('6LeN2HksAAAAAH_Urnmy61VGqP8JfTxAG1hsyBI1'),
    isTokenAutoRefreshEnabled: true
  });

  // ── Firebase Analytics (consent-based) ─────────────────────────
  // Analytics sa inicializuje hneď, ale zber dát je VYPNUTÝ.
  // Zapne sa až po súhlase používateľa cez cookie banner.
  const analytics = getAnalytics(app);
  setAnalyticsCollectionEnabled(analytics, false); // Vypnuté by default

  // Zapne analytics ak používateľ už dal súhlas
  if (localStorage.getItem('gerlach_cookie_analytics') === 'true') {
    setAnalyticsCollectionEnabled(analytics, true);
  }

  // Helper na logovanie eventov (bezpečný — ak analytics vypnuté, nič sa nestane)
  function trackEvent(name, params) {
    try { logEvent(analytics, name, params || {}); } catch(e) { /* ticho */ }
  }

  // Funkcia volaná z cookie banneru po súhlase
  window.enableAnalytics = function() {
    setAnalyticsCollectionEnabled(analytics, true);
    localStorage.setItem('gerlach_cookie_analytics', 'true');
  };
  window.disableAnalytics = function() {
    setAnalyticsCollectionEnabled(analytics, false);
    localStorage.removeItem('gerlach_cookie_analytics');
  };

  // ── App state ────────────────────────────────────────────────────
  const CATEGORIES = [
    { id: "water", name: "Voda", emoji: "💧", weight: 1.2 },
    { id: "food", name: "Jedlo", emoji: "🥫", weight: 1.0 },
    { id: "medkit", name: "Lekárnička", emoji: "🩺", weight: 1.1 },
    { id: "cash", name: "Peniaze", emoji: "💵", weight: 0.9 },
    { id: "gear", name: "Vybavenie", emoji: "🔦", weight: 1.0 },
    { id: "hygiene", name: "Hygiena", emoji: "🧼", weight: 0.8 },
    { id: "docs", name: "Doklady", emoji: "📄", weight: 0.3 },
  ];

  // ── Zdroje odporúčaní pre kategórie ──────────────────────────
  // Tieto zdroje sú použité pri výpočte množstiev a výbere položiek
  const CATEGORY_SOURCES = {
    food: {
      note: "Jedlo: 2000 kcal / deň dospelý (PAL 1.4, krízový režim). Dlhodobé potraviny, konzervy, sušené jedlá.",
      sources: [
        { label: "EFSA – Referenčné hodnoty pre energetický príjem (2013)", url: "https://www.efsa.europa.eu/en/efsajournal/pub/3005" },
        { label: "SK MINV – V prípade krízy alebo ozbrojeného konfliktu", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "UA DSNS – Príručka pre prípad núdze alebo vojny", url: "https://dovidka.info/" }
      ]
    },
    water: {
      note: "Voda: 2 l pitnej / osoba / deň (WHO). Hygiena: ďalších 3–5 l / deň.",
      sources: [
        { label: "WHO – Voda, hygiena a zdravie v núdzových situáciách", url: "https://www.who.int/teams/environment-climate-change-and-health/water-sanitation-and-health" },
        { label: "SK MINV – V prípade krízy alebo ozbrojeného konfliktu", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    cash: {
      note: "\u20AC70\u2013100 / osobu na 72h, v mal\u00FDch nomin\u00E1loch (\u20AC5, \u20AC10, \u20AC20 + mince)",
      sources: [
        { label: "ECB \u2013 'Keep calm and carry cash' (2025)", url: "https://www.ecb.europa.eu/press/blog/date/2025/html/ecb.blog20250128~4b35e0ed27.en.html" },
        { label: "Rak\u00FAska iniciat\u00EDva 'Bargeld f\u00FCr alle F\u00E4lle'", url: "https://cashessentials.org/eu-recommends-including-cash-as-a-crucial-component-of-emergency-kits/" },
        { label: "EU Preparedness Union Strategy (2025)", url: "https://commission.europa.eu/topics/preparedness_en" }
      ]
    },
    medkit: {
      note: "Dom\u00E1ca lek\u00E1rni\u010Dka + n\u00FAdzov\u00E9 z\u00E1soby liekov na 7 dn\u00ED",
      sources: [
        { label: "CZ 72h pr\u00EDru\u010Dka (MV \u010CR, 2025)", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 V pr\u00EDpade kr\u00EDzy alebo ozbrojen\u00E9ho konfliktu", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "UA DSNS \u2013 Pr\u00EDru\u010Dka pre pr\u00EDpad n\u00FAdze alebo vojny", url: "https://dovidka.info/" },
        { label: "IFRC \u2013 First Aid Recommendations", url: "https://www.ifrc.org/first-aid" }
      ]
    },
    hygiene: {
      note: "Min. 72h sebesta\u010Dnos\u0165 vr\u00E1tane hygienick\u00FDch potrieb",
      sources: [
        { label: "EU Preparedness Union Strategy (2025)", url: "https://commission.europa.eu/topics/preparedness_en" },
        { label: "CZ 72h pr\u00EDru\u010Dka (MV \u010CR, 2025)", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 V pr\u00EDpade kr\u00EDzy alebo ozbrojen\u00E9ho konfliktu", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    gear: {
      note: "Komunik\u00E1cia, osvetlenie, varenie, n\u00E1stroje \u2013 sebesta\u010Dnos\u0165 min. 72h\u20137 dn\u00ED",
      sources: [
        { label: "\u0160v\u00E9dsko MSB \u2013 'Om krisen eller kriget kommer' (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" },
        { label: "CZ 72h pr\u00EDru\u010Dka (MV \u010CR, 2025)", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 V pr\u00EDpade kr\u00EDzy alebo ozbrojen\u00E9ho konfliktu", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "UA DSNS \u2013 Pr\u00EDru\u010Dka pre pr\u00EDpad n\u00FAdze alebo vojny", url: "https://dovidka.info/" }
      ]
    }
  };

  const DEFAULT_ITEMS = {
    food: [
      { name: "Zásoby jedla (kcal)", isFoodItem: true, foodEntries: [] },
    ],
    water: [
      { name: "Zásoby vody (litre)", isWaterItem: true, waterEntries: [] },
    ],
    cash: [
      { name: "Hotovosť v domácnosti", isCashItem: true, cashEntries: [] },
    ],
    medkit: [
      { name: "Lieky na predpis – zásoba na 7 dní", done: false, qty: "", expiry: "", link: "" },
      { name: "Dezinfekcia na rany (Betadine / Skinsept)", done: false, qty: "1 ks", expiry: "", link: "" },
    ],
    hygiene: [
      { name: "Toaletný papier", done: false, qty: "", expiry: "", link: "" },
      { name: "Mydlo", done: false, qty: "", expiry: "", link: "" },
    ],
    gear: [
      { name: "Baterka LED", done: false, qty: "", expiry: "", link: "" },
      { name: "Rádio na batérie AM/FM", done: false, qty: "1 ks", expiry: "", link: "" },
    ],
    docs: [
      // ── Osobné dokumenty ──
      { name: "Občiansky preukaz / pas – originál", done: false, qty: "Každý člen rodiny", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Občiansky preukaz / pas – kópia papier + scan", done: false, qty: "PDF: Cloud + USB", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Rodný list – originál + úradne overená kópia", done: false, qty: "1–2 ks overených", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Rodný list – scan na Cloud + USB", done: false, qty: "", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Sobášny list / rozsudok o rozvode – originál", done: false, qty: "+ 1× overená kópia", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Sobášny list – scan na Cloud + USB", done: false, qty: "", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Vodičský preukaz – originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      { name: "Kartička zdravotnej poisťovne – originál", done: false, qty: "+ scan / fotka", expiry: "", link: "", docGroup: "Osobné dokumenty" },
      // ── Majetok a bývanie ──
      { name: "List vlastníctva – výpis z katastra", done: false, qty: "+ 1× overená kópia", expiry: "", link: "", docGroup: "Majetok a bývanie" },
      { name: "List vlastníctva – scan Cloud + USB", done: false, qty: "", expiry: "", link: "", docGroup: "Majetok a bývanie" },
      { name: "Kúpna zmluva na nehnuteľnosť – originál", done: false, qty: "+ 1× overená kópia", expiry: "", link: "", docGroup: "Majetok a bývanie" },
      { name: "Hypotekárna / úverová zmluva – originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Majetok a bývanie" },
      { name: "Nájomná zmluva (ak prenajímate) – originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Majetok a bývanie" },
      // ── Auto / Doprava ──
      { name: "Technický preukaz (osvedčenie) – originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Auto a doprava" },
      { name: "Zmluva o kúpe vozidla – originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Auto a doprava" },
      { name: "PZP + havarijné poistenie – zmluva + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Auto a doprava" },
      // ── Zamestnanie a vzdelanie ──
      { name: "Diplom / vysvedčenia – originál", done: false, qty: "+ úradne overená kópia", expiry: "", link: "", docGroup: "Vzdelanie a práca" },
      { name: "Diplom – scan na Cloud + USB", done: false, qty: "", expiry: "", link: "", docGroup: "Vzdelanie a práca" },
      { name: "Certifikácie / odborné oprávnenia – originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Vzdelanie a práca" },
      // ── Financie ──
      { name: "Bankové účty – zmluvy originál + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Financie" },
      { name: "Investičné zmluvy (broker, fondy) – scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Financie" },
      { name: "Crypto seed / recovery fráza – PAPIER offline", done: false, qty: "2× na rôznych miestach! Nikdy nescanovať!", expiry: "", link: "", docGroup: "Financie" },
      { name: "Životná / úrazová poistka – zmluva + scan", done: false, qty: "Cloud + USB + poznámka k podmienkam", expiry: "", link: "", docGroup: "Financie" },
      { name: "Poistenie domu / bytu – zmluva + scan", done: false, qty: "Cloud + USB", expiry: "", link: "", docGroup: "Financie" },
      { name: "Daňové dokumenty – posledné 2–4 roky", done: false, qty: "Papier + scan", expiry: "", link: "", docGroup: "Financie" },
      // ── Zdravotné dokumenty ──
      { name: "Karta pacienta – scan + papierová", done: false, qty: "", expiry: "", link: "", docGroup: "Zdravotné dokumenty" },
      { name: "Lekárske správy (deti / chronickí pacienti)", done: false, qty: "Papier + Cloud + USB", expiry: "", link: "", docGroup: "Zdravotné dokumenty" },
      { name: "Alergie / lieky / kontakty – 1× A4 v lekárničke", done: false, qty: "Papier v lekárničke + batohu", expiry: "", link: "", docGroup: "Zdravotné dokumenty" },
      { name: "Darcu krvi / transplantácie / dôležité med. info", done: false, qty: "Papier + scan", expiry: "", link: "", docGroup: "Zdravotné dokumenty" },
      // ── Krízové dokumenty ──
      { name: "Plnomocenstvo – NOTÁRSKY OVERENÉ", done: false, qty: "Na správu majetku, bankové úkony, poistky", expiry: "", link: "", docGroup: "Krízové dokumenty" },
      { name: "Závet / dedičstvo – originál u notára", done: false, qty: "Kópia pre rodinu. Scan neodporúčaný ako dôkaz!", expiry: "", link: "", docGroup: "Krízové dokumenty" },
      { name: "Zoznam kontaktov offline – papier 1–2 strany", done: false, qty: "Lekár, právnik, banka, poisťovne, hasiči, elektrikár...", expiry: "", link: "", docGroup: "Krízové dokumenty" },
      { name: "USB kľúč s dokumentmi – pripravený v batohu", done: false, qty: "Šifrovaný! + záloha na Cloud", expiry: "", link: "", docGroup: "Krízové dokumenty" },
    ],
  };

  // ── Dynamic item generation based on profile ───────────────────
  function generateProfileItems(profile) {
    if (!profile) return {};
    const a = profile.adults || 0, k = profile.kids || 0, inf = profile.infants || 0, s = profile.seniors || 0;
    const persons = a + k + s; // Infants don't need most items separately
    const allP = a + k + inf + s;
    const days = profile.prepDays || 3;
    const c = profile.readinessCoeff || 1.0;
    const isPremium = profile.budget === "premium";
    const isEnhanced = profile.readiness === "enhanced";
    const ceil = Math.ceil;

    function q(val, unit) { return `${ceil(val * c)} ${unit}`; }
    function mk(name, qty, extra) { return { name, done: false, qty, expiry: "", link: "", ...extra }; }

    // ── GEAR (Vybavenie) ───────────────────────────────────────────
    // Zdroje: SE MSB 2024, CZ 72h, SK MINV, UA DSNS, NO DSB
    const gear = [];
    // --- Osvetlenie (CZ, SK, UA, SE – všetky vyžadujú) ---
    gear.push(mk("Baterka LED + čelovka", q(Math.max(persons, 1), "ks")));
    gear.push(mk("Náhradné batérie (AAA + AA mix)", q(ceil(Math.max(persons, 1) * days / 3) * 2, "ks")));
    gear.push(mk("Sviečky (čajové + klasické)", q(ceil(days * 3), "ks"), {link:""}));
    // --- Komunikácia (CZ, SK, UA, SE – kritické pri výpadku) ---
    gear.push(mk("Rádio na batérie AM/FM", "1 ks"));
    if (isPremium) gear.push(mk("Rádio núdzové s kľukou + solárne (Etón / Sangean)", "1 ks"));
    gear.push(mk("Náhradné batérie AA do rádia", q(ceil(days / 2) * 4, "ks")));
    // --- Energia (CZ, SK, UA, SE) ---
    gear.push(mk("Powerbanka min. 20 000 mAh", q(ceil(Math.max(allP, 1) / 2), "ks")));
    gear.push(mk("USB nabíjací kábel (Lightning + USB-C + Micro)", "1 sada"));
    // --- Varenie (CZ, SK, UA – varič + palivo) ---
    gear.push(mk("Plynový kempingový varič", "1 ks"));
    gear.push(mk("Plynové kartuše (230 g)", q(ceil(days / 2), "ks")));
    gear.push(mk("Zápalky vodeodolné + zapaľovač", q(ceil(Math.max(persons, 1) / 2), "setov")));
    // --- Voda – nádoby (CZ, SK, UA) ---
    const totalLitresDay = allP * 2;
    const bigCanisters = ceil(totalLitresDay * days / 10);
    gear.push(mk(
      `Kanister na vodu s ventilom ${allP <= 2 ? "5" : "10"} L`,
      `${bigCanisters} ks`
    ));
    if (isEnhanced) gear.push(mk("Kanister na vodu 5 L (záložný)", q(ceil(totalLitresDay / 5), "ks")));
    // --- Nástroje (CZ, UA, SE) ---
    gear.push(mk("Multifunkčný nôž / multitool", "1 ks"));
    gear.push(mk("Pevná lepiaca páska (duct tape)", q(ceil(Math.max(allP, 1) / 3), "ks")));
    gear.push(mk("Ceruzka + papier (blok A5)", "1 set"));
    gear.push(mk("Píšťalka signalizačná", q(Math.max(persons, 1), "ks")));
    gear.push(mk("Lano / paracord 15 m", "1 ks"));
    // --- Odpad + toaleta (CZ, SK – núdzová toaleta) ---
    gear.push(mk("Vrecia na odpad (60 L)", q(allP * ceil(days / 2), "ks")));
    // --- Bezpečnosť (CZ, SK – hasiaci prístroj) ---
    gear.push(mk("Hasiaci prístroj práškový 2 kg alebo hasiaca deka", "1 ks"));
    // --- Ochrana (UA, SE – fólia na okná) ---
    gear.push(mk("Igelitová fólia (zakrytie okien / izolácia)", "1 rolka"));
    // --- Dokumenty digitálne (UA, CZ) ---
    gear.push(mk("USB kľúč s kópiami dokumentov (šifrovaný)", "1 ks"));
    // --- Zvieratá (CZ, SK, UA) ---
    gear.push(mk("Krmivo pre domáce zvieratá", `podľa potreby na ${days} dní`));
    // --- Kľúče ---
    gear.push(mk("Náhradné kľúče od bytu / domu / auta", "1 sada"));
    // --- Mapa (UA – offline mapa) ---
    gear.push(mk("Mapa okolia (papierová) + offline mapy v telefóne", "1 ks"));

    // ── MEDKIT (Lekárnička) ────────────────────────────────────────
    // Zdroje: CZ 72h (obsah domácí lékárničky), SK MINV, UA DSNS (2 lekárničky),
    // SE MSB 2024, IFRC first aid recommendations
    const medkit = [];
    // --- Lieky na predpis (CZ, SK, UA – zásoba na 7 dní) ---
    medkit.push(mk("Lieky na predpis – zásoba na 7 dní", `+ popis: čo, kedy, ako užívate`, {expiry: ""}));
    // --- Dezinfekcia (CZ, SK, UA) ---
    medkit.push(mk("Dezinfekcia na rany (Betadine / Skinsept)", q(Math.max(ceil(allP / 3), 1), "ks")));
    medkit.push(mk("Dezinfekcia na ruky (gél, 100 ml)", q(Math.max(allP, 1), "ks")));
    // --- Lieky – bolesť, horúčka, tráviace (CZ, SK, UA) ---
    medkit.push(mk("Lieky proti bolesti – Ibuprofen 400 mg", q(Math.max(persons, 1), "balenie")));
    medkit.push(mk("Lieky proti horúčke – Paralen 500 mg", q(Math.max(persons, 1), "balenie")));
    medkit.push(mk("Lieky proti hnačke – Smecta / Imodium", q(Math.max(persons, 1), "balenie")));
    medkit.push(mk("Lieky proti nevoľnosti (Kinedryl)", q(Math.max(ceil(allP / 2), 1), "balenie")));
    medkit.push(mk("Aktívne uhlie (Carbosorb) – otrava", q(Math.max(ceil(allP / 2), 1), "balenie")));
    // --- Antihistaminikum (UA odporúčanie) ---
    medkit.push(mk("Antihistaminikum (Cetirizín / Zyrtec)", q(Math.max(ceil(allP / 2), 1), "balenie")));
    medkit.push(mk("Kvapky do očí (umelé slzy)", "1 ks"));
    medkit.push(mk("Elektrolyty – rehydratačné soli (ORS)", q(Math.max(allP, 1), "sáčkov")));
    // --- Obväzový materiál (CZ 72h detailný zoznam) ---
    medkit.push(mk("Obväzy elastické + gáza (sterilná)", q(Math.max(ceil(allP / 2), 1), "set")));
    medkit.push(mk("Náplasti rôzne veľkosti", q(Math.max(allP, 1), "balenie")));
    medkit.push(mk("Trojrohá šatka", q(2, "ks")));
    medkit.push(mk("Jednorazové rukavice (nitrylové)", q(allP * 2, "párov")));
    // --- Trauma (CZ – škrtidlo, UA – tourniquet, hemostatik) ---
    medkit.push(mk("Škrtidlo (CAT tourniquet)", q(Math.max(ceil(allP / 3), 1), "ks")));
    medkit.push(mk("Resuscitačná rúška s ventilom", "1 ks"));
    // --- Nástroje (CZ) ---
    medkit.push(mk("Nožnice (lekárnické / atraumatické)", "1 ks"));
    medkit.push(mk("Pinzeta", "1 ks"));
    medkit.push(mk("Teplomer digitálny", "1 ks"));
    // --- Ochrana (CZ, SK) ---
    medkit.push(mk("Záchranárska fólia (izotermická deka)", q(allP, "ks")));
    medkit.push(mk("Respirátor FFP2", q(allP * 2, "ks")));
    // --- Deti (CZ, SK, UA) ---
    if (k > 0 || inf > 0) {
      medkit.push(mk("Paralen pre deti (čapíky alebo sirup)", q(k + inf, "balenie")));
      medkit.push(mk("Nurofen pre deti (sirup – od 3 mesiacov)", q(k + inf, "balenie")));
      medkit.push(mk("Elektrolyty pre deti (rehydratačné soli)", q((k + inf) * 3, "sáčkov")));
    }
    if (inf > 0) {
      medkit.push(mk("Nosné kvapky pre bábätká (fyziologický roztok)", q(inf, "ks")));
      medkit.push(mk("Zinková masť (ochrana pokožky dojčaťa)", q(inf, "ks")));
      medkit.push(mk("Kvapky proti kolikám (Espumisan / Sab Simplex)", q(inf, "ks")));
    }
    // --- Rozšírené (UA DSNS + ICRC) ---
    if (isEnhanced) {
      medkit.push(mk("Obväz s hemostatikom (QuikClot / Celox)", q(Math.max(ceil(allP / 2), 1), "ks")));
      medkit.push(mk("Sam Splint – dlahovacia pomôcka", "1 ks"));
      medkit.push(mk("Chest seal – okluzívna náplasť (pneumotorax)", "1 ks"));
      medkit.push(mk("Respirátor FFP3", q(allP, "ks")));
    }

    // ── HYGIENE (Hygiena) ──────────────────────────────────────────
    // Zdroje: CZ 72h, SK MINV, EU Preparedness Union Strategy
    const hygiene = [];
    hygiene.push(mk("Toaletný papier", q(ceil(allP * days / 3), "roliek")));
    hygiene.push(mk("Mydlo / sprchový gél", q(Math.max(ceil(allP / 2), 1), "ks")));
    hygiene.push(mk("Vlhčené utierky (veľké balenie)", q(Math.max(allP, 1), "balenie")));
    hygiene.push(mk("Zubná kefka + zubná pasta", q(allP, "ks + 1 pasta")));
    hygiene.push(mk("Šampón (cestovné balenie)", q(Math.max(ceil(allP / 2), 1), "ks")));
    hygiene.push(mk("Ručník (rýchloschnúci)", q(allP, "ks")));
    hygiene.push(mk("Menštruačné potreby (vložky / tampóny / kalíšok)", "podľa potreby"));
    hygiene.push(mk("Papierové vreckovky", q(allP, "balenie")));
    hygiene.push(mk("Dezinfekcia na ruky (cestovné balenie 50 ml)", q(allP, "ks")));
    // --- Núdzová toaleta (CZ – pytel do záchodu, SK) ---
    hygiene.push(mk("Kočkolit / absorpčné vrecká (núdzová toaleta)", "1 balenie"));
    hygiene.push(mk("Odpadkové vrecká na biologický odpad", q(allP * ceil(days / 2), "ks")));
    // --- Deti (SK, CZ) ---
    if (inf > 0) {
      hygiene.push(mk("Plienky (jednorazové)", q(inf * days * 6, "ks")));
      hygiene.push(mk("Detské vlhčené obrúsky", q(inf * 2, "balenie")));
      hygiene.push(mk("Ochranný krém na zadoček", q(inf, "ks")));
    }
    if (k > 0) {
      hygiene.push(mk("Detské vlhčené obrúsky", q(k, "balenie")));
    }

    return { gear, medkit, hygiene };
  }

  // Regenerate items for dynamic categories, preserving done states and custom items
  function regenerateProfileBasedItems() {
    if (!state.profile) return;
    const generated = generateProfileItems(state.profile);
    ["gear", "medkit", "hygiene"].forEach(catId => {
      if (!generated[catId]) return;
      const existing = state.items[catId] || [];
      const doneMap = {};
      existing.forEach(it => { doneMap[it.name] = it.done; });
      // Generated item names set
      const genNames = new Set(generated[catId].map(it => it.name));
      // Custom items = items that exist but are NOT in generated list
      const custom = existing.filter(it => !genNames.has(it.name));
      state.items[catId] = [
        ...generated[catId].map(it => ({
          ...it,
          done: doneMap[it.name] !== undefined ? doneMap[it.name] : false
        })),
        ...custom
      ];
    });
  }

  // Funkcia na vytvorenie čistého state - vždy volať pri novom prihlásení
  function freshState() {
    return {
      profile: null,
      selectedCategoryId: "water",
      alertDaysMeds: 180,
      alertDaysFood: 30,
      items: structuredClone(DEFAULT_ITEMS),
      plans: {
        meetingPoint: {
          name: "",
          address: "",
          note: "",
          times: ["08:00", "12:00", "16:00", "20:00"],
          backup: { name: "", address: "" }
        },
        scenarios: {
          home: {
            steps: "1. Zachovajte pokoj \u2013 panika je v\u00e1\u0161 najv\u00e4\u010d\u0161\u00ed nepriate\u013e\n2. Zistite typ ohrozenia: zapnite r\u00e1dio (96,6 FM BA / 90,1 FM BB / 89,5 FM KE)\n3. Zatvorte a utesnite okn\u00e1, dvere, ventil\u00e1ciu (chemick\u00fd \u00fanik, radi\u00e1cia)\n4. Skontrolujte z\u00e1soby: voda, jedlo, lieky, baterky, r\u00e1dio\n5. Pripravte evaku\u00e1\u010dn\u00e9 batohy pri dver\u00e1ch + pev\u00fa obuv\n6. Po\u010dkajte na hovor. inform\u00e1ciu \u2013 \u00farady povedia \u010do robi\u0165\n7. Ak nariadili evaku\u00e1ciu: vypnite isti\u010d + plyn, zamknite, l\u00edstok na dvere\n8. I\u010fte na miesto stretnutia pe\u0161o (auto len ak cesta vo\u013en\u00e1)",
            evacPlace: "",
            note: ""
          },
          separated: {
            tasks: [],
            meetPlace: "",
            meetTime: "",
            note: ""
          },
          partial: {
            whoHome: "",
            whoWork: "",
            homeSteps: "1. Zabezpe\u010dte deti \u2013 upokojte, vysvetlite primerane veku\n2. Pripravte v\u0161etky evaku\u00e1\u010dn\u00e9 batohy (aj partnerov)\n3. Sledujte r\u00e1dio \u2013 R\u00e1dio Slovensko\n4. SMS partnerovi: kr\u00e1tka spr\u00e1va s va\u0161ou poz\u00edciou\n5. Ak sa partner neozval do 2h \u2192 i\u010fte na miesto stretnutia\n6. L\u00edstok na dvere: kto, kedy, kam",
            workSteps: "1. Bezpe\u010dne opustite pracovisko (kol\u00e1\u010d, ne\u010dakajte)\n2. SMS partnerovi: \u201eSom OK, idem dom/stretnutie\u201c\n3. Ak je cesta domov bezpe\u010dn\u00e1 \u2192 i\u010fte domov\n4. Ak nie \u2192 smerujte na miesto stretnutia\n5. Po ceste vyzvihnite bl\u00edzkych ak m\u00f4\u017eete",
            meetPlace: "",
            meetTime: "",
            note: ""
          },
          night: {
            steps: "1. Zobu\u010fte v\u0161etk\u00fdch \u2013 pokojne ale r\u00e1zne, najprv deti\n2. Oble\u010dte sa: tepl\u00e9 oble\u010denie + PEVN\u00c1 OBUV (pripraven\u00e1 pri batohu)\n3. \u010celovka/baterka na hlavu \u2013 ruky musia byti vo\u013en\u00e9\n4. Zapnite r\u00e1dio na bat\u00e9rie \u2013 zistite \u010do sa deje\n5. Evaku\u00e1\u010dny batoh je pri dver\u00e1ch \u2013 vezmite ho\n6. Deti: neste/ve\u010fte za ruku, star\u0161\u00edch podoprite\n7. NIKDY nehladajte veci po byte v tme \u2013 vezmite len to \u010do je pripraven\u00e9\n8. Mobil + k\u013e\u00fa\u010de + doklady = minimum",
            evacPlace: "",
            note: ""
          },
          travel: {
            whoTravels: "",
            contactPerson: "",
            contactPhone: "",
            stepsHome: "",
            stepsAway: "",
            note: ""
          }
        }
      },
      personalContacts: [],
      evacuationBags: {}
    };
  }

  let state = freshState();

  let currentUser = null;
  let saveTimeout = null;
  let syncStatus = "idle"; // idle | syncing | synced

  // ── Firestore helpers ────────────────────────────────────────────
  function userDocRef(uid) { return doc(db, "users", uid, "data", "main"); }
  function metaRef() { return doc(db, "meta", "stats"); }

  async function loadUserData(uid) {
    // Demo: načítame zo sessionStorage (ak tam niečo je)
    if (isDemo) {
      try {
        const saved = sessionStorage.getItem('gerlach_demo_state');
        if (saved) {
          const data = JSON.parse(saved);
          state = { ...state, ...data };
        }
      } catch(e) { console.warn("Demo load error", e); }
      setSyncStatus("synced");
      return;
    }
    setSyncStatus("syncing");
    try {
      const snap = await getDoc(userDocRef(uid));
      if (snap.exists()) {
        const data = snap.data();
        // Deep merge plans structure (handle old A/B/C format migration)
        const defaultPlans = freshState().plans;
        let mergedPlans = defaultPlans;
        if (data.plans) {
          if (data.plans.meetingPoint) {
            // New format – deep merge
            mergedPlans = {
              meetingPoint: { ...defaultPlans.meetingPoint, ...(data.plans.meetingPoint || {}), backup: { ...defaultPlans.meetingPoint.backup, ...((data.plans.meetingPoint||{}).backup || {}) } },
              scenarios: {
                home: { ...defaultPlans.scenarios.home, ...((data.plans.scenarios||{}).home || {}) },
                separated: { ...defaultPlans.scenarios.separated, ...((data.plans.scenarios||{}).separated || {}), tasks: ((data.plans.scenarios||{}).separated||{}).tasks || [] },
                partial: { ...defaultPlans.scenarios.partial, ...((data.plans.scenarios||{}).partial || {}) },
                night: { ...defaultPlans.scenarios.night, ...((data.plans.scenarios||{}).night || {}) },
                travel: { ...defaultPlans.scenarios.travel, ...((data.plans.scenarios||{}).travel || {}) }
              }
            };
          }
          // else: old A/B/C format – just use defaults, old data ignored
        }
        state = {
          ...state,
          ...data,
          items: { ...structuredClone(DEFAULT_ITEMS), ...(data.items || {}) },
          plans: mergedPlans,
          personalContacts: data.personalContacts || [],
          evacuationBags: data.evacuationBags || {}
        };
        // Migrate: ensure link field
        for (const cid of Object.keys(state.items)) {
          state.items[cid] = state.items[cid].map(it => ({ link: "", waterBottles: 0, isWaterItem: false, isFoodItem: false, isCashItem: false, ...it }));
        }
        // Migrate: docs category – if old format (no docGroup), replace with new comprehensive list
        if (state.items.docs && state.items.docs.length > 0 && !state.items.docs[0].docGroup) {
          state.items.docs = structuredClone(DEFAULT_ITEMS.docs);
        }
        // Migrate: alertDays → alertDaysMeds + alertDaysFood
        if (!data.alertDaysMeds && !data.alertDaysFood) {
          state.alertDaysMeds = 180;
          state.alertDaysFood = data.alertDays || 30;
        } else {
          state.alertDaysMeds = data.alertDaysMeds || 180;
          state.alertDaysFood = data.alertDaysFood || 30;
        }
        delete state.alertDays;
        // Migrate: budget "basic" (old Úsporná) → "mid" (new Základná)
        if (state.profile && state.profile.budget === "basic") {
          state.profile.budget = "mid";
        }
        // Migrate: remove old default items from dynamic categories (replaced by profile-based generation)
        const OLD_DEFAULTS = {
          gear: ["Baterka + záložné batérie", "Powerbanka (min. 10 000 mAh)", "Rádio na batérie"],
          medkit: ["Lieky proti bolesti (Paralen, Ibuprofen)", "Obväzy, dezinfekcia, rukavice", "Lieky na predpis – záložná zásoba"],
          hygiene: ["Toaletný papier / vlhčené utierky", "Mydlo / dezinfekcia rúk"]
        };
        for (const [catId, oldNames] of Object.entries(OLD_DEFAULTS)) {
          if (state.items[catId]) {
            state.items[catId] = state.items[catId].filter(it => !oldNames.includes(it.name));
          }
        }
        // Migrate v22→v23: renamed items (preserve done state)
        const RENAME_MAP = {
          gear: {
            "Baterka LED": "Baterka LED + čelovka",
            "Náhradné batérie AAA do baterky": "Náhradné batérie (AAA + AA mix)",
            "Rádio núdzové Etón Odyssey (kľukou + solárne)": "Rádio núdzové s kľukou + solárne (Etón / Sangean)",
            "Zápalky / zapaľovač": "Zápalky vodeodolné + zapaľovač",
            "Multifunkčný nôž": "Multifunkčný nôž / multitool",
            "Ceruzka a papier (blok A5)": "Ceruzka + papier (blok A5)",
            "Píšťalka (signalizačná)": "Píšťalka signalizačná",
            "Paracord / lano 15 m": "Lano / paracord 15 m",
          },
          medkit: {
            "Aktívne uhlie (Carbosorb)": "Aktívne uhlie (Carbosorb) – otrava",
            "Elektrolyty – rehydratačné soli": "Elektrolyty – rehydratačné soli (ORS)",
            "Nožnice (lekárnické)": "Nožnice (lekárnické / atraumatické)",
          },
          hygiene: {
            "Dámska hygiena (vložky / tampóny)": "Menštruačné potreby (vložky / tampóny / kalíšok)",
          }
        };
        for (const [catId, renames] of Object.entries(RENAME_MAP)) {
          if (state.items[catId]) {
            state.items[catId].forEach(it => {
              if (renames[it.name]) it.name = renames[it.name];
            });
          }
        }
        // Also fix kanister name pattern (remove EDA suffix)
        if (state.items.gear) {
          state.items.gear.forEach(it => {
            if (it.name && it.name.includes("Kanister na vodu s ventilom") && it.name.includes("(EDA)")) {
              it.name = it.name.replace(" (EDA)", "");
            }
          });
        }
        // Regenerate dynamic items from profile
        regenerateProfileBasedItems();
        // Migrate: food_water → food + water (v22 split)
        if (state.items.food_water) {
          // Split food_water into separate food and water categories
          if (!state.items.food) state.items.food = [];
          if (!state.items.water) state.items.water = [];
          state.items.food_water.forEach(it => {
            if (it.isWaterItem) {
              if (it.name === "Pitná voda") it.name = "Zásoby vody (litre)";
              if (!it.waterEntries) it.waterEntries = [];
              if (it.waterBottles && it.waterBottles > 0 && it.waterEntries.length === 0) {
                it.waterEntries.push({ name: "Fľaša 1,5 l", liters: 1.5, qty: it.waterBottles, expiry: "" });
              }
              state.items.water.push(it);
            } else if (it.isFoodItem) {
              if (!it.foodEntries) it.foodEntries = [];
              state.items.food.push(it);
            } else {
              // Regular items (non-tracker) go to food
              state.items.food.push(it);
            }
          });
          delete state.items.food_water;
        }
        // Ensure food and water trackers exist
        if (!state.items.food) state.items.food = [];
        if (!state.items.water) state.items.water = [];
        // Rename old food/water names
        state.items.food.forEach(it => { if (it.isFoodItem && it.name === "Zásoby jedla") it.name = "Zásoby jedla (kcal)"; });
        if (!state.items.food.find(it => it.isFoodItem)) {
          state.items.food.unshift({ name: "Zásoby jedla (kcal)", isFoodItem: true, foodEntries: [] });
        }
        state.items.water.forEach(it => { if (it.isWaterItem && (it.name === "Zásoby pitnej vody" || it.name === "Pitná voda")) it.name = "Zásoby vody (litre)"; });
        if (!state.items.water.find(it => it.isWaterItem)) {
          state.items.water.unshift({ name: "Zásoby vody (litre)", isWaterItem: true, waterEntries: [] });
        }
        state.items.food.forEach(it => { if (it.isFoodItem && !it.foodEntries) it.foodEntries = []; });
        state.items.water.forEach(it => { if (it.isWaterItem && !it.waterEntries) it.waterEntries = []; });
        // Migrate: cash – remove old items, ensure cash tracker exists
        if (state.items.cash) {
          const oldCashNames = ["Hotovosť na 3–7 dní", "Drobné mince"];
          state.items.cash = state.items.cash.filter(it => !oldCashNames.includes(it.name));
          if (!state.items.cash.find(it => it.isCashItem)) {
            state.items.cash.push({ name: "Hotovosť v domácnosti", isCashItem: true, cashEntries: [] });
          }
          state.items.cash.forEach(it => {
            if (it.isCashItem && !it.cashEntries) it.cashEntries = [];
          });
        }
      }
      setSyncStatus("synced");
    } catch(e) {
      console.error("Load error", e);
      setSyncStatus("idle");
    }
  }

  async function saveUserData() {
    if (isDemo) {
      // Demo: ukladáme do sessionStorage (zmizne po zatvorení tabu)
      try {
        sessionStorage.setItem('gerlach_demo_state', JSON.stringify(state));
        setSyncStatus("synced");
      } catch(e) { console.warn("Demo save error", e); }
      return;
    }
    if (!currentUser) return;
    setSyncStatus("syncing");
    try {
      await setDoc(userDocRef(currentUser.uid), state);
      setSyncStatus("synced");
    } catch(e) {
      console.error("Save error", e);
      setSyncStatus("idle");
    }
  }

  function scheduleSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveUserData, 1200);
  }

  function setSyncStatus(s) {
    syncStatus = s;
    const dot = document.getElementById("syncDot");
    const lbl = document.getElementById("syncLabel");
    if (!dot || !lbl) return;
    if (isDemo) {
      dot.className = "sync-dot";
      dot.style.background = "#f59e0b";
      lbl.textContent = s === "synced" ? "Demo · uložené" : "Demo";
      return;
    }
    dot.style.background = "";
    dot.className = "sync-dot" + (s === "synced" ? " synced" : s === "syncing" ? " syncing" : "");
    lbl.textContent = s === "synced" ? "Uložené" : s === "syncing" ? "Ukladám…" : "";
  }

  // ── Registration limit ───────────────────────────────────────────
  async function registerNewUser(uid) {
    try {
      const result = await runTransaction(db, async (tx) => {
        const meta = await tx.get(metaRef());
        const count = meta.exists() ? (meta.data().registeredUsers || 0) : 0;
        if (count >= MAX_USERS) throw new Error("LIMIT_REACHED");
        tx.set(metaRef(), { registeredUsers: count + 1 }, { merge: true });
        tx.set(userDocRef(uid), freshState());
        return true;
      });
      return result;
    } catch(e) {
      if (e.message === "LIMIT_REACHED") return false;
      throw e;
    }
  }

  // ── Demo mode startup ────────────────────────────────────────────
  // Ak je ?mode=demo, preskočíme celý Firebase Auth a spustíme appku okamžite
  function startDemoMode() {
    document.body.classList.add('is-demo');
    currentUser = { uid: 'demo', displayName: 'Demo používateľ', email: null, photoURL: null };

    // Načítaj dáta zo sessionStorage (ak user sa vrátil v tom istom tabe)
    loadUserData('demo');

    // UI: demo banner
    document.getElementById('demoBanner').classList.add('visible');

    // UI: version badge → "Demo"
    const badge = document.getElementById('versionBadge');
    if (badge) {
      badge.textContent = 'Demo';
      badge.classList.remove('beta');
      badge.classList.add('demo-badge');
    }

    // UI: avatar
    const av = document.getElementById('userAvatar');
    if (av) av.textContent = 'D';

    // UI: sync indicator — show "Demo" instead of hiding
    const syncEl = document.querySelector('.sync-indicator');
    if (syncEl) {
      syncEl.style.display = '';
      const dot = document.getElementById('syncDot');
      const lbl = document.getElementById('syncLabel');
      if (dot) { dot.className = 'sync-dot'; dot.style.background = '#f59e0b'; }
      if (lbl) lbl.textContent = 'Demo';
    }

    // UI: logout → "Ukončiť demo"
    const btnLO = document.getElementById('btnLogout');
    if (btnLO) { btnLO.textContent = 'Ukončiť demo'; btnLO.style.display = ''; }
    const mobileLO = document.querySelector('.mobile-logout-btn');
    if (mobileLO) { mobileLO.textContent = '🔍 Ukončiť demo'; }

    showScreen('app');
    state._profileWasSet = !!state.profile;
    renderAll();
    setupLogoEasterEgg();
    trackEvent('demo_start');
    const emailSection = document.getElementById('emailSettingsInProfile');

    // Demo: "Vytvoriť účet zadarmo" link v banneri → ukončí demo a vráti na login
    const bannerLink = document.getElementById('demoBannerCreateAccount');
    if (bannerLink) {
      bannerLink.onclick = (e) => { e.preventDefault(); document.getElementById('btnLogout').click(); };
    }
    if (emailSection) {
      emailSection.innerHTML = `
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <div>
            <div style="font-size:0.8rem; font-weight:700; color:var(--c-text);">✉️ Emailové pripomienky</div>
            <div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.2rem;">V demo režime nie sú dostupné. Ukončite demo a vytvorte si účet pre emailové upozornenia na expirácie.</div>
          </div>
        </div>`;
    }

    if (!state.profile) openModal('modalProfile');
  }

  // Ak isDemo (z ?mode=demo), spustíme demo okamžite
  if (isDemo) {
    startDemoMode();
  }

  // ── Auth (len pre normálny režim) ─────────────────────────────────
  document.getElementById("btnGoogleLogin").onclick = async () => {
    if (isDemo) return; // V demo ignoruj Google login
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch(e) {
      const err = document.getElementById("loginError");
      err.style.display = "block";
      err.textContent = "Prihlásenie zlyhalo. Skús znova.";
    }
  };

  // Demo button na login screen
  document.getElementById("btnDemoLogin").onclick = () => {
    isDemo = true;
    startDemoMode();
  };

  document.getElementById("btnLogout").onclick = () => {
    if (isDemo) {
      // Demo: vymaž sessionStorage, resetuj stav a vráť na login
      sessionStorage.removeItem('gerlach_demo_state');
      isDemo = false;
      currentUser = null;
      state = freshState();
      // Reset UI demo prvkov
      document.body.classList.remove('is-demo');
      const badge = document.getElementById('versionBadge');
      if (badge) { badge.textContent = 'Beta v0.1'; badge.classList.remove('demo-badge'); badge.classList.add('beta'); }
      document.getElementById('demoBanner').classList.remove('visible');
      const btnLO = document.getElementById('btnLogout');
      if (btnLO) btnLO.textContent = 'Odhlásiť';
      const mobileLO = document.querySelector('.mobile-logout-btn');
      if (mobileLO) mobileLO.textContent = 'Odhlásiť';
      showScreen("login");
      return;
    }
    signOut(auth);
  };

  // Auth state listener — len v normálnom režime
  if (!isDemo) {
    onAuthStateChanged(auth, async (user) => {
    // Ak medzičasom užívateľ spustil demo, nerob nič
    if (isDemo) return;
    if (!user) {
      currentUser = null;
      // Reset state pri odhlásení - žiadne dáta nezostanú v pamäti
      state = freshState();
      showScreen("login");
      return;
    }
    currentUser = user;
    // Vždy začneme s čistým state pred načítaním dát z Firestore
    state = freshState();
    // Check if user already has data
    const snap = await getDoc(userDocRef(user.uid));
    if (!snap.exists()) {
      // New user – check limit
      const ok = await registerNewUser(user.uid);
      if (!ok) {
        showScreen("closed");
        await signOut(auth);
        return;
      }
    } else {
      await loadUserData(user.uid);
    }

    // Update avatar
    const av = document.getElementById("userAvatar");
    if (user.photoURL) {
      const img = document.createElement("img");
      img.src = user.photoURL;
      img.alt = "avatar";
      av.innerHTML = "";
      av.appendChild(img);
    } else {
      av.textContent = (user.displayName || user.email || "U")[0].toUpperCase();
    }

    showScreen("app");
    state._profileWasSet = !!state.profile;
    renderAll();
    setupLogoEasterEgg();
    trackEvent('login', { method: 'google', is_new: !snap.exists() });
    if (!state.profile) openModal("modalProfile");
    // Skontroluj expirácie a pošli notifikácie (ak treba)
    setTimeout(checkAndSendNotifications, 2000);
  });
  } // end if (!isDemo)

  function showScreen(name) {
    document.getElementById("loginScreen").style.display = name === "login" ? "flex" : "none";
    document.getElementById("closedScreen").style.display = name === "closed" ? "flex" : "none";
    document.getElementById("appScreen").style.display = name === "app" ? "block" : "none";
  }

  // ── Helpers ──────────────────────────────────────────────────────
  function esc(s) {
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function daysUntil(d) {
    const ms = new Date(d + "T00:00:00") - new Date();
    return Math.ceil(ms / 86400000);
  }

  function colorForPct(p) {
    // Plynulý prechod: 0% = červená (hsl 0), 100% = zelená (hsl 120)
    const h = Math.round((Math.min(100, Math.max(0, p)) / 100) * 120);
    const s = 75;
    const l = p < 15 ? 42 : p > 85 ? 36 : 38;
    return `hsl(${h} ${s}% ${l}%)`;
  }

  function rankForPct(p) {
    if (p <= 20) return "Ste ešte na začiatku";
    if (p <= 40) return "Už máte základ";
    if (p <= 60) return "Dobrý základ";
    if (p <= 80) return "Veľmi slušne";
    return "Výborne pripravení";
  }

  function emojiForPct(p) {
    return "";
  }

  // ── Voda – inteligentný kalkulátor ──────────────────────────────
  // Odporúčania WHO pre núdzové situácie: min. 2,5–3 l na osobu/deň na pitie
  // Appka používa 2 l/deň dospelý, 1.5 l dieťa, 1 l batoľa, 2 l senior (konzervat. odhad na pitie)
  // Zdroj: WHO Technical Notes on WASH in Emergencies (Technical Note No. 9)
  const WATER_SOURCE_URL = "https://www.who.int/teams/environment-climate-change-and-health/water-sanitation-and-health/environmental-health-in-emergencies/humanitarian-emergencies";
  const WATER_SOURCE_LABEL = "WHO – Water, Sanitation and Health in Emergencies";

  function getDailyWaterNeed() {
    if (!state.profile) return 0;
    const p = state.profile;
    const coeff = p.readinessCoeff || 1.0;
    return ((p.adults||0)*2 + (p.kids||0)*1.5 + (p.infants||0)*1 + (p.seniors||0)*2) * coeff;
  }

  function getTotalWaterLiters(item) {
    if (!item.isWaterItem) return 0;
    // Support legacy waterBottles field
    if (item.waterBottles && (!item.waterEntries || item.waterEntries.length === 0)) {
      return (item.waterBottles || 0) * 1.5;
    }
    if (!item.waterEntries) return 0;
    return item.waterEntries.reduce((sum, e) => sum + ((e.liters||0) * (e.qty||1)), 0);
  }

  function calcWaterCompletion(item) {
    if (!item.isWaterItem || !state.profile) return item.done ? 100 : 0;
    const p = state.profile;
    const d = p.prepDays || 3;
    const total = getDailyWaterNeed() * d;
    if (!total) return 0;
    return Math.min(100, (getTotalWaterLiters(item) / total) * 100);
  }

  // ── Kalórie / Jedlo – inteligentný kalkulátor ──────────────────
  // Odporúčané denné kcal podľa EFSA (European Food Safety Authority)
  // Scientific Opinion on Dietary Reference Values for Energy (2013)
  // PAL 1.4 (sedentárna aktivita – krízový režim), BMI 22 kg/m²
  // Zdroj: EFSA Journal 2013;11(1):3005
  const KCAL_PER_DAY = {
    adult:  2000,  // priemer muž/žena, PAL 1.4 (sedentárna)
    kid:    1500,  // deti 4–17 r., priemer
    infant: 1000,  // batoľatá 0–3 r.
    senior: 1800   // seniori 65+, PAL 1.4
  };
  const KCAL_SOURCE_URL = "https://www.efsa.europa.eu/en/efsajournal/pub/3005";
  const KCAL_SOURCE_LABEL = "EFSA – Dietary Reference Values for Energy (2013)";

  function getDailyKcalNeed() {
    if (!state.profile) return 0;
    const p = state.profile;
    const coeff = p.readinessCoeff || 1.0;
    return ((p.adults||0) * KCAL_PER_DAY.adult
          + (p.kids||0)   * KCAL_PER_DAY.kid
          + (p.infants||0)* KCAL_PER_DAY.infant
          + (p.seniors||0)* KCAL_PER_DAY.senior) * coeff;
  }

  function getTotalFoodKcal(item) {
    if (!item.isFoodItem || !item.foodEntries) return 0;
    return item.foodEntries.reduce((sum, e) => sum + ((e.kcal||0) * (e.qty||1)), 0);
  }

  function calcFoodCompletion(item) {
    if (!item.isFoodItem || !state.profile) return 0;
    const d = state.profile.prepDays || 3;
    const totalNeeded = getDailyKcalNeed() * d;
    if (!totalNeeded) return 0;
    return Math.min(100, (getTotalFoodKcal(item) / totalNeeded) * 100);
  }

  // ── Hotovosť – inteligentný kalkulátor ─────────────────────────
  // ECB štúdia "Keep calm and carry cash" (2025) odporúča €70–100 / osobu na 72h
  // Rakúska iniciatíva "Bargeld für alle Fälle": ~€100 / člen domácnosti
  // EU Preparedness Union Strategy (2025): 72h sebestačnosť vrátane hotovosti
  const CASH_PER_PERSON = 100; // € na osobu
  const CASH_SOURCE_URL = "https://cashessentials.org/eu-recommends-including-cash-as-a-crucial-component-of-emergency-kits/";
  const CASH_SOURCE_LABEL = "ECB & EU – Hotovosť ako súčasť núdzového vybavenia (2025)";

  function getRecommendedCash() {
    if (!state.profile) return 0;
    const p = state.profile;
    const totalPersons = (p.adults||0) + (p.kids||0) + (p.infants||0) + (p.seniors||0);
    return totalPersons * CASH_PER_PERSON;
  }

  function getTotalCash(item) {
    if (!item.isCashItem || !item.cashEntries) return 0;
    return item.cashEntries.reduce((sum, e) => sum + ((e.value||0) * (e.qty||1)), 0);
  }

  function calcCashCompletion(item) {
    if (!item.isCashItem || !state.profile) return 0;
    const needed = getRecommendedCash();
    if (!needed) return 0;
    return Math.min(100, (getTotalCash(item) / needed) * 100);
  }

  function categoryScore(catId) {
    const items = state.items[catId] || [];
    if (!items.length) return 0;
    return items.reduce((sum, it) => sum + (it.isWaterItem ? calcWaterCompletion(it) : it.isFoodItem ? calcFoodCompletion(it) : it.isCashItem ? calcCashCompletion(it) : it.done ? 100 : 0), 0) / items.length;
  }

  function overallScore() {
    const { sum, w } = CATEGORIES.reduce((acc, c) => ({
      sum: acc.sum + categoryScore(c.id) * c.weight,
      w: acc.w + c.weight
    }), { sum: 0, w: 0 });
    return w ? sum / w : 0;
  }

  function isValidUrl(u) {
    try { const url = new URL(u); return url.protocol === "https:" || url.protocol === "http:"; } catch { return false; }
  }

  // ── Modal helpers ────────────────────────────────────────────────
  function openModal(id) {
    const overlay = document.getElementById(id);
    overlay.classList.add("open");
    overlay.setAttribute("aria-modal", "true");
    overlay.setAttribute("role", "dialog");
    // Auto-detect label from first heading or title element in modal
    const box = overlay.querySelector(".modal-box");
    if (box) {
      const titleEl = box.querySelector("h3[id], [id*='Title'], [id*='ModalTitle']") || box.querySelector("h3");
      if (titleEl) {
        if (!titleEl.id) titleEl.id = id + "_autoTitle";
        overlay.setAttribute("aria-labelledby", titleEl.id);
      }
    }
    document.body.style.overflow = "hidden";
    // Store the element that opened the modal so we can restore focus
    overlay._previousFocus = document.activeElement;
    // Focus the first focusable element inside the modal (or close button)
    requestAnimationFrame(() => {
      if (box) {
        const firstFocusable = box.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (firstFocusable) firstFocusable.focus();
      }
    });
  }
  function closeModal(id) {
    const overlay = document.getElementById(id);
    overlay.classList.remove("open");
    overlay.removeAttribute("aria-modal");
    overlay.removeAttribute("aria-labelledby");
    // Obnov scroll len ak žiadny iný modal nie je otvorený
    if (!document.querySelector('.modal-overlay.open')) {
      document.body.style.overflow = "";
    }
    // Restore focus to the element that opened the modal
    if (overlay._previousFocus && typeof overlay._previousFocus.focus === 'function') {
      overlay._previousFocus.focus();
    }
  }
  document.querySelectorAll("[data-close]").forEach(b => b.onclick = () => closeModal(b.dataset.close));

  // ── Escape key closes topmost modal ──────────────────────────
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const openModals = [...document.querySelectorAll('.modal-overlay.open')];
      if (openModals.length > 0) {
        e.preventDefault();
        closeModal(openModals[openModals.length - 1].id);
      }
    }
  });

  // ── Focus trap: keep Tab cycling within open modal ────────────
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Tab") return;
    const openModal = document.querySelector('.modal-overlay.open');
    if (!openModal) return;
    const box = openModal.querySelector('.modal-box');
    if (!box) return;
    const focusable = [...box.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')].filter(el => {
      return !el.disabled && el.offsetParent !== null;
    });
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first || !box.contains(document.activeElement)) {
        e.preventDefault();
        last.focus();
      }
    } else {
      if (document.activeElement === last || !box.contains(document.activeElement)) {
        e.preventDefault();
        first.focus();
      }
    }
  });

  // ── Swipe-to-dismiss for mobile modals ─────────────────────
  (function() {
    const THRESHOLD = 80;
    const VELOCITY_THRESHOLD = 0.5;
    let startY = 0, currentY = 0, startTime = 0, activeBox = null, activeOverlay = null;

    document.addEventListener("touchstart", (e) => {
      const overlay = e.target.closest(".modal-overlay.open");
      if (!overlay) return;
      const box = overlay.querySelector(".modal-box");
      if (!box) return;
      // ONLY start swipe from the handle area (top 32px of modal = the ::before bar)
      const touch = e.touches[0];
      const boxRect = box.getBoundingClientRect();
      const touchInHandle = touch.clientY - boxRect.top < 32;
      if (!touchInHandle) return;
      startY = touch.clientY;
      currentY = startY;
      startTime = Date.now();
      activeBox = box;
      activeOverlay = overlay;
      activeBox.style.transition = "none";
    }, { passive: true });

    document.addEventListener("touchmove", (e) => {
      if (!activeBox) return;
      currentY = e.touches[0].clientY;
      const dy = currentY - startY;
      if (dy > 0) {
        activeBox.style.transform = `translateY(${dy}px)`;
        activeOverlay.style.background = `rgba(0,0,0,${Math.max(0, 0.4 - dy * 0.002)})`;
      }
    }, { passive: true });

    document.addEventListener("touchend", () => {
      if (!activeBox) return;
      const dy = currentY - startY;
      const dt = Date.now() - startTime;
      const velocity = dy / Math.max(dt, 1);
      if (dy > THRESHOLD || velocity > VELOCITY_THRESHOLD) {
        activeBox.style.transition = "transform 0.25s ease-out";
        activeBox.style.transform = `translateY(100%)`;
        activeOverlay.style.transition = "background 0.25s";
        activeOverlay.style.background = "rgba(0,0,0,0)";
        const overlayId = activeOverlay.id;
        setTimeout(() => {
          closeModal(overlayId);
          const box = document.querySelector(`#${overlayId} .modal-box`);
          if (box) { box.style.transform = ""; box.style.transition = ""; }
          const ov = document.getElementById(overlayId);
          if (ov) { ov.style.background = ""; ov.style.transition = ""; }
        }, 260);
      } else {
        activeBox.style.transition = "transform 0.2s ease";
        activeBox.style.transform = "";
        activeOverlay.style.transition = "background 0.2s";
        activeOverlay.style.background = "";
      }
      activeBox = null;
      activeOverlay = null;
    }, { passive: true });
  })();
  function makeAccessibleCard(el, label, handler) {
    el.setAttribute("tabindex", "0");
    el.setAttribute("role", "button");
    el.setAttribute("aria-label", label);
    el.onclick = handler;
    el.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        handler();
      }
    };
  }

  // ── Render ───────────────────────────────────────────────────────

  // ── Slovak Progress Milestones ─────────────────────────────
  function getMilestoneHtml(pct) {
    let msg = "";
    if (pct <= 5) return "";
    if (pct < 25) msg = "Každý krok sa počíta";
    else if (pct < 50) msg = "Prvý krok na Rysy — základ stojí";
    else if (pct < 75) msg = "Pol cesty na Kriváň — ste ďalej než väčšina";
    else if (pct < 100) msg = "Sedlo pod Gerlachom — už len kúsok";
    else msg = "Na vrchole Gerlachu! 🇸🇰";
    return `<div class="hero-milestone">${msg}</div>`;
  }

  // ── Confetti (Slovak flag colors) ──────────────────────────
  let confettiTriggered = false;
  function triggerSlovakConfetti() {
    if (confettiTriggered) return;
    confettiTriggered = true;
    const canvas = document.createElement('canvas');
    canvas.id = 'confettiCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const colors = ['#ffffff', '#0b4ea2', '#ee1c25', '#ffffff', '#0b4ea2', '#ee1c25', '#ffd700'];
    const particles = [];
    for (let i = 0; i < 150; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        w: Math.random() * 8 + 4,
        h: Math.random() * 6 + 3,
        color: colors[Math.floor(Math.random() * colors.length)],
        vx: (Math.random() - 0.5) * 3,
        vy: Math.random() * 3 + 2,
        rot: Math.random() * Math.PI * 2,
        vr: (Math.random() - 0.5) * 0.15,
        opacity: 1
      });
    }

    let frame = 0;
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let alive = false;
      particles.forEach(p => {
        if (p.opacity <= 0) return;
        alive = true;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.vy += 0.05;
        if (frame > 120) p.opacity -= 0.015;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.globalAlpha = Math.max(0, p.opacity);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
      });
      frame++;
      if (alive && frame < 300) {
        requestAnimationFrame(animate);
      } else {
        canvas.remove();
        // Reset after some time so it can trigger again if user drops below and returns
        setTimeout(() => { confettiTriggered = false; }, 60000);
      }
    }
    animate();
  }

  // ── Easter Egg: Tatry Panorama (5 clicks on logo) ─────────
  let logoClicks = 0;
  let logoClickTimer = null;
  function setupLogoEasterEgg() {
    const logo = document.getElementById('headerLogo');
    if (!logo) return;
    logo.onclick = () => {
      logoClicks++;
      clearTimeout(logoClickTimer);
      logoClickTimer = setTimeout(() => { logoClicks = 0; }, 2000);
      if (logoClicks >= 5) {
        logoClicks = 0;
        showTatryEasterEgg();
      }
    };
  }

  function showTatryEasterEgg() {
    let el = document.getElementById('tatryEasterEgg');
    if (!el) {
      el = document.createElement('div');
      el.id = 'tatryEasterEgg';
      el.className = 'easter-tatry';
      el.innerHTML = `
        <svg class="easter-tatry-mountains" viewBox="0 0 800 200" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="mt1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#8fa4bf"/><stop offset="100%" stop-color="#4a6fa5"/></linearGradient>
            <linearGradient id="mt2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a0b4c8"/><stop offset="100%" stop-color="#5a7fb5"/></linearGradient>
            <linearGradient id="snow" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="white"/><stop offset="100%" stop-color="#c8d8e8"/></linearGradient>
          </defs>
          <!-- Back range -->
          <path d="M0 200 L50 120 L100 140 L180 70 L250 110 L320 50 L380 85 L430 30 L480 75 L530 45 L580 90 L640 60 L700 100 L750 75 L800 110 L800 200Z" fill="url(#mt1)" opacity="0.6"/>
          <!-- Front range -->
          <path d="M0 200 L80 130 L140 150 L220 80 L280 120 L350 55 L400 90 L450 35 L500 80 L550 50 L610 100 L660 70 L720 115 L780 90 L800 105 L800 200Z" fill="url(#mt2)"/>
          <!-- Snow caps -->
          <path d="M430 30 L445 50 L450 35 L460 55 L480 75 L470 60 L455 48 L440 55 L425 45Z" fill="url(#snow)" opacity="0.9"/>
          <path d="M350 55 L365 72 L370 60 L380 75 L380 85 L370 70 L358 65Z" fill="url(#snow)" opacity="0.8"/>
          <path d="M530 45 L545 62 L550 50 L560 68 L570 80 L555 65 L540 58Z" fill="url(#snow)" opacity="0.8"/>
          <!-- Stars -->
          <circle cx="100" cy="30" r="1.5" fill="white" opacity="0.8"/>
          <circle cx="250" cy="15" r="1" fill="white" opacity="0.6"/>
          <circle cx="600" cy="20" r="1.5" fill="white" opacity="0.7"/>
          <circle cx="700" cy="35" r="1" fill="white" opacity="0.5"/>
          <circle cx="400" cy="10" r="2" fill="white" opacity="0.9"/>
        </svg>
        <div class="easter-tatry-quote">„Kto raz bol na Gerlachu,<br>zvládne všetko.”</div>
        <div class="easter-tatry-sub">Klikni kamkoľvek pre návrat</div>
      `;
      el.onclick = () => el.classList.remove('visible');
      document.body.appendChild(el);
    }
    el.classList.add('visible');
  }

  // ── Tab Navigation ─────────────────────────────────────────
  function switchTab(tabName) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    const paneMap = { preparation: 'tabPreparation', knowledge: 'tabKnowledge', plan: 'tabPlan', contacts: 'tabContacts' };
    const paneId = paneMap[tabName] || 'tabPreparation';
    document.getElementById(paneId).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.tab === tabName);
    });
    document.querySelectorAll('.header-tab-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.tab === tabName);
    });
    trackEvent('tab_switch', { tab: tabName });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  window.switchTab = switchTab;

  // ── Hero Banner (merged profile + progress) ────────────────
  function renderHeroBanner() {
    const box = document.getElementById("heroBanner");
    const onb = document.getElementById("onboardingCard");
    const catSection = document.getElementById("categoriesSection");

    if (!state.profile) {
      box.style.display = "none";
      if (onb) onb.style.display = "block";
      if (catSection) catSection.style.display = "none";
      return;
    }

    box.style.display = "block";
    if (onb) onb.style.display = "none";
    if (catSection) catSection.style.display = "block";

    const p = state.profile;
    const pct = overallScore();
    const col = colorForPct(pct);
    const rank = rankForPct(pct);
    const emoji = emojiForPct(pct);
    const d = p.prepDays || 3;
    const totalPersons = (p.adults||0)+(p.kids||0)+(p.infants||0)+(p.seniors||0);
    const housingMap = { flat: "Byt", rd: "Rodinný dom", rd_cellar: "RD + pivnica" };
    const budgetMap = { mid: "Základná", premium: "Prémiová" };

    box.innerHTML = `
      <div class="hero-top">
        <div class="hero-rank"><span>${rank}</span></div>
        <div style="display:flex; align-items:center; gap:0.75rem;">
          <span class="hero-pct" style="color:${col};">${Math.round(pct)}%</span>
          <button class="btn-ghost" id="btnEditProfile" style="font-size:0.78rem; padding:0.375rem 0.75rem;">Upraviť ⚙️</button>
        </div>
      </div>
      <div class="progress-bar" style="height:10px; position:relative; z-index:1;">
        <div class="progress-fill" style="width:${Math.round(pct)}%; background:${col};"></div>
      </div>
      ${getMilestoneHtml(pct)}
      <div class="hero-meta">
        <span class="hero-tag">👥 ${totalPersons} ${totalPersons === 1 ? "osoba" : totalPersons < 5 ? "osoby" : "osôb"}</span>
        <span class="hero-tag">📅 ${d} ${d === 1 ? "deň" : d < 5 ? "dni" : "dní"}</span>
        <span class="hero-tag">🏠 ${housingMap[p.housing] || "–"}</span>
        <span class="hero-tag">💰 ${budgetMap[p.budget] || "–"}</span>
      </div>`;

    // Re-bind edit profile button
    document.getElementById("btnEditProfile").onclick = openProfileEditor;
  }

  function renderProfileCard() { renderHeroBanner(); }

  function renderOverall() {
    const pct = overallScore();
    const col = colorForPct(pct);
    const mobBar = document.getElementById("overallBarMobile");
    const mobPct = document.getElementById("overallPctMobile");
    if (mobBar) { mobBar.style.width = Math.min(100, pct) + "%"; mobBar.style.background = col; }
    if (mobPct) { mobPct.textContent = Math.round(pct) + "%"; mobPct.style.color = col; }
  }

  function renderCategories() {
    const grid = document.getElementById("categoriesGrid");
    grid.innerHTML = "";
    for (const c of CATEGORIES) {
      const pct = categoryScore(c.id);
      const isSel = state.selectedCategoryId === c.id;
      const col = colorForPct(pct);
      // Dynamická farba karty podľa % - jemný tint pozadia a border
      const hue = Math.round((Math.min(100, Math.max(0, pct)) / 100) * 120);
      const cardBg = pct === 0 ? "var(--c-surface)" : `hsl(${hue} 60% 97%)`;
      const cardBorder = isSel
        ? `hsl(${hue} 65% ${pct === 0 ? 55 : 48}%)`
        : pct === 0 ? "var(--c-border)" : `hsl(${hue} 50% 82%)`;
      const cardShadow = isSel
        ? `0 10px 28px hsl(${hue} 60% 40% / 0.18)`
        : "0 1px 3px rgba(0,0,0,0.04)";

      const card = document.createElement("div");
      card.className = "cat-card" + (isSel ? " selected" : "");
      card.style.cssText = `background:${cardBg}; border-color:${cardBorder}; box-shadow:${cardShadow};`;
      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem;">
          <div style="font-size:1.375rem;">${c.emoji}</div>
          <span style="font-size:1.125rem; font-weight:800; color:${col}; letter-spacing:-0.02em;">${Math.round(pct)}%</span>
        </div>
        <div style="font-weight:700; font-size:0.9375rem; margin-bottom:0.2rem; color:var(--c-text);">${c.name}</div>
        <div style="font-size:0.72rem; color:${pct === 0 ? 'var(--c-muted)' : col}; margin-bottom:0.625rem; font-weight:500;">splnené na ${Math.round(pct)}%</div>
        <div class="progress-bar" style="height:6px;">
          <div class="progress-fill" style="width:${Math.min(100,pct)}%; background:${col};"></div>
        </div>`;
      card.onclick = () => {
        state.selectedCategoryId = c.id;
        scheduleSave();
        renderCategories();
        openCategoryModal(c);
      };
      card.setAttribute("tabindex", "0");
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", c.name + " – " + Math.round(pct) + "% splnené");
      card.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          card.onclick();
        }
      };
      grid.appendChild(card);
    }
  }

  // Otvoriť modálne okno kategórie
  function openCategoryModal(cat) {
    renderCategoryDetail();
    openModal("modalCategory");
  }

  function renderCategoryDetail() {
    const catId = state.selectedCategoryId;
    const cat = CATEGORIES.find(c => c.id === catId);
    const items = state.items[catId] || [];
    const pct = categoryScore(catId);
    const detail = document.getElementById("categoryDetail");
    detail.innerHTML = "";

    // Hide "Pridať položku" button for categories with smart trackers
    const addBtn = document.getElementById("btnAddItem");
    if (addBtn) addBtn.style.display = (catId === "food" || catId === "water" || catId === "cash") ? "none" : "flex";

    // Aktualizuj modal header
    const modalHeader = document.getElementById("modalCatHeader");
    if (modalHeader) {
      modalHeader.innerHTML = `
        <div style="display:flex; align-items:center; gap:0.875rem;">
          <div style="font-size:1.5rem;">${cat.emoji}</div>
          <div>
            <div style="font-size:1.125rem; font-weight:800; letter-spacing:-0.01em; line-height:1.2;">${cat.name}</div>
            <div style="font-size:0.78rem; color:var(--c-muted); margin-top:0.125rem;">${items.filter(i=>i.isWaterItem ? calcWaterCompletion(i)>=100 : i.isFoodItem ? calcFoodCompletion(i)>=100 : i.isCashItem ? calcCashCompletion(i)>=100 : i.done).length} / ${items.length} hotovo</div>
          </div>
          <div style="margin-left:auto; text-align:right; padding-right:0.5rem; line-height:1.1;">
            <div style="font-size:0.72rem; color:var(--c-muted);">splnené na</div>
            <div style="font-size:1.625rem; font-weight:800; color:${colorForPct(pct)}; letter-spacing:-0.03em;">${Math.round(pct)}%</div>
          </div>
        </div>
        <div style="margin-top:0.75rem;">
          <div class="progress-bar" style="height:6px;">
            <div class="progress-fill" style="width:${Math.min(100,pct)}%; background:${colorForPct(pct)};"></div>
          </div>
        </div>`;
    }

    // Progress v footer
    const modalProgress = document.getElementById("modalCatProgress");
    if (modalProgress) {
      modalProgress.textContent = `${items.filter(i=>i.isWaterItem ? calcWaterCompletion(i)>=100 : i.isFoodItem ? calcFoodCompletion(i)>=100 : i.isCashItem ? calcCashCompletion(i)>=100 : i.done).length} z ${items.length} položiek splnených`;
    }

    const list = document.createElement("div");
    list.style.cssText = "display:flex; flex-direction:column; gap:0.5rem;";

    // Docs category: info banner about storage strategy
    if (catId === "docs") {
      const banner = document.createElement("div");
      banner.innerHTML = `
        <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:1rem;">
          <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
            <span>💡 Kde uchovávať dokumenty?</span>
            <span class="info-collapse-arrow">▼</span>
          </button>
          <div class="info-collapse-body" style="font-size:0.78rem; color:var(--c-text); line-height:1.5;">
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:0.375rem; font-size:0.72rem; line-height:1.5;">
              <div style="background:white; border-radius:0.5rem; padding:0.5rem 0.625rem; border:1px solid var(--c-info-border);">
                <strong>📁 Originál</strong><br>
                <span style="color:var(--c-muted);">Doma v bezpečnom mieste (trezor, ohnivzdorná schránka)</span>
              </div>
              <div style="background:white; border-radius:0.5rem; padding:0.5rem 0.625rem; border:1px solid var(--c-info-border);">
                <strong>📄 Kópia</strong><br>
                <span style="color:var(--c-muted);">Papierová kópia v evakuačnom batohu + u príbuzných</span>
              </div>
              <div style="background:white; border-radius:0.5rem; padding:0.5rem 0.625rem; border:1px solid var(--c-info-border);">
                <strong>💾 USB</strong><br>
                <span style="color:var(--c-muted);">Šifrovaný USB kľúč v batohu – scany všetkých dokumentov</span>
              </div>
              <div style="background:white; border-radius:0.5rem; padding:0.5rem 0.625rem; border:1px solid var(--c-info-border);">
                <strong>☁️ Cloud</strong><br>
                <span style="color:var(--c-muted);">Šifrované úložisko (Google Drive, iCloud) – prístup odkiaľkoľvek</span>
              </div>
            </div>
            <div style="margin-top:0.5rem; font-size:0.7rem; color:var(--c-muted); line-height:1.5; font-style:italic;">
              ⚠️ Crypto seed / recovery frázy NIKDY nescanovať a neukladať digitálne! Iba papier na 2 odlišných miestach.
            </div>
          </div>
        </div>`;
      list.appendChild(banner);
    }

    // Source info banner - collapsible, placed at bottom
    let srcBannerEl = null;
    if (catId !== "docs" && CATEGORY_SOURCES[catId]) {
      const src = CATEGORY_SOURCES[catId];
      srcBannerEl = document.createElement("div");
      const linksHtml = src.sources.map(s =>
        `<div style="padding:0.125rem 0;">→ <a href="${s.url}" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:underline;">${s.label}</a></div>`
      ).join("");
      srcBannerEl.innerHTML = `
        <div style="margin-top:1rem;">
          <button class="source-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('open') ? 'rotate(180deg)' : ''">
            💡 Zdroje odporúčaní <span class="arrow">▼</span>
          </button>
          <div class="source-body">
            <div style="padding:0.375rem 0; line-height:1.5;">
              <div style="margin-bottom:0.25rem; font-size:0.65rem; color:var(--c-muted);">${src.note}</div>
              ${linksHtml}
            </div>
          </div>
        </div>`;
    }

    if (!items.length) {
      list.innerHTML = `<p style="color:var(--c-muted); font-size:0.875rem;">Zatiaľ žiadne položky.</p>`;
    } else {
      let lastDocGroup = "";
      items.forEach((it, idx) => {
        // Group headers for docs category
        if (catId === "docs" && it.docGroup && it.docGroup !== lastDocGroup) {
          lastDocGroup = it.docGroup;
          const groupEmojis = { "Osobné dokumenty": "🪪", "Majetok a bývanie": "🏠", "Auto a doprava": "🚗", "Vzdelanie a práca": "🎓", "Financie": "💰", "Zdravotné dokumenty": "🏥", "Krízové dokumenty": "🚨" };
          const gh = document.createElement("div");
          gh.style.cssText = "padding:0.625rem 0 0.25rem; margin-top:0.375rem;";
          gh.innerHTML = `<div style="font-size:0.72rem; font-weight:700; color:var(--c-muted); text-transform:uppercase; letter-spacing:0.05em;">${groupEmojis[it.docGroup]||"📋"} ${it.docGroup}</div>`;
          list.appendChild(gh);
        }
        if (it.isWaterItem && state.profile) {
          const p = state.profile;
          const d = p.prepDays || 3;
          const dailyNeed = getDailyWaterNeed();
          const total = dailyNeed * d;
          const current = getTotalWaterLiters(it);
          const wpct = calcWaterCompletion(it);
          const wCol = colorForPct(wpct);
          const entries = it.waterEntries || [];

          // Duration calculation
          const totalHours = dailyNeed > 0 ? (current / dailyNeed) * 24 : 0;
          const durDays = Math.floor(totalHours / 24);
          const durHours = Math.round(totalHours % 24);

          let durText = "";
          if (current === 0) {
            durText = "Žiadna zásoba";
          } else if (totalHours < 24) {
            const h = Math.round(totalHours);
            durText = h <= 0 ? "Menej ako hodinu" : h === 1 ? "1 hodinu" : h < 5 ? h + " hodiny" : h + " hodín";
          } else {
            const dayWord = durDays === 1 ? "deň" : durDays < 5 ? "dni" : "dní";
            const hourPart = durHours > 0 ? (" a " + durHours + (durHours === 1 ? " hodinu" : durHours < 5 ? " hodiny" : " hodín")) : "";
            durText = durDays + " " + dayWord + hourPart;
          }
          const durPct = Math.min(100, (totalHours / (d * 24)) * 100);
          const durHue = Math.round((Math.min(100, Math.max(0, durPct)) / 100) * 120);
          const durColor = `hsl(${durHue} 70% 34%)`;
          const durBg = `hsl(${durHue} 70% 96%)`;
          const durBorder = `hsl(${durHue} 60% 80%)`;

          // Water breakdown per person type
          const waterBreakdown = [];
          if (p.adults) waterBreakdown.push(`${p.adults}× dospelý: 2 l`);
          if (p.kids) waterBreakdown.push(`${p.kids}× dieťa: 1,5 l`);
          if (p.infants) waterBreakdown.push(`${p.infants}× batoľa: 1 l`);
          if (p.seniors) waterBreakdown.push(`${p.seniors}× senior: 2 l`);

          // Water entries HTML
          let wEntriesHtml = "";
          if (entries.length === 0) {
            wEntriesHtml = `<div style="text-align:center; padding:1rem 0; color:var(--c-muted); font-size:0.82rem;">Zatiaľ žiadna voda. Pridajte prvú položku nižšie.</div>`;
          } else {
            wEntriesHtml = entries.map((e, ei) => {
              const eExp = e.expiry ? daysUntil(e.expiry) : null;
              const catAD = getAlertDaysForCategory("food");
              const eExpBadge = e.expiry
                ? (eExp < 0 ? `<span class="badge badge-red" style="font-size:0.62rem;">EXP</span>`
                  : eExp <= catAD ? `<span class="badge badge-amber" style="font-size:0.62rem;">${eExp}d</span>`
                  : `<span class="badge badge-gray" style="font-size:0.62rem;">${eExp}d</span>`)
                : "";
              const totalE = (e.liters||0)*(e.qty||1);
              return `<div style="display:flex; align-items:center; gap:0.5rem; padding:0.5rem 0.625rem; background:rgba(255,255,255,0.6); border-radius:0.5rem; border:1px solid rgba(59,130,246,0.15);">
                <div style="flex:1; min-width:0;">
                  <div style="font-weight:600; font-size:0.8rem; color:var(--c-text); display:flex; align-items:center; gap:0.375rem; flex-wrap:wrap;">
                    ${esc(e.name)} ${eExpBadge}
                  </div>
                  <div style="font-size:0.7rem; color:var(--c-muted); margin-top:0.125rem;">
                    ${e.qty||1}× ${(e.liters||0)} l = <strong>${totalE.toFixed(1)} l</strong>${e.expiry ? " • " + e.expiry : ""}
                  </div>
                </div>
                <button class="btn-ghost" style="padding:0.25rem 0.5rem; font-size:0.7rem;" data-water-edit="${idx}:${ei}">✏️</button>
                <button style="background:none; border:none; cursor:pointer; font-size:0.85rem; padding:0.25rem; color:#991b1b;" data-water-del="${idx}:${ei}">✕</button>
              </div>`;
            }).join("");
          }

          const row = document.createElement("div");
          row.className = "water-card";
          const missing = Math.max(0, total - current);
          row.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem;">
              <div style="font-weight:700; font-size:1rem;">💧 ${esc(it.name)}</div>
              <span style="font-size:0.95rem; font-weight:700; color:${wCol}; flex-shrink:0;">${Math.round(wpct)}%</span>
            </div>

            <div class="tracker-summary">
              <div class="tracker-stat" style="border:1.5px solid #bfdbfe;">
                <div class="tracker-stat-label" style="color:#2563eb;">Potrebné</div>
                <div class="tracker-stat-value" style="color:#1e3a8a;">${total.toFixed(1)}</div>
                <div class="tracker-stat-unit">litrov na ${d} ${d===1?"deň":d<5?"dni":"dní"}</div>
              </div>
              <div class="tracker-stat" style="border:1.5px solid ${wpct >= 100 ? '#86efac' : '#fcd34d'};">
                <div class="tracker-stat-label" style="color:${wpct >= 100 ? 'var(--c-success)' : 'var(--c-amber)'};">Máte</div>
                <div class="tracker-stat-value" style="color:${wpct >= 100 ? '#166534' : '#92400e'};">${current.toFixed(1)}</div>
                <div class="tracker-stat-unit">litrov</div>
              </div>
              <div class="tracker-stat" style="border:1.5px solid ${missing > 0 ? 'var(--c-error-border)' : 'var(--c-success-border)'};">
                <div class="tracker-stat-label" style="color:${missing > 0 ? 'var(--c-error)' : 'var(--c-success)'};">${missing > 0 ? 'Chýba' : 'Splnené ✓'}</div>
                <div class="tracker-stat-value" style="color:${missing > 0 ? '#991b1b' : '#166534'};">${missing > 0 ? missing.toFixed(1) : '—'}</div>
                <div class="tracker-stat-unit">${missing > 0 ? 'litrov' : ''}</div>
              </div>
            </div>

            <div class="progress-bar" style="margin-bottom:0.5rem; height:10px;">
              <div class="progress-fill" style="width:${Math.min(100,wpct)}%; background:${colorForPct(wpct)};"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:0.875rem; font-size:0.68rem; color:var(--c-muted);">
              <span>Vydrží na: <strong style="color:${durColor};">${durText}</strong></span>
              <span>${dailyNeed.toFixed(1)} l/deň (${waterBreakdown.join(", ")})</span>
            </div>

            <!-- Water entries list -->
            <div style="display:flex; flex-direction:column; gap:0.375rem; margin-bottom:0.875rem;" id="waterEntriesList_${idx}">
              ${wEntriesHtml}
            </div>

            <!-- Add water entry form -->
            <div style="background:rgba(255,255,255,0.7); border-radius:0.75rem; padding:0.75rem; border:1px dashed #93c5fd;">
              <div style="font-size:0.75rem; font-weight:600; color:#1e40af; margin-bottom:0.5rem;">+ Pridať vodu</div>
              <div style="display:grid; grid-template-columns:1fr; gap:0.5rem;">
                <input type="text" placeholder="Názov (napr. Fľaša 1,5 l, Kanister 5 l)" id="we_name_${idx}" style="font-size:0.82rem; padding:0.5rem 0.75rem;" required />
                <div class="tracker-form-grid">
                  <div>
                    <label class="item-sublabel">Litrov / kus *</label>
                    <input type="number" min="0" step="0.1" placeholder="1.5" id="we_liters_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem; width:100%;" required />
                  </div>
                  <div>
                    <label class="item-sublabel">Počet</label>
                    <input type="number" min="1" value="1" id="we_qty_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem; width:100%;" />
                  </div>
                  <div class="tracker-form-full">
                    <label class="item-sublabel">Expirácia *</label>
                    <input type="date" id="we_exp_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem; width:100%;" required />
                  </div>
                </div>
                <button class="btn-primary" style="padding:0.5rem 1rem; font-size:0.82rem; width:100%;" id="we_add_${idx}">Pridať do zásob</button>
              </div>
            </div>

            <!-- Source (collapsible) -->
            <div style="margin-top:0.75rem;">
              <button class="source-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('open') ? 'rotate(180deg)' : ''">
                💡 Zdroj výpočtu <span class="arrow">▼</span>
              </button>
              <div class="source-body">
                <a href="${WATER_SOURCE_URL}" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:underline;">${WATER_SOURCE_LABEL}</a>
              </div>
            </div>`;
          list.appendChild(row);

          // Bind water entry actions
          setTimeout(() => {
            // Add entry
            const addBtn = document.getElementById(`we_add_${idx}`);
            if (addBtn) addBtn.onclick = () => {
              const nameInp = document.getElementById(`we_name_${idx}`);
              const litersInp = document.getElementById(`we_liters_${idx}`);
              const qtyInp = document.getElementById(`we_qty_${idx}`);
              const expInp = document.getElementById(`we_exp_${idx}`);
              const eName = (nameInp.value||"").trim();
              const eLiters = Number(litersInp.value)||0;
              const eExpiry = (expInp.value||"").trim();
              if (!eName || !eLiters || !eExpiry) { showValidation("Vyplňte všetky povinné polia: názov, litrov a expiráciu."); return; }
              if (!state.items[catId][idx].waterEntries) state.items[catId][idx].waterEntries = [];
              state.items[catId][idx].waterEntries.push({
                name: eName,
                liters: eLiters,
                qty: Number(qtyInp.value)||1,
                expiry: expInp.value||""
              });
              scheduleSave(); renderAll();
            };
            // Delete entries
            row.querySelectorAll("[data-water-del]").forEach(btn => {
              btn.onclick = () => {
                const [itemI, entryI] = btn.dataset.waterDel.split(":").map(Number);
                if (state.items[catId][itemI] && state.items[catId][itemI].waterEntries) {
                  state.items[catId][itemI].waterEntries.splice(entryI, 1);
                  scheduleSave(); renderAll();
                }
              };
            });
            // Edit entries
            row.querySelectorAll("[data-water-edit]").forEach(btn => {
              btn.onclick = () => {
                const [itemI, entryI] = btn.dataset.waterEdit.split(":").map(Number);
                const entry = state.items[catId][itemI]?.waterEntries?.[entryI];
                if (!entry) return;
                openWaterEditModal(catId, itemI, entryI, entry);
              };
            });
          }, 0);
          return;
        }

        // ── FOOD CARD (intelligent calorie tracker) ──────────────
        if (it.isFoodItem && state.profile) {
          const p = state.profile;
          const d = p.prepDays || 3;
          const dailyKcal = getDailyKcalNeed();
          const totalNeeded = dailyKcal * d;
          const currentKcal = getTotalFoodKcal(it);
          const fpct = calcFoodCompletion(it);
          const fCol = colorForPct(fpct);
          const entries = it.foodEntries || [];

          // Duration calculation
          const totalHoursFood = dailyKcal > 0 ? (currentKcal / dailyKcal) * 24 : 0;
          const fDurDays = Math.floor(totalHoursFood / 24);
          const fDurHours = Math.round(totalHoursFood % 24);

          let fDurText = "";
          if (currentKcal === 0) {
            fDurText = "Žiadna zásoba";
          } else if (totalHoursFood < 24) {
            const h = Math.round(totalHoursFood);
            fDurText = h <= 0 ? "Menej ako hodinu" : h === 1 ? "1 hodinu" : h < 5 ? h + " hodiny" : h + " hodín";
          } else {
            const dayW = fDurDays === 1 ? "deň" : fDurDays < 5 ? "dni" : "dní";
            const hourP = fDurHours > 0 ? (" a " + fDurHours + (fDurHours === 1 ? " hodinu" : fDurHours < 5 ? " hodiny" : " hodín")) : "";
            fDurText = fDurDays + " " + dayW + hourP;
          }
          const fDurPct = Math.min(100, (totalHoursFood / (d * 24)) * 100);
          const fDurHue = Math.round((Math.min(100, Math.max(0, fDurPct)) / 100) * 120);
          const fDurColor = `hsl(${fDurHue} 70% 34%)`;
          const fDurBg = `hsl(${fDurHue} 70% 96%)`;
          const fDurBorder = `hsl(${fDurHue} 60% 80%)`;

          // Kcal breakdown per person type
          const kcalBreakdown = [];
          if (p.adults) kcalBreakdown.push(`${p.adults}× dospelý: ${KCAL_PER_DAY.adult} kcal`);
          if (p.kids) kcalBreakdown.push(`${p.kids}× dieťa: ${KCAL_PER_DAY.kid} kcal`);
          if (p.infants) kcalBreakdown.push(`${p.infants}× batoľa: ${KCAL_PER_DAY.infant} kcal`);
          if (p.seniors) kcalBreakdown.push(`${p.seniors}× senior: ${KCAL_PER_DAY.senior} kcal`);

          // Food entries HTML
          let entriesHtml = "";
          if (entries.length === 0) {
            entriesHtml = `<div style="text-align:center; padding:1rem 0; color:var(--c-muted); font-size:0.82rem;">Zatiaľ žiadne jedlo. Pridajte prvú položku nižšie.</div>`;
          } else {
            entriesHtml = entries.map((e, ei) => {
              const eExp = e.expiry ? daysUntil(e.expiry) : null;
              const catAD = getAlertDaysForCategory("food");
              const eExpBadge = e.expiry
                ? (eExp < 0 ? `<span class="badge badge-red" style="font-size:0.62rem;">EXP</span>`
                  : eExp <= catAD ? `<span class="badge badge-amber" style="font-size:0.62rem;">${eExp}d</span>`
                  : `<span class="badge badge-gray" style="font-size:0.62rem;">${eExp}d</span>`)
                : "";
              const totalE = (e.kcal||0)*(e.qty||1);
              return `<div style="display:flex; align-items:center; gap:0.5rem; padding:0.5rem 0.625rem; background:rgba(255,255,255,0.6); border-radius:0.5rem; border:1px solid rgba(234,124,27,0.15);">
                <div style="flex:1; min-width:0;">
                  <div style="font-weight:600; font-size:0.8rem; color:var(--c-text); display:flex; align-items:center; gap:0.375rem; flex-wrap:wrap;">
                    ${esc(e.name)} ${eExpBadge}
                  </div>
                  <div style="font-size:0.7rem; color:var(--c-muted); margin-top:0.125rem;">
                    ${e.qty||1}× ${(e.kcal||0).toLocaleString()} kcal = <strong>${totalE.toLocaleString()} kcal</strong>${e.expiry ? " • " + e.expiry : ""}
                  </div>
                </div>
                <button class="btn-ghost" style="padding:0.25rem 0.5rem; font-size:0.7rem;" data-food-edit="${idx}:${ei}">✏️</button>
                <button style="background:none; border:none; cursor:pointer; font-size:0.85rem; padding:0.25rem; color:#991b1b;" data-food-del="${idx}:${ei}">✕</button>
              </div>`;
            }).join("");
          }

          const row = document.createElement("div");
          row.style.cssText = "background:linear-gradient(135deg, #fef7ed 0%, #fef3c7 100%); border:1.5px solid #fcd34d; border-radius:1rem; padding:1.25rem;";
          const missingKcal = Math.max(0, totalNeeded - currentKcal);
          row.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem;">
              <div style="font-weight:700; font-size:1rem;">🍽️ ${esc(it.name)}</div>
              <span style="font-size:0.95rem; font-weight:700; color:${fCol}; flex-shrink:0;">${Math.round(fpct)}%</span>
            </div>

            <div class="tracker-summary">
              <div class="tracker-stat" style="border:1.5px solid #fcd34d;">
                <div class="tracker-stat-label" style="color:#b45309;">Potrebné</div>
                <div class="tracker-stat-value" style="color:#78350f;">${totalNeeded.toLocaleString()}</div>
                <div class="tracker-stat-unit">kcal na ${d} ${d===1?"deň":d<5?"dni":"dní"}</div>
              </div>
              <div class="tracker-stat" style="border:1.5px solid ${fpct >= 100 ? '#86efac' : '#fcd34d'};">
                <div class="tracker-stat-label" style="color:${fpct >= 100 ? 'var(--c-success)' : 'var(--c-amber)'};">Máte</div>
                <div class="tracker-stat-value" style="color:${fpct >= 100 ? '#166534' : '#92400e'};">${currentKcal.toLocaleString()}</div>
                <div class="tracker-stat-unit">kcal</div>
              </div>
              <div class="tracker-stat" style="border:1.5px solid ${missingKcal > 0 ? 'var(--c-error-border)' : 'var(--c-success-border)'};">
                <div class="tracker-stat-label" style="color:${missingKcal > 0 ? 'var(--c-error)' : 'var(--c-success)'};">${missingKcal > 0 ? 'Chýba' : 'Splnené ✓'}</div>
                <div class="tracker-stat-value" style="color:${missingKcal > 0 ? '#991b1b' : '#166534'};">${missingKcal > 0 ? missingKcal.toLocaleString() : '—'}</div>
                <div class="tracker-stat-unit">${missingKcal > 0 ? 'kcal' : ''}</div>
              </div>
            </div>

            <div class="progress-bar" style="margin-bottom:0.5rem; height:10px;">
              <div class="progress-fill" style="width:${Math.min(100,fpct)}%; background:${colorForPct(fpct)};"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:0.875rem; font-size:0.68rem; color:var(--c-muted);">
              <span>Vydrží na: <strong style="color:${fDurColor};">${fDurText}</strong></span>
              <span>${dailyKcal.toLocaleString()} kcal/deň</span>
            </div>

            <!-- Food entries list -->
            <div style="display:flex; flex-direction:column; gap:0.375rem; margin-bottom:0.875rem;" id="foodEntriesList_${idx}">
              ${entriesHtml}
            </div>

            <!-- Add food entry form -->
            <div style="background:rgba(255,255,255,0.7); border-radius:0.75rem; padding:0.75rem; border:1px dashed #fbbf24;">
              <div style="font-size:0.75rem; font-weight:600; color:#92400e; margin-bottom:0.5rem;">+ Pridať jedlo</div>
              <div style="display:grid; grid-template-columns:1fr; gap:0.5rem;">
                <input type="text" placeholder="Názov (napr. Fazuľa v konzerve)" id="fe_name_${idx}" style="font-size:0.82rem; padding:0.5rem 0.75rem;" required />
                <div class="tracker-form-grid">
                  <div>
                    <label class="item-sublabel">kcal / kus *</label>
                    <input type="number" min="0" placeholder="350" id="fe_kcal_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem; width:100%;" required />
                  </div>
                  <div>
                    <label class="item-sublabel">Počet</label>
                    <input type="number" min="1" value="1" id="fe_qty_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem; width:100%;" />
                  </div>
                  <div class="tracker-form-full">
                    <label class="item-sublabel">Expirácia *</label>
                    <input type="date" id="fe_exp_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem; width:100%;" required />
                  </div>
                </div>
                <button class="btn-primary" style="padding:0.5rem 1rem; font-size:0.82rem; width:100%;" id="fe_add_${idx}">Pridať do zásob</button>
              </div>
            </div>

            <!-- Source (collapsible) -->
            <div style="margin-top:0.75rem;">
              <button class="source-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('open') ? 'rotate(180deg)' : ''">
                💡 Zdroj výpočtu <span class="arrow">▼</span>
              </button>
              <div class="source-body">
                <a href="${KCAL_SOURCE_URL}" target="_blank" rel="noopener" style="color:#b45309; text-decoration:underline;">${KCAL_SOURCE_LABEL}</a>
              </div>
            </div>`;
          list.appendChild(row);

          // Bind food entry actions
          setTimeout(() => {
            // Add entry
            const addBtn = document.getElementById(`fe_add_${idx}`);
            if (addBtn) addBtn.onclick = () => {
              const nameInp = document.getElementById(`fe_name_${idx}`);
              const kcalInp = document.getElementById(`fe_kcal_${idx}`);
              const qtyInp = document.getElementById(`fe_qty_${idx}`);
              const expInp = document.getElementById(`fe_exp_${idx}`);
              const eName = (nameInp.value||"").trim();
              const eKcal = Number(kcalInp.value)||0;
              const eExpiry = (expInp.value||"").trim();
              if (!eName || !eKcal || !eExpiry) { showValidation("Vyplňte všetky povinné polia: názov, kalórie a expiráciu."); return; }
              if (!state.items[catId][idx].foodEntries) state.items[catId][idx].foodEntries = [];
              state.items[catId][idx].foodEntries.push({
                name: eName,
                kcal: eKcal,
                qty: Number(qtyInp.value)||1,
                expiry: expInp.value||""
              });
              scheduleSave(); renderAll();
            };
            // Delete entries
            row.querySelectorAll("[data-food-del]").forEach(btn => {
              btn.onclick = () => {
                const [itemI, entryI] = btn.dataset.foodDel.split(":").map(Number);
                if (state.items[catId][itemI] && state.items[catId][itemI].foodEntries) {
                  state.items[catId][itemI].foodEntries.splice(entryI, 1);
                  scheduleSave(); renderAll();
                }
              };
            });
            // Edit entries
            row.querySelectorAll("[data-food-edit]").forEach(btn => {
              btn.onclick = () => {
                const [itemI, entryI] = btn.dataset.foodEdit.split(":").map(Number);
                const entry = state.items[catId][itemI]?.foodEntries?.[entryI];
                if (!entry) return;
                openFoodEditModal(catId, itemI, entryI, entry);
              };
            });
          }, 0);
          return;
        }

        // ── CASH CARD (intelligent cash tracker) ─────────────────
        if (it.isCashItem && state.profile) {
          const p = state.profile;
          const totalPersons = (p.adults||0) + (p.kids||0) + (p.infants||0) + (p.seniors||0);
          const recommended = getRecommendedCash();
          const currentCash = getTotalCash(it);
          const cpct = calcCashCompletion(it);
          const cCol = colorForPct(cpct);
          const entries = it.cashEntries || [];

          // Entries HTML
          let cEntriesHtml = "";
          if (entries.length === 0) {
            cEntriesHtml = `<div style="text-align:center; padding:1rem 0; color:var(--c-muted); font-size:0.82rem;">Zatiaľ žiadna hotovosť. Pridajte bankovky a mince nižšie.</div>`;
          } else {
            // Group by type
            const bankovky = entries.filter(e => e.type === "bankovka");
            const mince = entries.filter(e => e.type === "minca");
            const renderGroup = (groupEntries, label, emoji) => {
              if (!groupEntries.length) return "";
              const groupTotal = groupEntries.reduce((s, e) => s + (e.value||0)*(e.qty||1), 0);
              return `<div style="margin-bottom:0.5rem;">
                <div style="font-size:0.7rem; font-weight:700; color:var(--c-muted); text-transform:uppercase; letter-spacing:0.04em; margin-bottom:0.25rem;">${emoji} ${label} — ${groupTotal.toFixed(2)} €</div>
                ${groupEntries.map((e, ei) => {
                  const realIdx = entries.indexOf(e);
                  const totalE = (e.value||0)*(e.qty||1);
                  return `<div style="display:flex; align-items:center; gap:0.5rem; padding:0.375rem 0.5rem; background:rgba(255,255,255,0.6); border-radius:0.5rem; border:1px solid rgba(42,122,75,0.15); margin-bottom:0.25rem;">
                    <div style="flex:1; min-width:0;">
                      <div style="font-weight:600; font-size:0.78rem; color:var(--c-text);">${(e.value||0)} € × ${e.qty||1}</div>
                      <div style="font-size:0.68rem; color:var(--c-muted);">= ${totalE.toFixed(2)} €</div>
                    </div>
                    <button class="btn-ghost" style="padding:0.25rem 0.5rem; font-size:0.7rem;" data-cash-edit="${idx}:${realIdx}">✏️</button>
                    <button style="background:none; border:none; cursor:pointer; font-size:0.85rem; padding:0.25rem; color:#991b1b;" data-cash-del="${idx}:${realIdx}">✕</button>
                  </div>`;
                }).join("")}
              </div>`;
            };
            cEntriesHtml = renderGroup(bankovky, "Bankovky", "💶") + renderGroup(mince, "Mince", "🪙");
          }

          const row = document.createElement("div");
          row.style.cssText = "background:linear-gradient(135deg, #eaf4ee 0%, #d1fae5 100%); border:1.5px solid #86efac; border-radius:1rem; padding:1.25rem;";
          row.innerHTML = `
            <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:0.875rem; gap:0.75rem;">
              <div style="font-weight:700; font-size:1rem;">💵 ${esc(it.name)}</div>
              <span style="font-size:0.95rem; font-weight:700; color:${cCol}; flex-shrink:0;">${Math.round(cpct)}%</span>
            </div>

            <div class="water-info-grid" style="display:grid; grid-template-columns:1fr auto; gap:0.625rem; margin-bottom:0.875rem; align-items:stretch;">
              <div style="background:rgba(255,255,255,0.7); border-radius:0.625rem; padding:0.625rem 0.75rem;">
                <div style="font-size:0.7rem; color:var(--c-green); font-weight:600; margin-bottom:0.2rem; text-transform:uppercase; letter-spacing:0.04em;">Vaša hotovosť</div>
                <div style="font-size:0.9rem; font-weight:700; color:#14532d;">${currentCash.toFixed(2)} €</div>
                <div style="font-size:0.72rem; color:var(--c-green);">z odporúčaných ${recommended} € (${totalPersons} ${totalPersons === 1 ? "osoba" : totalPersons < 5 ? "osoby" : "osôb"} × ${CASH_PER_PERSON} €)</div>
              </div>
              <div style="background:rgba(255,255,255,0.7); border-radius:0.625rem; padding:0.625rem 0.875rem; min-width:0;">
                <div style="font-size:0.68rem; color:var(--c-green); font-weight:600; margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:0.04em;">Odporúčanie</div>
                <div style="font-size:0.82rem; font-weight:700; color:#14532d; line-height:1.3;">€70–100 / osobu</div>
                <div style="font-size:0.68rem; color:var(--c-green); opacity:0.75; margin-top:0.2rem;">v malých nomináloch</div>
              </div>
            </div>

            <div class="progress-bar" style="margin-bottom:0.75rem; height:10px;">
              <div class="progress-fill" style="width:${Math.min(100,cpct)}%; background:${colorForPct(cpct)};"></div>
            </div>

            <!-- Source (collapsible) -->
            <div style="margin-bottom:0.875rem;">
              <button class="source-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('open') ? 'rotate(180deg)' : ''" style="font-size:0.7rem;">
                💡 Prečo hotovosť? <span class="arrow">▼</span>
              </button>
              <div class="source-body">
                <div style="padding:0.375rem 0; font-size:0.7rem; color:#166534; line-height:1.6;">
                  Pri výpadku elektriny, kybernetických útokoch alebo živelných pohromách platobné terminály nefungujú. ECB odporúča mať doma €70–100 na osobu v malých bankovkách a minciach.
                  <br><a href="${CASH_SOURCE_URL}" target="_blank" rel="noopener" style="color:var(--c-green); text-decoration:underline; font-size:0.65rem;">${CASH_SOURCE_LABEL}</a>
                </div>
              </div>
            </div>

            <!-- Entries -->
            <div style="display:flex; flex-direction:column; gap:0.25rem; margin-bottom:0.875rem;" id="cashEntriesList_${idx}">
              ${cEntriesHtml}
            </div>

            <!-- Add cash entry form -->
            <div style="background:rgba(255,255,255,0.7); border-radius:0.75rem; padding:0.75rem; border:1px dashed #86efac;">
              <div style="font-size:0.75rem; font-weight:600; color:#166534; margin-bottom:0.5rem;">+ Pridať hotovosť</div>
              <div style="display:grid; grid-template-columns:1fr; gap:0.5rem;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                  <div>
                    <label class="item-sublabel">Typ</label>
                    <select id="ce_type_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem;">
                      <option value="bankovka">💶 Bankovka</option>
                      <option value="minca">🪙 Minca</option>
                    </select>
                  </div>
                  <div>
                    <label class="item-sublabel">Hodnota (€)</label>
                    <select id="ce_value_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem;">
                      <optgroup label="Bankovky">
                        <option value="5">5 €</option>
                        <option value="10" selected>10 €</option>
                        <option value="20">20 €</option>
                        <option value="50">50 €</option>
                        <option value="100">100 €</option>
                        <option value="200">200 €</option>
                      </optgroup>
                      <optgroup label="Mince">
                        <option value="0.01">0,01 €</option>
                        <option value="0.02">0,02 €</option>
                        <option value="0.05">0,05 €</option>
                        <option value="0.10">0,10 €</option>
                        <option value="0.20">0,20 €</option>
                        <option value="0.50">0,50 €</option>
                        <option value="1">1 €</option>
                        <option value="2">2 €</option>
                      </optgroup>
                    </select>
                  </div>
                </div>
                <div>
                  <label class="item-sublabel">Počet kusov</label>
                  <input type="number" min="1" value="1" id="ce_qty_${idx}" style="font-size:0.82rem; padding:0.5rem 0.625rem;" />
                </div>
                <button class="btn-primary" style="padding:0.5rem 1rem; font-size:0.82rem; width:100%;" id="ce_add_${idx}">Pridať do zásob</button>
              </div>
            </div>`;
          list.appendChild(row);

          // Bind cash entry actions
          setTimeout(() => {
            const addBtn = document.getElementById(`ce_add_${idx}`);
            if (addBtn) addBtn.onclick = () => {
              const typeInp = document.getElementById(`ce_type_${idx}`);
              const valueInp = document.getElementById(`ce_value_${idx}`);
              const qtyInp = document.getElementById(`ce_qty_${idx}`);
              const eValue = Number(valueInp.value)||0;
              const eQty = Number(qtyInp.value)||1;
              if (!eValue) return;
              if (!state.items[catId][idx].cashEntries) state.items[catId][idx].cashEntries = [];
              state.items[catId][idx].cashEntries.push({
                type: typeInp.value,
                value: eValue,
                qty: eQty
              });
              scheduleSave(); renderAll();
            };
            // Delete entries
            row.querySelectorAll("[data-cash-del]").forEach(btn => {
              btn.onclick = () => {
                const [itemI, entryI] = btn.dataset.cashDel.split(":").map(Number);
                if (state.items[catId][itemI] && state.items[catId][itemI].cashEntries) {
                  state.items[catId][itemI].cashEntries.splice(entryI, 1);
                  scheduleSave(); renderAll();
                }
              };
            });
            // Edit entries
            row.querySelectorAll("[data-cash-edit]").forEach(btn => {
              btn.onclick = () => {
                const [itemI, entryI] = btn.dataset.cashEdit.split(":").map(Number);
                const entry = state.items[catId][itemI]?.cashEntries?.[entryI];
                if (!entry) return;
                openCashEditModal(catId, itemI, entryI, entry);
              };
            });
          }, 0);
          return;
        }

        const exp = it.expiry ? daysUntil(it.expiry) : null;
        const catAlertDays = getAlertDaysForCategory(catId);
        const expBadge = it.expiry
          ? (exp < 0 ? `<span class="badge badge-red">EXPIROVANÉ</span>`
            : exp <= catAlertDays ? `<span class="badge badge-amber">za ${exp} dní</span>`
            : `<span class="badge badge-gray">za ${exp} dní</span>`)
          : "";
        const linkBtn = (it.link && isValidUrl(it.link))
          ? `<a href="${esc(it.link)}" target="_blank" rel="noopener" class="btn-ghost" style="padding:0.375rem 0.625rem; text-decoration:none;">🔗</a>`
          : "";

        const row = document.createElement("div");
        row.className = "item-row";
        row.innerHTML = `
          <input type="checkbox" style="margin-top:2px; width:16px; height:16px; accent-color:var(--c-green); flex-shrink:0;" ${it.done?"checked":""} data-toggle="${catId}:${idx}" />
          <div style="flex:1; min-width:0;">
            <div style="font-weight:500; font-size:0.875rem; ${it.done?"text-decoration:line-through; color:var(--c-muted)":""}">${esc(it.name)} ${expBadge}</div>
            <div style="font-size:0.75rem; color:var(--c-muted); margin-top:0.125rem;">${it.qty||"—"}${it.expiry ? " • " + it.expiry : ""}</div>
          </div>
          <div style="display:flex; gap:0.375rem; flex-shrink:0;">
            ${linkBtn}
            <button class="btn-ghost item-btn-edit" style="padding:0.375rem 0.625rem; font-size:0.75rem;" data-edit="${catId}:${idx}">Upraviť</button>
            <button class="btn-danger item-btn-del" style="padding:0.375rem 0.625rem;" data-del="${catId}:${idx}">✕</button>
          </div>`;
        list.appendChild(row);
      });
    }

    detail.appendChild(list);

    // Append source banner at the bottom (after all items)
    if (srcBannerEl) {
      detail.appendChild(srcBannerEl);
    }

    // Bind item actions
    detail.querySelectorAll("[data-toggle]").forEach(el => {
      el.onchange = () => {
        const [cid, i] = el.dataset.toggle.split(":");
        state.items[cid][+i].done = el.checked;
        scheduleSave(); renderAll();
      };
    });
    detail.querySelectorAll("[data-del]").forEach(el => {
      el.onclick = () => {
        const [cid, i] = el.dataset.del.split(":");
        openDeleteConfirmation(cid, +i);
      };
    });
    detail.querySelectorAll("[data-edit]").forEach(el => {
      el.onclick = () => {
        const [cid, i] = el.dataset.edit.split(":");
        openItemModal(cid, +i);
      };
    });
  }

  function renderPlans() {
    renderMeetingPoint();
    renderScenarios();
  }

  // ── Miesto stretnutia ──────────────────────────────────────────
  function renderMeetingPoint() {
    const box = document.getElementById("meetingPointBox");
    if (!box) return;
    const mp = state.plans.meetingPoint;
    const hasData = mp.name && mp.name.trim();
    const hasTimes = mp.times && mp.times.length > 0;
    const hasBackup = mp.backup && mp.backup.name && mp.backup.name.trim();

    if (!hasData) {
      box.innerHTML = `
        <div style="background:linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%); border:1.5px solid #fcd34d; border-radius:1rem; padding:1.25rem; cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;" tabindex="0" role="button" aria-label="Nastaviť miesto stretnutia" onclick="openMeetingPointModal()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openMeetingPointModal()}" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 18px rgba(0,0,0,0.08)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="display:flex; align-items:center; gap:0.75rem;">
            <div style="width:48px; height:48px; border-radius:50%; background:#fbbf24; display:flex; align-items:center; justify-content:center; font-size:1.375rem; flex-shrink:0;">📍</div>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:0.95rem; color:#92400e;">Nastavte miesto stretnutia</div>
              <div style="font-size:0.78rem; color:#854d0e; line-height:1.5; margin-top:0.2rem;">Kde sa stretnete, keď vypadne signál a internet? Vyberte miesto, ktoré: <strong>všetci poznajú</strong> (kostol, pamätník, škola), je <strong>pešo do 30 min</strong>, na <strong>otvorenom priestranstve</strong> (nie v budove), a <strong>ďaleko od rizík</strong> (nie most, nie pod svahom, nie v údolí). Nastavte aj <strong>záložné miesto</strong> pre prípad, že primárne je nedostupné.</div>
            </div>
            <div style="font-size:1.25rem; color:#854d0e; flex-shrink:0;">→</div>
          </div>
        </div>`;
      return;
    }

    let timesHtml = "";
    if (hasTimes) {
      timesHtml = `<div style="display:flex; flex-wrap:wrap; gap:0.375rem; margin-top:0.625rem;">` +
        mp.times.sort().map(t => `<span style="background:#eff6ff; border:1px solid #bfdbfe; color:#1e40af; border-radius:0.5rem; padding:0.2rem 0.5rem; font-size:0.75rem; font-weight:700; font-family:'Lexend',sans-serif;">${t}</span>`).join("") +
        `</div>`;
    }

    let backupHtml = "";
    if (hasBackup) {
      backupHtml = `
        <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px dashed #bfdbfe;">
          <div style="font-size:0.72rem; font-weight:600; color:#2563eb; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:0.25rem;">Záložné miesto</div>
          <div style="font-weight:600; font-size:0.85rem;">${esc(mp.backup.name)}</div>
          ${mp.backup.address ? `<div style="font-size:0.75rem; color:var(--c-muted);">${esc(mp.backup.address)}</div>` : ""}
        </div>`;
    }

    box.innerHTML = `
      <div style="background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border:1.5px solid #bfdbfe; border-radius:1rem; padding:1.25rem;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:0.75rem;">
          <div style="display:flex; align-items:flex-start; gap:0.75rem; flex:1; min-width:0;">
            <div style="width:48px; height:48px; border-radius:50%; background:#3b82f6; display:flex; align-items:center; justify-content:center; font-size:1.375rem; flex-shrink:0; color:white;">📍</div>
            <div style="flex:1; min-width:0;">
              <div style="font-size:0.68rem; font-weight:600; color:#2563eb; text-transform:uppercase; letter-spacing:0.04em;">Miesto stretnutia</div>
              <div style="font-weight:800; font-size:1.0625rem; color:var(--c-text); margin-top:0.125rem;">${esc(mp.name)}</div>
              ${mp.address ? `<div style="font-size:0.8rem; color:var(--c-muted); margin-top:0.125rem;">📌 ${esc(mp.address)}</div>` : ""}
              ${mp.note ? `<div style="font-size:0.78rem; color:var(--c-muted); margin-top:0.25rem; font-style:italic;">${esc(mp.note)}</div>` : ""}
              ${hasTimes ? `<div style="margin-top:0.5rem;"><div style="font-size:0.68rem; font-weight:600; color:#2563eb; margin-bottom:0.25rem;">⏰ ČASY STRETÁVANIA</div>${timesHtml}</div>` : ""}
            </div>
          </div>
          <button class="btn-ghost" onclick="openMeetingPointModal()" style="font-size:0.78rem; padding:0.375rem 0.75rem; flex-shrink:0;">Upraviť</button>
        </div>
        ${backupHtml}
        <div style="background:rgba(255,255,255,0.6); border-radius:0.625rem; padding:0.625rem 0.75rem; margin-top:0.75rem; font-size:0.75rem; color:#1e40af; line-height:1.5;">
          💡 <strong>Pravidlo:</strong> Ak tam ten druhý nie je, počkajte 30 minút a príďte znova o ďalší interval. Ak sa nestretnete ani na 3. pokus – prejdite na <strong>záložné miesto</strong>.
        </div>
      </div>`;
  }

  // ── Krízové scenáre ────────────────────────────────────────────
  const SCENARIO_DEFS = [
    {
      id: "home",
      emoji: "\ud83c\udfe0",
      title: "Celá rodina je doma",
      subtitle: "Kríza zastihne všetkých doma \u2013 postup od momentu varovania po rozhodnutie zostať alebo evakuovať",
      color: "#2a7a4b",
      bg: "#eaf4ee",
      border: "#86efac"
    },
    {
      id: "separated",
      emoji: "\ud83c\udfeb",
      title: "Rodičia v práci, deti v škole",
      subtitle: "Rodina je rozdelená na 2\u20133 miesta \u2013 kto ide pre koho, odkiaľ, v akom poradí, záložný plán",
      color: "#b45309",
      bg: "#fef3c7",
      border: "#fcd34d"
    },
    {
      id: "partial",
      emoji: "\ud83d\udc68\u200d\ud83d\udc67",
      title: "Jeden rodič doma, druh\u00fd v pr\u00e1ci",
      subtitle: "Rozdelenie \u00faloh \u2013 kto zabezpečí deti, kto batoh, kto ide na miesto stretnutia",
      color: "#1e40af",
      bg: "#eff6ff",
      border: "#bfdbfe"
    },
    {
      id: "night",
      emoji: "\ud83c\udf19",
      title: "Kr\u00edzov\u00e1 situ\u00e1cia v noci",
      subtitle: "Sir\u00e9na o 3:00 r\u00e1no \u2013 orientácia v tme, oblečenie, deti, čo vziať, kam ísť",
      color: "#6b21a8",
      bg: "#faf5ff",
      border: "#e9d5ff"
    },
    {
      id: "travel",
      emoji: "\u2708\ufe0f",
      title: "Člen rodiny je mimo mesto",
      subtitle: "Služobná cesta, dovolenka, zahraničie \u2013 kontaktná osoba, komunikácia, náhradné riešenia",
      color: "#be185d",
      bg: "#fdf2f8",
      border: "#fbcfe8"
    }
  ];

  function renderScenarios() {
    const box = document.getElementById("scenariosBox");
    if (!box) return;
    box.innerHTML = "";
    SCENARIO_DEFS.forEach(def => {
      const scenario = state.plans.scenarios[def.id];
      const filled = isScenarioFilled(def.id, scenario);
      const card = document.createElement("div");
      card.className = "scenario-row" + (filled ? " done" : "");

      card.innerHTML = `
        <div class="sc-icon">${def.emoji}</div>
        <div class="sc-title">${def.title}</div>
        <span class="sc-status ${filled ? 'done' : 'todo'}">${filled ? '✓ Hotovo' : 'Nastaviť →'}</span>`;
      card.onclick = () => openScenarioModal(def.id);
      card.setAttribute("tabindex", "0");
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", def.title + (filled ? " – hotovo" : " – nastaviť"));
      card.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openScenarioModal(def.id);
        }
      };
      box.appendChild(card);
    });
  }

  function isScenarioFilled(id, s) {
    if (id === "home") return !!(s.steps && s.steps.trim());
    if (id === "separated") return (s.tasks && s.tasks.length > 0) || !!(s.meetPlace && s.meetPlace.trim());
    if (id === "partial") return !!(s.whoHome && s.whoHome.trim()) || !!(s.whoWork && s.whoWork.trim());
    if (id === "night") return !!(s.steps && s.steps.trim());
    if (id === "travel") return !!(s.contactPerson && s.contactPerson.trim()) || !!(s.steps && s.steps.trim());
    return false;
  }

  function getScenarioPreview(id, s) {
    if (id === "home") {
      const lines = (s.steps||"").split("\n").filter(l => l.trim()).slice(0, 2);
      return `<div style="font-size:0.75rem; color:var(--c-muted); margin-top:0.375rem; line-height:1.5;">${lines.map(l => esc(l)).join("<br>")}</div>`;
    }
    if (id === "separated") {
      const taskCount = (s.tasks||[]).length;
      const taskPrev = (s.tasks||[]).slice(0, 2).map(t => `<strong>${esc(t.person||"?")}</strong> \u2192 vyzdvihne <strong>${esc(t.picksUp||"?")}</strong> z ${esc(t.from||"?")}`).join("; ");
      return `<div style="font-size:0.75rem; color:var(--c-muted); margin-top:0.375rem; line-height:1.5;">${taskCount > 0 ? taskPrev : ""}${s.meetPlace ? `<br>Stretnutie: <strong>${esc(s.meetPlace)}</strong>` : ""}${s.meetTime ? ` o <strong>${esc(s.meetTime)}</strong>` : ""}</div>`;
    }
    if (id === "partial") {
      return `<div style="font-size:0.75rem; color:var(--c-muted); margin-top:0.375rem; line-height:1.5;">${s.whoHome ? `Doma: <strong>${esc(s.whoHome)}</strong>` : ""}${s.whoWork ? ` | V pr\u00e1ci: <strong>${esc(s.whoWork)}</strong>` : ""}</div>`;
    }
    if (id === "night") {
      const lines = (s.steps||"").split("\n").filter(l => l.trim()).slice(0, 2);
      return `<div style="font-size:0.75rem; color:var(--c-muted); margin-top:0.375rem; line-height:1.5;">${lines.map(l => esc(l)).join("<br>")}</div>`;
    }
    if (id === "travel") {
      return `<div style="font-size:0.75rem; color:var(--c-muted); margin-top:0.375rem; line-height:1.5;">${s.contactPerson ? `Kontaktn\u00e1 osoba: <strong>${esc(s.contactPerson)}</strong>` : ""}${s.whoTravels ? ` | Cestuje: <strong>${esc(s.whoTravels)}</strong>` : ""}</div>`;
    }
    return "";
  }

  // ── Meeting point modal ─────────────────────────────────────────
  let tempMeetingTimes = [];

  function openMeetingPointModal() {
    const mp = state.plans.meetingPoint;
    const f = document.getElementById("meetingPointForm");
    f.elements["mp_name"].value = mp.name || "";
    f.elements["mp_address"].value = mp.address || "";
    f.elements["mp_note"].value = mp.note || "";
    f.elements["mp_backup_name"].value = (mp.backup||{}).name || "";
    f.elements["mp_backup_address"].value = (mp.backup||{}).address || "";
    tempMeetingTimes = [...(mp.times || [])];
    renderMeetingTimesEditor();
    openModal("modalMeetingPoint");
  }

  function renderMeetingTimesEditor() {
    const box = document.getElementById("meetingTimesEditor");
    if (!box) return;
    box.innerHTML = tempMeetingTimes.sort().map((t, i) => `
      <span style="display:inline-flex; align-items:center; gap:0.25rem; background:white; border:1.5px solid #bfdbfe; border-radius:0.5rem; padding:0.25rem 0.375rem 0.25rem 0.5rem; font-size:0.8rem; font-weight:700; color:#1e40af; font-family:'Lexend',sans-serif;">
        ${t}
        <button type="button" onclick="removeMeetingTime(${i})" style="background:none; border:none; cursor:pointer; color:#93c5fd; font-size:1rem; line-height:1; padding:0 0.125rem;" title="Odstrániť">✕</button>
      </span>
    `).join("");
  }

  function removeMeetingTime(i) {
    tempMeetingTimes.splice(i, 1);
    renderMeetingTimesEditor();
  }
  // expose to onclick
  window.removeMeetingTime = removeMeetingTime;
  window.openMeetingPointModal = openMeetingPointModal;

  document.getElementById("btnAddMeetingTime").onclick = () => {
    const inp = document.getElementById("newMeetingTime");
    if (inp.value && !tempMeetingTimes.includes(inp.value)) {
      tempMeetingTimes.push(inp.value);
      inp.value = "";
      renderMeetingTimesEditor();
    }
  };

  document.getElementById("meetingPointForm").onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    state.plans.meetingPoint = {
      name: String(fd.get("mp_name")||"").trim(),
      address: String(fd.get("mp_address")||"").trim(),
      note: String(fd.get("mp_note")||"").trim(),
      times: [...tempMeetingTimes],
      backup: {
        name: String(fd.get("mp_backup_name")||"").trim(),
        address: String(fd.get("mp_backup_address")||"").trim()
      }
    };
    closeModal("modalMeetingPoint");
    scheduleSave(); renderPlans();
  };

  // ── Scenario modals ─────────────────────────────────────────────
  function openScenarioModal(scenarioId) {
    const def = SCENARIO_DEFS.find(d => d.id === scenarioId);
    const s = state.plans.scenarios[scenarioId];
    document.getElementById("scenarioModalTitle").textContent = def.emoji + " " + def.title;
    document.getElementById("scenarioModalSubtitle").textContent = def.subtitle;
    const content = document.getElementById("scenarioModalContent");

    if (scenarioId === "home") {
      content.innerHTML = `
        <form id="scenarioHomeForm" style="display:grid; gap:1rem;">
          <div style="background:${def.bg}; border:1px solid ${def.border}; border-radius:0.75rem; padding:0.75rem 1rem; font-size:0.78rem; color:${def.color}; line-height:1.6;">
            <strong>Situácia:</strong> Celá rodina je doma keď nastane kríza (siréna, výbuch, zemetrasenie). Prepíšte alebo doplňte kroky podľa vašej domácnosti.
            <div style="margin-top:0.375rem; font-size:0.72rem; opacity:0.8;">💡 <em>Kde máte hlavný istič? Plynový uzáver? Batoh? Zapíšte si to \u2013 v strese si nepamätáte ani jednoduché veci.</em></div>
          </div>
          <div>
            <label class="item-label">Postup krok za krokom</label>
            <textarea name="steps" rows="8" style="line-height:1.6; font-size:0.85rem;" placeholder="1. Zostaňte pokojní – panika je najväčší nepriateľ&#10;2. Zapnite rádio (Rádio Slovensko 96,6 FM)&#10;3. Skontrolujte zásoby a evakuačné batohy&#10;4. Zabezpečte dom: okná, dvere, plyn&#10;5. Ak treba evakuovať: batoh + doklady → miesto stretnutia&#10;6. Nechajte lístok na dverách kam idete">${esc(s.steps||"")}</textarea>
          </div>
          <div>
            <label class="item-label">Kam evakuujete? (ak treba opustiť dom)</label>
            <input name="evacPlace" type="text" value="${esc(s.evacPlace||"")}" placeholder="napr. K starým rodičom, na chatu, na miesto stretnutia..." />
          </div>
          <div>
            <label class="item-label">Poznámka</label>
            <input name="note" type="text" value="${esc(s.note||"")}" placeholder="napr. Kto vezme mačku, kto uzamkne dom, kde sú kľúče..." />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
          </div>
        </form>`;
      content.querySelector("#scenarioHomeForm").onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        state.plans.scenarios.home = {
          steps: String(fd.get("steps")||"").trim(),
          evacPlace: String(fd.get("evacPlace")||"").trim(),
          note: String(fd.get("note")||"").trim()
        };
        closeModal("modalScenario");
        scheduleSave(); renderPlans();
      };
    }

    else if (scenarioId === "night") {
      content.innerHTML = `
        <form id="scenarioNightForm" style="display:grid; gap:1rem;">
          <div style="background:${def.bg}; border:1px solid ${def.border}; border-radius:0.75rem; padding:0.75rem 1rem; font-size:0.78rem; color:${def.color}; line-height:1.6;">
            <strong>Situácia:</strong> Je 3:00 v noci, zaznie siréna alebo vás zobudí zemetrasenie. Je tma, ste dezorientovaní.
            <div style="margin-top:0.375rem; font-size:0.72rem; opacity:0.8;">💡 <em>Mať čelovku a topánky pri posteli nie je paranoia – je to pripravenosť. V tme na rozbité sklo stúpite skôr než si to uvedomíte.</em></div>
          </div>
          <div>
            <label class="item-label">Postup krok za krokom</label>
            <textarea name="steps" rows="7" style="line-height:1.6; font-size:0.85rem;" placeholder="1. Zobuďte všetkých – pokojne ale rázne&#10;2. Čelovka/baterka + topánky (HNEĎ)&#10;3. Oblečte sa teplé oblečenie&#10;4. Zapnite rádio na batérie&#10;5. Vezmite batoh od dverí&#10;6. Ak treba evakuovať: deti neste/veďte">${esc(s.steps||"")}</textarea>
          </div>
          <div>
            <label class="item-label">Kam evakuujete v noci?</label>
            <input name="evacPlace" type="text" value="${esc(s.evacPlace||"")}" placeholder="napr. Rovnaké miesto ako cez deň, alebo najbližší úkryt..." />
          </div>
          <div>
            <label class="item-label">Poznámka</label>
            <input name="note" type="text" value="${esc(s.note||"")}" placeholder="napr. Čelovka v nočnom stolíku, topánky pod posteľou..." />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
          </div>
        </form>`;
      content.querySelector("#scenarioNightForm").onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        state.plans.scenarios.night = {
          steps: String(fd.get("steps")||"").trim(),
          evacPlace: String(fd.get("evacPlace")||"").trim(),
          note: String(fd.get("note")||"").trim()
        };
        closeModal("modalScenario");
        scheduleSave(); renderPlans();
      };
    }

    else if (scenarioId === "travel") {
      content.innerHTML = `
        <form id="scenarioTravelForm" style="display:grid; gap:1rem;">
          <div style="background:${def.bg}; border:1px solid ${def.border}; border-radius:0.75rem; padding:0.75rem 1rem; font-size:0.78rem; color:${def.color}; line-height:1.6;">
            <strong>Situácia:</strong> Jeden člen rodiny je na služobnej ceste alebo na dovolenke – koordinácia na diaľku.
            <div style="margin-top:0.375rem; font-size:0.72rem; opacity:0.8;">💡 <em>Dohodnite si kontaktnú osobu mimo ohrozeného regiónu (napr. príbuzní v inom meste). Cez ňu sa rodina navzájom nájde aj keď lokálne siete zlyhajú.</em></div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.625rem;">
            <div>
              <label class="item-label">Kto cestuje?</label>
              <input name="whoTravels" type="text" value="${esc(s.whoTravels||"")}" placeholder="napr. Ocko, Mama..." />
            </div>
            <div>
              <label class="item-label">Kontaktná osoba mimo regiónu</label>
              <input name="contactPerson" type="text" value="${esc(s.contactPerson||"")}" placeholder="napr. Strýko Jano v Prahe" />
            </div>
          </div>
          <div>
            <label class="item-label">Telefón kontaktnej osoby</label>
            <input name="contactPhone" type="text" value="${esc(s.contactPhone||"")}" placeholder="napr. +421 9XX XXX XXX" />
          </div>
          <div>
            <label class="item-label">Čo robí rodina doma?</label>
            <textarea name="stepsHome" rows="3" style="line-height:1.6; font-size:0.85rem;" placeholder="Zabezpečí dom, ide na miesto stretnutia, ohlási sa kontaktnej osobe...">${esc(s.stepsHome||"")}</textarea>
          </div>
          <div>
            <label class="item-label">Čo robí ten, kto je preč?</label>
            <textarea name="stepsAway" rows="3" style="line-height:1.6; font-size:0.85rem;" placeholder="Ohlási sa kontaktnej osobe, smeruje domov ak to je možné, kontaktuje ambasádu ak je v zahraničí...">${esc(s.stepsAway||"")}</textarea>
          </div>
          <div>
            <label class="item-label">Poznámka</label>
            <input name="note" type="text" value="${esc(s.note||"")}" placeholder="napr. Číslo ambasády, poistenie na cestu..." />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
          </div>
        </form>`;
      content.querySelector("#scenarioTravelForm").onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        state.plans.scenarios.travel = {
          whoTravels: String(fd.get("whoTravels")||"").trim(),
          contactPerson: String(fd.get("contactPerson")||"").trim(),
          contactPhone: String(fd.get("contactPhone")||"").trim(),
          stepsHome: String(fd.get("stepsHome")||"").trim(),
          stepsAway: String(fd.get("stepsAway")||"").trim(),
          note: String(fd.get("note")||"").trim()
        };
        closeModal("modalScenario");
        scheduleSave(); renderPlans();
      };
    }

    else if (scenarioId === "separated") {
      const tasks = s.tasks || [];
      let tasksHtml = "";
      tasks.forEach((t, i) => {
        tasksHtml += `
          <div class="sep-task-row" style="background:white; border:1.5px solid ${def.border}; border-radius:0.875rem; padding:0.875rem; position:relative;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem;">
              <div style="font-weight:700; font-size:0.8rem; color:${def.color};">Úloha ${i+1}</div>
              <button type="button" data-removetask="${i}" style="background:none; border:none; cursor:pointer; color:#dc2626; font-size:0.8rem; font-weight:600; font-family:'Lexend',sans-serif;">Odstrániť</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
              <div>
                <label class="item-sublabel">Kto ide?</label>
                <input name="task_person_${i}" type="text" value="${esc(t.person||"")}" placeholder="napr. Mama, Ocko, Babka..." style="font-size:0.85rem;" />
              </div>
              <div>
                <label class="item-sublabel">Vyzdvihne koho?</label>
                <input name="task_picksUp_${i}" type="text" value="${esc(t.picksUp||"")}" placeholder="napr. Jakub, Ema..." style="font-size:0.85rem;" />
              </div>
              <div>
                <label class="item-sublabel">Odkiaľ?</label>
                <input name="task_from_${i}" type="text" value="${esc(t.from||"")}" placeholder="napr. ZŠ Partizánska, MŠ Lúčka..." style="font-size:0.85rem;" />
              </div>
              <div>
                <label class="item-sublabel">Poznámka</label>
                <input name="task_note_${i}" type="text" value="${esc(t.note||"")}" placeholder="napr. Bočný vchod, trieda 3.A" style="font-size:0.85rem;" />
              </div>
            </div>
          </div>`;
      });

      content.innerHTML = `
        <form id="scenarioSepForm" style="display:grid; gap:1rem;">
          <div style="background:${def.bg}; border:1px solid ${def.border}; border-radius:0.75rem; padding:0.75rem 1rem; font-size:0.78rem; color:${def.color}; line-height:1.6;">
            <strong>Situácia:</strong> Rodičia sú v práci, deti v škole/škôlke/krúžkoch. Kto ide pre koho?
            <div style="margin-top:0.375rem; font-size:0.72rem; opacity:0.8;">💡 <em>Školy majú vlastné krízové plány \u2013 deti sú v bezpečí. Nepanikárte, ale majte jasné: kto ide kam, v akom poradí, a čo ak primárna osoba nemôže. Dohodnite záložného vyzberača!</em></div>
            <div style="margin-top:0.375rem; font-size:0.72rem; opacity:0.8;">💡 <em>Školy majú vlastné krízové plány – deti nevydajú neautorizovaným osobám. Overte vopred, kto je oprávnený vyzdvihnúť vaše dieťa (a zapíšte to aj v škole).</em></div>
          </div>
          <div>
            <div style="font-size:0.78rem; font-weight:700; margin-bottom:0.5rem;">Rozdelenie úloh</div>
            <div id="sepTasksList" style="display:flex; flex-direction:column; gap:0.625rem;">${tasksHtml}</div>
            <button type="button" id="btnAddSepTask" class="btn-ghost" style="margin-top:0.625rem; font-size:0.78rem; padding:0.5rem 1rem; width:100%; text-align:center;">+ Pridať úlohu (kto ide pre koho)</button>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.625rem;">
            <div>
              <label class="item-label">Kde sa všetci stretnete?</label>
              <input name="meetPlace" type="text" value="${esc(s.meetPlace||"")}" placeholder="napr. Doma, alebo miesto stretnutia" />
            </div>
            <div>
              <label class="item-label">O koľkej najneskôr?</label>
              <input name="meetTime" type="text" value="${esc(s.meetTime||"")}" placeholder="napr. Do 2 hodín, o 15:00..." />
            </div>
          </div>
          <div>
            <label class="item-label">Poznámka</label>
            <input name="note" type="text" value="${esc(s.note||"")}" placeholder="napr. Ak sa nedá vyzdvihnúť do 1h, volať babku..." />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
          </div>
        </form>`;

      let taskCount = tasks.length;
      const addTaskBtn = content.querySelector("#btnAddSepTask");
      const tasksList = content.querySelector("#sepTasksList");
      addTaskBtn.onclick = () => {
        const i = taskCount++;
        const row = document.createElement("div");
        row.className = "sep-task-row";
        row.style.cssText = `background:white; border:1.5px solid ${def.border}; border-radius:0.875rem; padding:0.875rem; position:relative;`;
        row.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem;">
            <div style="font-weight:700; font-size:0.8rem; color:${def.color};">Úloha ${i+1}</div>
            <button type="button" data-removetask="${i}" style="background:none; border:none; cursor:pointer; color:#dc2626; font-size:0.8rem; font-weight:600; font-family:'Lexend',sans-serif;">Odstrániť</button>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
            <div><label class="item-sublabel">Kto ide?</label><input name="task_person_${i}" type="text" placeholder="napr. Mama, Ocko, Babka..." style="font-size:0.85rem;" /></div>
            <div><label class="item-sublabel">Vyzdvihne koho?</label><input name="task_picksUp_${i}" type="text" placeholder="napr. Jakub, Ema..." style="font-size:0.85rem;" /></div>
            <div><label class="item-sublabel">Odkiaľ?</label><input name="task_from_${i}" type="text" placeholder="napr. ZŠ Partizánska, MŠ Lúčka..." style="font-size:0.85rem;" /></div>
            <div><label class="item-sublabel">Poznámka</label><input name="task_note_${i}" type="text" placeholder="" style="font-size:0.85rem;" /></div>
          </div>`;
        tasksList.appendChild(row);
        bindRemoveButtons();
      };

      function bindRemoveButtons() {
        content.querySelectorAll("[data-removetask]").forEach(b => {
          b.onclick = () => { b.closest(".sep-task-row").remove(); };
        });
      }
      bindRemoveButtons();

      content.querySelector("#scenarioSepForm").onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const newTasks = [];
        const rows = content.querySelectorAll(".sep-task-row");
        rows.forEach(row => {
          const inputs = row.querySelectorAll("input");
          if (inputs.length >= 2) {
            const task = {
              person: (inputs[0]?.value||"").trim(),
              picksUp: (inputs[1]?.value||"").trim(),
              from: (inputs[2]?.value||"").trim(),
              note: (inputs[3]?.value||"").trim()
            };
            if (task.person || task.picksUp) newTasks.push(task);
          }
        });
        state.plans.scenarios.separated = {
          tasks: newTasks,
          meetPlace: String(fd.get("meetPlace")||"").trim(),
          meetTime: String(fd.get("meetTime")||"").trim(),
          note: String(fd.get("note")||"").trim()
        };
        closeModal("modalScenario");
        scheduleSave(); renderPlans();
      };
    }

    else if (scenarioId === "partial") {
      content.innerHTML = `
        <form id="scenarioPartForm" style="display:grid; gap:1rem;">
          <div style="background:${def.bg}; border:1px solid ${def.border}; border-radius:0.75rem; padding:0.75rem 1rem; font-size:0.78rem; color:${def.color}; line-height:1.6;">
            <strong>Situácia:</strong> Jeden z partnerov je doma s deťmi, druhý je v práci. Čo robí každý?
            <div style="margin-top:0.375rem; font-size:0.72rem; opacity:0.8;">💡 <em>Dohodnite si jasné pravidlo: ak sa nedá spojiť do X minút, každý koná podľa plánu a smeruje na miesto stretnutia. Nečakajte na potvrdenie – konajte.</em></div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.625rem;">
            <div>
              <label class="item-label">Kto je doma?</label>
              <input name="whoHome" type="text" value="${esc(s.whoHome||"")}" placeholder="napr. Mama, Mišo..." />
            </div>
            <div>
              <label class="item-label">Kto je v práci?</label>
              <input name="whoWork" type="text" value="${esc(s.whoWork||"")}" placeholder="napr. Ocko, Katka..." />
            </div>
          </div>
          <div>
            <label class="item-label">Čo robí ten doma?</label>
            <textarea name="homeSteps" rows="3" style="line-height:1.6; font-size:0.85rem;" placeholder="Pripraví batoh, zabezpečí deti, ide na miesto stretnutia...">${esc(s.homeSteps||"")}</textarea>
          </div>
          <div>
            <label class="item-label">Čo robí ten v práci?</label>
            <textarea name="workSteps" rows="3" style="line-height:1.6; font-size:0.85rem;" placeholder="Bezpečne opustí pracovisko, smeruje domov alebo na miesto stretnutia...">${esc(s.workSteps||"")}</textarea>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.625rem;">
            <div>
              <label class="item-label">Kde sa stretnete?</label>
              <input name="meetPlace" type="text" value="${esc(s.meetPlace||"")}" placeholder="napr. Doma, alebo miesto stretnutia" />
            </div>
            <div>
              <label class="item-label">O koľkej najneskôr?</label>
              <input name="meetTime" type="text" value="${esc(s.meetTime||"")}" placeholder="napr. Do 2 hodín, ASAP..." />
            </div>
          </div>
          <div>
            <label class="item-label">Poznámka</label>
            <input name="note" type="text" value="${esc(s.note||"")}" placeholder="napr. Kľúče od auta – v šuflíku v chodbe..." />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button type="submit" class="btn-primary" style="padding:0.75rem 2rem;">Uložiť</button>
          </div>
        </form>`;
      content.querySelector("#scenarioPartForm").onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        state.plans.scenarios.partial = {
          whoHome: String(fd.get("whoHome")||"").trim(),
          whoWork: String(fd.get("whoWork")||"").trim(),
          homeSteps: String(fd.get("homeSteps")||"").trim(),
          workSteps: String(fd.get("workSteps")||"").trim(),
          meetPlace: String(fd.get("meetPlace")||"").trim(),
          meetTime: String(fd.get("meetTime")||"").trim(),
          note: String(fd.get("note")||"").trim()
        };
        closeModal("modalScenario");
        scheduleSave(); renderPlans();
      };
    }

    openModal("modalScenario");
  }

  function getAlertDaysForCategory(catId) {
    if (catId === "medkit") return state.alertDaysMeds || 180;
    if (catId === "food" || catId === "water") return state.alertDaysFood || 30;
    return state.alertDaysFood || 30;
  }

  function renderAlerts() {
    // Sync select values from state
    const selMeds = document.getElementById("alertDaysMeds");
    const selFood = document.getElementById("alertDaysFood");
    if (selMeds) selMeds.value = state.alertDaysMeds || 180;
    if (selFood) selFood.value = state.alertDaysFood || 30;

    const alerts = [];
    for (const c of CATEGORIES) {
      const threshold = getAlertDaysForCategory(c.id);
      (state.items[c.id]||[]).forEach((it, idx) => {
        // Food entries: check each entry's expiry
        if (it.isFoodItem && it.foodEntries) {
          it.foodEntries.forEach(fe => {
            if (!fe.expiry) return;
            const d = daysUntil(fe.expiry);
            if (d <= threshold) alerts.push({ name: fe.name, expiry: fe.expiry, catName: c.name, catId: c.id, idx, days: d, threshold });
          });
          return;
        }
        // Water entries: check each entry's expiry
        if (it.isWaterItem && it.waterEntries) {
          it.waterEntries.forEach(we => {
            if (!we.expiry) return;
            const d = daysUntil(we.expiry);
            if (d <= threshold) alerts.push({ name: we.name, expiry: we.expiry, catName: c.name, catId: c.id, idx, days: d, threshold });
          });
          return;
        }
        if (!it.expiry) return;
        const d = daysUntil(it.expiry);
        if (d <= threshold) alerts.push({ ...it, catName: c.name, catId: c.id, idx, days: d, threshold });
      });
    }
    alerts.sort((a,b) => a.days - b.days);
    const section = document.getElementById("alertsSection");
    const box = document.getElementById("alertsBox");
    // Email notif status – update in profile modal
    const emailStatus = document.getElementById("emailNotifStatus");
    if (emailStatus) {
      const configured = EMAILJS_CONFIG.publicKey !== "YOUR_EMAILJS_PUBLIC_KEY";
      emailStatus.textContent = configured
        ? `✅ Aktívne – pripomienky na ${currentUser?.email || "váš email"}`
        : "Pripomienky zatiaľ nie sú aktívne";
      emailStatus.style.color = configured ? "var(--c-green)" : "var(--c-muted)";
    }

    if (!alerts.length) { section.style.display = "none"; return; }
    section.style.display = "block";
    box.innerHTML = alerts.slice(0,6).map(a => `
      <div style="display:flex; align-items:center; justify-content:space-between; padding:0.625rem 0; border-bottom:1px solid var(--c-border);">
        <div>
          <div style="font-weight:500; font-size:0.875rem;">${esc(a.name)}</div>
          <div style="font-size:0.75rem; color:var(--c-muted);">${esc(a.catName)} • ${esc(a.expiry)}</div>
        </div>
        <span class="badge ${a.days < 0 ? 'badge-red' : 'badge-amber'}">${a.days < 0 ? 'EXPIROVANÉ' : 'za ' + a.days + ' dní'}</span>
      </div>`).join("");
  }


  // Zobrazenie litrov - vždy len číslo + "l"
  function litreSklon(val) {
    const n = parseFloat(val);
    return n.toFixed(1) + " l";
  }

  // ══════════════════════════════════════════════════════════════════
  // PRVÁ POMOC – dáta podľa ERC Guidelines 2025 + príručka MV SR
  // ══════════════════════════════════════════════════════════════════
  const FIRST_AID_DATA = [
    // ═══════════════════════════════════════════════════════════════
    // ŽIVOT OHROZUJÚCE STAVY
    // ═══════════════════════════════════════════════════════════════
    {
      id: "cardiac_arrest",
      emoji: "❤️",
      title: "Zástava srdca (KPR)",
      subtitle: "Kardiopulmonálna resuscitácia – každá sekunda rozhoduje",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Rozpoznanie" },
        { text: "<strong>Zavolajte na osobu a potriaste za ramená.</strong> Ak nereaguje – skontrolujte dýchanie: zakloňte hlavu, zdvihnite bradu, priblížte ucho k ústam na max. 10 sekúnd." },
        { text: "<strong>Ak nedýcha alebo dýcha abnormálne</strong> (lapavé, chrčivé – tzv. agonálne dýchanie) – ide o zástavu srdca. Konajte ihneď." },
        { warn: "Agonálne dýchanie (nepravidelné lapanie po dychu) NIE JE normálne dýchanie. Je to známka zástavy srdca – začnite KPR!" },
        { header: "Aktivácia pomoci" },
        { text: "<strong>Zavolajte 155 alebo 112</strong> – ak ste sami, zavolajte na hlasitý odposluch a začnite resuscitáciu. Ak je prítomný niekto ďalší, pošlite ho zavolať a priniesť AED." },
        { header: "Stlačovanie hrudníka (30 stlačení)" },
        { text: "<strong>Položte osobu na tvrdý podklad</strong> na chrbát. Kľaknite si zboku." },
        { text: "<strong>Položte zápästie jednej ruky do stredu hrudníka</strong> (dolná polovica hrudnej kosti). Druhú ruku položte na ňu, prepleťte prsty." },
        { text: "<strong>Stláčajte kolmo nadol:</strong> hĺbka <strong>5–6 cm</strong>, rýchlosť <strong>100–120/min</strong> (rytmus piesne Stayin' Alive). Po každom stlačení hrudník úplne uvoľnite – nesedajte na ňom." },
        { header: "Vdychy (2 vdychy)" },
        { text: "<strong>Po 30 stlačeniach:</strong> zakloňte hlavu, zdvihnite bradu, zatlačte nos a 2× vdýchnite do úst (každý vdych ~1 sekunda, hrudník sa musí zdvihnúť)." },
        { text: "<strong>Pokračujte 30:2</strong> – neprerušujte stlačovanie na dlhšie ako 10 sekúnd." },
        { note: "Ak nemôžete alebo nechcete dýchať z úst do úst – robte aspoň nepretržité stlačovanie hrudníka. Aj to zachraňuje životy!" },
        { header: "AED (automatický externý defibrilátor)" },
        { text: "<strong>Ak je AED dostupný – zapnite ho a nalepte elektródy</strong> na holý, suchý hrudník podľa obrázkov. AED môže použiť ktokoľvek – riaďte sa hlasovými pokynmi." },
        { text: "<strong>Počas analýzy a výboja sa osoby nedotýkajte.</strong> Ihneď po výboji pokračujte v KPR." },
        { note: "ERC 2025: AED lokality majú byť označené jasným signalizačným znakom. AED je bezpečný – prístroj rozhodne, či výboj podá." },
        { header: "Kedy prestať" },
        { text: "<strong>Pokračujte v resuscitácii</strong> kým: 1) nepríde záchranka, 2) osoba nezačne normálne dýchať, 3) ste úplne vyčerpaní (striedajte sa po 2 min.)." }
      ],
      warning: "Ak si nie ste istí dýchaním – začnite resuscitáciu. Lepšie zbytočná KPR na živom ako žiadna na mŕtvom. Každá minúta bez KPR znižuje šancu na prežitie o 10%.",
      info: "Tiesňové čísla SR: <strong>112</strong> (univerzálna), <strong>155</strong> (záchranka). Na 112 je možné zaslať aj SMS. Dispečer vás bude navigovať cez telefón.",
      source: "ERC 2025 BLS",
      sources: [
        { label: "ERC Guidelines 2025 – Adult Basic Life Support (Smyth et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00283-7/fulltext" },
        { label: "SK MINV – Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "bleeding",
      emoji: "🩸",
      title: "Silné krvácanie",
      subtitle: "Život ohrozujúce vonkajšie krvácanie",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Rozpoznanie masívneho krvácania" },
        { text: "<strong>Krv strieka alebo vytekáva prúdom,</strong> oblečenie je rýchlo nasiaknuté, na zemi sa tvorí kaluž. Toto krvácanie zabíja v minútach – konajte okamžite." },
        { header: "Zastavenie krvácania" },
        { text: "<strong>1. Priamy tlak na ranu</strong> – pritlačte čistú tkaninu, obväz alebo priamo ruku (ideálne s rukavicami) na krvácajúce miesto. Tlačte pevne a nepretržite min. 5–10 minút." },
        { text: "<strong>2. Wound packing (vyplnenie rany)</strong> – ak je rana hlboká a priamy tlak nestačí: vtlačte do rany obväz alebo čistú tkaninu čo najhlbšie a pokračujte v tlaku na ňu." },
        { text: "<strong>3. Tlakový obväz</strong> – keď krvácanie ustáva, zabezpečte ranu tlakovým obväzom. Ak sa presiaknú – NEODSTRAŇUJTE, pridajte ďalšiu vrstvu." },
        { header: "Turniket (škrtidlo)" },
        { text: "<strong>Pri masívnom krvácaní z končatiny</strong> – ak priamy tlak nestačí, priložte turniket 5–7 cm nad ranu (medzi ranou a srdcom)." },
        { text: "<strong>Uťahujte, kým krvácanie neprestane.</strong> Turniket bolí – to je normálne a správne." },
        { text: "<strong>Zapíšte čas priloženia</strong> fixkou priamo na turniket aj na telo/čelo. TCCC: ak nie je viditeľný zdroj krvácania, aplikujte turniket čo najvyššie na končatine." },
        { warn: "Turniket NIKDY neuvoľňujte – to je práca lekára. Nesprávne uvoľnenie môže spôsobiť opätovné krvácanie alebo uvoľnenie toxínov do obehu." },
        { header: "Miesta kde turniket nejde použiť" },
        { text: "<strong>Krk, podpazušie, slabiny, brucho:</strong> vtlačte hemostatický obväz (QuikClot, Celox) alebo čistú tkaninu priamo do rany a držte pevný tlak min. 3 minúty." },
        { header: "Po zastavení krvácania" },
        { text: "<strong>Zavolajte 155 / 112.</strong> Uložte osobu na chrbát, zdvihnite nohy (ak nemá poranenie nôh). Udržujte teplo – prikryte dekou, izolujte od zeme." },
        { text: "<strong>Monitorujte vedomie a dýchanie</strong> – ak stratí vedomie a dýcha, uložte do stabilizovanej polohy." }
      ],
      warning: "ERC 2025: Nepoužívajte tlakové body – nie sú účinné. Priamo tlačte na ranu. Masívna strata krvi (>1 liter) vedie k šoku – každá sekunda sa počíta.",
      info: null,
      source: "ERC 2025 + TCCC 2024",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Life-threatening bleeding (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "ILCOR CoSTR 2025 – Control of life-threatening bleeding", url: "https://ilcor.org/" },
        { label: "TCCC Guidelines 2024 – Hemorrhage control", url: "https://books.allogy.com/web/tenant/8/books/b729b76a-1a34-4bf7-b76b-66bb2072b2a7/" }
      ]
    },
    {
      id: "choking",
      emoji: "😤",
      title: "Dusenie (cudzie teleso)",
      subtitle: "Upchatie dýchacích ciest – okamžitý zásah",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Rozpoznanie" },
        { text: "<strong>Osoba sa náhle nemôže rozprávať, kašlať ani dýchať.</strong> Často sa chytá za hrdlo. Koža modrie." },
        { text: "<strong>Ak môže kašlať</strong> – povzbudzujte ju nech kašle. Nezasahujte, kašeľ je najúčinnejší mechanizmus." },
        { header: "Ak NEMÔŽE kašlať (ťažká obštrukcia)" },
        { text: "<strong>5 úderov medzi lopatky:</strong> Predkloňte osobu (jednou rukou podoprite hrudník). Druhou rukou udrite 5× medzi lopatky pätou dlane. Každý úder musí byť silný a samostatný." },
        { text: "<strong>5 stlačení brucha (Heimlichov manéver):</strong> Postavte sa za osobu, objímte ju okolo pása. Zatnite päsť a umiestnite ju medzi pupok a rebrovú oblasť. Druhou rukou priložte na päsť. Prudko zatlačte dovnútra a nahor 5×." },
        { text: "<strong>Striedajte 5 úderov a 5 stlačení</strong> kým sa predmet neuvoľní alebo osoba nestratí vedomie." },
        { warn: "<strong>U tehotných a obéznych:</strong> namiesto stlačení brucha použite stlačenia hrudníka (ruky na strednú časť hrudnej kosti)." },
        { header: "Ak stratí vedomie" },
        { text: "<strong>Opatrne položte na zem.</strong> Ihneď volajte 155/112." },
        { text: "<strong>Začnite KPR</strong> – stlačovanie hrudníka môže pomôcť uvoľniť predmet." },
        { text: "<strong>Pred každým vdychom</strong> skontrolujte ústa – ak vidíte predmet, vyberte ho. Nevhŕňajte prsty naslepo." },
        { header: "Dusenie u bábätiek (do 1 roka)" },
        { text: "<strong>Položte dieťa tvárou nadol na predlaktie</strong> (hlavička nižšie) a podpierajte mu hlavičku. 5× udrite medzi lopatky." },
        { text: "<strong>Ak nepomôže:</strong> otočte na chrbátik, 5× stlačte hrudník dvoma prstami (stred hrudníka, pod prsníkmi)." },
        { text: "<strong>Striedajte 5/5</strong> kým sa predmet neuvoľní. Pri bezvedomí začnite KPR pre dojčatá." }
      ],
      warning: "Každý, kto bol ošetrený stlačeniami brucha, musí byť následne vyšetrený lekárom – hrozí vnútorné poranenie orgánov.",
      info: null,
      source: "ERC 2025 First Aid",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Choking / FBAO (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "ERC Guidelines 2025 – Basic Life Support", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00283-7/fulltext" }
      ]
    },
    {
      id: "anaphylaxis",
      emoji: "💜",
      title: "Anafylaxia",
      subtitle: "Ťažká alergická reakcia – život ohrozujúci stav",
      iconBg: "#fdf4ff",
      iconBorder: "#e9d5ff",
      steps: [
        { header: "Rozpoznanie (príznaky sa rozvíjajú v minútach)" },
        { text: "<strong>Koža:</strong> náhly žihľavý vyrážka, sčervenanie, opuch tváre/pier/jazyka." },
        { text: "<strong>Dýchanie:</strong> ťažkosti s dýchaním, piskanie, chrčanie, pocit upchatého hrdla." },
        { text: "<strong>Obeh:</strong> závraty, mdloby, rýchly slabý pulz, bledosť (anafylaktický šok)." },
        { text: "<strong>Tráviaci trakt:</strong> nevoľnosť, zvracanie, kŕčovitá bolesť brucha." },
        { warn: "Anafylaxia sa vyvíja veľmi rýchlo – minúty rozhodujú o živote." },
        { header: "Liečba" },
        { text: "<strong>Zavolajte 155 alebo 112</strong> – ihneď." },
        { text: "<strong>Adrenalín (EpiPen / Anapen)</strong> – ak má osoba autoinjekčný adrenalín, pomôžte jej ho použiť:<br>• Odistite poistku<br>• Aplikujte do vonkajšej strany stehna (cez oblečenie je OK)<br>• Držte 10 sekúnd<br>• Masírujte miesto vpichu" },
        { note: "ERC 2025: Adrenalín je JEDINÝ účinný liek pri anafylaxii. Antihistaminiká (Zyrtec, Zodac) sú príliš pomalé a neúčinné pri život ohrozujúcom stave." },
        { text: "<strong>Poloha podľa stavu:</strong><br>• Ťažkosti s dýchaním → nechajte sedieť<br>• Šok (závraty, bledosť) → na chrbát, nohy hore<br>• Bezvedomie, dýcha → stabilizovaná poloha<br>• Nedýcha → KPR" },
        { text: "<strong>Druhá dávka adrenalínu</strong> – ak sa stav do 5–10 minút nezlepší, aplikujte druhý autoinjekčný adrenalín (ak je dostupný)." },
        { header: "Po stabilizácii" },
        { text: "<strong>Každý po anafylaxii musí do nemocnice</strong> – aj keď sa stav zlepšil. Hrozí bifázická reakcia (návrat príznakov po 4–12 hodinách)." }
      ],
      warning: "Ak máte v rodine alergika – zabezpečte aby mal autoinjekčný adrenalín VŽDY po ruke (EpiPen / Anapen). Naučte všetkých členov rodiny, ako ho použiť. Najčastejšie spúšťače: orechy, hmyzí bodnutie, lieky, morské plody.",
      info: null,
      source: "ERC 2025 First Aid",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Anaphylaxis (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "ILCOR CoSTR 2025 – First Aid", url: "https://ilcor.org/" }
      ]
    },
    {
      id: "stroke",
      emoji: "🧠",
      title: "Cievna mozgová príhoda",
      subtitle: "Mozgová porážka – každá minúta rozhoduje",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Test FAST (rozpoznanie)" },
        { text: "<strong>F – Face (tvár):</strong> Požiadajte osobu, aby sa usmiala. Pokles jednej strany tváre? Kútik úst padá?" },
        { text: "<strong>A – Arms (ruky):</strong> Požiadajte zdvihnúť obe ruky a vydržať. Jedna ruka klesá alebo ju nevládze zdvihnúť?" },
        { text: "<strong>S – Speech (reč):</strong> Požiadajte zopakovať jednoduchú vetu (napr. „Dnes je pekný deň”). Reč je nezrozumiteľná, pomalá, zmiešaná?" },
        { text: "<strong>T – Time (čas):</strong> Ak je ČOKOĽVEK z toho prítomné → okamžite volajte <strong>155!</strong>" },
        { warn: "ERC 2025: Použitie škály na rozpoznanie mŕtvice (FAST) skracuje čas do začiatku liečby. Každá minúta bez liečby ničí ~1.9 milióna mozgových buniek." },
        { header: "Ďalšie príznaky" },
        { text: "<strong>Náhla silná bolesť hlavy</strong> bez zjavnej príčiny, náhle problémy s videním (na jedno alebo obe oči), náhle závrate a strata rovnováhy, náhle znecitlivenie tváre/ruky/nohy (zvyčajne na jednej strane)." },
        { header: "Čo robiť" },
        { text: "<strong>Zavolajte 155 IHNEĎ</strong> – povedzte dispečerovi: „Podozrenie na mŕtvicu, pozitívny test FAST.”" },
        { text: "<strong>Zaznamenajte čas</strong> kedy sa príznaky začali – táto informácia je kľúčová pre lekárov (rozhoduje o type liečby)." },
        { text: "<strong>Uložte osobu do pohodlnej polohy</strong> – ideálne polosediačka s podopretou hlavou." },
        { text: "<strong>Nič nepodávajte ústami</strong> – žiadne jedlo, pitie ani lieky. Prehĺtanie môže byť porušené." },
        { text: "<strong>Ak stratí vedomie ale dýcha</strong> → stabilizovaná poloha. Ak nedýcha → KPR." }
      ],
      warning: "NIKDY nečakajte či príznaky ustúpia – pri mŕtvici platí „čas je mozog”. Nepodávajte aspirín – neviete, či ide o upchatie cievy alebo krvácanie v mozgu (aspirín pri krvácaní zhoršuje stav).",
      info: null,
      source: "ERC 2025 First Aid",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Stroke recognition (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "ILCOR CoSTR 2025 – First Aid: Stroke", url: "https://ilcor.org/" }
      ]
    },
    // ═══════════════════════════════════════════════════════════════
    // ÚRAZY A ZRANENIA
    // ═══════════════════════════════════════════════════════════════
    {
      id: "burns",
      emoji: "🔥",
      title: "Popáleniny",
      subtitle: "Termické popáleniny, obareniny a chemické popáleniny",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Okamžitý postup" },
        { text: "<strong>Zastavte pôsobenie tepla</strong> – odstráňte osobu od zdroja. Ak horí oblečenie: <strong>STOP – DROP – ROLL</strong> (zastavte, položte na zem, váľajte)." },
        { text: "<strong>Chlaďte tečúcou vodou 20 minút</strong> – ihneď, vodou izbovej teploty (15–25°C). ERC 2025 silné odporúčanie: chladenie je účinné aj do 3 hodín po popálení." },
        { text: "<strong>Odstráňte oblečenie a šperky</strong> – opatrne ich zložte z popálenej oblasti ak nie sú prilepené. Prstene a hodinky zložte kým opuch neznemožní." },
        { warn: "NIKDY nepoužívajte: ľad, maslo, zubnú pastu, olej, múku, med. Nepoužívajte veľmi studenú vodu – hrozí podchladenie (hlavne u detí)." },
        { header: "Po chladení" },
        { text: "<strong>Zakryte ranu</strong> voľne čistou, nelepivou tkaninou alebo potravinárskou fóliou (horizontálne pruhy, nie tesné omotanie)." },
        { text: "<strong>Neprepichujte pľuzgiere</strong> – chránia ranu pred infekciou." },
        { header: "Kedy volať 155/112" },
        { text: "<strong>Vždy volajte pri:</strong> popálenine väčšej ako dlaň postihnutého, popálenine tváre/rúk/kĺbov/genitálií, hlbokých popáleninách (biela/hnedá koža, necitlivosť), detských popáleninách, chemických a elektrických popáleninách, vdýchnutí horúceho dymu." },
        { header: "Chemické popáleniny" },
        { text: "<strong>Oplachujte veľkým množstvom vody</strong> min. 20 minút. Odstráňte kontaminovaný odev (chráňte seba – rukavice!)." },
        { text: "<strong>Suché chemikálie</strong> (prášok) – najprv oprášte, potom oplachujte vodou." },
        { header: "Elektrické popáleniny" },
        { text: "<strong>Najprv odpojte zdroj prúdu!</strong> Nedotýkajte sa osoby kým je v kontakte s elektrinou. Volajte 155 – elektrické popáleniny majú skryté vnútorné poškodenie." }
      ],
      warning: "Popáleniny >20% povrchu tela (u dospelého = celá ruka+hrudník) sú život ohrozujúce – hrozí šok z tekutinových strát. ERC 2025: aktívne chladenie je najdôležitejší krok prvej pomoci pri popáleninách.",
      info: null,
      source: "ERC 2025 + ILCOR",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Burns (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "ILCOR CoSTR 2025 – Active cooling of thermal burns", url: "https://ilcor.org/" }
      ]
    },
    {
      id: "fractures",
      emoji: "🦴",
      title: "Zlomeniny a poranenia chrbtice",
      subtitle: "Zlomeniny kostí, vyvrtnutia a poranenia kĺbov",
      iconBg: "#f5f3ee",
      iconBorder: "#e2ddd5",
      steps: [
        { header: "Rozpoznanie zlomeniny" },
        { text: "<strong>Príznaky:</strong> silná bolesť (zosilnená pohybom), opuch, deformácia, nemožnosť hýbať končatinou, prasknutie pri úraze, modriny." },
        { header: "Základný postup" },
        { text: "<strong>Postihnutého zbytočne nehýbte.</strong> Ak hrozí nebezpečenstvo (požiar, doprava), premiestnite ho čo nejopatrnejšie s fixáciou." },
        { text: "<strong>Znehybnite poranenú oblasť</strong> v polohe, v akej sa nachádza. Fixujte kĺb NAD aj POD zlomeninou. Na dlahu použite čokoľvek tvrdé (doska, palica, zrolovaný časopis) alebo fixujte k telu." },
        { text: "<strong>Studený obklad</strong> – zabalený v tkanine na opuchnuté miesto, 15–20 min. Priamo na kožu ľad nedávajte." },
        { text: "<strong>Zavolajte 155/112</strong> – pri podozrení na zlomeninu, deformácii, neschopnosti pohybu." },
        { header: "Otvorená zlomenina (kosť prečnieva)" },
        { text: "<strong>Ranu voľne prikryte</strong> čistou tkaninou. S kosťou nemanipulujte – nesnažte sa ju vtlačiť späť." },
        { text: "<strong>Ak silne krváca</strong> – zastavte krvácanie tlakom okolo (nie na) kosť. Volajte 155." },
        { header: "⚠️ Podozrenie na poranenie chrbtice" },
        { text: "<strong>Kedy podozrievať:</strong> pád z výšky, dopravná nehoda, skok do vody, priamy úder do chrbta, športový úraz." },
        { text: "<strong>NEHÝBTE osobou</strong> pokiaľ to nie je absolútne nevyhnutné (priame ohrozenie života). Čakajte na záchranárov." },
        { text: "<strong>Ak musíte presunúť:</strong> udržujte hlavu, krk a chrbát v jednej línii. Ideálne viacerí ľudia koordinovane." },
        { text: "<strong>Stabilizujte hlavu</strong> – rukami fixujte hlavu z oboch strán a zabráňte akémukoľvek pohybu krku." },
        { warn: "ERC 2025: Pri podozrení na poranenie krčnej chrbtice minimalizujte pohyb krku. Nesprávna manipulácia môže spôsobiť trvalé ochrnutie." }
      ],
      warning: "Nepokúšajte sa naprávať zlomeninu ani vyvrtnutý kĺb – to je práca lekára. Znehybníte a čakajte na pomoc.",
      info: null,
      source: "ERC 2025 First Aid",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Cervical spinal motion restriction (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" }
      ]
    },
    {
      id: "chest_wound",
      emoji: "🩸",
      title: "Otvorená rana hrudníka",
      subtitle: "Penetrujúce poranenie hrudníka (pneumotorax)",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Rozpoznanie" },
        { text: "<strong>Príznaky:</strong> rana na hrudníku (bodná, strelná, šrapnelová), bublanie alebo satie vzduchu z rany pri dýchaní, dýchavičnosť, bolesť, kašeľ s krvou." },
        { warn: "Otvorená rana hrudníka je ŽIVOT ohrozujúci stav. Vzduch vniká do hrudníka a stláča pľúca." },
        { header: "Okamžitý postup" },
        { text: "<strong>Zavolajte 155 alebo 112</strong> – ihneď." },
        { text: "<strong>Zakryte ranu ventilovou náplasťou (chest seal)</strong> – ak máte: prilepte priamo na ranu. Ventil umožní vzduchu unikať z hrudníka, ale nie vnikať." },
        { text: "<strong>Ak nemáte chest seal – improvizujte:</strong> použite potravinársku fóliu alebo čistý igelit. Prilepte ho z <strong>troch strán</strong> lepenkou a nechajte <strong>jednu stranu voľnú</strong> (jednosmerný ventil)." },
        { text: "<strong>Skontrolujte aj chrbát</strong> – strela alebo črepina môže mať výstupný otvor. Ak áno, zakryte aj tento otvor rovnakým spôsobom." },
        { header: "Poloha a monitoring" },
        { text: "<strong>Poloha:</strong> ak je pri vedomí, nechajte v polohe kde sa najlepšie dýcha (zvyčajne polased). Poranenú stranu orientujte nadol." },
        { text: "<strong>Ak sa stav zhoršuje</strong> (zrýchlené dýchanie, modranie, opuch krčnej žily) – môže sa vyvíjať tenzný pneumotorax. Stiahnite náplasť na chvíľu, aby mohol ujsť tlak, potom znova prilepte." },
        { warn: "NIKDY z rany neodstraňujte zaklínený predmet (nôž, črepina). Zafixujte ho obväzom a čakajte na záchranku." }
      ],
      warning: "Pri penetrujúcom poranení hrudníka je kľúčové utesniť ranu a zabezpečiť jednosmerný ventil. TCCC 2024: použite ventilovú náplasť prednostne pred neventilovú.",
      info: null,
      source: "ERC 2025 + TCCC 2024",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Open chest wounds (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "TCCC Guidelines 2024 – Tactical Field Care: Chest injuries", url: "https://books.allogy.com/web/tenant/8/books/b729b76a-1a34-4bf7-b76b-66bb2072b2a7/" }
      ]
    },
    // ═══════════════════════════════════════════════════════════════
    // ĎALŠIE STAVY
    // ═══════════════════════════════════════════════════════════════
    {
      id: "shock",
      emoji: "😰",
      title: "Šok",
      subtitle: "Obehový šok – zlyhanie krvného obehu",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Rozpoznanie šoku" },
        { text: "<strong>Koža:</strong> bledá, studená, spotená (lepkavá)." },
        { text: "<strong>Pulz:</strong> rýchly a slabý (>100/min)." },
        { text: "<strong>Dýchanie:</strong> zrýchlené a plytké." },
        { text: "<strong>Psychika:</strong> úzkosť, zmätenosť, ospalosť, smäd." },
        { text: "<strong>Ďalšie:</strong> závraty, mdloby, studené končatiny, oneskorené plnenie kapilár (stlačte necht – biela škvrna trvá >2 sekundy)." },
        { warn: "Šok je život ohrozujúci stav – orgány nedostávajú dosť krvi a kyslíka. Bez liečby vedie k smrti." },
        { header: "Postup" },
        { text: "<strong>Zavolajte 155 / 112</strong> – ihneď." },
        { text: "<strong>Ošetrite príčinu:</strong> ak je príčinou krvácanie – ZASTAVTE ho (pozri Silné krvácanie). Ak anafylaxia – adrenalín. Ak popáleniny – chladenie." },
        { text: "<strong>Uložte na chrbát, zdvihnite nohy</strong> 30–40 cm (podložte batohom, oblečením, vankúšom). Výnimky: poranenie nôh, poranenie chrbtice, ťažkosti s dýchaním → nechajte v polohe, ktorá je najpohodlnejšia." },
        { text: "<strong>Udržujte teplo</strong> – prikryte dekou, kabátom. Izolujte od studeného povrchu (kartón, karimatka)." },
        { text: "<strong>Nepodávajte jedlo ani pitie</strong> – hrozí aspirácia (vdýchnutie). Ak je veľmi smädný, navlhčite pery." },
        { text: "<strong>Monitorujte vedomie a dýchanie</strong> – ak stratí vedomie: stabilizovaná poloha. Ak nedýcha: KPR." },
        { text: "<strong>Hovorte s postihnutým</strong> – upokojte ho, vysvetlite čo robíte. Psychická podpora znižuje stres a spomaľuje šok." }
      ],
      warning: "Šok sa môže rozvinúť aj desiatky minút po úraze – aj keď osoba vyzerá dobre, monitorujte ju. Príčiny: krvácanie, ťažká alergia, popáleniny, infekcia, srdcový problém.",
      info: null,
      source: "ERC 2025 First Aid",
      sources: [
        { label: "ERC Guidelines 2025 – First Aid: Shock management (Djärv et al.)", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" }
      ]
    },
    {
      id: "hypothermia",
      emoji: "🥶",
      title: "Podchladenie",
      subtitle: "Pokles telesnej teploty pod 35°C",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Rozpoznanie" },
        { text: "<strong>Mierne (35–32°C):</strong> triaška, husacia koža, studené ruky a nohy, ťažkopádna reč, zmätenosť." },
        { text: "<strong>Stredné (32–28°C):</strong> triaška ustáva (!), ospalosť, strata koordinácie, iracionálne správanie (paradoxné vyzliekanie)." },
        { text: "<strong>Ťažké (<28°C):</strong> strata vedomia, sotva hmatateľný pulz, nehybnosť – môže vyzerať ako mŕtvy, ale NEMUSÍ byť." },
        { warn: "ERC 2025: „Nikto nie je mŕtvy, kým nie je teplý a mŕtvy.” Pri ťažkom podchladení vždy začnite KPR ak nedýcha – aj pri zdanlivo beznádejnom stave." },
        { header: "Postup" },
        { text: "<strong>Presuňte do tepla</strong> – ak to nie je možné, chráňte pred vetrom, dažďom a chladom (prístrešok, izolácia od zeme)." },
        { text: "<strong>Vyzlečte mokré oblečenie</strong> – opatrne! Nahraďte suchým. Osoba sa nesmie sama prezliekať ani veľa hýbať." },
        { text: "<strong>Zahrievajte postupne a pasívne:</strong> zabaľte do diek, spacáku, izotermickej fólie (striebornou stranou dovnútra)." },
        { text: "<strong>Aktívne teplo na trup:</strong> teplé (nie horúce!) obklady alebo fľaše s teplou vodou na hrudník, podpazušie, slabiny – zabalené v tkanine." },
        { text: "<strong>Teplé sladké nápoje</strong> – ak je pri vedomí a dokáže prehĺtať. <strong>Nepodávajte alkohol</strong> – rozširuje cievy a zvyšuje straty tepla." },
        { text: "<strong>Zavolajte 155/112</strong> – pri strednom a ťažkom podchladení vždy." },
        { header: "Kritické chyby" },
        { text: "<strong>Nezahrievajte náhle</strong> (horúca vaňa, horúci radiátor) – studená krv z končatín naplaví srdce a môže spôsobiť zástavu." },
        { text: "<strong>Netrieťe končatiny</strong> a nemasírujte – hrozí srdcová arytmia." },
        { text: "<strong>Zaobchádzajte veľmi jemne</strong> – prudký pohyb pri ťažkom podchladení môže spustiť fibriláciu srdca." }
      ],
      warning: "S ťažko podchladenou osobou zaobchádzajte ako s „surovým vajíčkom” – každý prudký pohyb môže spôsobiť srdcovú arytmiu. Zahrievajte len trup, nie končatiny.",
      info: null,
      source: "ERC 2025 + SK MINV",
      sources: [
        { label: "ERC Guidelines 2025 – Special Circumstances: Hypothermia", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00265-5/fulltext" },
        { label: "SK MINV – Ochrana obyvateľstva: Nízke teploty", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "poisoning",
      emoji: "☠️",
      title: "Otrava",
      subtitle: "Požitie, vdýchnutie alebo kontakt s jedom",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Bezpečnosť najprv" },
        { text: "<strong>Uistite sa, že miesto je bezpečné pre vás.</strong> Pri otrave plynom/chemikáliou – nevchádzajte bez ochrany. Odveďte osobu na čerstvý vzduch." },
        { header: "Aktivácia pomoci" },
        { text: "<strong>Zavolajte 155 alebo 112.</strong> Alebo volajte priamo:<br>• <strong>NTIC: <a href='tel:+421254774166' style='color:#1e40af;'>+421 2 5477 4166</a></strong> (24/7, nonstop)<br>• <strong>Mobil: <a href='tel:+421911166066' style='color:#1e40af;'>0911 166 066</a></strong>" },
        { note: "Národné toxikologické informačné centrum (NTIC) poskytuje odborné rady pri otravách pre lekárov aj verejnosť – 24 hodín denne." },
        { header: "Zistite okolnosti" },
        { text: "<strong>Čo, koľko a kedy</strong> – zistite akú látku osoba požila/vdýchla, približné množstvo a čas. Zachovajte obal, zvyšok látky alebo zvratky pre záchranárov." },
        { header: "Čo robiť a čo NIE" },
        { text: "<strong>Nevyvolávajte zvracanie</strong> – pokiaľ to výslovne neodporučí lekár alebo toxikológ. Pri žieravých látkach (kyseliny, lúhy, Domestos) by zvracanie spôsobilo ďalšie poleptanie." },
        { text: "<strong>Nepodávajte nič ústami</strong> (mlieko, uhlie, vodu) bez konzultácie s lekárom." },
        { text: "<strong>Ak je pri vedomí</strong> – udržujte v pokoji, monitorujte stav." },
        { text: "<strong>Ak je v bezvedomí a dýcha</strong> – uložte do stabilizovanej polohy (aby sa nezadusila zvratkami)." },
        { text: "<strong>Ak nedýcha</strong> – začnite KPR. Pozor: pri otrave cez ústa zvážte riziko kontaminácie – použite bariérový prostriedok alebo robte len stlačovanie hrudníka." },
        { header: "Kontakt s chemikáliou na koži/v očiach" },
        { text: "<strong>Vyplachujte postihnuté miesto</strong> veľkým množstvom čistej tečúcej vody minimálne <strong>15–20 minút</strong>. Odstráňte kontaminovaný odev." }
      ],
      warning: "Pri otrave nebezpečnými látkami – chráňte si dýchacie cesty a oči, opustite ohrozený priestor. Niektoré látky (hubky, metanol) majú oneskorený účinok – vyhľadajte lekára aj keď sa cítite dobre.",
      info: "Národné toxikologické informačné centrum (NTIC): <strong><a href='tel:+421254774166' style='color:#1e40af;'>+421 2 5477 4166</a></strong> alebo <strong><a href='tel:+421911166066' style='color:#1e40af;'>0911 166 066</a></strong> (24/7, nonstop).",
      source: "ERC 2025 + NTIC + SK MINV",
      sources: [
        { label: "ERC Guidelines 2025 – Special Circumstances: Toxic agents", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00265-5/fulltext" },
        { label: "Národné toxikologické informačné centrum (NTIC)", url: "https://www.ntic.sk/" },
        { label: "SK MINV – Únik nebezpečných chemických látok", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    // ═══════════════════════════════════════════════════════════════
    // VOJNOVÉ ZRANENIA (TCCC PRE CIVILISTOV)
    // ═══════════════════════════════════════════════════════════════
    {
      id: "war_injuries",
      emoji: "🎯",
      title: "Vojnové zranenia",
      subtitle: "Strelné, šrapnelové a výbuchové zranenia – TCCC pre civilistov",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "⚠️ BEZPEČNOSŤ NAJPRV" },
        { text: "<strong>Nikdy nepomáhajte pod paľbou.</strong> Vaša smrť neznamenáa viac záchrancov. Počkajte kým je bezpečne, alebo prenášajte zraneného do úkrytu." },
        { text: "<strong>Ak je zranený pri vedomí</strong> – komunikujte: „Som tu, pomôžem ti. Musíš sa presunúť ku mne.” Navigujte ho do bezpečia." },
        { header: "Protokol M.A.R.C.H. (NATO / UA štandard)" },
        { note: "MARCH je poradie priorít – riešte prvý problém ktorý nájdete, potom pokračujte ďalej." },
        { text: "<strong>M – Massive bleeding (masívne krvácanie)</strong><br>→ Turniket na končatiny (5–7 cm nad ranu, uťahovať kým neprestane krvácanie)<br>→ Wound packing pre neturniketovateľné oblasti (krk, podpazušie, slabiny)<br>→ <strong>Zapíšte čas</strong> fixkou na turniket aj na telo/čelo" },
        { text: "<strong>A – Airway (dýchacie cesty)</strong><br>→ Ak je pri vedomí – nechajte v polohe kde sa mu najlepšie dýcha (aj sediačky)<br>→ Ak je v bezvedomí – záklon hlavy, zdvihnutie brady, stabilizovaná poloha" },
        { text: "<strong>R – Respiration (dýchanie)</strong><br>→ Skontrolujte hrudník – otvorenej rane priložte chest seal alebo fóliu z 3 strán<br>→ Skontrolujte aj chrbát (výstupný otvor)" },
        { text: "<strong>C – Circulation (obeh/šok)</strong><br>→ Skontrolujte ďalšie krvácanie po celom tele<br>→ Uložte na chrbát, zdvihnite nohy<br>→ Udržujte teplo" },
        { text: "<strong>H – Hypothermia (podchladenie)</strong><br>→ Zranený stráca teplo veľmi rýchlo – zabaľte do izotermickej fólie alebo čohokoľvek<br>→ Izolujte od zeme (kartón, karimatka, oblečenie)" },
        { header: "Výbuchové zranenia (blast)" },
        { text: "<strong>Výbuch spôsobuje viacero typov zranení:</strong><br>• Tlaková vlna – poškodenie pľúc, uší (hluchota), vnútorné orgány<br>• Črepiny/šrapnel – penetrujúce rany<br>• Odhodenie telom – tupé zranenia, zlomeniny<br>• Popáleniny – termické a chemické" },
        { text: "<strong>Ošetrite čo vidíte:</strong> zastavte krvácanie, zakryte otvorené rany, chráňte pred podchladením." },
        { warn: "Po výbuchu: skontrolujte uši (krvácanie = barotrauma), dýchanie (piskanie = poškodenie pľúc). Aj „dobre vyzerajúci” zranení môžu mať skryté vnútorné zranenia." },
        { header: "Strelné rany" },
        { text: "<strong>Vstupný aj výstupný otvor:</strong> strela vytvára vstupný otvor (menší) a výstupný (väčší, nepravidelný). Ošetrite obe rany." },
        { text: "<strong>Na končatinách:</strong> turniket je prvá voľba. Na trupe: wound packing + priamy tlak." },
        { text: "<strong>Z rany nič nevyťahujte</strong> – zaklínený predmet zabraňuje väčšiemu krvácaniu." },
        { header: "Zavolajte pomoc" },
        { text: "<strong>112</strong> – a čakajte na záchranku. Ak ste v oblasti konfliktu, presúňte zraneného do bezpečného miesta." }
      ],
      warning: "Turniket neuvoľňujte – to je práca lekára v nemocnici. Nedotýkajte sa neznámych predmetov – môže ísť o nevybuchnutú muníciu. Pri blast zraneniach – aj keď osoba vyzerá dobre, VŽDY volajte záchranku.",
      info: "TCCC (Tactical Combat Casualty Care) je medzinárodne uznávaný štandard pre ošetrenie bojových zranení, používaný v Ukrajine a NATO. Tieto postupy sú adaptované pre civilistov – žiadne lieky, len základné manuálne zákroky.",
      source: "TCCC 2024 + ERC 2025 + UA DSNS",
      sources: [
        { label: "TCCC Guidelines 2024 – Tactical Combat Casualty Care", url: "https://books.allogy.com/web/tenant/8/books/b729b76a-1a34-4bf7-b76b-66bb2072b2a7/" },
        { label: "TCCC Ukrajina – Taktická medicína pre civilistov", url: "https://tccc.org.ua/en" },
        { label: "ERC Guidelines 2025 – First Aid: Life-threatening bleeding", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00264-3/fulltext" },
        { label: "UA DSNS – Núdzová príručka: Prvá pomoc", url: "https://dovidka.info/" }
      ]
    }
  ];


  function renderFirstAid() {
    const grid = document.getElementById("firstAidGrid");
    if (!grid) return;
    grid.innerHTML = "";
    FIRST_AID_DATA.forEach(item => {
      const card = document.createElement("div");
      card.className = "fa-card";
      card.setAttribute("role", "button");
      card.setAttribute("tabindex", "0");
      card.setAttribute("aria-label", item.title + " – zobraziť postup prvej pomoci");
      card.innerHTML = `
        <div class="fa-icon" style="background:${item.iconBg}; border:1.5px solid ${item.iconBorder};">
          ${item.emoji}
        </div>
        <div class="fa-card-label">${item.title}</div>`;
      card.onclick = () => openFirstAidModal(item);
      card.onkeydown = (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openFirstAidModal(item); }};
      grid.appendChild(card);
    });
  }

  // ── Shared modal content renderer ──────────────────────────────
  function renderStepsHTML(steps, options = {}) {
    const housing = options.housing || "flat";
    let html = '';
    let inSection = false;
    let stepNum = 0;

    steps.forEach(step => {
      if (step.forHousing && !step.forHousing.includes(housing)) return;

      if (step.header) {
        if (inSection) html += '</div></div>'; // close steps + section
        html += `<div class="modal-section">`;
        html += `<div class="modal-section-header">${step.header}</div>`;
        html += `<div class="modal-section-steps">`;
        inSection = true;
        stepNum = 0;
        return;
      }

      if (!inSection) {
        html += `<div class="modal-section"><div class="modal-section-steps">`;
        inSection = true;
      }

      if (step.note) {
        html += `<div class="modal-note-box"><strong>💡</strong> ${step.note}</div>`;
        return;
      }
      if (step.warn) {
        html += `<div class="modal-warn-box"><strong>⚠️</strong> ${step.warn}</div>`;
        return;
      }
      if (step.text) {
        stepNum++;
        html += `<div class="fa-modal-step">
          <div class="fa-step-num">${stepNum}</div>
          <div class="fa-step-text">${step.text}</div>
        </div>`;
      }
    });

    if (inSection) html += '</div></div>';
    return html;
  }

  function renderSourcesCollapsible(sources, source) {
    if (!sources && !source) return '';
    let linksHtml = '';
    if (Array.isArray(sources)) {
      linksHtml = sources.map(s =>
        s.url ? `<a href="${s.url}" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:underline;">${s.label}</a>` : s.label
      ).join('<br>');
    } else if (source) {
      linksHtml = source;
    }
    return `<div style="margin-top:1rem; border-top:1px solid var(--c-border); padding-top:0.5rem;">
      <button class="source-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('open') ? 'rotate(180deg)' : ''">
        💡 Zdroje <span class="arrow">▼</span>
      </button>
      <div class="source-body">${linksHtml}</div>
    </div>`;
  }

  function openFirstAidModal(item) {
    const icon = document.getElementById("faModalIcon");
    const title = document.getElementById("faModalTitle");
    const subtitle = document.getElementById("faModalSubtitle");
    const content = document.getElementById("faModalContent");

    icon.style.background = item.iconBg;
    icon.style.border = `1.5px solid ${item.iconBorder}`;
    icon.textContent = item.emoji;
    title.textContent = item.title;
    subtitle.textContent = item.subtitle;

    let html = `<div class="fa-emergency-bar">📞 Tiesňové číslo: <a href="tel:112">112</a> &nbsp;|&nbsp; Záchranka: <a href="tel:155">155</a></div>`;

    // Count real steps for quick-view limit
    const QUICK_VIEW_LIMIT = 3;
    const realSteps = item.steps.filter(s => s.text);
    const hasMoreSteps = realSteps.length > QUICK_VIEW_LIMIT;

    // Render all steps with section structure
    const allStepsHtml = renderStepsHTML(item.steps);

    if (hasMoreSteps) {
      // Split: show first few, hide rest behind expand button
      // We show the full structured HTML but wrap the "more" portion
      html += `<div id="faQuickView">${allStepsHtml}</div>`;

      // Warning/info/source in hidden section
      let extraHtml = '';
      if (item.warning) extraHtml += `<div class="fa-warning"><strong>⚠️ Dôležité:</strong> ${item.warning}</div>`;
      if (item.info) extraHtml += `<div class="fa-info"><strong>💡 Tip:</strong> ${item.info}</div>`;
      extraHtml += renderSourcesCollapsible(item.sources, item.source);

      html += `<div id="faExtraContent" style="display:none;">${extraHtml}</div>`;
      html += `<button id="faExpandBtn" onclick="document.getElementById('faExtraContent').style.display='block'; this.style.display='none';" style="width:100%; margin-top:0.5rem; padding:0.75rem; background:var(--c-info-bg); border:1.5px solid var(--c-info-border); border-radius:0.875rem; font-family:'Lexend',sans-serif; font-size:0.82rem; font-weight:700; color:var(--c-info); cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.06)'" onmouseout="this.style.transform='';this.style.boxShadow=''">⚠️ Dôležité upozornenia a zdroje →</button>`;
    } else {
      html += allStepsHtml;
      if (item.warning) html += `<div class="fa-warning"><strong>⚠️ Dôležité:</strong> ${item.warning}</div>`;
      if (item.info) html += `<div class="fa-info"><strong>💡 Tip:</strong> ${item.info}</div>`;
      html += renderSourcesCollapsible(item.sources, item.source);
    }

    content.innerHTML = html;
    openModal("modalFirstAid");
  }

  // ══════════════════════════════════════════════════════════════════
  // DÔLEŽITÉ KONTAKTY
  // ══════════════════════════════════════════════════════════════════

  const EMERGENCY_LINES = [
    { number: "112", label: "Tiesňová linka", desc: "Univerzálna európska tiesňová linka (24/7). Funguje aj bez SIM karty a bez kreditu. Možno zaslať aj SMS. Operátor hovorí anglicky. Volajte ak neviete, ktorú zložku potrebujete.", emoji: "🆘", bg: "#fef2f2", border: "#fecaca", color: "#dc2626" },
    { number: "150", label: "Hasiči (HaZZ)", desc: "Hasičský a záchranný zbor SR. Volajte pri požiari, úniku chemikálií alebo plynu, dopravnej nehode, záchrane osôb z výšky/hĺbky, záplavách a technických zásahoch.", emoji: "🚒", bg: "#fef2f2", border: "#fecaca", color: "#dc2626" },
    { number: "155", label: "Záchranka (ZZS)", desc: "Záchranná zdravotná služba. Volajte pri bezvedomí, zástave dýchania, silnom krvácaní, bolesti na hrudníku, podozrení na mŕtvicu, ťažkých úrazoch, otravách a popáleninách.", emoji: "🚑", bg: "#eff6ff", border: "#bfdbfe", color: "#1e40af" },
    { number: "158", label: "Polícia (PZ SR)", desc: "Policajný zbor SR. Volajte pri trestnom čine, dopravnej nehode, ohrození bezpečnosti, krádeži, násilí, podozrivej činnosti alebo náleze podozrivého predmetu.", emoji: "🚔", bg: "#eff6ff", border: "#bfdbfe", color: "#1e40af" },
    { number: "159", label: "Mestská polícia", desc: "Obecná / mestská polícia. Verejný poriadok, parkovanie, rušenie nočného kľudu, túlavé zvieratá, čierne skládky.", emoji: "👮", bg: "#f5f3ee", border: "#e2ddd5", color: "#6b6560" },
    { number: "18 300", label: "Horská služba", desc: "Horská záchranná služba (HZS). Volajte pri úraze alebo stratení v horách. Funguje celoročne. Ak nemáte signál, skúste SMS na 112.", emoji: "⛰️", bg: "#eaf4ee", border: "#86efac", color: "#2a7a4b" },
  ];

  const INSTITUTIONS = [
    // Zdravotníctvo a toxikológia
    { name: "Národné toxikologické informačné centrum (NTIC)", phone: "+421 2 5477 4166", phone2: "0911 166 066", desc: "24/7 nonstop – odborné rady pri otravách pre lekárov aj verejnosť. Volajte pri požití liekov, chemikálií, húb, čistiacich prostriedkov.", emoji: "☠️" },
    { name: "Úrad verejného zdravotníctva SR", phone: "+421 2 4928 4111", url: "https://www.uvzsr.sk", desc: "Epidemiologické ohrozenia, očkovanie, kvalita pitnej vody, ochrana zdravia.", emoji: "🏥" },
    // Krízové a psychologické linky
    { name: "Linka dôvery", phone: "0800 500 333", desc: "Bezplatná, nonstop, anonymná. Emocionálna podpora, krízy, myšlienky na sebapoškodenie. Pre dospelých aj mladistvých.", emoji: "💚" },
    { name: "Linka pomoci", phone: "116 123", desc: "Emocionálna podpora a pomoc v krízových situáciách. Bezplatná linka.", emoji: "🤝" },
    { name: "Linka pre ženy zažívajúce násilie", phone: "0800 212 212", desc: "Bezplatná, anonymná, 24/7. Pomoc pre obete domáceho násilia.", emoji: "🛡️" },
    // Civilná ochrana a počasie
    { name: "MV SR – Civilná ochrana", url: "https://www.minv.sk/?ochrana-obyvatelstva", desc: "Varovanie obyvateľstva, evakuácia, krízové riadenie. Oficiálne informácie pri mimoriadnych udalostiach.", emoji: "🛡️" },
    { name: "SHMÚ – Výstrahy a počasie", url: "https://www.shmu.sk", desc: "Meteorologické a hydrologické výstrahy, predpovede počasia, povodňová aktivita, kvalita ovzdušia.", emoji: "🌦️" },
    // Humanitárna pomoc
    { name: "Slovenský Červený kríž", phone: "+421 2 5441 3868", url: "https://www.redcross.sk", desc: "Humanitárna pomoc, prvá pomoc, kurzy prvej pomoci, vyhľadávanie osôb, psychosociálna podpora.", emoji: "✚" },
    // Poruchové linky – energie
    { name: "SPP – Poruchová linka PLYN", phone: "0850 111 727", desc: "24/7, celé Slovensko. Volajte ihneď pri úniku plynu, zápachu, poškodení plynového zariadenia.", emoji: "🔥", highlight: true },
    { name: "Poruchy elektriny – ZSD (západ)", phone: "0800 111 567", desc: "Západoslovenská distribučná. Bratislavský, Trnavský, Nitriansky kraj. Bezplatná linka.", emoji: "⚡" },
    { name: "Poruchy elektriny – SSD (stred)", phone: "0800 159 000", desc: "Stredoslovenská distribučná. Žilinský, Banskobystrický kraj. Bezplatná linka.", emoji: "⚡" },
    { name: "Poruchy elektriny – VSD (východ)", phone: "0800 123 332", desc: "Východoslovenská distribučná. Prešovský, Košický kraj. Bezplatná linka.", emoji: "⚡" },
  ];

  function renderEmergencyContacts() {
    // Tiesňové linky
    const linesGrid = document.getElementById("emergencyLinesGrid");
    if (!linesGrid) return;
    linesGrid.innerHTML = "";
    EMERGENCY_LINES.forEach(line => {
      const card = document.createElement("a");
      card.href = `tel:${line.number.replace(/\s/g, "")}`;
      card.className = "ec-card";
      card.title = line.desc;
      card.innerHTML = `
        <div class="ec-icon" style="background:${line.bg}; border:1.5px solid ${line.border};">${line.emoji}</div>
        <div class="ec-card-label">${line.label}</div>
        <div class="ec-card-number" style="color:${line.color};">${line.number}</div>`;
      linesGrid.appendChild(card);
    });

    // Inštitúcie – with group headers
    const instGrid = document.getElementById("institutionsGrid");
    if (!instGrid) return;
    instGrid.innerHTML = "";
    
    const instGroups = [
      { label: "🏥 Zdravie a toxikológia", indices: [0, 1] },
      { label: "💚 Krízové a psychologické linky", indices: [2, 3, 4] },
      { label: "🛡️ Civilná ochrana a počasie", indices: [5, 6] },
      { label: "✚ Humanitárna pomoc", indices: [7] },
      { label: "⚡ Poruchové linky – energie (24/7)", indices: [8, 9, 10, 11] },
    ];
    
    instGroups.forEach(group => {
      const collapse = document.createElement("div");
      collapse.className = "info-collapse";
      collapse.style.cssText = "background:var(--c-bg); border-radius:0.75rem;";
      
      let itemsHtml = "";
      group.indices.forEach(idx => {
        const inst = INSTITUTIONS[idx];
        if (!inst) return;
        let actions = "";
        if (inst.phone) actions += `<a href="tel:${inst.phone.replace(/\s/g, "")}" style="display:inline-flex; align-items:center; gap:0.25rem; background:${inst.highlight ? '#fef2f2' : '#eaf4ee'}; color:${inst.highlight ? '#dc2626' : '#2a7a4b'}; border:1px solid ${inst.highlight ? '#fecaca' : '#86efac'}; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.7rem; font-weight:600; text-decoration:none; font-family:'Lexend',sans-serif; white-space:nowrap;">📞 ${inst.phone}</a> `;
        if (inst.phone2) actions += `<a href="tel:${inst.phone2.replace(/\s/g, "")}" style="display:inline-flex; align-items:center; gap:0.25rem; background:#eaf4ee; color:#2a7a4b; border:1px solid #86efac; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.7rem; font-weight:600; text-decoration:none; font-family:'Lexend',sans-serif; white-space:nowrap;">📞 ${inst.phone2}</a> `;
        if (inst.url) actions += `<a href="${inst.url}" target="_blank" rel="noopener" style="display:inline-flex; align-items:center; gap:0.25rem; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.7rem; font-weight:600; text-decoration:none; font-family:'Lexend',sans-serif; white-space:nowrap;">🔗 Web</a>`;
        itemsHtml += `
          <div style="display:flex; align-items:flex-start; gap:0.75rem; padding:0.625rem 0; border-bottom:1px solid var(--c-border);">
            <div style="font-size:1.25rem; flex-shrink:0; margin-top:0.125rem;">${inst.emoji}</div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:700; font-size:0.85rem; line-height:1.3;">${inst.name}</div>
              <div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.15rem; line-height:1.5;">${inst.desc}</div>
              <div style="display:flex; flex-wrap:wrap; gap:0.375rem; margin-top:0.5rem;">${actions}</div>
            </div>
          </div>`;
      });
      
      collapse.innerHTML = `
        <button class="info-collapse-toggle" style="color:var(--c-text);" onclick="this.closest('.info-collapse').classList.toggle('open')">
          <span>${group.label} <span style="font-size:0.68rem; color:var(--c-muted); font-weight:400;">(${group.indices.length})</span></span>
          <span class="info-collapse-arrow">▼</span>
        </button>
        <div class="info-collapse-body" style="padding-top:0;">${itemsHtml}</div>`;
      instGrid.appendChild(collapse);
    });
  }

  // ══════════════════════════════════════════════════════════════════
  // OSOBNÉ KONTAKTY
  // ══════════════════════════════════════════════════════════════════

  const PC_CATEGORIES = [
    // Rodina a blízki
    { id: "family",      emoji: "👨‍👩‍👧", label: "Rodina",              placeholder: "Mama, otec, babka, dedko..." },
    { id: "neighbor",    emoji: "🏘️", label: "Sused / susedka",     placeholder: "Pán Horváth, 3. poschodie" },
    { id: "friend",      emoji: "🫂", label: "Blízky priateľ",      placeholder: "Kamarát, ktorý vie pomôcť" },
    { id: "work",        emoji: "💼", label: "Práca / zamestnávateľ", placeholder: "HR, šéf, kolega..." },
    { id: "school",      emoji: "🎒", label: "Škola / škôlka",      placeholder: "ZŠ Partizánska, triedna učiteľka" },
    // Zdravie
    { id: "doctor",      emoji: "🩺", label: "Všeobecný lekár",     placeholder: "MUDr. Kováč, praktický lekár" },
    { id: "doctor_kid",  emoji: "👶", label: "Pediater",            placeholder: "MUDr. Nová, detská ambulancia" },
    { id: "dentist",     emoji: "🦷", label: "Zubár",               placeholder: "MDDr. Horvát" },
    { id: "specialist",  emoji: "🏥", label: "Špecialista",         placeholder: "Kardiológ, alergológ, psychiater..." },
    { id: "pharmacy",    emoji: "💊", label: "Lekáreň",             placeholder: "Lekáreň pri nemocnici, non-stop" },
    // Financie a právo
    { id: "bank",        emoji: "🏦", label: "Banka",               placeholder: "Slovenská sporiteľňa, pobočka..." },
    { id: "lawyer",      emoji: "⚖️", label: "Právnik / notár",     placeholder: "JUDr. Novák" },
    { id: "ins_life",    emoji: "🛡️", label: "Životná poisťovňa",   placeholder: "Allianz – číslo zmluvy..." },
    { id: "ins_car",     emoji: "🚗", label: "Autopoistenie",       placeholder: "Generali – PZP / havarijné" },
    { id: "ins_home",    emoji: "🏠", label: "Poistenie bytu/domu", placeholder: "ČSOB Poisťovňa – domácnosť" },
    // Služby pre domácnosť
    { id: "electric",    emoji: "⚡", label: "Elektrikár",           placeholder: "Poruchová linka / súkromný" },
    { id: "gas",         emoji: "🔥", label: "Plynár / SPP",        placeholder: "SPP poruchová: 0850 111 727" },
    { id: "water",       emoji: "💧", label: "Vodár / vodáreň",     placeholder: "BVS, TVVK – poruchová linka" },
    { id: "locksmith",   emoji: "🔑", label: "Zámočník",            placeholder: "Non-stop zámočnícka služba" },
    { id: "vet",         emoji: "🐾", label: "Veterinár",           placeholder: "MVDr. Horváth, veterinárna klinika" },
    // Úrady a ostatné
    { id: "embassy",     emoji: "🏛️", label: "Ambasáda / konzulát", placeholder: "Zastupiteľský úrad..." },
    { id: "civil_def",   emoji: "📢", label: "Civilná ochrana / obec", placeholder: "Obecný úrad, krízový štáb..." },
    { id: "other",       emoji: "📝", label: "Iný kontakt",         placeholder: "" },
  ];

  let pcSelectedCategoryId = "";

  function renderPersonalContacts() {
    const grid = document.getElementById("personalContactsGrid");
    if (!grid) return;
    const contacts = state.personalContacts || [];

    if (contacts.length === 0) {
      grid.innerHTML = `
        <div onclick="openPersonalContactModal(-1)" tabindex="0" role="button" aria-label="Pridať osobný kontakt" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPersonalContactModal(-1)}" style="background:linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border:1.5px dashed #86efac; border-radius:1rem; padding:1.25rem; cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 18px rgba(0,0,0,0.06)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="display:flex; align-items:center; gap:0.75rem;">
            <div style="width:44px; height:44px; border-radius:50%; background:#86efac; display:flex; align-items:center; justify-content:center; font-size:1.25rem; flex-shrink:0;">+</div>
            <div>
              <div style="font-weight:700; font-size:0.9rem; color:#166534;">Pridajte si osobné kontakty</div>
              <div style="font-size:0.75rem; color:#22c55e; line-height:1.5; margin-top:0.125rem;">Lekár, rodina, sused, poisťovňa, elektrikár, škola – všetko na jednom mieste, offline prístupné aj bez internetu a signálu.</div>
            </div>
          </div>
        </div>`;
      return;
    }

    // Group contacts by category
    const grouped = {};
    contacts.forEach((c, idx) => {
      const catId = c.categoryId || "other";
      if (!grouped[catId]) grouped[catId] = [];
      grouped[catId].push({ ...c, _idx: idx });
    });

    let html = "";
    // Sort groups by PC_CATEGORIES order
    const catOrder = PC_CATEGORIES.map(c => c.id);
    const sortedKeys = Object.keys(grouped).sort((a, b) => catOrder.indexOf(a) - catOrder.indexOf(b));

    sortedKeys.forEach(catId => {
      const cat = PC_CATEGORIES.find(c => c.id === catId) || { emoji: "📝", label: "Iný" };
      const items = grouped[catId];
      items.forEach(c => {
        const phoneClean = (c.phone||"").replace(/\s/g, "");
        const phone2Clean = (c.phone2||"").replace(/\s/g, "");
        html += `
          <div style="display:flex; align-items:flex-start; gap:0.75rem; padding:0.75rem 0.875rem; background:var(--c-bg); border-radius:0.875rem; cursor:pointer; transition:background 0.15s;" tabindex="0" role="button" aria-label="${esc(c.name||'')} – ${cat.label}" onclick="openPersonalContactModal(${c._idx})" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPersonalContactModal(${c._idx})}" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background='var(--c-bg)'">
            <div style="font-size:1.25rem; flex-shrink:0; margin-top:0.125rem;">${cat.emoji}</div>
            <div style="flex:1; min-width:0;">
              <div style="display:flex; align-items:center; gap:0.375rem; flex-wrap:wrap;">
                <span style="font-weight:700; font-size:0.85rem; line-height:1.3;">${esc(c.name||"")}</span>
                <span style="font-size:0.65rem; font-weight:600; color:var(--c-muted); background:var(--c-surface); border:1px solid var(--c-border); border-radius:0.375rem; padding:0.1rem 0.375rem;">${cat.label}${c.customType ? " – " + esc(c.customType) : ""}</span>
              </div>
              ${c.note ? `<div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.15rem; line-height:1.4;">${esc(c.note)}</div>` : ""}
              <div style="display:flex; flex-wrap:wrap; gap:0.375rem; margin-top:0.5rem;" onclick="event.stopPropagation()">
                <a href="tel:${phoneClean}" style="display:inline-flex; align-items:center; gap:0.25rem; background:#eaf4ee; color:#2a7a4b; border:1px solid #86efac; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.7rem; font-weight:600; text-decoration:none; font-family:'Lexend',sans-serif; white-space:nowrap;">📞 ${esc(c.phone||"")}</a>
                ${c.phone2 ? `<a href="tel:${phone2Clean}" style="display:inline-flex; align-items:center; gap:0.25rem; background:#eaf4ee; color:#2a7a4b; border:1px solid #86efac; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.7rem; font-weight:600; text-decoration:none; font-family:'Lexend',sans-serif; white-space:nowrap;">📞 ${esc(c.phone2)}</a>` : ""}
                ${c.address ? `<span style="display:inline-flex; align-items:center; gap:0.25rem; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.7rem; font-weight:600; font-family:'Lexend',sans-serif; white-space:nowrap;">📌 ${esc(c.address)}</span>` : ""}
              </div>
            </div>
            <div style="color:var(--c-muted); font-size:0.8rem; flex-shrink:0; margin-top:0.25rem;">✏️</div>
          </div>`;
      });
    });

    grid.innerHTML = html;
  }

  // ── Personal contact modal ──────────────────────────────────────
  function openPersonalContactModal(editIndex) {
    const f = document.getElementById("personalContactForm");
    const isEdit = editIndex >= 0 && editIndex < (state.personalContacts||[]).length;
    const c = isEdit ? state.personalContacts[editIndex] : {};

    document.getElementById("pcModalTitle").textContent = isEdit ? "✏️ Upraviť kontakt" : "👤 Nový kontakt";
    f.elements["pc_editIndex"].value = editIndex;
    f.elements["pc_name"].value = c.name || "";
    f.elements["pc_phone"].value = c.phone || "";
    f.elements["pc_phone2"].value = c.phone2 || "";
    f.elements["pc_address"].value = c.address || "";
    f.elements["pc_note"].value = c.note || "";
    document.getElementById("pcCustomTypeInput").value = c.customType || "";
    document.getElementById("pcCustomTypeInput").style.display = (c.categoryId === "other") ? "block" : "none";
    document.getElementById("btnDeletePC").style.display = isEdit ? "inline-flex" : "none";

    pcSelectedCategoryId = c.categoryId || "";
    renderPCCategoryPicker();
    openModal("modalPersonalContact");
  }
  window.openPersonalContactModal = openPersonalContactModal;

  function renderPCCategoryPicker() {
    const box = document.getElementById("pcCategoryPicker");
    if (!box) return;
    box.innerHTML = PC_CATEGORIES.map(cat => {
      const sel = pcSelectedCategoryId === cat.id;
      return `<button type="button" data-pccat="${cat.id}" style="display:inline-flex; align-items:center; gap:0.25rem; padding:0.3rem 0.5rem; border-radius:0.5rem; font-size:0.72rem; font-weight:600; font-family:'Lexend',sans-serif; cursor:pointer; transition:all 0.15s; border:1.5px solid ${sel ? '#2a7a4b' : 'var(--c-border)'}; background:${sel ? '#eaf4ee' : 'var(--c-surface)'}; color:${sel ? '#2a7a4b' : 'var(--c-muted)'};" title="${cat.label}">${cat.emoji} ${cat.label}</button>`;
    }).join("");
    box.querySelectorAll("[data-pccat]").forEach(btn => {
      btn.onclick = () => {
        pcSelectedCategoryId = btn.dataset.pccat;
        renderPCCategoryPicker();
        const custom = document.getElementById("pcCustomTypeInput");
        custom.style.display = pcSelectedCategoryId === "other" ? "block" : "none";
        // Pre-fill name placeholder
        const cat = PC_CATEGORIES.find(c => c.id === pcSelectedCategoryId);
        if (cat && cat.placeholder) {
          document.querySelector("[name='pc_name']").placeholder = cat.placeholder;
        }
      };
    });
  }

  document.getElementById("btnAddPersonalContact").onclick = () => openPersonalContactModal(-1);

  document.getElementById("personalContactForm").onsubmit = (e) => {
    e.preventDefault();
    if (!pcSelectedCategoryId) { alert("Vyberte typ kontaktu."); return; }
    const fd = new FormData(e.target);
    const idx = parseInt(fd.get("pc_editIndex"));
    const contact = {
      categoryId: pcSelectedCategoryId,
      customType: pcSelectedCategoryId === "other" ? String(fd.get("pc_customType")||"").trim() : "",
      name: String(fd.get("pc_name")||"").trim(),
      phone: String(fd.get("pc_phone")||"").trim(),
      phone2: String(fd.get("pc_phone2")||"").trim(),
      address: String(fd.get("pc_address")||"").trim(),
      note: String(fd.get("pc_note")||"").trim()
    };
    if (!state.personalContacts) state.personalContacts = [];
    if (idx >= 0 && idx < state.personalContacts.length) {
      state.personalContacts[idx] = contact;
    } else {
      state.personalContacts.push(contact);
    }
    closeModal("modalPersonalContact");
    scheduleSave(); renderPersonalContacts();
  };

  document.getElementById("btnDeletePC").onclick = () => {
    const idx = parseInt(document.getElementById("personalContactForm").elements["pc_editIndex"].value);
    if (idx >= 0 && idx < (state.personalContacts||[]).length) {
      if (confirm("Odstrániť tento kontakt?")) {
        state.personalContacts.splice(idx, 1);
        closeModal("modalPersonalContact");
        scheduleSave(); renderPersonalContacts();
      }
    }
  };

  // ══════════════════════════════════════════════════════════════════
  // EVAKUAČNÉ BATOŽINY
  // ══════════════════════════════════════════════════════════════════

  const EVAC_BAG_TYPES = {
    adult:  { emoji: "🧑", label: "Dospelý", maxKg: 25, kcalDay: 2000, color: "#1e40af", bg: "#eff6ff", border: "#bfdbfe" },
    kid:    { emoji: "🧒", label: "Dieťa",   maxKg: 15, kcalDay: 1500, color: "#b45309", bg: "#fef3c7", border: "#fcd34d" },
    infant: { emoji: "👶", label: "Bábätko", maxKg: 5,  kcalDay: 800,  color: "#be185d", bg: "#fdf2f8", border: "#fbcfe8" },
    senior: { emoji: "👴", label: "Senior",  maxKg: 20, kcalDay: 1800, color: "#2a7a4b", bg: "#eaf4ee", border: "#86efac" },
    pet:    { emoji: "🐾", label: "Domáce zviera", maxKg: 10, kcalDay: 0, color: "#6b6560", bg: "#f5f3ee", border: "#e2ddd5" },
  };

  function getEvacBagItems(type) {
    const t = EVAC_BAG_TYPES[type];
    const kcal = t.kcalDay;
    const items = [];

    // ── Domáce zviera – odlišný obsah ──
    if (type === "pet") {
      items.push({ cat: "Identifikácia", items: [
        { name: "Očkovací preukaz zvieraťa", note: "Originál alebo kópia – niektoré útulky neprijmú zviera bez neho" },
        { name: "Fotografia zvieraťa (aktuálna)", note: "Na papieri aj v telefóne – pre prípad straty" },
        { name: "Adresná známka / mikročip", note: "Overte aktuálnosť údajov v registri (CRSZ)" },
        { name: "Kópia registrácie / pedigree", note: "Ak je zviera registrované" },
      ]});
      items.push({ cat: "Krmivo a voda", items: [
        { name: "Suché krmivo (zásoba na 3–5 dní)", note: "V uzatvárateľnom vodotesnom vrecku" },
        { name: "Konzervy / mokré krmivo (3 dni)", note: "Nezabudnite na otvárač" },
        { name: "Voda pre zviera (1–2 litre)", note: "Zvieratá nemôžu piť kontaminovanú vodu" },
        { name: "Skladacia miska na jedlo a vodu", note: "Silikónová / plastová – skladná" },
      ]});
      items.push({ cat: "Zdravie", items: [
        { name: "Pravidelne užívané lieky", note: "Antiparazitiká, srdcové lieky – zásoba na 7 dní" },
        { name: "Kontakt na veterinára (na papieri)", note: "Mobilná sieť nemusí fungovať" },
        { name: "Obväz, dezinfekcia pre zviera", note: "Základná veterinárna lekárnička" },
      ]});
      items.push({ cat: "Transport a bezpečnosť", items: [
        { name: "Prepravka / klietka", note: "Primeraná veľkosť – zviera musí mať pohodlie. Pre mačky nevyhnutná" },
        { name: "Vodítko + obojok + náhubok", note: "Aj kľudné zvieratá môžu v strese reagovať nepredvídateľne" },
        { name: "Podložka / deka (známy pach)", note: "Zníženie stresu – zviera cíti domov" },
        { name: "Hračka / predmet s vôňou domova", note: "Na upokojenie" },
        { name: "Igelitové vrecká na exkrementy", note: "Min. 10 ks" },
        { name: "Podložky na učenie (šteňatá/mačky)", note: "Ak nemáte prístup von" },
      ]});
      return items;
    }

    // ── Doklady & peniaze ──
    items.push({ cat: "Doklady a peniaze", items: [
      { name: "Občiansky preukaz / pas", note: "Originál – vždy mať pri sebe. Pas ak hrozí cezhraničná evakuácia. Deti: rodný list + OP dieťaťa" },
      { name: "Kartička zdravotnej poisťovne", note: "Originál + EHIC karta (Európsky preukaz). Zapíšte si číslo poisťovne aj na papier" },
      { name: "Kópie dôležitých dokumentov (papier)", note: "Rodný list, sobášny list, poistné zmluvy, list vlastníctva, zmluvy – vo vodotesnom zipovom vrecku" },
      { name: "Šifrovaný USB kľúč so scanmi dokumentov", note: "Všetky doklady v PDF – záloha na USB aj v cloude. Heslo si pamätajte alebo dajte blízkej osobe" },
      { name: "Kľúče (dom, auto, pivnica, garáž)", note: "Na jednom krúžku pri batohu. Náhradný kľúč u dôveryhodnej osoby mimo vášho regiónu" },
      { name: "Hotovosť", note: "Min. 200–300 € v drobných (5, 10, 20 €). Bankomaty a terminály zlyhajú pri výpadku elektriny. Mince na automaty" },
      { name: "Platobné karty", note: "Visa/Mastercard od dvoch rôznych bánk. Zapíšte si čísla na blokovanie kariet na papier" },
      { name: "Zoznam kontaktov na papieri", note: "Rodina, lekár, právnik, banka, poisťovňa, zamestnávateľ, škola, ambasáda – telefón nemusí fungovať" },
      { name: "Zdravotný info list", note: "Krvná skupina, alergie, užívané lieky, chronické ochorenia, kontakt na lekára – laminovaný 1× A4, v batohu aj peňaženke" },
    ]});

    // ── Zdravie ──
    const healthItems = [
      { name: "Osobná lekárnička", note: "Sterilné obväzy 3 veľkosti, gáza, náplaste, elastický obväz, trojcípy šatka, nožnice, pinzeta, latexové rukavice (5 párov), izotermická fólia" },
      { name: "Dezinfekcia (rany)", note: "Betadine, Cutasept alebo peroxid vodíka – na ošetrenie otvorených poranení. Skontrolujte exspiráciu!" },
      { name: "Pravidelne užívané lieky", note: "Zásoby na minimálne 7–14 dní + kópia receptu / názov lieku na papieri. Inzulín: chladiace puzdro FRIO" },
      { name: "Voľnopredajné lieky", note: "Ibuprofen/Paralen (bolesť, teplota), Smecta/aktívne uhlie (hnačka), Cerucal (nevoľnosť), antihistaminikum (alergia), Immodium, Endiaron" },
      { name: "Dezinfekcia na ruky", note: "Gél alebo sprej – min. 60% alkohol, 100 ml. Bez čistej vody je to jediná hygiena rúk" },
      { name: "Ochranné rúška FFP2 (2 ks)", note: "Ochrana pred prachom, dymom, chemikáliami, infekciami. FFP2 chráni aj pred vírusmi" },
      { name: "Opaľovací krém SPF 30+", note: "Pri dlhšej evakuácii vonku – spálenie znižuje odolnosť organizmu" },
    ];
    if (type !== "infant") {
      healthItems.push({ name: "Okuliare / kontaktné šošovky", note: "Náhradné! Bez okuliarov ste v kríze výrazne zraniteľnejší. Čistiaci sprej/ubrúsky" });
    }
    if (type === "infant") {
      healthItems.push({ name: "Plienky a vlhčené utierky", note: "Zásoba na min. 3–5 dní (15–25 ks plienok). Vezmite aj vrecká na použité plienky" });
      healthItems.push({ name: "Dojčenská výživa / mlieko", note: "Práškové mlieko + sterilizovaná fľaška s cumlíkom + čistá voda. Hotové mliečka v Tetrapaku sú najpohodlnejšie" });
      healthItems.push({ name: "Cumlík a obľúbená hračka", note: "Na upokojenie – stres bábätko cíti od rodiča. Vezmite 2 kusy cumlíka (jeden sa stratí)" });
      healthItems.push({ name: "Detský krém / zinková masť", note: "Ochrana pred opruzeninami pri dlhšom pobyte bez kúpania" });
      healthItems.push({ name: "Teplomer", note: "Digitálny, bezortuťový. Horúčka u bábätka je vždy urgentná!" });
    }
    items.push({ cat: "Zdravie a hygiena", items: healthItems });

    // ── Jedlo a voda ──
    const foodItems = [
      { name: "Balená pitná voda (min. 1,5 l)", note: "1,5–2 l na osobu na 24 hodín. Malé fľaše 0,5 l sú praktickejšie – ľahšie sa nesú a delia" },
    ];
    if (type === "adult" || type === "senior") {
      foodItems.push({ name: "Tablety na čistenie vody", note: "Micropur, Aquatabs – 1 tableta = 1 liter. Na núdzovú úpravu vody z neznámeho zdroja. Účinkujú 30 min" });
    }
    foodItems.push({ name: `Trvanlivé jedlo na 24 h (~${kcal} kcal)`, note: type === "infant" ? "Detská výživa v poháriku, instantná kaša, keksíky, banán" : type === "kid" ? "Energetické tyčinky, orechy, sušené ovocie, keksíky, konzervy s krúžkom, müsli tyčinky" : "Energetické tyčinky, orechy, konzervy s krúžkom, sušené mäso (jerky), čokoláda, instantná polievka, arašidové maslo" });
    if (type !== "infant") {
      foodItems.push({ name: "Hrnček + lyžica", note: "Ľahký plastový alebo titánový. Lyžica je najdôležitejšia – konzervu zjete aj bez vidličky" });
      foodItems.push({ name: "Multifunkčný nôž", note: "S otvárač na konzervy, nožom, skrutkovačom – napr. Victorinox. Nenoste v príručnej batožine lietadla" });
    }
    if (type === "adult" || type === "senior") {
      foodItems.push({ name: "Soľ a cukor (malé balenia)", note: "Soľ: na dehydratáciu, cukor: na rýchlu energiu. Malé vrecúška z reštaurácie sú ideálne" });
    }
    items.push({ cat: "Jedlo a voda", items: foodItems });

    // ── Oblečenie ──
    const clothItems = [
      { name: "Pevná obuv (PRI BATOHU!)", note: "Nepremokavá, členkové, pohodlná – pripravte VEDĽA batohu. V panike na ňu nemáte čas hľadať. Najčastejšia chyba evakuácie!" },
      { name: "Pláštenka / nepremokavá bunda", note: "Ľahká, skladná – ochrana pred dažďom, vetrom aj chladnou nocou. Poncho pokryje aj batoh" },
      { name: "Náhradné oblečenie (1 sada)", note: type === "infant" ? "2× body, čiapka, ponožky, teplá kombinéza, overal" : "Tričko, nohavice, mikina, čiapka – podľa ročného obdobia. Radšej vrstvy ako jednu hrubú vestu" },
      { name: "Spodné prádlo a ponožky (2 sady)", note: "Suché ponožky = prevencia pľuzgierov a podchladenia. Merino vlna je ideálna – rýchlo schne, nesmrdí" },
    ];
    if (type === "adult" || type === "senior") {
      clothItems.push({ name: "Pracovné rukavice", note: "Kožené alebo mechanické – ochrana rúk pri pohybe v troskách, skle, drôtoch. Nepoužívajte textilné" });
      clothItems.push({ name: "Ochranné okuliare / lyžiarske okuliare", note: "Proti prachu, dymu a úlomkom – dôležité pri pohybe v poškodených budovách" });
    }
    items.push({ cat: "Oblečenie", items: clothItems });

    // ── Spanie a teplo ──
    const sleepItems = [
      { name: "Spacák alebo teplá deka", note: "Kompaktný, ľahký – teplota komfortu min. 5\u00b0C. Syntetický schne rýchlejšie ako páperový" },
      { name: "Izotermická (z\u00e1chranárska) fólia (2 ks)", note: "Zlatá/strieborná – váži 50 g, zachráni život pri podchladení. Strieborná strana k telu = teplo dovnútra. Balte 2 ks pre istotu" },
    ];
    if (type !== "infant") {
      sleepItems.push({ name: "Karimatka", note: "Skladacia penová alebo nafukovacia – izolácia od studenej/mokrej zeme je kritická. Zem odčerpáva teplo 25× rýchlejšie ako vzduch" });
    }
    if (type === "infant") {
      sleepItems.push({ name: "Zavinovačka / detská deka", note: "Bábätko stráca teplo rýchlejšie ako dospelý – veľký povrch tela voči hmotnosti. Vždy kontrolujte teplotu krku" });
    }
    if (type === "adult") {
      sleepItems.push({ name: "Sviečka v plechovke + zapaľovač", note: "Čajová sviečka v konzerve = núdzové svetlo aj teplo (zvýši teplotu malého priestoru o 2–3\u00b0C). Pozor na vetranie!" });
    }
    items.push({ cat: "Spanie a teplo", items: sleepItems });

    // ── Technika a komunikácia ──
    const techItems = [];
    if (type !== "infant") {
      techItems.push({ name: "Mobilný telefón + nabíjačka + kábel", note: "Nabite na 100% IHNEĎ pri varovných správach. Zapnite šetrič batérie, vypnite WiFi/Bluetooth, znížte jas" });
      techItems.push({ name: "Nabitá power banka (min. 10 000 mAh)", note: "Pravidelne dobíjajte 1\u00d7 mesačne. Skontrolujte kompatibilitu kábla. Solárna power banka = bonus" });
    }
    if (type === "adult" || type === "senior") {
      techItems.push({ name: "Rádio na batérie / kľučkou", note: "Jediný spoľahlivý zdroj informácií pri výpadku elektriny a internetu. Nalaďte Rádio Slovensko (96,6 FM BA / 90,1 FM BB / 89,5 FM KE)" });
      techItems.push({ name: "Náhradné batérie (AA, AAA)", note: "Pre rádio a baterku. Lithiové batérie vydržia dlhšie a nekorodujú. Skontrolujte aký typ potrebujete" });
    }
    techItems.push({ name: "Baterka / čelovka", note: "LED, s náhradnými batériami. Čelovka uvoľní obe ruky – zásadná výhoda pri pohybe v tme" });
    if (type === "adult" || type === "kid") {
      techItems.push({ name: "Píšťalka", note: "Na privolanie pomoci – počuť ju na 1+ km, aj keď nemáte silu kričať. Každý člen rodiny by mal mať svoju" });
    }
    if (type !== "infant") {
      techItems.push({ name: "Papier, ceruzka, permanentná fixka", note: "Na poznámky, správy pre rodinu, označenie dverí pri evakuácii. Fixka píše aj na mokrý povrch" });
    }
    if (type === "adult") {
      techItems.push({ name: "Mapa regiónu (papierová)", note: "GPS nemusí fungovať. Papierová mapa kraja s vyznačenými evakuačnými trasami a úkrytmi" });
    }
    if (techItems.length) items.push({ cat: "Technika a komunikácia", items: techItems });

    // ── Hygiena ──
    const hygieneItems = [
      { name: "Toaletný papier (kompaktný)", note: "Stlačte rolku, vyberte dutinku – zaberá polovicu miesta" },
      { name: "Uterák z mikrovlákna", note: "Skladací, rýchloschnúci – zaberá minimum miesta" },
    ];
    if (type !== "infant") {
      hygieneItems.push({ name: "Zubná kefka + mini pasta", note: "" });
      hygieneItems.push({ name: "Vlhčené utierky", note: "Na rýchlu hygienu bez vody" });
    }
    if (type === "adult" || type === "senior") {
      hygieneItems.push({ name: "Menštruačné pomôcky", note: "Ak relevantné – kalíšok alebo vložky na 3–5 dní" });
    }
    items.push({ cat: "Hygiena", items: hygieneItems });

    // ── Rôzne ──
    const miscItems = [];
    if (type === "kid") {
      miscItems.push({ name: "Hračka / plyšiak / hra", note: "Na upokojenie a rozptýlenie – stres prežívajú aj deti. Obľúbená vec = pocit bezpečia" });
      miscItems.push({ name: "Kniha / omaľovánky + ceruzky", note: "Dlhé čakanie je pre deti najťažšie. Malý zápisník a fixky zaberú minimum miesta" });
      miscItems.push({ name: "Kartička s menom a kontaktom", note: "Meno dieťaťa, mená rodičov, telefón, adresa, krvná skupina – do vrecka kabáta aj do batohu. Laminovaná!" });
      miscItems.push({ name: "Malý snack navyše", note: "Hladné dieťa = nespokojné dieťa. Müsli tyčinka, sušienky, orechy – niečo čo má rado" });
    } else if (type === "adult") {
      miscItems.push({ name: "Igelitové vrecká (5–10 ks)", note: "Na odpadky, mokré veci, improvizovaná ochrana, zber vody, na nohy cez topánky pri brodení" });
      miscItems.push({ name: "Páska lepiaca (duct tape)", note: "Opravy, utesňovanie okien, označovanie, improvizované obväzy, oprava stanu. Naviňte 3–5 m na kreditku" });
      miscItems.push({ name: "Lano / paracord (10 m)", note: "Sušenie oblečenia, improvizovaný prístrešok, záchranné účely, nosnosť paracordu: 250 kg" });
      miscItems.push({ name: "Zapaľovač + zápalky (vodotesné)", note: "Núdzový oheň na varenie, signalizáciu, teplo. Zapaľovač + záloha zápalky vo vodotesnom obale" });
      miscItems.push({ name: "Kniha / karty / hra", note: "Psychická pohoda je dôležitá – dlhé čakanie bez aktivity je psychicky vyčerpávajúce" });
      miscItems.push({ name: "Kabínkové vrecko na cennosti", note: "Pod oblečenie – pas, peniaze, kľúče na tele. Pri evakuácii sa batoh môže stratiť" });
    } else if (type === "senior") {
      miscItems.push({ name: "Skladacia palica / sedačka", note: "Ak používate – pri dlhom presune nevyhnutná. Trojnožka je ľahká a skladná" });
      miscItems.push({ name: "Kniha / karty / sudoku", note: "Na udržanie psychickej pohody a mentálnej aktivity" });
      miscItems.push({ name: "Naslúchadlo + batérie", note: "Ak používate – náhradné batérie a čistiaca pomôcka" });
    }
    if (miscItems.length) items.push({ cat: "Rôzne", items: miscItems });

    return items;
  }

  function generateEvacBags() {
    const p = state.profile;
    if (!p) return;
    const bags = {};
    let idx = 0;
    for (let i = 0; i < (p.adults||0); i++) {
      const id = "adult_" + i;
      const existing = state.evacuationBags[id];
      bags[id] = {
        type: "adult",
        label: (p.adults > 1) ? `Dospelý ${i + 1}` : "Dospelý",
        checked: existing ? existing.checked : {}
      };
      idx++;
    }
    for (let i = 0; i < (p.kids||0); i++) {
      const id = "kid_" + i;
      const existing = state.evacuationBags[id];
      bags[id] = {
        type: "kid",
        label: (p.kids > 1) ? `Dieťa ${i + 1}` : "Dieťa",
        checked: existing ? existing.checked : {}
      };
    }
    for (let i = 0; i < (p.infants||0); i++) {
      const id = "infant_" + i;
      const existing = state.evacuationBags[id];
      bags[id] = {
        type: "infant",
        label: (p.infants > 1) ? `Bábätko ${i + 1}` : "Bábätko",
        checked: existing ? existing.checked : {}
      };
    }
    for (let i = 0; i < (p.seniors||0); i++) {
      const id = "senior_" + i;
      const existing = state.evacuationBags[id];
      bags[id] = {
        type: "senior",
        label: (p.seniors > 1) ? `Senior ${i + 1}` : "Senior",
        checked: existing ? existing.checked : {}
      };
    }
    if (p.pets && p.pets > 0) {
      for (let i = 0; i < p.pets; i++) {
        const id = "pet_" + i;
        const existing = state.evacuationBags[id];
        bags[id] = {
          type: "pet",
          label: (p.pets > 1) ? `Zviera ${i + 1}` : "Domáce zviera",
          checked: existing ? existing.checked : {}
        };
      }
    }
    state.evacuationBags = bags;
  }

  function getBagProgress(bagId) {
    const bag = state.evacuationBags[bagId];
    if (!bag) return { done: 0, total: 0, pct: 0 };
    const sections = getEvacBagItems(bag.type);
    let total = 0, done = 0;
    sections.forEach(sec => sec.items.forEach(item => {
      total++;
      if (bag.checked && bag.checked[item.name]) done++;
    }));
    return { done, total, pct: total ? Math.round((done / total) * 100) : 0 };
  }

  function renderEvacBags() {
    const container = document.getElementById("evacBagsContainer");
    const regenBtn = document.getElementById("btnRegenBags");
    if (!container) return;

    if (!state.profile) {
      container.innerHTML = `
        <div style="background:var(--c-bg); border-radius:1rem; padding:1.25rem; text-align:center;">
          <div style="font-size:2rem; margin-bottom:0.5rem;">🎒</div>
          <div style="font-weight:600; font-size:0.9rem; margin-bottom:0.25rem;">Najprv vyplňte profil domácnosti</div>
          <div style="font-size:0.78rem; color:var(--c-muted);">Batožiny sa vygenerujú podľa počtu a typu členov vašej rodiny.</div>
        </div>`;
      if (regenBtn) regenBtn.style.display = "none";
      return;
    }

    // Auto-generate if empty or profile changed
    const bagKeys = Object.keys(state.evacuationBags);
    const expectedCount = (state.profile.adults||0) + (state.profile.kids||0) + (state.profile.infants||0) + (state.profile.seniors||0) + (state.profile.pets||0);
    if (bagKeys.length === 0 || bagKeys.length !== expectedCount) {
      generateEvacBags();
      scheduleSave();
    }
    if (regenBtn) regenBtn.style.display = "inline-flex";

    // BYOB info - all collapsible
    let html = `
      <div class="info-collapse" style="background:var(--c-info-bg); border:1px solid var(--c-info-border); margin-bottom:1rem;">
        <button class="info-collapse-toggle" style="color:var(--c-info);" onclick="this.closest('.info-collapse').classList.toggle('open')">
          <span>💡 Prečo evakuačný batoh a pravidlá</span>
          <span class="info-collapse-arrow">▼</span>
        </button>
        <div class="info-collapse-body" style="font-size:0.75rem; color:var(--c-text); line-height:1.6;">
          <p style="margin:0 0 0.5rem;">Pri evakuácii máte často len <strong>5–15 minút</strong>. Každý člen domácnosti potrebuje <strong>vlastný batoh</strong>. Kontrola 2× ročne.</p>
          <p style="margin:0 0 0.5rem; font-weight:500;"><strong>Pravidlá:</strong> 1) Ideálne batoh <strong>pri dverách</strong> – ale lepšie v skrini ako vôbec. 2) <strong>Vedzte, aké topánky si beriete</strong> pri evakuácii (pevné, rýchlo obuvateľné). 3) Každý člen rodiny musí <strong>vedieť kde batoh je</strong>. 4) Deti od 6 r. – <strong>vedieť batoh otvoriť a niesť</strong>. 5) <strong>Kartička s kontaktom</strong> vo vrecku kabáta.</p>
          <p style="margin:0 0 0.5rem;">Bez pripraveného batohu zabudnete lieky, doklady alebo vodu. Batoh by mal byť <strong>samostatný</strong> – nebalte veci, ktoré denne používate.</p>
          <p style="margin:0 0 0.375rem; font-weight:600; color:#92400e;">Max. hmotnosť: Dospelý 25 kg &nbsp;|  Senior 20 kg &nbsp;|  Dieťa 15 kg &nbsp;|  Bábätko 5 kg (nosí rodič)</p>
          <p style="margin:0; font-size:0.68rem;">Zdroj: CZ 72h (MV ČR, 2025), SK MINV, UA DSNS, SE MSB (2024)</p>
        </div>
      </div>`;

    // Bag cards
    html += `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:0.625rem;">`;
    Object.keys(state.evacuationBags).forEach(bagId => {
      const bag = state.evacuationBags[bagId];
      const t = EVAC_BAG_TYPES[bag.type];
      const prog = getBagProgress(bagId);
      const progressColor = colorForPct(prog.pct);
      // Status-based coloring: green when complete, neutral when not
      const cardBg = prog.pct === 100 ? "var(--c-success-bg)" : "var(--c-surface)";
      const cardBorder = prog.pct === 100 ? "var(--c-success-border)" : "var(--c-border)";
      const titleColor = prog.pct === 100 ? "var(--c-success)" : "var(--c-text)";

      html += `
        <div onclick="openEvacBagModal('${bagId}')" tabindex="0" role="button" aria-label="${esc(bag.label)} – ${prog.done} z ${prog.total}" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openEvacBagModal('${bagId}')}" style="background:${cardBg}; border:1.5px solid ${cardBorder}; border-radius:1rem; padding:1rem; cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 6px 18px rgba(0,0,0,0.08)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="display:flex; align-items:center; gap:0.625rem; margin-bottom:0.75rem;">
            <div style="width:40px; height:40px; border-radius:50%; background:${prog.pct === 100 ? 'white' : 'var(--c-bg)'}; border:1.5px solid ${cardBorder}; display:flex; align-items:center; justify-content:center; font-size:1.125rem; flex-shrink:0;">${t.emoji}</div>
            <div>
              <div style="font-weight:700; font-size:0.9rem; color:${titleColor};">${esc(bag.label)}</div>
              <div style="font-size:0.68rem; color:var(--c-muted);">max ${t.maxKg} kg</div>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <div class="progress-bar" style="flex:1; height:6px; margin:0;">
              <div class="progress-fill" style="width:${prog.pct}%; background:${progressColor}; transition:width 0.4s ease;"></div>
            </div>
            <span style="font-size:0.75rem; font-weight:700; color:${progressColor}; white-space:nowrap;">${prog.done}/${prog.total}</span>
          </div>
          ${prog.pct === 100 ? `<div style="text-align:center; margin-top:0.5rem; font-size:0.72rem; font-weight:700; color:var(--c-success);">✓ Kompletný</div>` : prog.pct === 0 ? `<div style="text-align:center; margin-top:0.5rem; font-size:0.72rem; color:var(--c-muted);">Nastaviť →</div>` : ""}
        </div>`;
    });
    html += `</div>`;

    container.innerHTML = html;
  }

  function openEvacBagModal(bagId) {
    const bag = state.evacuationBags[bagId];
    if (!bag) return;
    const t = EVAC_BAG_TYPES[bag.type];
    const sections = getEvacBagItems(bag.type);
    const prog = getBagProgress(bagId);

    const icon = document.getElementById("evacBagModalIcon");
    icon.style.background = t.bg;
    icon.style.border = `1.5px solid ${t.border}`;
    icon.textContent = t.emoji;
    document.getElementById("evacBagModalTitle").textContent = "🎒 " + bag.label;
    document.getElementById("evacBagModalSubtitle").textContent = `Max ${t.maxKg} kg · ${t.kcalDay} kcal/deň · ${prog.done}/${prog.total} položiek`;

    let html = `
      <div style="display:flex; align-items:center; gap:0.625rem; margin-bottom:1rem;">
        <div class="progress-bar" style="flex:1; height:8px; margin:0;">
          <div class="progress-fill" style="width:${prog.pct}%; background:${colorForPct(prog.pct)}; transition:width 0.3s;"></div>
        </div>
        <span style="font-size:0.9rem; font-weight:800; color:${colorForPct(prog.pct)};">${prog.pct}%</span>
      </div>`;

    sections.forEach(sec => {
      html += `<div style="margin-bottom:1rem;">
        <div style="font-size:0.72rem; font-weight:700; color:var(--c-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">${sec.cat}</div>`;
      sec.items.forEach(item => {
        const checked = bag.checked && bag.checked[item.name];
        html += `
          <div data-evacitem="${esc(item.name)}" data-evacbag="${bagId}" style="display:flex; align-items:flex-start; gap:0.625rem; padding:0.5rem 0.625rem; border-radius:0.625rem; cursor:pointer; transition:background 0.15s; ${checked ? 'opacity:0.6;' : ''}" onmouseover="this.style.background='var(--c-bg)'" onmouseout="this.style.background='transparent'">
            <div style="width:22px; height:22px; border-radius:0.375rem; border:2px solid ${checked ? '#2a7a4b' : 'var(--c-border)'}; background:${checked ? '#2a7a4b' : 'white'}; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:0.0625rem; transition:all 0.15s;">
              ${checked ? '<span style="color:white; font-size:0.75rem; font-weight:700;">✓</span>' : ''}
            </div>
            <div style="flex:1; min-width:0;">
              <div style="font-size:0.85rem; font-weight:600; ${checked ? 'text-decoration:line-through; color:var(--c-muted);' : 'color:var(--c-text);'}">${esc(item.name)}</div>
              ${item.note ? `<div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.1rem; line-height:1.4;">${esc(item.note)}</div>` : ""}
            </div>
          </div>`;
      });
      html += `</div>`;
    });

    html += `
      <div style="display:flex; justify-content:space-between; align-items:center; padding-top:0.75rem; border-top:1px solid var(--c-border); margin-top:0.5rem;">
        <button type="button" onclick="toggleAllEvacItems('${bagId}', true)" class="btn-ghost" style="font-size:0.72rem; padding:0.375rem 0.75rem;">✓ Označiť všetko</button>
        <button type="button" onclick="toggleAllEvacItems('${bagId}', false)" class="btn-ghost" style="font-size:0.72rem; padding:0.375rem 0.75rem; color:#dc2626;">✕ Odznačiť všetko</button>
      </div>`;

    const content = document.getElementById("evacBagModalContent");
    content.innerHTML = html;

    // Bind item clicks
    content.querySelectorAll("[data-evacitem]").forEach(el => {
      el.onclick = () => {
        const itemName = el.dataset.evacitem;
        const bId = el.dataset.evacbag;
        if (!state.evacuationBags[bId].checked) state.evacuationBags[bId].checked = {};
        state.evacuationBags[bId].checked[itemName] = !state.evacuationBags[bId].checked[itemName];
        scheduleSave();
        // Re-render modal in place
        openEvacBagModal(bId);
        renderEvacBags();
      };
    });

    openModal("modalEvacBag");
  }
  window.openEvacBagModal = openEvacBagModal;

  function toggleAllEvacItems(bagId, val) {
    const bag = state.evacuationBags[bagId];
    if (!bag) return;
    const sections = getEvacBagItems(bag.type);
    if (!bag.checked) bag.checked = {};
    sections.forEach(sec => sec.items.forEach(item => {
      bag.checked[item.name] = val;
    }));
    scheduleSave();
    openEvacBagModal(bagId);
    renderEvacBags();
  }
  window.toggleAllEvacItems = toggleAllEvacItems;

  document.getElementById("btnRegenBags").onclick = () => {
    if (confirm("Pregenerovať batohy podľa aktuálneho profilu? Zaškrtnuté položky sa zachovajú.")) {
      generateEvacBags();
      scheduleSave();
      renderEvacBags();
    }
  };

  // ══════════════════════════════════════════════════════════════════
  // VAROVNÉ SIGNÁLY SIRÉN
  // ══════════════════════════════════════════════════════════════════

  const SIRENS_DATA = [
    {
      id: "general",
      title: "Všeobecné ohrozenie",
      duration: "2 minúty",
      type: "kolísavý tón",
      color: "#dc2626",
      bg: "#fef2f2",
      border: "#fecaca",
      wave: "oscillating",
      meaning: "Signalizuje ohrozenie alebo vznik mimoriadnej udalosti (chemický únik, radiácia, priemyselná havária, teroristický útok), ako aj možnosť rozšírenia jej následkov. Tón stúpa a klesá po dobu 2 minút.",
      howToRecognize: "Kolísavý (stúpajúci a klesajúci) tón sirény trvajúci presne 2 minúty. Zvuk pripomína vlnenie – striedavo zosilňuje a zoslabuje. Jednoznačne odlíšiteľný od stáleho tónu skúšky.",
      actions: [
        { header: "Okamžité kroky (prvé 2 minúty)" },
        { text: "<strong>Vojdite do najbližšej budovy</strong> – nepokúšajte sa dostať domov, vojdite do najbližšieho murovaného objektu." },
        { text: "<strong>Zatvorte a utesnite okná, dvere a ventilačné otvory.</strong> Netesnosti prelepte lepiacou páskou, väčšie otvory utesnite mokrými handradami alebo fóliou." },
        { text: "<strong>Vypnite klimatizáciu a ventilátory</strong> – zastavte akúkoľvek výmenu vzduchu s vonkajším prostredím." },
        { text: "<strong>Presuňte sa do vnútornej miestnosti</strong> bez okien (chodba, kúpeľňa). Ak hrozí chemická kontaminácia, choďte do vyšších poschodí (väčšina chemikálií je ťažšia ako vzduch)." },
        { header: "Informovanie sa" },
        { text: "<strong>Zapnite Rádio Slovensko</strong> (96,6 FM Bratislava, 90,1 FM B. Bystrica, 89,5 FM Košice) alebo Rádio Regina – dozviete sa čo sa stalo a čo robiť." },
        { text: "<strong>Ak nemáte elektriku</strong>, použite rádio na batérie alebo v aute." },
        { text: "<strong>Netelefonujte zbytočne</strong> – nezaťažujte tiesňové linky. Volajte len ak potrebujete záchranu alebo máte informácie pre záchranné zložky." },
        { warn: "Varovný signál sa ihneď po skončení dopĺňa <strong>hovorenou informáciou</strong> v rozhlase a TV – obsahuje miesto, čas, druh ohrozenia, veľkosť ohrozeného územia a pokyny. Počkajte na ňu!" },
        { header: "Čomu sa vyhnúť" },
        { text: "<strong>Neotvárajte okná „pozrieť sa čo sa deje”</strong> – práve to je najnebezpečnejšie pri chemickom úniku." },
        { text: "<strong>Nevychádzajte von</strong> kým nedostanete pokyn od záchranných zložiek. Budova je váš najlepší úkryt." },
        { text: "<strong>Nevyzdvihujte deti zo škôl</strong> – školy majú vlastné ochranné postupy a vaše cestovanie vás môže ohroziť." }
      ],
      note: "Počas vojnového stavu alebo vojny sa rovnakým kolísavým tónom (2 min) vyhlasuje aj <strong>VZDUŠNÝ POPLACH</strong>. Slovná informácia potom obsahuje vymedzenie ohrozeného územia a výraz „vzdušný poplach”.",
      sources: [
        { label: "Zákon č. 42/1994 Z.z. o civilnej ochrane obyvateľstva, § 18", url: "https://www.slov-lex.sk/pravne-predpisy/SK/ZZ/1994/42/" },
        { label: "SK MINV – Varovné signály civilnej ochrany", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "Civilná ochrana Košice – Čo robiť keď zaznie siréna", url: "https://www.cokosice.sk/-co-robit-ked-zaznie-sirena" }
      ]
    },
    {
      id: "water",
      title: "Ohrozenie vodou",
      duration: "6 minút",
      type: "stály tón",
      color: "#1e40af",
      bg: "#eff6ff",
      border: "#bfdbfe",
      wave: "steady",
      meaning: "Signalizuje ohrozenie ničivými účinkami vody – hroziace povodne, pretrhnutie priehrady, náhla prívalová vlna. Je najdlhší signál (6 minút), aby bol jednoznačne odlíšiteľný.",
      howToRecognize: "Neprerušovaný stály tón sirény trvajúci celých 6 minút. Je to najdlhší varovný signál v systéme – jeho dĺžka sama o sebe signalizuje vodnú hrozbu.",
      actions: [
        { header: "Okamžité kroky" },
        { text: "<strong>Okamžite sa presuňte na vyvýšené miesto</strong> – vyššie poschodie, kopec, vyvýšený terén. Každá minúta sa počíta." },
        { warn: "<strong>NEUKRÝVAJTE SA v pivnici ani suteréne!</strong> Pri ohrození vodou je úkryt v nízko položených priestoroch smrteľne nebezpečný." },
        { text: "<strong>Nevstupujte do zatopeného priestoru</strong> – stačí 15 cm tečúcej vody na zhodenie dospelého človeka, 30 cm odplávi auto." },
        { text: "<strong>Ak ste v aute</strong> a voda stúpa – ihneď vystúpte a presuňte sa peši na vyššie miesto. Auto nie je bezpečné." },
        { header: "Príprava na evakuáciu" },
        { text: "<strong>Vezmite si evakuačný batoh, doklady, lieky.</strong> Doklady uložte do vodotesného obalu (igelitový vrecko)." },
        { text: "<strong>Vypnite hlavný istič, plyn a vodu</strong> ak máte čas – predídete elektrickému šoku a úniku plynu." },
        { text: "<strong>Varujte susedov</strong>, najmä starších, imobilných a ľudí s malými deťmi." },
        { header: "Čo robiť ďalej" },
        { text: "<strong>Sledujte rozhlasové vysielanie</strong> – dozviete sa smer a rýchlosť postupu vody, evakuačné trasy." },
        { text: "<strong>Riaďte sa pokynmi záchranných zložiek</strong> a miestnych úradov. Nepodceňujte situáciu." },
        { text: "<strong>Nepite vodu z vodovodu</strong> – vodovod môže byť kontaminovaný záplavovou vodou." }
      ],
      note: null,
      sources: [
        { label: "Zákon č. 42/1994 Z.z. o civilnej ochrane obyvateľstva, § 18", url: "https://www.slov-lex.sk/pravne-predpisy/SK/ZZ/1994/42/" },
        { label: "SK MINV – Varovné signály: Ohrozenie vodou", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "end",
      title: "Koniec ohrozenia",
      duration: "2 minúty",
      type: "stály tón (bez opakovania)",
      color: "#2a7a4b",
      bg: "#eaf4ee",
      border: "#86efac",
      wave: "steady",
      meaning: "Signalizuje koniec ohrozenia alebo koniec pôsobenia následkov mimoriadnej udalosti. Vysiela sa jednorazovo, bez opakovania.",
      howToRecognize: "Neprerušovaný stály tón trvajúci 2 minúty, ktorý zaznie <strong>iba raz</strong> (bez opakovania). Odlíšenie od skúšky: pred skúškou sú ľudia vopred informovaní médiami.",
      actions: [
        { header: "Po zaznení signálu" },
        { text: "<strong>Počkajte na hovorenú informáciu</strong> v rozhlase, televízii alebo miestnom rozhlase – potvrdí koniec ohrozenia a dá ďalšie pokyny." },
        { text: "<strong>Vyvetrajte miestnosť</strong> – otvorte okná, pustite ventiláciu a obnovte cirkuláciu vzduchu." },
        { text: "<strong>Riaďte sa pokynmi záchranných zložiek</strong> – niektoré oblasti môžu byť stále nebezpečné." },
        { header: "Opatrnosť po odvolaní" },
        { text: "<strong>Nevracajte sa do ohrozenej oblasti</strong> kým to nebude výslovne povolené. Môžu pretrvávať skryté nebezpečenstvá (kontaminácia, nestabilné konštrukcie)." },
        { text: "<strong>Skontrolujte stav bytu/domu</strong> – rozvody plynu, elektriny, vody. Pri pochybnostiach volajte poruchové linky." },
        { text: "<strong>Skontrolujte blízkych a susedov</strong> – overte či sú v poriadku, najmä starší a zraniteľní ľudia." }
      ],
      note: "Signál „Koniec ohrozenia” sa vždy dopĺňa hovorenou informáciou – sledujte médiá aj po jeho odznení.",
      sources: [
        { label: "Zákon č. 42/1994 Z.z. o civilnej ochrane obyvateľstva, § 18", url: "https://www.slov-lex.sk/pravne-predpisy/SK/ZZ/1994/42/" }
      ]
    },
    {
      id: "test",
      title: "Skúška sirén",
      duration: "2 minúty",
      type: "stály tón",
      color: "#6b6560",
      bg: "#f5f3ee",
      border: "#e2ddd5",
      wave: "steady",
      meaning: "Pravidelné preskúšanie funkčnosti varovného systému. Nejedná sa o skutočné ohrozenie – žiadna akcia nie je potrebná.",
      howToRecognize: "Stály neprerušovaný tón, 2 minúty. Koná sa <strong>pravidelne každý druhý piatok v mesiaci o 12:00</strong>. O skúške vopred informujú médiá a miestny rozhlas.",
      actions: [
        { header: "Žiadna akcia nie je potrebná" },
        { text: "<strong>Skúšky sú vopred oznámené</strong> v médiách. Ak ste si istí, že je piatok a napoludnie – ide o pravidelnú skúšku." },
        { text: "<strong>Ak počujete sirénu mimo pravidelného termínu</strong> a neboli ste o skúške informovaní – berichte to vážne a postupujte podľa typu signálu." },
        { note: "Skúšky sirén sa na Slovensku vykonávajú od roku 1996 na základe Zákona č. 42/1994 Z.z. o civilnej ochrane obyvateľstva. Okrem pravidelných mesačných skúšok sa môžu uskutočniť aj mimoriadne skúšky – o tých sa dozvíte z médií vopred." }
      ],
      note: null,
      sources: [
        { label: "Zákon č. 42/1994 Z.z. o civilnej ochrane obyvateľstva", url: "https://www.slov-lex.sk/pravne-predpisy/SK/ZZ/1994/42/" }
      ]
    }
  ];

  function renderSirens() {
    const grid = document.getElementById("sirensGrid");
    if (!grid) return;
    grid.innerHTML = "";
    SIRENS_DATA.forEach(siren => {
      const card = document.createElement("div");
      card.className = "siren-card";
      // Generuj wave bars
      const barCount = 20;
      let bars = "";
      for (let i = 0; i < barCount; i++) {
        const delay = siren.wave === "oscillating"
          ? (Math.sin(i * 0.6) * 0.4 + 0.3).toFixed(2)
          : (0.1 * (i % 3)).toFixed(2);
        const height = siren.wave === "oscillating"
          ? Math.round(40 + Math.sin(i * 0.8) * 35)
          : Math.round(70 + Math.sin(i * 0.2) * 10);
        bars += `<div class="siren-wave-bar" style="left:${(i / barCount) * 100}%; height:${height}%; background:${siren.color}; opacity:0.6; animation-delay:${delay}s;"></div>`;
      }
      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem;">
          <div>
            <div style="font-weight:700; font-size:0.9rem; color:${siren.color};">${siren.title}</div>
            <div style="font-size:0.72rem; color:var(--c-muted); margin-top:0.125rem;">${siren.duration} – ${siren.type}</div>
          </div>
          <div style="background:${siren.bg}; border:1px solid ${siren.border}; border-radius:0.5rem; padding:0.25rem 0.5rem; font-size:0.68rem; font-weight:700; color:${siren.color}; white-space:nowrap;">${siren.duration}</div>
        </div>
        <div class="siren-wave ${siren.wave === 'steady' ? 'siren-wave-steady' : ''}" style="background:${siren.bg}; border:1px solid ${siren.border};">${bars}</div>`;
      card.onclick = () => openSirenModal(siren);
      card.setAttribute("tabindex", "0");
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", siren.title + " – " + siren.duration);
      card.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openSirenModal(siren);
        }
      };
      grid.appendChild(card);
    });
  }

  function openSirenModal(siren) {
    document.getElementById("sirenModalTitle").textContent = "\ud83d\udd14 " + siren.title;
    let html = `
      <div style="background:${siren.bg}; border:1.5px solid ${siren.border}; border-radius:1rem; padding:1rem; margin-bottom:1rem;">
        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.5rem;">
          <div style="font-size:1.75rem; font-weight:800; color:${siren.color};">${siren.duration}</div>
          <div>
            <div style="font-weight:700; color:${siren.color}; font-size:0.9rem;">${siren.type.charAt(0).toUpperCase() + siren.type.slice(1)}</div>
            <div style="font-size:0.75rem; color:var(--c-muted);">trvanie sign\u00e1lu</div>
          </div>
        </div>
      </div>`;

    // Meaning section
    html += `<div class="modal-section">
      <div class="modal-section-header">\ud83d\udcd6 V\u00fdznam</div>
      <div class="modal-section-steps">
        <div style="font-size:0.85rem; color:var(--c-text); line-height:1.6; padding:0.375rem;">${siren.meaning}</div>
      </div>
    </div>`;

    if (siren.howToRecognize) {
      html += `<div class="modal-section">
        <div class="modal-section-header">\ud83d\udd0a Ako rozozna\u0165</div>
        <div class="modal-section-steps">
          <div style="font-size:0.85rem; color:var(--c-text); line-height:1.6; padding:0.375rem;">${siren.howToRecognize}</div>
        </div>
      </div>`;
    }

    // Render structured actions
    if (Array.isArray(siren.actions)) {
      // Convert siren actions to steps format and use shared renderer
      const stepsForRender = [];
      stepsForRender.push({ header: "\u2705 \u010co robi\u0165" });
      siren.actions.forEach(item => {
        if (item.header) stepsForRender.push({ header: item.header });
        else if (item.warn) stepsForRender.push({ warn: item.warn });
        else if (item.note) stepsForRender.push({ note: item.note });
        else if (item.text) stepsForRender.push({ text: item.text });
      });
      html += renderStepsHTML(stepsForRender);
    } else if (siren.action) {
      html += `<div class="modal-section">
        <div class="modal-section-header">\u2705 \u010co robi\u0165</div>
        <div class="modal-section-steps">
          <div style="font-size:0.85rem; color:var(--c-text); line-height:1.6; padding:0.375rem;">${siren.action}</div>
        </div>
      </div>`;
    }

    if (siren.note) {
      html += `<div class="fa-info"><strong>💡 Pozn\u00e1mka:</strong> ${siren.note}</div>`;
    }

    html += renderSourcesCollapsible(siren.sources, null);

    document.getElementById("sirenModalContent").innerHTML = html;
    openModal("modalSiren");
  }

  // ══════════════════════════════════════════════════════════════════
  // NÚDZOVÉ VYSIELANIE RÁDIA
  // ══════════════════════════════════════════════════════════════════

  const RADIO_DATA = [
    {
      name: "Rádio Slovensko",
      desc: "Hlavný kanál STVR pre núdzové hlásenia a pokyny záchranných zložiek. Pri mimoriadnej udalosti prerušuje bežný program a vysiela krízové informácie pre celé Slovensko.",
      emoji: "📡",
      bg: "#fef2f2",
      border: "#fecaca",
      priority: true,
      frequencies: [
        { region: "Bratislava", fm: "96,6 MHz", note: "Kamzík, 50 kW" },
        { region: "Banská Bystrica", fm: "90,1 MHz", note: "Suchá hora, 100 kW" },
        { region: "Košice", fm: "89,5 MHz", note: "Humenec, 50 kW" },
        { region: "Žilina", fm: "104,8 MHz", note: "" },
        { region: "Nitra", fm: "91,2 MHz", note: "Zobor, 10 kW" },
        { region: "Prešov", fm: "100,3 MHz", note: "" },
        { region: "Trenčín", fm: "92,7 MHz", note: "" },
        { region: "Trnava", fm: "101,1 MHz", note: "" },
        { region: "Poprad", fm: "92,2 MHz", note: "Kráľova hoľa, 30 kW" },
        { region: "Stará Ľubovňa", fm: "89,1 MHz", note: "" },
      ]
    },
    {
      name: "Rádio Regina",
      desc: "Regionálne vysielanie STVR s lokálnymi núdzovými informáciami, varovaniami a pokynmi. Tri samostatné okruhy pokrývajú celé Slovensko s regionálne relevantnými informáciami.",
      emoji: "🏔️",
      bg: "#eff6ff",
      border: "#bfdbfe",
      priority: true,
      frequencies: [
        { region: "Regina Západ (BA, TT, TN, NR)", fm: "99,3 MHz", note: "Kamzík, BA" },
        { region: "Regina Stred (BB, ZA)", fm: "101,5 MHz", note: "Suchá hora, BB" },
        { region: "Regina Východ (KE, PO)", fm: "100,3 MHz", note: "Humenec, KE" },
      ]
    },
    {
      name: "Rádio Patria",
      desc: "Vysielanie STVR v maďarskom jazyku. Núdzové hlásenia pre obyvateľov južného Slovenska, ktorí preferujú maďarský jazyk.",
      emoji: "🌍",
      bg: "#eaf4ee",
      border: "#86efac",
      priority: false,
      frequencies: [
        { region: "Bratislava", fm: "98,9 MHz", note: "" },
        { region: "Komárno", fm: "96,2 MHz", note: "" },
        { region: "Rimavská Sobota", fm: "105,5 MHz", note: "" },
        { region: "Košice", fm: "91,1 MHz", note: "" },
      ]
    },
    {
      name: "Rádio Devín",
      desc: "Kultúrny okruh STVR – v prípade krízy sa zapája do núdzového vysielania ako záloha hlavného okruhu Rádio Slovensko.",
      emoji: "🎵",
      bg: "#f5f3ee",
      border: "#e2ddd5",
      priority: false,
      frequencies: [
        { region: "Bratislava", fm: "101,4 MHz", note: "" },
        { region: "Banská Bystrica", fm: "88,8 MHz", note: "" },
        { region: "Košice", fm: "96,4 MHz", note: "" },
      ]
    }
  ];

  function renderRadio() {
    const grid = document.getElementById("radioGrid");
    if (!grid) return;
    grid.innerHTML = "";
    RADIO_DATA.forEach(radio => {
      const card = document.createElement("div");
      card.style.cssText = `background:${radio.bg}; border:1.5px solid ${radio.border}; border-radius:1rem; padding:1rem;`;
      let freqHtml = radio.frequencies.map(f =>
        `<div style="display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0; border-bottom:1px solid ${radio.border};">
          <span style="font-size:0.78rem; color:var(--c-muted);">${f.region}</span>
          <div style="display:flex; align-items:center; gap:0.375rem;">
            <span style="font-size:0.82rem; font-weight:700; color:var(--c-text); font-family:'Lexend',sans-serif;">${f.fm}</span>
          </div>
        </div>`
      ).join("");
      const priorityBadge = radio.priority
        ? `<span style="display:inline-block; background:#dc2626; color:#fff; font-size:0.6rem; font-weight:700; padding:0.1rem 0.375rem; border-radius:0.25rem; vertical-align:middle; margin-left:0.375rem;">PRIORITA</span>`
        : "";
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:0.625rem; margin-bottom:0.625rem;">
          <span style="font-size:1.25rem;">${radio.emoji}</span>
          <div>
            <div style="font-weight:700; font-size:0.875rem;">${radio.name}${priorityBadge}</div>
            <div style="font-size:0.7rem; color:var(--c-muted); line-height:1.4; margin-top:0.1rem;">${radio.desc}</div>
          </div>
        </div>
        <div>${freqHtml}</div>`;
      grid.appendChild(card);
    });
  }

  // ══════════════════════════════════════════════════════════════════
  // POSTUPY PRI MIMORIADNYCH UDALOSTIACH
  // ══════════════════════════════════════════════════════════════════

  const EMERGENCY_PROC_DATA = [
    // ═══════════════════════════════════════════════════════════════
    // PRÍRODNÉ HROZBY
    // ═══════════════════════════════════════════════════════════════
    {
      id: "flood",
      emoji: "🌊",
      title: "Povodne",
      subtitle: "Silné dažde, záplavy a stúpanie hladín",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Pred povodňou (keď hrozí)" },
        { text: "<strong>Sledujte výstrahy SHMÚ</strong> (shmu.sk) a správy z oficiálnych kanálov. Stupeň povodňovej aktivity naznačuje závažnosť." },
        { text: "<strong>Pripravte si evakuačný batoh</strong> \u2013 doklady v nepremokavom obale, lieky, voda, potraviny, nabíjačka, baterka." },
        { text: "<strong>Presuňte cennosti do vyšších poschodí</strong> \u2013 doklady, elektroniku, lieky, dôležité dokumenty." },
        { text: "<strong>Pripravte si nádoby na pitnú vodu</strong> \u2013 kanistre alebo uzatvárateľné nádoby na odber vody z cisterien, ak bude prerušený vodovod." },
        { text: "<strong>Odstráňte nebezpečné látky</strong> \u2013 jedy, kyseliny a žieraviny z miest, kam môže dosiahnuť voda." },
        { header: "Počas povodne" },
        { text: "<strong>Vypnite elektrinu (hlavný istič), plyn a vodu.</strong> Predídete úrazom elektrickým prúdom a úniku plynu." },
        { text: "<strong>Zatvorte všetky okná a dvere.</strong> Utesnite prívod vody do pivnice ak je to možné." },
        { text: "<strong>Presuňte sa na vyvýšené miesto</strong> \u2013 vyššie poschodie, podkrovie. V prípade časovej tiesne okamžite prerušte všetky aktivity." },
        { text: "<strong>Nejazdite cez zaplavené cesty</strong> \u2013 stačí 30 cm vody na odplavenie auta. Ak voda stúpa v aute, ihneď vystúpte a presúvajte sa peši na vyvýšené miesto." },
        { warn: "<strong>Záplavová voda je kontaminovaná</strong> \u2013 kanalizácia, chemikálie, baktérie. Vyhnite sa kontaktu, nepite ju." },
        { header: "Po povodni" },
        { text: "<strong>Nevstupujte do zaplavených budov</strong> kým nie sú skontrolované \u2013 hrozí zrútenie, kontaminácia, úraz elektrickým prúdom." },
        { text: "<strong>Nepite vodu z kohútika</strong> kým úrady nepotvrdia jej bezpečnosť. Používajte len balenú vodu." },
        { text: "<strong>Vyfoťte škody</strong> pre poisťovňu ešte pred upratovaním. Dokumentujte stav." },
        { text: "<strong>Vyveťrajte a vysušte priestory</strong> \u2013 plesne sa tvoria do 24\u201348 hodín." }
      ],
      warning: "Pri 3. stupni povodňovej aktivity buďte pripravení na okamžitú evakuáciu. Uistite sa, že vaši blízki a susedia (hlavne starší) majú všetky informácie.",
      source: "CZ 72h + SK MINV",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Voda a záplavy", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Povodne", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "earthquake",
      emoji: "🫨",
      title: "Zemetrasenie",
      subtitle: "Seizmická aktivita a otrasy",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Počas otrasov" },
        { text: "<strong>DROP \u2013 COVER \u2013 HOLD ON</strong> (Padnite \u2013 Ukryte sa \u2013 Držte sa): Padnite na kolená, ukryte sa pod pevný stôl alebo nábytok, držte sa nohy stola a chráňte hlavu a krk." },
        { text: "<strong>Ak nie je nábytok poruke</strong> \u2013 kľaknite si k vnútornej nosnej stene, skrčte sa a chráňte hlavu rukami. Nikdy nie k oknu." },
        { text: "<strong>V budove zostaňte vo vnútri, mimo budovu zostaňte vonku</strong> \u2013 najviac úrazov sa stáva pri panických presunoch počas otrasov." },
        { text: "<strong>Nevstupujte do výťahu</strong> \u2013 pri otrasoch sa môže zaseknúť." },
        { text: "<strong>Vonku sa zdržiavajte ďalej</strong> od budov, elektrického vedenia, stromov a billboardov." },
        { text: "<strong>V aute zastavte</strong> na otvorenom priestranstve, zapnite výstražné svetlá a nevystupujte počas otrasov. Vyhnite sa mostom a nadjazdom." },
        { header: "Po otrasoch" },
        { text: "<strong>Očakávajte dotrasovanie</strong> (aftershocks) \u2013 môžu byť takmer rovnako silné a prichádzajú minúty až dni po hlavnom otrase." },
        { text: "<strong>Skontrolujte rozvody plynu</strong> \u2013 ak cítite plyn, otvorte okná, opustite budovu a zavolajte hasieb (150). Nepoužívajte otvorený oheň ani elektrické spínače." },
        { text: "<strong>Skontrolujte blízkych a susedov.</strong> Pomôžte zraneným ak tým neohrozíte seba." },
        { text: "<strong>Opatrne opustite poškodenú budovu</strong> \u2013 pozor na uvoľnené konštrukcie, rozbité sklo a spadnuté vedenie." },
        { text: "<strong>Nepite vodu z vodovodu</strong> kým nie je overená \u2013 potrubie môže byť poškodené." }
      ],
      warning: "Na Slovensku sú najrizikovejšie oblasti Komárno, Dobrá Voda, Žilina. Aj malé otrasy môžu poškodiť statiku budovy \u2013 po zemetrasení nechajte budovu skontrolovať odborníkom.",
      source: "SK MINV",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Zemetrasenie", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "storm",
      emoji: "🌪️",
      title: "Víchrica / búrka",
      subtitle: "Silný vietor, búrky, krupobitie a tornádo",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Pred búrkou" },
        { text: "<strong>Sledujte výstrahy SHMÚ</strong> \u2013 varovanie 2. a 3. stupňa znamená vážne nebezpečenstvo." },
        { text: "<strong>Zabezpečte voľné predmety</strong> na dvoroch a balkónoch \u2013 záhradný nábytok, kvetináče, odpadkové koše sa môžu stať smrteľnými projektilmi." },
        { text: "<strong>Zatvorte a zabezpečte všetky okná a dvere.</strong> Stiahnite rolety alebo žalúzie." },
        { text: "<strong>Neparkujte pod stromami</strong> a pri chatrných budovách alebo billboardoch." },
        { header: "Počas búrky" },
        { text: "<strong>Zostaňte vnútri.</strong> Nezdržiavajte sa pri oknách." },
        { text: "<strong>Vonku vyhľadajte pevnú budovu</strong> \u2013 vyhnite sa voľným plochám, horám, parkom, izolovaným stromom." },
        { text: "<strong>Pri blesku</strong> \u2013 ak ste vonku, skrčte sa čo najnižšie (nie na zem naplocho). Vyhnite sa kovovým konštrukciám, vode a vyvýšeným miestam." },
        { text: "<strong>V aute zostaňte v aute</strong> \u2013 je relatívne bezpečným úkrytom (Faradayova klietka). Zastavte mimo stromy a vedenie." },
        { warn: "<strong>Pri tornáde:</strong> Ihneď do pivnice alebo vnútornej miestnosti bez okien v najnižšom podlaží. Ľahnite si na zem a zakryte hlavu." },
        { header: "Po búrke" },
        { text: "<strong>Pozor na spadnuté vedenie</strong> \u2013 nepribližujte sa. Zavolajte 112." },
        { text: "<strong>Nejazdite cez zaplavené úseky ciest.</strong>" },
        { text: "<strong>Skontrolujte strechu a okná</strong> \u2013 dokumentujte škody pre poisťovňu." }
      ],
      warning: "Zabezpečte domáce zvieratá. Nejazdite s ľahkými vozidlami po otvorených veterných plochách. Švédsko MSB odporúča: majte doma rádio na batérie \u2013 pri výpadku prúdu je to často jediný zdroj informácií.",
      source: "SK MINV + SE MSB",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Víchrica", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "Švédsko MSB \u2013 Om krisen eller kriget kommer (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" }
      ]
    },
    {
      id: "landslide",
      emoji: "⛰️",
      title: "Zosuv pôdy",
      subtitle: "Zosuvy pôdy, bahno a skalné zrútenia",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { text: "<strong>Sledujte varovné znaky</strong> \u2013 neobvyklé zvuky (praskanie stromov, skál), náhle zmeny hladiny tokov, praskliny v zemi alebo na stenách, naklonené stromy alebo stĺpy." },
        { text: "<strong>Pri prívalovom daždi</strong> v horskom alebo kopcovitom teréne buďte v strehu \u2013 najväčšie riziko zosuvu je keď je zem nasiaknutá po dlhotrvajúcich dažďoch." },
        { text: "<strong>Ak počujete hučanie alebo vidíte pohyb zeme \u2013 okamžite utekajte</strong> kolmo na smer zosuvu, na najbližšie vyvýšené miesto." },
        { text: "<strong>V budove sa presuňte</strong> na vyššie poschodie, čo najďalej od strany budovy smerujúcej k svahu." },
        { text: "<strong>Ak nemôžete uniknúť</strong> \u2013 skrčte sa za skupinu väčších stromov alebo v najodolnejšej časti budovy, chráňte si hlavu." },
        { text: "<strong>Po zosuve</strong> \u2013 nepribližujte sa k okraju. Hľadajte zranených, ale nevstupujte do nestabilného terénu. Zavolajte 112." }
      ],
      warning: "Zosuv sa pohybuje rýchlosťou až 50 km/h \u2013 reagujte okamžite, nečakajte. Nikdy sa nevracajte po cestu zosuvu.",
      source: "SK MINV",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Zosuvy pôdy", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "heat",
      emoji: "🌡️",
      title: "Extrémne horúčavy",
      subtitle: "Vlny horúčav a tepelné ohrozenie",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Prevencia" },
        { text: "<strong>Pite dostatočne</strong> \u2013 min. 2\u20133 litre vody denne, aj keď nemáte smäd. Vyhýbajte sa alkoholu a kofeínu." },
        { text: "<strong>Zdržiavajte sa v tieni a klimatizovaných priestoroch</strong> \u2013 hlavne medzi 11:00\u201316:00." },
        { text: "<strong>Oblečenie:</strong> ľahké, vzdušné, svetlých farieb. Pokrývka hlavy, slnečné okuliare." },
        { text: "<strong>Tieňte okná</strong> žalúziami alebo roletami \u2013 cez deň neotvárajte okná na slnečnej strane, veťrajte v noci a ráno." },
        { text: "<strong>Nenechávajte NIKDY deti a zvieratá</strong> v zaparkovanom aute \u2013 teplota vnútri stúpne za 10 minút o 20°C." },
        { header: "Rozpoznajte tepelný úpal (stav ohrozenia života)" },
        { text: "<strong>Príznaky:</strong> teplota nad 40°C, horúca suchá koža (bez potenia!), zmätenosť, strata vedomia, kŕče." },
        { text: "<strong>Volajte 155</strong> \u2013 ide o život ohrozujúci stav." },
        { text: "<strong>Chlaďte postihnutého</strong> \u2013 presuňte do tieňa/chladu, zabaľte do mokrých handier, prikladajte ľad na krk, podpazušie a slabiny." },
        { warn: "Tepelný úpal ≠ úžeh. Pri úpale telo PRESTANE regulovať teplotu. Bez pomoci je smrteľný." },
        { header: "Riziková skupina" },
        { text: "<strong>Seniori, malé deti, chronicky chorí a ľudia na liekoch</strong> (diuretiká, beta-blokátory) sú najviac ohrození \u2013 kontrolujte ich stav." }
      ],
      warning: "ERC 2025 odporúča pri prehriatí: aktívne chladenie (studená voda, ľad) čo najrýchlejšie. Pri teplotách nad 35°C v tieni sledujte výstrahy SHMÚ a obmedzte pobyt vonku na minimum.",
      source: "SK MINV + ERC 2025",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Horúčavy", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "ERC Guidelines 2025 \u2013 Special Circumstances: Hyperthermia", url: "https://www.resuscitationjournal.com/article/S0300-9572(25)00265-5/fulltext" }
      ]
    },
    {
      id: "snow",
      emoji: "❄️",
      title: "Snehová kalamita",
      subtitle: "Extrémne sneženie, ľadovica a nízke teploty",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Doma" },
        { text: "<strong>Majte zásoby jedla, vody a liekov</strong> min. na 3 dni \u2013 obchody a lekárne môžu byť nedostupné." },
        { text: "<strong>Pripravte si alternatívne vykurovanie</strong> \u2013 ak máte krb alebo piecku, majte zásobu dreva. Nikdy nekúrte grilom ani plynovým varičom vnútri (otrava CO!)." },
        { text: "<strong>Obliekajte sa do vrstiev</strong> \u2013 teplé ponožky, čiapka, šál, rukavice. Spodná vrstva termoprádlo, stredná fleece, vonkajšia vetru-odolná." },
        { text: "<strong>Chráňte vodovodné potrubie pred zamrznutím</strong> \u2013 nechajte vodu mierne kvapkať, izolujte trúbky." },
        { header: "Vonku a v aute" },
        { text: "<strong>Obmedzte jazdu autom.</strong> Ak musíte ísť, vezmite si: teplú deku, sviecu v plechovke (ohreje interiér), lopatu, trakčný posyp, nabité telefóny, teplé oblečenie." },
        { text: "<strong>Ak uviazne auto v snehu \u2013 zostaňte v aute.</strong> Zapínajte kúrenie len na krátke intervaly a pootvorte okno (prevencia otravy CO z výfuku zasypaného snehom)." },
        { text: "<strong>Nezdržiavajte sa dlho na mraze</strong> \u2013 omrzliny vznikajú rýchlejšie než si myslíte, hlavne na ušiach, nose, prstoch." },
        { warn: "<strong>Rozpoznajte omrzliny:</strong> biela/vosková koža, necitlivosť, pichanie. Zahrejte postihnuté miesto telesným teplom (podpazušie). NIKDY netrte snehom!" },
        { header: "Ak vypadne kúrenie" },
        { text: "<strong>Zhromaždite sa v jednej miestnosti.</strong> Utesnite dvere do ostatných miestností dekami." },
        { text: "<strong>Na podlahu položte koberce/deky,</strong> presuňte posteľ na najteplejšie miesto. Spite spoločne \u2013 zdieľané teplo je najúčinnejšie." }
      ],
      warning: "Nedotýkajte sa namrznutých kovových predmetov holými rukami. Vždy majte rezervné suché oblečenie. Alkohol zahrieva len krátkodobo a potom zvyšuje stratu tepla \u2013 v zime sa mu vyhnite.",
      source: "SK MINV + SE MSB + CZ 72h",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Snehová kalamita", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "Švédsko MSB \u2013 Om krisen eller kriget kommer (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" },
        { label: "CZ 72h príručka \u2013 Ako zostať v teple", url: "https://www.72h.gov.cz" }
      ]
    },
    // ═══════════════════════════════════════════════════════════════
    // HAVÁRIE A OHROZENIA
    // ═══════════════════════════════════════════════════════════════
    {
      id: "fire",
      emoji: "🔥",
      title: "Požiar",
      subtitle: "Požiar v budove alebo okolí",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Únik z horiaceho priestoru" },
        { text: "<strong>Ohláste požiar na 150 alebo 112</strong> \u2013 aj keď si myslíte, že ho zvládnete uhasiť sami." },
        { text: "<strong>Pred otvorením dverí priložte dlaň na kľučku</strong> \u2013 ak je horúca, za dverami je oheň. Neotvárajte a hľadajte inú cestu." },
        { text: "<strong>Pohybujte sa pri zemi</strong> \u2013 dym stúpa hore, pri podlahe je lepší vzduch. Plazením k východu." },
        { text: "<strong>Zakryte si nos a ústa</strong> navlhčenou tkaninou \u2013 zmenšíte vdýchnutie toxických splodín." },
        { text: "<strong>Zatvárajte za sebou dvere</strong> (nezamykajte) \u2013 spomaľuje to šírenie ohňa a dymu." },
        { text: "<strong>Nikdy sa nevracajte do horiaceho objektu</strong> \u2013 za žiadnych okolností." },
        { header: "Ak nemôžete uniknúť" },
        { text: "<strong>Zavrite dvere miestnosti,</strong> utesnite špáry mokrými handramí alebo oblečením." },
        { text: "<strong>Dajte o sebe vedieť</strong> \u2013 volajte z okna, svieťte telefónom, klopte na stenu." },
        { text: "<strong>Neotvárajte okná dokorán</strong> \u2013 privan vzduch podporí oheň. Pootvorte len na dýchanie." },
        { header: "Prvotné hasenie (ak je bezpečné)" },
        { text: "<strong>Malý požiar (do 1 m²)</strong> \u2013 použite hasiaci prístroj alebo mokrú deku. Smerujte prúd na základňu plameňa." },
        { text: "<strong>Olej na panvici</strong> \u2013 NIKDY nelejte vodu! Prikryte pokrievkou alebo mokrou handrou. Vypnite sporák." },
        { text: "<strong>Elektrika</strong> \u2013 najprv vypnite istič, potom haste. Nikdy nehaste vodou zapojené zariadenia." },
        { text: "<strong>Uzavrite prívod plynu.</strong>" },
        { text: "<strong>Uvoľnite prístupové cesty hasičom</strong> \u2013 minimálne 3 metre." }
      ],
      warning: "Dym zabíja rýchlejšie ako oheň \u2013 3 nádychy toxického dymu môžu spôsobiť bezvedomie. CZ príručka 72h: majte doma funkčný hasiaci prístroj a detektor dymu.",
      source: "SK MINV + CZ 72h",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Požiar", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Požiar", url: "https://www.72h.gov.cz" }
      ]
    },
    {
      id: "blackout",
      emoji: "🔌",
      title: "Výpadok elektriny",
      subtitle: "Čo robiť keď vypadne elektrický prúd",
      iconBg: "#f5f3ee",
      iconBorder: "#e2ddd5",
      steps: [
        { header: "Okamžité kroky" },
        { text: "<strong>Overte rozsah výpadku</strong> \u2013 svieti sa u susedov? Skontrolujte ističe. Ak je výpadok plošný, vypnite hlavný istič \u2013 ochránite spotrebiče pri obnovení prúdu." },
        { text: "<strong>Platobné karty a bankomaty nebudú fungovať.</strong> Majte doma hotovosť (€70\u2013100 na osobu) v malých nomináloch." },
        { note: "Do niekoľkých hodín prestanú fungovať aj telefónne siete. Významne sa obmedzí väčšina základných služieb." },
        { header: "Jedlo a zásoby" },
        { text: "<strong>Ledničku a mrazák otvárajte čo najmenej</strong> \u2013 potraviny v neotvorenom mrazáku vydržia 24\u201348 hodín." },
        { text: "<strong>Premiestnite niečo z mrazáku do lednice</strong> \u2013 pomôže udržať v nej chlad." },
        { text: "<strong>Kontrolujte podlahu</strong> \u2013 pri tání môže vytekať voda." },
        { text: "<strong>Rozmrazené potraviny spotrebujte čo najrýchlejšie.</strong> Ak ich chcete znova zmraziť, najprv ich tepelne spracujte." },
        { text: "<strong>V zime skladujte potraviny vonku</strong> \u2013 chráňte ich pred zvieratami a priamym slnkom." },
        { text: "<strong>Jedlo bez elektriny:</strong> kuskus, instantná kaša, vločky stačí zaliať studenou vodou. Kempingový varič alebo gril \u2013 <strong>používajte len vonku!</strong>" },
        { header: "Ako zostať v teple (zima)" },
        { text: "<strong>Zhromaždite sa v jednej miestnosti.</strong> Dvere do ostatných miestností zatvorte a utesnite dekou." },
        { text: "<strong>Na podlahu položte koberec alebo prikrývky.</strong> Oblečte si viaceré vrstvy priedušného oblečenia." },
        { text: "<strong>Presuňte posteľ na najteplejšie miesto</strong> \u2013 spite spoločne pod všetkými prikrývkami." },
        { warn: "<strong>Alkohol</strong> zahrieva len krátkodobo \u2013 znižuje pozornosť a zhoršuje termoreguláciu. Lepšie sa mu vyhnúť." },
        { header: "Toaleta a hygiena" },
        { text: "<strong>Plošný výpadok elektriny prerušuje dodávky vody.</strong> Toaletu spláchnete iba raz, potom sa nádržka nenapĺňa." },
        { text: "<strong>Pri prerušení vody aj elektriny</strong> používajte toaletu len v nevyhnutných prípadoch. Na umytie rúk používajte dezinfekciu." },
        { note: "<strong>Núdzové riešenie toalety:</strong> do záchodovej misy vložte odpadkový pytel, dajte naň toaletný papier, noviny alebo kočkolit. Po použití pytel pevne zaviažte a vložte do ďalších dvoch vriec." },
        { header: "Komunikácia" },
        { text: "<strong>Telefón používajte len v najnutnejších prípadoch.</strong> Šetrite batériu \u2013 letový režim, nízky jas." },
        { text: "<strong>Rádio na batérie</strong> \u2013 môže byť jediný zdroj informácií. Slovenský rozhlas vysiela krízové informácie." },
        { header: "Po obnovení dodávok" },
        { text: "<strong>Skontrolujte spotrebiče</strong> \u2013 uistite sa, že nie je zapnutý sporák alebo iný spotrebič." },
        { text: "<strong>Overte stav potravín</strong> v lednici a mrazáku \u2013 ak boli dlhšie ako 4 hodiny nad 5°C, zahoďte ich." }
      ],
      warning: "Pozor: V budovách s diaľkovým vykurovaním môže byť teplá voda počas výpadku prúdu nebezpečne horúca. Nikdy nekúrte vnútri grilom alebo plynovým varičom \u2013 hrozí otrava oxidom uhoľnatým!",
      source: "CZ 72h + SK MINV + SE MSB",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Výpadok elektriny", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "Švédsko MSB \u2013 Om krisen eller kriget kommer (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" }
      ]
    },
    {
      id: "water_outage",
      emoji: "🚰",
      title: "Výpadok vody",
      subtitle: "Prerušenie dodávok pitnej vody",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Okamžité kroky" },
        { text: "<strong>Napustite si vodu</strong> kým ešte tečie \u2013 do vane, vedier, hrncov, PET fliaš. Každý liter sa počíta." },
        { text: "<strong>Použite zásoby balenej vody na pitie.</strong> Minimum 2 litre na osobu/deň (SK MINV odporúča 3\u20135 l)." },
        { text: "<strong>Pripravte si uzatvárateľné nádoby</strong> (kanistre) \u2013 na odber vody z cisterien alebo výdajných miest." },
        { header: "Hospodárenie s vodou" },
        { text: "<strong>Pitnú vodu používajte len na pitie a varenie.</strong> Na umývanie rúk stačí dezinfekčný gél." },
        { text: "<strong>Nepoužívajte umývačku riadu.</strong> Riad umývajte minimálnym množstvom vody do lavóra." },
        { text: "<strong>Toaletu splachujte len v nevyhnutnom prípade</strong> \u2013 použite dažďovú vodu, vodu z vane alebo starú vodu z varenia." },
        { text: "<strong>Oblečenie neperte</strong> \u2013 prezliekajte sa a perte až po obnovení dodávok." },
        { header: "Núdzové zdroje vody" },
        { text: "<strong>Cistierna</strong> \u2013 sledujte oznámenia obce/vodárenskej spoločnosti o výdajných miestach." },
        { text: "<strong>Zásobníky na ohrev vody</strong> (bojler) \u2013 obsahujú 50\u2013200 litrov vody, ktorá sa dá použiť (vypustite z výpustného ventilu)." },
        { text: "<strong>Studňa</strong> \u2013 ak máte, overte kvalitu vody pred pitím (chemické znečistenie po povodniach)." },
        { warn: "<strong>Vodu z neznámeho zdroja vždy prevárajte</strong> minimálne 1 minútu v plnom vare. Eliminujete baktérie (nie chemikálie)." },
        { header: "Hygiena" },
        { text: "<strong>Mokré obrúsky a dezinfekcia</strong> sú nevyhnutné \u2013 majte ich v zásobách." },
        { text: "<strong>Na čistenie zubov</strong> použite balenú vodu, nie vodu z vodovodu (potrubie môže byť kontaminované)." }
      ],
      warning: "Po obnovení dodávok nechajte vodu tiecť niekoľko minút pred použitím \u2013 v potrubí môže byť znečistená. CZ príručka 72h: výpadok vody býva často sprievodným javom výpadku elektriny.",
      source: "CZ 72h + SK MINV",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Výpadok vody", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "gas_leak",
      emoji: "💨",
      title: "Únik plynu",
      subtitle: "Únik zemného plynu v budove alebo okolí",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { text: "<strong>Ak cítite plyn \u2013 NEPANIKUJTE, ale konajte rýchlo.</strong>" },
        { text: "<strong>Nefajčite, neškrtajte zápalkou, nepoužívajte elektrické vypínače</strong> (ani nezapínajte, ani nevypínajte svetlo!). Iskra môže spôsobiť výbuch." },
        { text: "<strong>Nepoužívajte zvončeky, telefón ani žiadne elektronické zariadenie</strong> v priestore s plynom." },
        { text: "<strong>Otvorte okná a dvere dokorán</strong> \u2013 vytvorte prievan na odvetranie." },
        { text: "<strong>Uzavrite hlavný ventil plynu</strong> \u2013 zvyčajne pri plynomere alebo pred sporákm. Otáčajte kolmo na potrubie = zavreté." },
        { text: "<strong>Opustite budovu</strong> \u2013 vezmite si len kľúče a telefón. Varujte susedov." },
        { text: "<strong>Až vonku zavolajte:</strong><br>\u2022 <strong>SPP poruchová linka: 0850 111 727</strong><br>\u2022 <strong>Hasiči: 150</strong><br>\u2022 <strong>Tiesňová linka: 112</strong>" },
        { text: "<strong>Nevstupujte späť do budovy</strong> kým situáciu nevyhodnotí plynár alebo hasič." }
      ],
      warning: "Zemný plyn je bez zápachu \u2013 charakteristický zápach (po sírke) je pridaný odorizant. Ak cítite tento zápach, VŽDY to berte vážne. Oxid uhoľnatý (CO) je bez zápachu aj bez farby \u2013 preto je detektor CO v domácnosti nevyhnutný.",
      source: "SK MINV + SPP",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Únik plynu", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "SPP \u2013 Poruchová linka a bezpečnosť", url: "https://www.spp.sk/" }
      ]
    },
    {
      id: "chemical",
      emoji: "🧪",
      title: "Chemický únik",
      subtitle: "Únik nebezpečných chemických látok",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Ak ste vonku" },
        { text: "<strong>Okamžite sa vzďaľte</strong> od zdroja úniku \u2013 ideálne kolmo na smer vetra." },
        { text: "<strong>Chráňte si dýchacie cesty</strong> \u2013 navlhčenou tkaninou, šálom, čímkoľvek. Dýchajte plytko." },
        { text: "<strong>Chráňte si oči</strong> \u2013 okuliare, lyžiarske okuliare, čokoľvek." },
        { text: "<strong>Presúvajte sa do vyšších polôh</strong> \u2013 väčšina nebezpečných plynov (chlór, fosgén) je ťažšia ako vzduch a hromadí sa v nížinách, pivniciach a priehlbinách." },
        { warn: "<strong>Nikdy sa neukrývajte do pivníc</strong> a terénnych nerovností \u2013 chemické látky sú často ťažšie než vzduch a hromadia sa tam!" },
        { header: "Ak ste doma (shelter-in-place)" },
        { text: "<strong>Zostaňte doma!</strong> Zatvorte a utesnite okná, dvere, vetracie otvory." },
        { text: "<strong>Vypnite ventiláciu, klimatizáciu, digestor.</strong>" },
        { text: "<strong>Uhaste otvorený oheň</strong> a vypnite plynové spotrebiče." },
        { text: "<strong>Na utesnenie</strong> použite mokré handry, igelitové vrecia a lepiacu pásku na špáry okien a dverí." },
        { text: "<strong>Presúvajte sa do vyšších poschodí</strong> \u2013 ak je to možné, na 2.+ poschodie." },
        { header: "Ak ste boli vystavení chemikáliám" },
        { text: "<strong>Odložte kontaminovaný odev</strong> do nepriedušného vreca." },
        { text: "<strong>Osprchujte sa veľkým množstvom vody</strong> \u2013 min. 15 minút. Neumývajte sa teplou vodou (otvára póry)." },
        { text: "<strong>Vypláchnite oči</strong> čistou vodou min. 15 minút." },
        { text: "<strong>Vyhľadajte lekársku pomoc</strong> \u2013 aj keď sa cítite dobre. Niektoré látky majú oneskorený účinok (6\u201324 hodín)." }
      ],
      warning: "Telefonujte len v súrnom prípade \u2013 nezaťažujte siete. Pripravte si evakuačný batoh pre prípad, že bude nariadená evakuácia. Sledujte pokyny na oficiálnych kanáloch.",
      source: "SK MINV + CZ 72h",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Chemický únik", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "CZ 72h príručka (MV ČR, 2025)", url: "https://www.72h.gov.cz" }
      ]
    },
    {
      id: "radiation",
      emoji: "☢️",
      title: "Rádioaktívny únik",
      subtitle: "Jadrová havária alebo rádioaktívna kontaminácia",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Okamžitá ochrana" },
        { text: "<strong>Ihneď do budovy!</strong> Na otvorenom priestranstve vyhľadajte najbližšiu pevnú budovu." },
        { text: "<strong>Choďte čo najhlbšie</strong> \u2013 stredové miestnosti na prízemí alebo suterén. Čím viac stien medzi vami a vonkajším prostredím, tým lepšie." },
        { text: "<strong>Uzatvorte a utesnite okná, dvere,</strong> vetracie otvory. Vypnite ventiláciu a klimatizáciu." },
        { text: "<strong>Zabezpečte potraviny a vodu</strong> \u2013 hermeticky uzavrite v nádobách. Nepožívajte ovocie, zeleninu a potraviny z voľného priestranstva." },
        { header: "Ak ste boli vonku počas úniku" },
        { text: "<strong>Odložte kontaminovaný odev</strong> do nepriedušného obalu \u2013 mimo obytné priestory." },
        { text: "<strong>Umyte si ruky, tvár, vlasy šampónom</strong> (nie kondicionérom \u2013 viaže častice). Vypláchnite oči a ústa." },
        { text: "<strong>Osprchujte sa a vymeňte bielizeň.</strong>" },
        { header: "Jódové tablety" },
        { text: "<strong>Jodid draselný (KI)</strong> \u2013 užite LEN na pokyn úradov. Chráni štítnu žľazu pred rádioaktívnym jódom." },
        { note: "Fínsko (72 tuntia) odporúča mať doma jódové tablety. Na Slovensku ich vydávajú úrady v prípade jadrovej havárie (Jaslovské Bohunice, Mochovce)." },
        { header: "Jadrový výbuch \u2013 UA DSNS odporúčania" },
        { text: "<strong>Ak vidíte záblesk:</strong> NEPOZERAJTE SA naň (popáleniny rohovky). Okamžite ľahnite na zem tvárou nadol, nohy smerom k výbuchu, ruky pod telo, zakryte si uši." },
        { text: "<strong>Čakajte na tlakovú vlnu</strong> \u2013 po prechode vlny okamžite utekajte do najbližšej budovy." },
        { text: "<strong>V úkryte zostaňte min. 24 hodín</strong> \u2013 rádioaktívny spád je najsilnejší v prvých hodinách." },
        { text: "<strong>Evakuáciu vykonajte</strong> až na pokyn úradov." }
      ],
      warning: "Rádioaktívne častice nie sú vidieť ani cítiť. VŽDY berte varovanie úradov vážne. Švédsko MSB (2024) a Fínsko (72 tuntia) zdôrazňujú: príprava na jadrovú hrozbu je súčasť civilnej pripravenosti v Európe.",
      source: "SK MINV + UA DSNS + SE MSB + FI 72 tuntia",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Radiačná udalosť", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "UA DSNS \u2013 Ako sa chrániť pred jadrovým útokom", url: "https://dovidka.info/en/yak-diyaty-v-razi-zastosuvannya-brudnoyi-bomby-yadernoyi-ataky-chy-avariyi-na-aes/" },
        { label: "Švédsko MSB \u2013 Om krisen eller kriget kommer (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" }
      ]
    },
    {
      id: "terror",
      emoji: "🚨",
      title: "Teroristický útok",
      subtitle: "Streľba, bombový útok alebo útok vozidlom",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "UTEČTE (ak máte únikovú cestu)" },
        { text: "<strong>Opustite priestor najrýchlejšou bezpečnou cestou.</strong> Zoberte si iba telefón." },
        { text: "<strong>Varujte ostatných</strong> pred vstupom do nebezpečnej zóny \u2013 ale nečakajte na nikoho, kto nechce ísť." },
        { text: "<strong>Nechajte za sebou otvorené dvere</strong> \u2013 uľahčíte únik ďalším ľuďom." },
        { text: "<strong>Neutekajte priamočiaro</strong> \u2013 cik-cak pohyb, za prekážkami, z dosahu útočníka." },
        { header: "SKRYTE SA (ak nemôžete utiecť)" },
        { text: "<strong>Zamknite dvere,</strong> kľúč nechajte v zámku. Zabarikádujte nábytkom." },
        { text: "<strong>Nezdržujte sa pri oknách a stenách smerujúcich na chodbu.</strong>" },
        { text: "<strong>Schovajte sa za pevné predmety</strong> \u2013 betónová stena, ťažký nábytok, pilier." },
        { text: "<strong>Stíšte telefón</strong> (aj vibrácie!). Nepíšte na sociálne siete \u2013 prezrádzate svoju pozíciu." },
        { text: "<strong>Zostaňte skrytí</strong> kým vás neoslobodí polícia." },
        { header: "BRÁŇTE SA (posledná možnosť)" },
        { text: "<strong>Len pri bezprostrednom ohrožení života</strong> \u2013 bojujte so všetkým čo máte." },
        { text: "<strong>Použite predmety v okolí:</strong> hasiaci prístroj (oslepí + údery), stolička, fľaša, kľúče, pero." },
        { text: "<strong>Konajte rozhodne a agresívne.</strong> Cieľte na oči a hrdlo." },
        { header: "Po zásahu polície" },
        { text: "<strong>Ukážte prázdne ruky</strong> \u2013 polícia netuší kto je útočník. Nerobte prudké pohyby." },
        { text: "<strong>Poslúchajte pokyny policajtov</strong> \u2013 aj keď idú opačným smerom od východu." },
        { text: "<strong>Nezdieľajte videá na sociálnych sieťach</strong> \u2013 môžu byť zneužité útočníkmi." }
      ],
      warning: "Po výbuchu môžu nasledovať ďalšie útoky (tzv. double tap). Ak nie ste zranení, vzďaľte sa z miesta čo najďalej. Ak neohrozíte seba, poskytnite pomoc zraneným.",
      source: "SK MINV + UA DSNS",
      sources: [
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Teroristický útok", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "UA DSNS \u2013 Príručka pre prípad núdze alebo vojny", url: "https://dovidka.info/" }
      ]
    },
    {
      id: "armed_conflict",
      emoji: "💣",
      title: "Ozbrojený konflikt",
      subtitle: "Čo robiť pri ostreľovaní, dronoch a bombardovaní",
      iconBg: "#fef2f2",
      iconBorder: "#fecaca",
      steps: [
        { header: "Keď zaznie siréna (vzdušný poplach)" },
        { text: "<strong>Okamžite vyhľadajte úkryt</strong> \u2013 pivnica, suterén, metro, podzemný parking, vnútorná miestnosť bez okien." },
        { text: "<strong>Držte sa ďalej od okien, sklenených plôch a vonkajších stien.</strong>" },
        { text: "<strong>Sadnite si alebo ľahnite na zem</strong> \u2013 čím nižšie, tým lepšie. Chráňte si hlavu a krk." },
        { text: "<strong>Zostaňte v úkryte</strong> kým nezaznie signál konca ohrozenia alebo kým nedostanete oficiálnu informáciu." },
        { warn: "Nikdy nevychádzajte von bezprostredne po výbuchu \u2013 môžu nasledovať ďalšie útoky (double tap)." },
        { header: "Pravidlo dvoch stien (UA DSNS)" },
        { text: "<strong>Ak ste doma a nestíhate do úkrytu</strong> \u2013 nájdite miesto oddelené od vonkajšej steny dvoma nosnými stenami. Kúpeľňa alebo chodba v strede bytu." },
        { text: "<strong>Nikdy sa neukrývajte pri oknách</strong> \u2013 tlaková vlna vyráža sklo, ktoré spôsobuje najčastejšie zranenia civilistov." },
        { header: "Ochrana okien a bytu" },
        { text: "<strong>Prelepte okná krížom lepenkou</strong> \u2013 zmenšíte riziko poranenia odletujúcim sklom.", forHousing: ["flat", "rd", "rd_cellar"] },
        { text: "<strong>Ochrana okien doskami, preglejkou</strong> alebo vrstvou kobercov. UA DSNS: nasypte piesok alebo zeminu do vriec pred vonkajšie steny a okná.", forHousing: ["rd", "rd_cellar"] },
        { text: "<strong>Vnútri otočte ťažký nábytok</strong> (pohovka, skriňa) medzi vonkajšiu stenu a miesto kde sa zdržiavate \u2013 funguje ako ochranná bariéra." },
        { header: "Drony" },
        { text: "<strong>Ak počujete bzukot dronu \u2013 okamžite pod betónovú konštrukciu</strong> alebo do budovy." },
        { text: "<strong>Nepozerajte sa hore a nefotografujte</strong> \u2013 svetlo displeja vás identifikuje." },
        { text: "<strong>Vonku bez úkrytu:</strong> ľahnite si tvárou nadol, zakryte hlavu. Akákoľvek priehlbina, priekopa alebo obrubník je lepšia ako nič." },
        { header: "Ochrana sluchu a zraku" },
        { text: "<strong>Chrániče sluchu alebo aspoň štuple do uší</strong> \u2013 výbuchy spôsobujú trvalé poškodenie sluchu. UA DSNS: slúchadlá sú ochrana proti barotraume." },
        { text: "<strong>Ochranné okuliare</strong> \u2013 sklené črepiny, prach a úlomky ohrozujú zrak. Stavebné alebo lyžiarske okuliare." },
        { header: "Po výbuchu / ostreľovaní" },
        { text: "<strong>Skontrolujte seba a blízkych</strong> \u2013 zastavte krvácanie (pozrite postup Vojnové zranenia v sekcii Prvá pomoc)." },
        { text: "<strong>Ak sa budova poškodila \u2013 opatrne ju opustite.</strong> Pozor na uvoľnené konštrukcie, rozbité sklo a spadnuté vedenie." },
        { text: "<strong>Nedotýkajte sa neznámych predmetov</strong> \u2013 môže ísť o nevybuchnutú muníciu. Zavolajte 112." },
        { text: "<strong>Ak ste pod troskami</strong> \u2013 zavolajte 112, klopte na potrubie, svieťte telefónom. Šetrite energiu." },
        { header: "Príprava vopred" },
        { text: "<strong>Identifikujte najbližšie úkryty</strong> \u2013 pivnice, garáže, metro. UA DSNS: overte ich na mape úkrytov." },
        { text: "<strong>Evakuačný batoh pri dverách</strong> \u2013 doklady, voda, lieky, baterka, power banka, peniaze, nabíjačka." },
        { text: "<strong>Rodinný plán stretnutia</strong> \u2013 kde sa stretnete ak vypadne signál. Každý člen rodiny musí vedieť plán." },
        { text: "<strong>Naučte sa základy prvej pomoci</strong> \u2013 turniket, zastavenie krvácania, stabilizovaná poloha." },
        { text: "<strong>Pracovné oblečenie a ochranné pomôcky</strong> \u2013 UA DSNS odporúča: pracovné rukavice (sklo všade), pevnú obuv, stavebné okuliare, rúško/respirátor, prilbu." }
      ],
      warning: "Tieto odporúčania vychádzajú zo skúseností ukrajinského obyvateľstva od roku 2022. Vždy sa riaďte pokynmi miestnych autorít. Najúčinnejšia ochrana civilistov je včasná evakuácia z ohrozenej oblasti.",
      source: "UA DSNS + SK MINV + ICRC",
      sources: [
        { label: "UA DSNS \u2013 Príručka pre prípad núdze alebo vojny", url: "https://dovidka.info/" },
        { label: "UA DSNS \u2013 Ako prežiť ostreľovanie a pripraviť úkryt", url: "https://dovidka.info/en/russians-are-shelling-ukrainian-cities-how-to-equip-a-shelter-and-get-out-of-the-rubble/" },
        { label: "UA DSNS \u2013 Príprava civilnej obrany v obliehaniu", url: "https://dovidka.info/en/preparation-of-civil-defense-in-the-siege/" },
        { label: "UA DSNS \u2013 V bojovej zóne", url: "https://dovidka.info/en/in-the-combat-area/" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "ICRC \u2013 International Committee of the Red Cross", url: "https://www.icrc.org/" }
      ]
    },
    // ═══════════════════════════════════════════════════════════════
    // PRIPRAVENOSŤ A PODPORA
    // ═══════════════════════════════════════════════════════════════
    {
      id: "survival_72h",
      emoji: "⏱️",
      title: "72 hodín bez služieb",
      subtitle: "Ako zvládnuť 3 dni bez základných služieb",
      iconBg: "#eff6ff",
      iconBorder: "#bfdbfe",
      steps: [
        { header: "Čo sa môže stať naraz?" },
        { text: "<strong>Nepôjde elektrina.</strong> Z kohútika nepotečie voda. Prestane fungovať telefón, televízia a internet." },
        { text: "<strong>Nezaplatíme kartou.</strong> Nenatankujeme. Obchody budú zavreté. Prestane jazdiť MHD." },
        { text: "<strong>Prestane fungovať kúrenie.</strong> Nikde nevyzdvihneme lieky. Toaletu spláchneme možno raz." },
        { note: "Pravidlo 72 hodín (CZ) / 1 týždeň (Švédsko, Nórsko): každý má zvládnuť prvé dni bez pomoci záchranných zložiek \u2013 iba s tým, čo má doma." },
        { header: "Čo mať pripravené" },
        { text: "<strong>Voda:</strong> min. 2\u20133 litre na osobu/deň. Na 72h = min. 6\u20139 litrov na osobu. Balenú + nádoby na odber." },
        { text: "<strong>Jedlo:</strong> konzervy, sušienky, müsli tyčinky, sušené ovocie, orechy. Nič čo vyžaduje chladenie alebo varenie." },
        { text: "<strong>Lieky:</strong> min. na 7\u201314 dní. Chronická medikácia, bežné lieky (paracetamol, ibuprofen, antidiaroiká)." },
        { text: "<strong>Hotovosť:</strong> €70\u2013100 na osobu v malých nomináloch (€5, €10, €20)." },
        { text: "<strong>Info a komunikácia:</strong> rádio na batérie, powerbanka, baterka, píšťalka, nabíjačky." },
        { text: "<strong>Hygiena:</strong> mokré obrúsky, dezinfekcia, odpadkové vrecia, toaletný papier." },
        { text: "<strong>Doklady:</strong> kópie OP, pasu, poistiek, lekárskych správ v nepremokavom obale." },
        { header: "Prečo sa pripraviť?" },
        { text: "<strong>Pripravená domácnosť = menej stresu + schopnosť pomáhať.</strong> Kto je pripravený, dokáže pomôcť susedom, starším a rodinám s deťmi." },
        { text: "<strong>Príprava zaberie len pár hodín</strong> a stojí €30\u201350 na osobu. Môže zachrániť život." }
      ],
      warning: "Najnáročnejšie bývajú prvé 72 hodín. Ak sa včas pripravíte, pomôžete tým nielen sebe ale aj ostatným. EU Preparedness Union Strategy (2025) odporúča 72h sebestačnosť pre všetkých občanov.",
      source: "CZ 72h + SE MSB + SK MINV + EU",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025)", url: "https://www.72h.gov.cz" },
        { label: "Švédsko MSB \u2013 Om krisen eller kriget kommer (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "EU Preparedness Union Strategy (2025)", url: "https://commission.europa.eu/strategy-and-policy/priorities-2024-2029/protecting-our-european-way-life/european-security-and-defence/preparedness-union-strategy_en" }
      ]
    },
    {
      id: "shelter",
      emoji: "🛖",
      title: "Ukrytie",
      subtitle: "Kedy a ako sa ukryť na bezpečnom mieste",
      iconBg: "#f0fdf4",
      iconBorder: "#86efac",
      steps: [
        { header: "Varovný signál" },
        { text: "<strong>Všeobecná výstraha:</strong> kolísavý tón sirény po dobu 140 sekúnd. Znamená: ihneď sa ukryte!" },
        { text: "<strong>Po zaznení signálu</strong> sa rýchlo ukryte v najbližšej pevnej budove. Dôkladne uzavrite dvere a okná." },
        { header: "Kedy sa musíme ukryť?" },
        { text: "<strong>Silná búrka alebo tornádo, únik nebezpečných látok, riziko radiácie, vzdušný poplach, ostreľovanie.</strong>" },
        { header: "Čo je dobrý úkryt?" },
        { text: "<strong>Najlepšie:</strong> pivnica, suterén, metro, podzemný parking, protiatómový kryt." },
        { text: "<strong>Dobré:</strong> vnútorná miestnosť bez okien (kúpeľňa, chodba) obklopená nosnými stenami." },
        { text: "<strong>Nie je úkryt:</strong> auto, autobusová zastávka, sklenená prístavba, stanové konštrukcie." },
        { note: "UA DSNS pravidlo dvoch stien: medzi vami a vonkajšou stenou majú byť aspoň 2 nosné steny." },
        { header: "V úkryte" },
        { text: "<strong>Utesnite miestnosť</strong> \u2013 mokré handry do špár dverí a okien. Vypnite ventiláciu a klimatizáciu." },
        { text: "<strong>Zabezpečte prístup k informáciám</strong> \u2013 rádio na batérie, telefón v letovom režime (šetrí batériu)." },
        { text: "<strong>Zbytočne netelefonujte</strong> \u2013 nepreťažujte mobilné siete." },
        { text: "<strong>Zostaňte v úkryte</strong> a čakajte na pokyny (rádio, sirény, záchranári)." },
        { warn: "Niektoré nebezpečné látky nie sú vidieť ani cítiť. VŽDY berte varovanie úradov vážne \u2013 aj keď sa vám zdá, že vonku je všetko v poriadku." }
      ],
      warning: "Pamätajte: kolísavý tón 140 sekúnd = všeobecná výstraha = ihneď do úkrytu. Koniec ohrozenia: stály tón 140 sekúnd.",
      source: "CZ 72h + UA DSNS + SK MINV",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Ukrytie", url: "https://www.72h.gov.cz" },
        { label: "UA DSNS \u2013 Úkryty a ochrana pred ostreľovaním", url: "https://dovidka.info/en/what-is-shelter/" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Ukrytie", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "evacuation",
      emoji: "🏃",
      title: "Evakuácia",
      subtitle: "Kompletný postup pri nariadení evakuácie",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { header: "Bezpečnostné opatrenia pred odchodom" },
        { text: "<strong>Uhaste oheň</strong> v kamnách, krbe alebo na sporáku." },
        { text: "<strong>Vypnite elektrické spotrebiče</strong> (okrem mrazáku \u2013 ak funguje elektrina)." },
        { text: "<strong>Uzavrite vodu a plyn.</strong> Zatvorte okná a dvere, vypnite ventiláciu." },
        { header: "Evakuačný batoh" },
        { text: "<strong>Batoh označte štítkom</strong> so menom a telefónnym číslom." },
        { text: "<strong>Hmotnosť:</strong> max 25 kg (dospelý), 15 kg (dieťa), + 5 kg príručná taška." },
        { text: "<strong>Obsah:</strong> doklady v nepremokavom obale, peniaze, lieky, 1.5l vody na osobu, potraviny na 1\u20132 dni, oblečenie na prezlečenie, hygienické potreby, baterka, powerbanka, nabíjačka, rádio." },
        { note: "UA DSNS: batoh max 25 litrov, max 50 kg. Plánujte, že časť cesty možno pôjdete peši \u2013 berte len najnutnejšie." },
        { header: "Ochrana osôb" },
        { text: "<strong>Deťom a zraniteľným osobám</strong> dajte do kapsy kartičku s menom, adresou a kontaktom na príbuzného." },
        { text: "<strong>Upozornite susedov.</strong> Ponúknite pomoc starším a osobám s obmedzenou mobilitou." },
        { text: "<strong>Nezabudnite na domáce zvieratá</strong> \u2013 prepravka, krmivo, voda, veterinárne doklady." },
        { header: "Pred odchodom" },
        { text: "<strong>Zamknite byt / dom.</strong>" },
        { text: "<strong>Na dvere nalepte lístok</strong> s informáciou kedy a kam ste sa evakuovali, s menami a kontaktom." },
        { header: "Evakuačné trasy" },
        { text: "<strong>Riaďte sa pokynmi záchranárov</strong> \u2013 neopúšťajte stanovené trasy." },
        { text: "<strong>Než sa evakuujete autom</strong> \u2013 zvážte riziká: palivo, stav ciest, premávka. V niektorých situáciách je peší odchod bezpečnejší." },
        { text: "<strong>Ak sa evakuujete sami</strong> \u2013 nahláste sa úradom alebo známym, aby vedeli kde ste." },
        { text: "<strong>Dostavte sa na určené zhromaždisko.</strong>" }
      ],
      warning: "Výzvu k evakuácii musíte uposlúchnuť. Nie je to odporúčanie \u2013 je to nariadenie na záchranu života. Chránime tým nielen seba, ale aj zdravie záchranárov.",
      source: "CZ 72h + SK MINV + UA DSNS",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Evakuácia", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva: Evakuácia", url: "https://www.minv.sk/?ochrana-obyvatelstva" },
        { label: "UA DSNS \u2013 Evakuácia a organizácia úkrytov", url: "https://dovidka.info/en/evacuation-and-organization-of-shelters/" }
      ]
    },
    {
      id: "help_neighbors",
      emoji: "🤝",
      title: "Pomoc susedom",
      subtitle: "Vzájomná pomoc v okolí počas krízy",
      iconBg: "#f0fdf4",
      iconBorder: "#86efac",
      steps: [
        { text: "<strong>Žije vo vašom okolí niekto, kto by mohol potrebovať pomoc?</strong> Starší človek, rodina s malými deťmi, osoba s handicapom, chorý alebo cudzinec, ktorý nerozumie dobre slovensky." },
        { note: "V krízových situáciách je vzájomná pomoc kľúčová. CZ 72h: \u201ePripravená domácnosť môže lepšie pomáhať ostatným.\u201c Fínska príručka zdôrazňuje: vopred sa dohodnite so susedmi, kto je zraniteľný a kto môže pomôcť." },
        { header: "Vaši susedia môžu" },
        { text: "<strong>Potrebovať lekársku pomoc</strong> alebo lieky, na ktoré sa nedostanú." },
        { text: "<strong>Nemať zásoby</strong> jedla alebo pitnej vody." },
        { text: "<strong>Nevyznať sa v situácii</strong> \u2013 nevedia prečo nefunguje elektrina, voda, čo majú robiť." },
        { text: "<strong>Mať problém s pohybom</strong> \u2013 nemôžu sa dostať na miesto výdaja vody alebo na zhromaždisko." },
        { header: "Čo môžete urobiť" },
        { text: "<strong>Zavolajte pomoc</strong> v naliehavých prípadoch (112, 155, 150)." },
        { text: "<strong>Rozdeľte sa o zásoby</strong> \u2013 aj malé množstvo vody alebo jedla môže pomôcť." },
        { text: "<strong>Pomôžte s presunom</strong> \u2013 do úkrytu, na zhromaždisko, k lekárovi." },
        { text: "<strong>Odovzdávajte informácie</strong> \u2013 čo sa deje, kde je výdajné miesto, aké sú pokyny." },
        { text: "<strong>Overte stav izolovaných ľudí</strong> \u2013 zaklopte, zavolajte, opýtajte sa či niečo nepotrebujú." }
      ],
      warning: "Spoločenstvo a susedská pomoc sú v kríze neoceniteľné. UA skúsenosť: susedstvá, ktoré sa organizovali vopred, zvládli ostreľovanie a blackouty výrazne lepšie.",
      source: "CZ 72h + SK MINV + FI 72 tuntia",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Pomoc susedom", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "children_crisis",
      emoji: "👨‍👧‍👦",
      title: "Komunikácia s deťmi",
      subtitle: "Ako hovoriť s deťmi o kríze",
      iconBg: "#fdf2f8",
      iconBorder: "#fbcfe8",
      steps: [
        { text: "<strong>V krízových situáciách sa deťom venujte ešte viac.</strong> Deti potrebujú chápať čo sa deje, cítiť podporu a vedieť čo ich čaká. Vďaka tomu sa so situáciou lepšie vyrovnajú." },
        { header: "Ako komunikovať" },
        { text: "<strong>Hovorte otvorene a úprimne,</strong> primerane veku dieťaťa." },
        { text: "<strong>Dajte im priestor</strong> povedať, z čoho majú obavy. Naslúchajte." },
        { text: "<strong>Hovorte aj o svojich pocitoch</strong> \u2013 je normálne cítiť strach alebo neistotu." },
        { text: "<strong>Snažte sa zostať v pokoji</strong> \u2013 deti zrkadlia naše emócie." },
        { text: "<strong>Zapojte ich do činností</strong> primerane veku \u2013 pomáhanie dáva pocit kontroly." },
        { header: "Čo povedať" },
        { text: "<strong>Situáciu vysvetlite jednoducho:</strong> \u201eTeraz nemáme elektrinu. To sa stáva a my sme pripravení.\u201c" },
        { text: "<strong>Zdôraznite, že odborníci situáciu riešia</strong> a robia všetko pre ochranu." },
        { text: "<strong>Ujistite ich:</strong> \u201eBudeme stále s tebou. Spolu to zvládneme.\u201c" },
        { text: "<strong>Ak je to možné, udržujte obvyklý režim</strong> \u2013 jedlo, spánok, hra v pravidelných intervaloch." },
        { note: "<strong>Evakuácia:</strong> Pripravte dieťaťu kartičku s menom, adresou a kontaktom na blízku osobu do vrecka. Do batôžku pribaľte obľúbenú hračku alebo plyšáka." }
      ],
      warning: "Obmedzte vystavenie detí správam a záberom z krízy/vojny. Sledujte zmeny správania (problémy so spánkom, agresivita, pomočovanie) \u2013 môžu byť signálom traumy.",
      source: "CZ 72h + SK MINV",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Deti a kríza", url: "https://www.72h.gov.cz" },
        { label: "SK MINV \u2013 Ochrana obyvateľstva", url: "https://www.minv.sk/?ochrana-obyvatelstva" }
      ]
    },
    {
      id: "mental_health",
      emoji: "🧠",
      title: "Psychická podpora",
      subtitle: "Podpora v ťažkých chvíľach pre dospelých",
      iconBg: "#ede9fe",
      iconBorder: "#c4b5fd",
      steps: [
        { text: "<strong>V kríze je dôležité myslieť aj na psychickú pohodu.</strong> Strach, úzkosť, hnev, smútok alebo necitlivosť sú normálne reakcie na nenormálnu situáciu." },
        { header: "Ako sa starať o seba" },
        { text: "<strong>Udržujte denný režim</strong> \u2013 pravidelné jedlo, spánok a pohyb pomáhajú." },
        { text: "<strong>Obmedzte sledovanie správ</strong> \u2013 stačí 2x denne z overených zdrojov." },
        { text: "<strong>Hovorte o svojich pocitoch</strong> s blízkymi \u2013 izolácia zhoršuje stav." },
        { text: "<strong>Zapojte sa do pomoci ostatným</strong> \u2013 aktívna pomoc dáva pocit kontroly a zmyslu." },
        { header: "Ako podporovať druhých" },
        { text: "<strong>Hovorte s rešpektom a trpezlivosťou.</strong> Naslúchajte a nesúďte." },
        { text: "<strong>Dajte priestor emóciám</strong> \u2013 plač, hnev aj ticho sú normálne reakcie." },
        { text: "<strong>Umožnite zapojenie</strong> do riešenia situácie spôsobom, ktorý zvládnu." },
        { header: "Linky pomoci" },
        { text: "<strong>Linka dôvery (SK):</strong> <a href='tel:0800500333' style='color:#1e40af;font-weight:bold'>0800 500 333</a> \u2013 bezplatná, nonstop" },
        { text: "<strong>Linka pomoci (SK):</strong> <a href='tel:116123' style='color:#1e40af;font-weight:bold'>116 123</a> \u2013 emocionálna podpora" },
        { text: "<strong>Krízová linka (SK):</strong> <a href='tel:0800801616' style='color:#1e40af;font-weight:bold'>0800 801 616</a> \u2013 pre obete násilia" },
        { note: "Staráte sa o niekoho so špecifickými potrebami (starší, osoba so zdravotným znevýhodnením, duševné ochorenie)? Kontaktujte miestny úrad sociálnych vecí alebo linku pomoci." }
      ],
      warning: "Ak máte myšlienky na sebapoškodenie, zavolajte ihneď 0800 500 333 alebo 112. Nemusíte to zvládať sami.",
      source: "CZ 72h + Linka dôvery SR",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Psychická podpora", url: "https://www.72h.gov.cz" },
        { label: "Linka dôvery SR \u2013 0800 500 333", url: "https://www.linkadovery.sk/" }
      ]
    },
    {
      id: "info_hygiene",
      emoji: "📰",
      title: "Overovanie informácií",
      subtitle: "Ako rozpoznať a brániť sa dezinformáciám v kríze",
      iconBg: "#fef3c7",
      iconBorder: "#fcd34d",
      steps: [
        { text: "<strong>V kríze sa rýchlo šíria fámy, poplašné správy a dezinformácie.</strong> Môžu spôsobiť paniku, ohroziť životy a komplikovať prácu záchranárov." },
        { header: "Pravidlá informačnej hygieny" },
        { text: "<strong>Overujte z viacerých dôveryhodných zdrojov</strong> \u2013 Slovenský rozhlas (RTVS), Civilná ochrana SR, SHMÚ, hasiči." },
        { text: "<strong>Zdieľajte iba overené informácie.</strong> Pred zdieľaním sa spýtajte: Viem, kto to napísal? Je to z oficiálneho zdroja? Nie je to stará správa?" },
        { text: "<strong>Dávajte pozor na emocionálny jazyk</strong> \u2013 správy typu \u201eŠÍRTE ĎALEJ!!!\u201c, \u201eVšetci musia vedieť!\u201c sú typickým znakom dezinformácií." },
        { header: "UA skúsenosť s dezinformáciami vo vojne" },
        { text: "<strong>Nefotografujte a nezdieľajte:</strong> pozície armády, pohyby vojsk, zásahy na objekty \u2013 pomáhate tým nepriateľovi." },
        { text: "<strong>Falošné evakuačné príkazy:</strong> overte každý príkaz k evakuácii cez oficiálne kanály (rádio, web MV SR, civilná ochrana)." },
        { text: "<strong>Nedôverujte neznámym účtom</strong> na sociálnych sieťach \u2013 boti a trollovia sú reálnou hrozbou aj v Európe." },
        { note: "Švédsko MSB (2024): dezinformácie a kyberútoky sú súčasťou moderného konfliktu. Pripravte sa rovnako ako na výpadok elektriny." },
        { header: "Dôveryhodné zdroje na Slovensku" },
        { text: "<strong>RTVS</strong> (Slovenský rozhlas a televízia), <strong>SHMÚ</strong> (shmu.sk), <strong>Civilná ochrana MV SR</strong> (minv.sk), <strong>HaZZ SR</strong> (hasiči), <strong>112</strong> (tiesňová linka)." }
      ],
      warning: "V kríze platí: najprv overiť, potom zdieľať. Jedna nepravdivá správa môže spôsobiť paniku a ohroziť životy. Buďte súčasťou riešenia, nie problému.",
      source: "CZ 72h + UA DSNS + SE MSB",
      sources: [
        { label: "CZ 72h príručka (MV ČR, 2025) \u2013 Informačná hygiena", url: "https://www.72h.gov.cz" },
        { label: "UA DSNS \u2013 Dezinformácie a informačná bezpečnosť", url: "https://dovidka.info/" },
        { label: "Švédsko MSB \u2013 Om krisen eller kriget kommer (2024)", url: "https://www.msb.se/en/rad-till-privatpersoner/the-brochure-if-crisis-or-war-comes/" }
      ]
    }
  ];


  function renderEmergencyProc() {
    // 4 separate groups → 4 separate grids
    const groupDefs = [
      { gridId: "procGridNature", ids: ["flood", "earthquake", "storm", "landslide", "heat", "snow"] },
      { gridId: "procGridHazards", ids: ["fire", "blackout", "water_outage", "gas_leak", "chemical", "radiation"] },
      { gridId: "procGridConflict", ids: ["terror", "armed_conflict"] },
      { gridId: "procGridSupport", ids: ["survival_72h", "shelter", "evacuation", "help_neighbors", "children_crisis", "mental_health", "info_hygiene"] }
    ];

    groupDefs.forEach(group => {
      const grid = document.getElementById(group.gridId);
      if (!grid) return;
      grid.innerHTML = "";

      group.ids.forEach(id => {
        const item = EMERGENCY_PROC_DATA.find(d => d.id === id);
        if (!item) return;
        const card = document.createElement("div");
        card.className = "mu-card";
        card.setAttribute("role", "button");
        card.setAttribute("tabindex", "0");
        card.setAttribute("aria-label", item.title + " – zobraziť postup");
        card.innerHTML = `
          <div class="mu-icon" style="background:${item.iconBg}; border:1.5px solid ${item.iconBorder};">
            ${item.emoji}
          </div>
          <div class="mu-card-label">${item.title}</div>`;
        card.onclick = () => openEmergencyProcModal(item);
        card.onkeydown = (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openEmergencyProcModal(item); }};
        grid.appendChild(card);
      });
    });
  }

  function openEmergencyProcModal(item) {
    const icon = document.getElementById("muModalIcon");
    const title = document.getElementById("muModalTitle");
    const subtitle = document.getElementById("muModalSubtitle");
    const content = document.getElementById("muModalContent");

    icon.style.background = item.iconBg;
    icon.style.border = `1.5px solid ${item.iconBorder}`;
    icon.textContent = item.emoji;
    title.textContent = item.title;
    subtitle.textContent = item.subtitle;

    let html = `<div class="fa-emergency-bar">📞 Tiesňové číslo: <a href="tel:112">112</a> &nbsp;|&nbsp; Hasiči: <a href="tel:150">150</a> &nbsp;|&nbsp; Polícia: <a href="tel:158">158</a></div>`;

    const housing = (state.profile && state.profile.housing) || "flat";
    html += renderStepsHTML(item.steps, { housing });

    if (item.warning) {
      html += `<div class="fa-warning"><strong>⚠️ Dôležité:</strong> ${item.warning}</div>`;
    }

    html += renderSourcesCollapsible(item.sources, item.source);

    content.innerHTML = html;
    openModal("modalEmergencyProc");
  }

  function renderAll() {
    renderProfileCard();
    renderOverall();
    renderCategories();
    renderFirstAid();
    renderEmergencyContacts();
    renderPersonalContacts();
    renderSirens();
    renderRadio();
    renderEmergencyProc();
    renderEvacBags();
    // Aktualizuj detail kategórie len ak je modal otvorený
    if (document.getElementById("modalCategory").classList.contains("open")) {
      renderCategoryDetail();
    }
    renderPlans();
    renderAlerts();
    // Check for 100% completion → Slovak confetti
    if (state.profile && overallScore() >= 99.5) {
      setTimeout(triggerSlovakConfetti, 500);
    }
  }

  // ── Forms ────────────────────────────────────────────────────────
  function openProfileEditor() {
    const f = document.getElementById("profileForm");
    if (state.profile) {
      const p = state.profile;
      ["adults","kids","infants","seniors","prepDays"].forEach(k => {
        if (f.elements[k]) f.elements[k].value = p[k] ?? (k === "prepDays" ? 3 : 0);
      });
      ["readiness","budget","housing"].forEach(k => {
        const val = p[k];
        if (val) {
          const radio = f.querySelector(`input[name="${k}"][value="${val}"]`);
          if (radio) radio.checked = true;
        }
      });
    } else {
      const defReadiness = f.querySelector('input[name="readiness"][value="standard"]');
      if (defReadiness) defReadiness.checked = true;
      const defBudget = f.querySelector('input[name="budget"][value="mid"]');
      if (defBudget) defBudget.checked = true;
      const defHousing = f.querySelector('input[name="housing"][value="flat"]');
      if (defHousing) defHousing.checked = true;
    }
    openModal("modalProfile");
  }
  window.openProfileEditor = openProfileEditor;

  // ── Profile Advanced Toggle ──
  (function() {
    const toggle = document.getElementById("profileAdvancedToggle");
    const content = document.getElementById("profileAdvancedContent");
    const arrow = document.getElementById("profileAdvancedArrow");
    let isOpen = false;
    function setAdvancedOpen(open) {
      isOpen = open;
      content.style.display = open ? "grid" : "none";
      arrow.style.transform = open ? "rotate(180deg)" : "";
    }
    toggle.addEventListener("click", () => setAdvancedOpen(!isOpen));
    // Auto-expand when editing existing profile with non-default advanced values
    const origOpen = window.openProfileEditor;
    window.openProfileEditor = function() {
      origOpen();
      if (state.profile) {
        const p = state.profile;
        const hasAdvanced = p.readiness !== "standard" || p.budget !== "mid";
        setAdvancedOpen(hasAdvanced);
      } else {
        setAdvancedOpen(false);
      }
    };
  })();

  document.getElementById("profileForm").onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);

    // Koeficient pre zvýšenú pripravenosť
    const readiness = String(fd.get("readiness") || "standard");
    const readinessCoeff = readiness === "enhanced" ? 1.3 : 1.0;

    state.profile = {
      adults:   +fd.get("adults")   || 0,
      kids:     +fd.get("kids")     || 0,
      infants:  +fd.get("infants")  || 0,
      seniors:  +fd.get("seniors")  || 0,
      prepDays: +fd.get("prepDays") || 3,
      housing:  String(fd.get("housing")  || "flat"),
      readiness,
      readinessCoeff,
      budget:   String(fd.get("budget")   || "mid"),
    };
    closeModal("modalProfile");
    regenerateProfileBasedItems();
    scheduleSave(); renderAll();
    trackEvent('profile_setup', {
      household_size: state.profile.adults + state.profile.kids + state.profile.infants + state.profile.seniors,
      prep_days: state.profile.prepDays
    });
    // Onboarding: scroll to categories after first profile save
    const isFirstSetup = !state._profileWasSet;
    state._profileWasSet = true;
    setTimeout(() => {
      const catSection = document.getElementById("categoriesSection");
      if (catSection) catSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Show onboarding tip on first profile save
      if (isFirstSetup) {
        const tip = document.getElementById("onboardingTip");
        if (tip) {
          tip.style.display = "block";
          // Auto-dismiss after 12 seconds
          setTimeout(() => { tip.style.display = "none"; }, 12000);
        }
      }
    }, 300);
  };

  // ── Unified Item Modal (Add / Edit) ──────────────────────────────
  let pendingDeleteCatId = "";
  let pendingDeleteIdx = -1;

  function openItemModal(catId, itemIdx) {
    const f = document.getElementById("addItemForm");
    const isEdit = itemIdx >= 0 && state.items[catId] && itemIdx < state.items[catId].length;
    const item = isEdit ? state.items[catId][itemIdx] : {};
    const isDocs = (catId === "docs");
    const hasExpiry = (catId === "food" || catId === "water" || catId === "medkit");
    const hasLink = (catId === "food" || catId === "water" || catId === "medkit" || catId === "hygiene" || catId === "gear");
    const isCashOnly = (catId === "cash");

    // Title
    const catLabels = { docs: "doklad", cash: "položku", medkit: "položku", food: "položku", water: "položku", hygiene: "položku", gear: "položku" };
    if (isDocs) {
      document.getElementById("itemModalTitle").textContent = isEdit ? "✏️ Upraviť doklad" : "➕ Pridať doklad";
    } else {
      document.getElementById("itemModalTitle").textContent = isEdit ? "✏️ Upraviť položku" : "➕ Pridať položku";
    }
    document.getElementById("btnItemSubmit").textContent = isEdit ? "Uložiť" : "Pridať";

    // Name label
    document.getElementById("itemLabelName").textContent = isDocs ? "Názov dokladu *" : "Názov *";

    // Field visibility per category:
    // docs: Name + Typ uloženia only
    // cash: Name + Množstvo only
    // food, water, medkit: Name + Množstvo + Expirácia + Odkaz
    // hygiene, gear: Name + Množstvo + Odkaz (no expiry)
    const qtyRow = document.getElementById("itemFieldQtyRow");
    const expiryField = document.getElementById("itemFieldExpiry");
    const docsField = document.getElementById("itemFieldDocs");
    const linkField = document.getElementById("itemFieldLink");

    if (isDocs) {
      qtyRow.style.display = "none";
      docsField.style.display = "block";
      linkField.style.display = "none";
    } else {
      qtyRow.style.display = hasExpiry ? "grid" : "block";
      qtyRow.style.gridTemplateColumns = hasExpiry ? "1fr 1fr" : "1fr";
      expiryField.style.display = hasExpiry ? "block" : "none";
      docsField.style.display = "none";
      linkField.style.display = (hasLink && !isCashOnly) ? "block" : "none";
    }

    f.elements["editIndex"].value = itemIdx;
    f.elements["name"].value = item.name || "";

    if (isDocs) {
      f.elements["qty_docs"].value = item.qty || "";
      f.elements["qty"].value = "";
      f.elements["expiry"].value = "";
      f.elements["link"].value = "";
    } else {
      f.elements["qty"].value = item.qty || "";
      f.elements["qty_docs"].value = "";
      f.elements["expiry"].value = hasExpiry ? (item.expiry || "") : "";
      f.elements["link"].value = hasLink ? (item.link || "") : "";
    }

    openModal("modalAddItem");
  }

  // ── Undo toast system ──────────────────────────────────────
  let undoTimeout = null;
  let undoData = null;

  function showUndoToast(message, restoreFn) {
    // Remove existing toast
    const existing = document.getElementById("undoToast");
    if (existing) existing.remove();
    if (undoTimeout) clearTimeout(undoTimeout);

    const toast = document.createElement("div");
    toast.id = "undoToast";
    toast.className = "undo-toast";
    toast.innerHTML = `<span>${message}</span><button onclick="performUndo()">Vrátiť späť</button>`;
    document.body.appendChild(toast);

    undoData = restoreFn;
    undoTimeout = setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transition = "opacity 0.3s";
      setTimeout(() => toast.remove(), 300);
      undoData = null;
    }, 5000);
  }

  window.performUndo = function() {
    if (undoData) {
      undoData();
      undoData = null;
    }
    if (undoTimeout) clearTimeout(undoTimeout);
    const toast = document.getElementById("undoToast");
    if (toast) toast.remove();
    scheduleSave(); renderAll();
  };

  function openDeleteConfirmation(catId, itemIdx) {
    const cat = CATEGORIES.find(c => c.id === catId);
    const item = state.items[catId] && state.items[catId][itemIdx];
    if (!item || !cat) return;

    // Save item data for undo
    const deletedItem = structuredClone(item);
    const deletedIdx = itemIdx;
    const deletedCatId = catId;

    // Delete immediately
    state.items[catId].splice(itemIdx, 1);
    scheduleSave(); renderAll();

    // Show undo toast
    showUndoToast(`🗑️ ${esc(deletedItem.name)} odstránené`, () => {
      state.items[deletedCatId].splice(deletedIdx, 0, deletedItem);
    });
  }

  document.getElementById("btnConfirmDelete").onclick = () => {
    if (pendingDeleteCatId && pendingDeleteIdx >= 0 && state.items[pendingDeleteCatId]) {
      state.items[pendingDeleteCatId].splice(pendingDeleteIdx, 1);
      closeModal("modalDeleteItem");
      scheduleSave(); renderAll();
    }
  };

  document.getElementById("btnAddItem").onclick = () => {
    openItemModal(state.selectedCategoryId, -1);
  };

  document.getElementById("addItemForm").onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const name = String(fd.get("name")||"").trim();
    if (!name) return;
    const cid = state.selectedCategoryId;
    const idx = parseInt(fd.get("editIndex"));
    const isDocs = (cid === "docs");
    const hasExpiry = (cid === "food" || cid === "water" || cid === "medkit");
    const hasLink = (cid === "food" || cid === "water" || cid === "medkit" || cid === "hygiene" || cid === "gear");

    const itemData = {
      name,
      qty: isDocs ? String(fd.get("qty_docs")||"").trim() : String(fd.get("qty")||"").trim(),
      expiry: hasExpiry ? String(fd.get("expiry")||"").trim() : "",
      link: hasLink ? String(fd.get("link")||"").trim() : "",
    };

    state.items[cid] = state.items[cid] || [];
    if (idx >= 0 && idx < state.items[cid].length) {
      Object.assign(state.items[cid][idx], itemData);
    } else {
      const newItem = { ...itemData, done: false };
      if (isDocs) newItem.docGroup = "Iné";
      state.items[cid].push(newItem);
    }
    closeModal("modalAddItem");
    e.target.reset();
    scheduleSave(); renderAll();
  };

  document.getElementById("alertDaysMeds").onchange = (e) => {
    state.alertDaysMeds = +e.target.value;
    scheduleSave(); renderAlerts(); renderAll();
  };
  document.getElementById("alertDaysFood").onchange = (e) => {
    state.alertDaysFood = +e.target.value;
    scheduleSave(); renderAlerts(); renderAll();
  };

  // ── Food Entry Edit Modal ───────────────────────────────────────
  function openFoodEditModal(catId, itemIdx, entryIdx, entry) {
    const f = document.getElementById("foodEditForm");
    f.elements["fe_catId"].value = catId;
    f.elements["fe_itemIdx"].value = itemIdx;
    f.elements["fe_entryIdx"].value = entryIdx;
    f.elements["fe_name"].value = entry.name || "";
    f.elements["fe_kcal"].value = entry.kcal || "";
    f.elements["fe_qty"].value = entry.qty || 1;
    f.elements["fe_expiry"].value = entry.expiry || "";
    openModal("modalFoodEdit");
  }

  document.getElementById("foodEditForm").onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const catId = fd.get("fe_catId");
    const itemIdx = parseInt(fd.get("fe_itemIdx"));
    const entryIdx = parseInt(fd.get("fe_entryIdx"));
    const entry = state.items[catId]?.[itemIdx]?.foodEntries?.[entryIdx];
    if (!entry) return;
    entry.name = String(fd.get("fe_name")||"").trim();
    entry.kcal = Number(fd.get("fe_kcal"))||0;
    entry.qty = Number(fd.get("fe_qty"))||1;
    entry.expiry = String(fd.get("fe_expiry")||"").trim();
    closeModal("modalFoodEdit");
    scheduleSave(); renderAll();
  };

  // ── Water Entry Edit Modal ───────────────────────────────────────
  function openWaterEditModal(catId, itemIdx, entryIdx, entry) {
    const f = document.getElementById("waterEditForm");
    f.elements["we_catId"].value = catId;
    f.elements["we_itemIdx"].value = itemIdx;
    f.elements["we_entryIdx"].value = entryIdx;
    f.elements["we_name"].value = entry.name || "";
    f.elements["we_liters"].value = entry.liters || "";
    f.elements["we_qty"].value = entry.qty || 1;
    f.elements["we_expiry"].value = entry.expiry || "";
    openModal("modalWaterEdit");
  }

  document.getElementById("waterEditForm").onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const catId = fd.get("we_catId");
    const itemIdx = parseInt(fd.get("we_itemIdx"));
    const entryIdx = parseInt(fd.get("we_entryIdx"));
    const entry = state.items[catId]?.[itemIdx]?.waterEntries?.[entryIdx];
    if (!entry) return;
    entry.name = String(fd.get("we_name")||"").trim();
    entry.liters = Number(fd.get("we_liters"))||0;
    entry.qty = Number(fd.get("we_qty"))||1;
    entry.expiry = String(fd.get("we_expiry")||"").trim();
    closeModal("modalWaterEdit");
    scheduleSave(); renderAll();
  };

  // ── Cash Entry Edit Modal ────────────────────────────────────────
  function openCashEditModal(catId, itemIdx, entryIdx, entry) {
    const f = document.getElementById("cashEditForm");
    f.elements["ce_catId"].value = catId;
    f.elements["ce_itemIdx"].value = itemIdx;
    f.elements["ce_entryIdx"].value = entryIdx;
    f.elements["ce_type"].value = entry.type || "bankovka";
    f.elements["ce_value"].value = entry.value || "";
    f.elements["ce_qty"].value = entry.qty || 1;
    openModal("modalCashEdit");
  }

  document.getElementById("cashEditForm").onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const catId = fd.get("ce_catId");
    const itemIdx = parseInt(fd.get("ce_itemIdx"));
    const entryIdx = parseInt(fd.get("ce_entryIdx"));
    const entry = state.items[catId]?.[itemIdx]?.cashEntries?.[entryIdx];
    if (!entry) return;
    entry.type = String(fd.get("ce_type")||"bankovka");
    entry.value = Number(fd.get("ce_value"))||0;
    entry.qty = Number(fd.get("ce_qty"))||1;
    closeModal("modalCashEdit");
    scheduleSave(); renderAll();
  };

  // ── Validation Modal Helper ──────────────────────────────────────
  function showValidation(msg) {
    document.getElementById("validationText").textContent = msg;
    openModal("modalValidation");
  }

  // Click outside modal to close
  document.querySelectorAll(".modal-overlay").forEach(overlay => {
    overlay.onclick = (e) => { if (e.target === overlay) closeModal(overlay.id); };
  });


  // ══════════════════════════════════════════════════════════════════
  // EMAIL NOTIFIKÁCIE
  // ══════════════════════════════════════════════════════════════════

  // Prahové hodnoty v dňoch
  // Expirácia: riadi sa nastaveniami v appke (alertDaysMeds / alertDaysFood)
  const NOTIFY_SHOPPING_DAYS = 14; // nákupný zoznam ak expiruje do 14 dní
  const NOTIFY_COOLDOWN_H    = 24; // min. hodín medzi emailami rovnakého typu

  // Zistí čo expiruje – vráti pole { name, catName, expiry, days }
  // Ak thresholdDays nie je zadaný, použije per-kategóriu nastavenia
  function getExpiringItems(thresholdDays) {
    const items = [];
    for (const c of CATEGORIES) {
      const catThreshold = thresholdDays !== undefined ? thresholdDays : getAlertDaysForCategory(c.id);
      (state.items[c.id] || []).forEach(it => {
        // Food entries: check each entry's expiry
        if (it.isFoodItem && it.foodEntries) {
          it.foodEntries.forEach(fe => {
            if (!fe.expiry) return;
            const d = daysUntil(fe.expiry);
            if (d <= catThreshold) {
              items.push({
                name:    fe.name,
                catName: c.name,
                expiry:  fe.expiry,
                days:    d,
                qty:     (fe.qty||1) + "× " + (fe.kcal||0) + " kcal"
              });
            }
          });
          return;
        }
        // Water entries: check each entry's expiry
        if (it.isWaterItem && it.waterEntries) {
          it.waterEntries.forEach(we => {
            if (!we.expiry) return;
            const d = daysUntil(we.expiry);
            if (d <= catThreshold) {
              items.push({
                name:    we.name,
                catName: c.name,
                expiry:  we.expiry,
                days:    d,
                qty:     (we.qty||1) + "× " + (we.liters||0) + " l"
              });
            }
          });
          return;
        }
        if (!it.expiry || !it.done) return; // len položky ktoré sú v zásobách (done=true)
        const d = daysUntil(it.expiry);
        if (d <= catThreshold) {
          items.push({
            name:    it.name,
            catName: c.name,
            expiry:  it.expiry,
            days:    d,
            qty:     it.qty || ""
          });
        }
      });
    }
    return items.sort((a, b) => a.days - b.days);
  }

  // Skontroluje či sa má poslať email (cooldown 24h)
  async function canSendEmail(type) {
    if (isDemo) return false; // Demo: žiadne emaily
    if (!currentUser) return false;
    if (EMAILJS_CONFIG.publicKey === "YOUR_EMAILJS_PUBLIC_KEY") return false; // nekonfigurované
    try {
      const snap = await getDoc(doc(db, "users", currentUser.uid, "notifications", type));
      if (!snap.exists()) return true;
      const lastSent = snap.data().sentAt?.toMillis?.() || 0;
      const hoursSince = (Date.now() - lastSent) / 3600000;
      return hoursSince >= NOTIFY_COOLDOWN_H;
    } catch { return false; }
  }

  // Zapíše timestamp posledného odoslania
  async function markEmailSent(type) {
    if (isDemo || !currentUser) return;
    try {
      await setDoc(
        doc(db, "users", currentUser.uid, "notifications", type),
        { sentAt: new Date() }
      );
    } catch(e) { console.warn("markEmailSent error", e); }
  }

  // Formátuje zoznam položiek do HTML pre email
  function formatItemsHtml(items) {
    return items.map(it => {
      const daysLabel = it.days < 0
        ? "<span style='color:#dc2626;font-weight:600;'>EXPIROVANÉ</span>"
        : `za <strong>${it.days} dní</strong> (${it.expiry})`;
      return `<tr>
        <td style="padding:6px 12px;border-bottom:1px solid #f0ebe3;">${it.name}</td>
        <td style="padding:6px 12px;border-bottom:1px solid #f0ebe3;color:#6b6560;">${it.catName}</td>
        <td style="padding:6px 12px;border-bottom:1px solid #f0ebe3;">${daysLabel}</td>
      </tr>`;
    }).join("");
  }

  // EMAIL 1 – Upozornenie na blížiacu sa expiráciu (spotrebuj to!)
  async function sendExpiryWarningEmail(items) {
    if (!currentUser?.email) return;
    if (!(await canSendEmail("expiry_warning"))) return;
    if (!items.length) return;

    const userName = currentUser.displayName?.split(" ")[0] || "používateľ";
    const itemsHtml = formatItemsHtml(items);
    const itemCount = items.length;

    try {
      await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.template_expiry, {
        to_email:    currentUser.email,
        to_name:     userName,
        item_count:  itemCount,
        items_html:  itemsHtml,
        items_text:  items.map(it => `• ${it.name} (${it.catName}) – expiruje ${it.expiry}`).join("\n"),
        app_url:     window.location.href,
        subject:     `Gerlach: ${itemCount} ${itemCount === 1 ? "položka" : itemCount < 5 ? "položky" : "položiek"} v zásobách čoskoro expiruje`
      });
      await markEmailSent("expiry_warning");
      console.log("✉️ Expiry warning email odoslaný");
    } catch(e) {
      console.warn("EmailJS expiry send error:", e);
    }
  }

  // EMAIL 2 – Nákupný zoznam (dobuď zásoby!)
  async function sendShoppingListEmail(items) {
    if (!currentUser?.email) return;
    if (!(await canSendEmail("shopping_list"))) return;
    if (!items.length) return;

    const userName = currentUser.displayName?.split(" ")[0] || "používateľ";
    const itemCount = items.length;
    const shoppingHtml = items.map(it => `<tr>
      <td style="padding:6px 12px;border-bottom:1px solid #f0ebe3;"><strong>${it.name}</strong></td>
      <td style="padding:6px 12px;border-bottom:1px solid #f0ebe3;color:#6b6560;">${it.catName}</td>
      <td style="padding:6px 12px;border-bottom:1px solid #f0ebe3;color:#6b6560;">${it.qty || "—"}</td>
    </tr>`).join("");

    try {
      await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.template_shopping, {
        to_email:      currentUser.email,
        to_name:       userName,
        item_count:    itemCount,
        shopping_html: shoppingHtml,
        shopping_text: items.map(it => `• ${it.name} (${it.catName})${it.qty ? " – " + it.qty : ""}`).join("\n"),
        app_url:       window.location.href,
        subject:       `Gerlach: Nákupný zoznam – ${itemCount} ${itemCount === 1 ? "položka na doplnenie" : "položky na doplnenie"}`
      });
      await markEmailSent("shopping_list");
      console.log("✉️ Shopping list email odoslaný");
    } catch(e) {
      console.warn("EmailJS shopping send error:", e);
    }
  }

  // Hlavná funkcia – skontroluje expirácie a odošle emaily ak treba
  async function checkAndSendNotifications() {
    if (isDemo) return; // Demo: žiadne emaily
    if (!currentUser || EMAILJS_CONFIG.publicKey === "YOUR_EMAILJS_PUBLIC_KEY") return;

    const expiringItems  = getExpiringItems(); // per-category thresholds
    const criticalItems  = getExpiringItems(NOTIFY_SHOPPING_DAYS);

    // Email 1: upozornenie (podľa nastavených prahov per kategória)
    if (expiringItems.length > 0) {
      await sendExpiryWarningEmail(expiringItems);
    }

    // Email 2: nákupný zoznam (do 14 dní) – s oneskorením aby neišli súčasne
    if (criticalItems.length > 0) {
      setTimeout(() => sendShoppingListEmail(criticalItems), 3000);
    }
  }

  // UI funkcia – manuálne odoslanie z appky (tlačidlo)
  async function sendTestNotification() {
    if (isDemo) {
      alert("V demo režime nie sú emailové notifikácie dostupné. Vytvorte si účet zadarmo pre plnú funkcionalitu.");
      return;
    }
    const btn = document.getElementById("btnTestEmail");
    if (btn) { btn.disabled = true; btn.textContent = "Odosielam..."; }

    try {
      const expiringItems = getExpiringItems(); // per-category thresholds
      const criticalItems = getExpiringItems(NOTIFY_SHOPPING_DAYS);

      if (!expiringItems.length && !criticalItems.length) {
        alert("Žiadne položky s blížiacou sa expiráciou. Pridajte položky s dátumom expirácie.");
        return;
      }

      // Obíde cooldown pre testovanie
      if (EMAILJS_CONFIG.publicKey !== "YOUR_EMAILJS_PUBLIC_KEY") {
        await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.template_expiry, {
          to_email:   currentUser.email,
          to_name:    currentUser.displayName?.split(" ")[0] || "používateľ",
          item_count: expiringItems.length,
          items_text: expiringItems.map(it => `• ${it.name} (${it.catName}) – expiruje ${it.expiry}`).join("\n"),
          items_html: formatItemsHtml(expiringItems),
          app_url:    window.location.href,
          subject:    "Gerlach: Test emailovej notifikácie"
        });
        alert(`✅ Testovací email odoslaný na ${currentUser.email}`);
      } else {
        alert("EmailJS nie je nakonfigurovaný. Pozri komentáre v kóde.");
      }
    } catch(e) {
      alert("Chyba pri odosielaní: " + (e.text || e.message || e));
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = "Testovací email"; }
    }
  }

  // Zavrieť user menu pri kliknutí mimo
  document.addEventListener("click", (e) => {
    const menu = document.getElementById("userMenu");
    const avatar = document.getElementById("userAvatar");
    if (menu && !menu.contains(e.target) && e.target !== avatar) {
      menu.classList.remove("open");
    }
  });

  // Dynamic year
  document.querySelectorAll('.js-year').forEach(el => { el.textContent = new Date().getFullYear(); });

</script>

<!-- Cookie Banner -->
<div class="cookie-banner" id="cookieBanner" role="dialog" aria-label="Informácia o cookies">
  <div class="cookie-banner-inner">
    <div class="cookie-banner-text">
      Používame <strong style="font-weight:500;color:#fff;">nevyhnutné cookies</strong> na prihlásenie a <strong style="font-weight:500;color:#fff;">analytické cookies</strong> (Firebase Analytics) na zlepšovanie aplikácie. Analytické cookies aktivujeme len s vaším súhlasom.
      <a href="./pravne-info.html#cookies">Podrobnosti</a>
    </div>
    <div class="cookie-banner-actions">
      <button class="cookie-btn cookie-btn-accept" onclick="acceptAllCookies()">Prijať všetko</button>
      <button class="cookie-btn cookie-btn-info" onclick="acceptNecessaryOnly()">Len nevyhnutné</button>
    </div>
  </div>
</div>
<script>
  (function() {
    // Ak používateľ ešte nerozhodol → ukáž banner
    if (!localStorage.getItem('gerlach_cookie_consent')) {
      setTimeout(function() {
        document.getElementById('cookieBanner').classList.add('show');
      }, 1500);
    }
  })();
  function acceptAllCookies() {
    localStorage.setItem('gerlach_cookie_consent', 'all');
    if (typeof window.enableAnalytics === 'function') window.enableAnalytics();
    document.getElementById('cookieBanner').classList.remove('show');
  }
  function acceptNecessaryOnly() {
    localStorage.setItem('gerlach_cookie_consent', 'necessary');
    if (typeof window.disableAnalytics === 'function') window.disableAnalytics();
    document.getElementById('cookieBanner').classList.remove('show');
  }
</script>
</body>
</html>
